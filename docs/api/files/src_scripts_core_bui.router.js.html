<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>src/scripts/core/bui.router.js - BUI</title>
    <!-- <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css"> -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../assets/css/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/js/jquery-1.9.1.min.js"></script>
</head>

<body class="yui3-skin-sam">
    <div id="sidemenu" class="sidebar-menu">菜单</div>
    <div id="doc">
        <div id="hd" class="yui3-g header" style="display: none;">
            <div class="yui3-u-3-4">
                <h1><a href="../index.html"><img src="../assets/css/logo.png"
                            title="BUI" width="30px"></a>
                    <a href="../index.html">BUI</a>
                </h1>
                <p class="off-left">其它版本:<select name="" id="" onchange="window.open(this.value)">
                        <option value="../api/index.html" selected>1.8.x</option>
                        <option value="../api-1.7.x/index.html">1.7.x</option>
                        <option value="../api-1.6.x/index.html">1.6.x</option>
                        <option value="../api-1.5.x/index.html">1.5.x</option>
                        <option value="../api-1.4.8/index.html">1.4.x</option>
                    </select></p>
                <p class="off-left" style="font-size:12px;margin-right: 15px;">API for BUI
                    1.8.x </p>

            </div>
        </div>
        <div id="bd" class="yui3-g" style="padding-top: 0;">
            <div id="sidebar" class="yui3-u-1-4" style="top:0;">

                <a href="../index.html"
                    style="display: block;padding:6px;font-size:16px;background:#fff;position:absolute;z-index:1000;width:70px;letter-spacing:2px;text-align:right;left:220px;top:20px;color:#333;">返回</a>

                <div id="docs-sidebar" class="sidebar apidocs">
                    <div id="api-list">
                        <div id="api-tabview" class="tabview">
                    
                            <ul class="tabs">
                                <li><a href="#api-classes">Classes</a></li>
                                <li><a href="#api-modules">Modules</a></li>
                            </ul>
                    
                            <div id="api-tabview-filter">
                                <input type="search" id="api-filter" placeholder="Type to filter APIs">
                            </div>
                    
                            <div id="api-tabview-panel">
                                <ul id="api-classes" class="apis classes">
                                    <li><a href="../classes/bui.accordion.html">bui.accordion</a></li>
                                    <li><a href="../classes/bui.actionsheet.html">bui.actionsheet</a></li>
                                    <li><a href="../classes/bui.ajax.html">bui.ajax</a></li>
                                    <li><a href="../classes/bui.alert.html">bui.alert</a></li>
                                    <li><a href="../classes/bui.all.html">bui.all</a></li>
                                    <li><a href="../classes/bui.animate.html">bui.animate</a></li>
                                    <li><a href="../classes/bui.array.html">bui.array</a></li>
                                    <li><a href="../classes/bui.back.html">bui.back</a></li>
                                    <li><a href="../classes/bui.btn.html">bui.btn</a></li>
                                    <li><a href="../classes/bui.checkVersion.html">bui.checkVersion</a></li>
                                    <li><a href="../classes/bui.cmd.html">bui.cmd</a></li>
                                    <li><a href="../classes/bui.config.html">bui.config</a></li>
                                    <li><a href="../classes/bui.confirm.html">bui.confirm</a></li>
                                    <li><a href="../classes/bui.date.html">bui.date</a></li>
                                    <li><a href="../classes/bui.delete.html">bui.delete</a></li>
                                    <li><a href="../classes/bui.dialog.html">bui.dialog</a></li>
                                    <li><a href="../classes/bui.download.html">bui.download</a></li>
                                    <li><a href="../classes/bui.dropdown.html">bui.dropdown</a></li>
                                    <li><a href="../classes/bui.emitter.html">bui.emitter</a></li>
                                    <li><a href="../classes/bui.extend.html">bui.extend</a></li>
                                    <li><a href="../classes/bui.file.html">bui.file</a></li>
                                    <li><a href="../classes/bui.fileselect.html">bui.fileselect</a></li>
                                    <li><a href="../classes/bui.floor.html">bui.floor</a></li>
                                    <li><a href="../classes/bui.get.html">bui.get</a></li>
                                    <li><a href="../classes/bui.getPageParams.html">bui.getPageParams</a></li>
                                    <li><a href="../classes/bui.guid.html">bui.guid</a></li>
                                    <li><a href="../classes/bui.hint.html">bui.hint</a></li>
                                    <li><a href="../classes/bui.history.html">bui.history</a></li>
                                    <li><a href="../classes/bui.init.html">bui.init</a></li>
                                    <li><a href="../classes/bui.input.html">bui.input</a></li>
                                    <li><a href="../classes/bui.levelselect.html">bui.levelselect</a></li>
                                    <li><a href="../classes/bui.list.html">bui.list</a></li>
                                    <li><a href="../classes/bui.listview.html">bui.listview</a></li>
                                    <li><a href="../classes/bui.load.html">bui.load</a></li>
                                    <li><a href="../classes/bui.loader.html">bui.loader</a></li>
                                    <li><a href="../classes/bui.loading.html">bui.loading</a></li>
                                    <li><a href="../classes/bui.mask.html">bui.mask</a></li>
                                    <li><a href="../classes/bui.number.html">bui.number</a></li>
                                    <li><a href="../classes/bui.page.html">bui.page</a></li>
                                    <li><a href="../classes/bui.pickerdate.html">bui.pickerdate</a></li>
                                    <li><a href="../classes/bui.platform.html">bui.platform</a></li>
                                    <li><a href="../classes/bui.popover.html">bui.popover</a></li>
                                    <li><a href="../classes/bui.post.html">bui.post</a></li>
                                    <li><a href="../classes/bui.prompt.html">bui.prompt</a></li>
                                    <li><a href="../classes/bui.pullrefresh.html">bui.pullrefresh</a></li>
                                    <li><a href="../classes/bui.put.html">bui.put</a></li>
                                    <li><a href="../classes/bui.rating.html">bui.rating</a></li>
                                    <li><a href="../classes/bui.ready.html">bui.ready</a></li>
                                    <li><a href="../classes/bui.refresh.html">bui.refresh</a></li>
                                    <li><a href="../classes/bui.router.html">bui.router</a></li>
                                    <li><a href="../classes/bui.run.html">bui.run</a></li>
                                    <li><a href="../classes/bui.scroll.html">bui.scroll</a></li>
                                    <li><a href="../classes/bui.searchbar.html">bui.searchbar</a></li>
                                    <li><a href="../classes/bui.select.html">bui.select</a></li>
                                    <li><a href="../classes/bui.setting.html">bui.setting</a></li>
                                    <li><a href="../classes/bui.sidebar.html">bui.sidebar</a></li>
                                    <li><a href="../classes/bui.slide.html">bui.slide</a></li>
                                    <li><a href="../classes/bui.stepbar.html">bui.stepbar</a></li>
                                    <li><a href="../classes/bui.storage.html">bui.storage</a></li>
                                    <li><a href="../classes/bui.store.html">bui.store</a></li>
                                    <li><a href="../classes/bui.swipe.html">bui.swipe</a></li>
                                    <li><a href="../classes/bui.tab.html">bui.tab</a></li>
                                    <li><a href="../classes/bui.timer.html">bui.timer</a></li>
                                    <li><a href="../classes/bui.toggle.html">bui.toggle</a></li>
                                    <li><a href="../classes/bui.touch.html">bui.touch</a></li>
                                    <li><a href="../classes/bui.typeof.html">bui.typeof</a></li>
                                    <li><a href="../classes/bui.unit.html">bui.unit</a></li>
                                    <li><a href="../classes/bui.upload.html">bui.upload</a></li>
                                    <li><a href="../classes/bui.viewport.html">bui.viewport</a></li>
                                </ul>
                    
                                <ul id="api-modules" class="apis modules">
                                    <li><a href="../modules/Animate.html">Animate</a></li>
                                    <li><a href="../modules/Core.html">Core</a></li>
                                    <li><a href="../modules/Event.html">Event</a></li>
                                    <li><a href="../modules/Method.html">Method</a></li>
                                    <li><a href="../modules/Native.html">Native</a></li>
                                    <li><a href="../modules/UI.html">UI</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        // iframe 里执行脚本，通过引入index.js 的方式无法成功
                        function sidebarInit() {
                            var sidebarHeight = $(window).height() - 153;
                    
                            $("#api-tabview-panel").height(sidebarHeight);
                        }
                        sidebarInit();
                    </script>                </div>
            </div>
            <div class="yui3-u-3-4">
                    <div id="api-options">
                        Show:
                        <label for="api-show-inherited">
                            <input type="checkbox" id="api-show-inherited" checked>
                            Inherited
                        </label>
                
                        <label for="api-show-protected">
                            <input type="checkbox" id="api-show-protected">
                            Protected
                        </label>
                
                        <label for="api-show-private">
                            <input type="checkbox" id="api-show-private">
                            Private
                        </label>
                        <label for="api-show-deprecated">
                            <input type="checkbox" id="api-show-deprecated">
                            Deprecated
                        </label>
                
                    </div>
                
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
                            <h1 class="file-heading">File: src/scripts/core/bui.router.js</h1>
                            
                            <div class="file">
                                <pre class="code prettyprint linenums">
                            /**
                             * 核心
                             * @module Core
                             */
                            
                            ;
                            (function (ui, $) {
                                &quot;use strict&quot;;
                            
                                /**
                                 *
                                 * &lt;div class=&quot;oui-fluid&quot;&gt;
                                 *   &lt;div class=&quot;span8&quot;&gt;
                                 *     &lt;h2&gt;BUI 单页路由器&lt;/h2&gt;
                                 *     &lt;p&gt;&lt;a href=&quot;http://www.easybui.com/docs/index.html?id=buirouter&quot; target=&quot;_parent&quot; style=&quot;color:red;&quot;&gt;单页路由入门文档&lt;/a&gt;&lt;/p&gt;
                                 *     &lt;p&gt;开启单页路由以后, 同样可以使用 bui.back (页面后退) , bui.load (页面跳转) , bui.history.getParams (获取对应的参数), 保持跟多页的开发方式一致有利于后面单页满足不了需求的时候进行切换.&lt;/p&gt;
                                 *     &lt;p&gt;路由依赖于 {{#crossLink &quot;bui.loader&quot;}}{{/crossLink}}, 具体查看模块的API. &lt;/p&gt;
                                 *     &lt;p&gt;路由默认已经初始化了一个main模块, 通过loader.map 可以修改首页的路径,一般无需修改&lt;/p&gt;
                                 *     &lt;h3&gt;预览地址: &lt;a href=&quot;http://www.easybui.com/demo/index.html#pages/router/index.html&quot; target=&quot;_blank&quot;&gt;demo&lt;/a&gt;&lt;/h3&gt;
                                 *     &lt;p&gt;功能点:&lt;/p&gt;
                                 *     &lt;p&gt;1. 页面跳转,支持模块跳转或者html跳转,支持动画 {{#crossLink &quot;bui.router/load&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;2. 指定后退几层,并且可以执行回调 {{#crossLink &quot;bui.router/back&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;3. 页面刷新,后退刷新 {{#crossLink &quot;bui.router/refresh&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;4. 页面替换 {{#crossLink &quot;bui.router/replace&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;5. 局部加载 {{#crossLink &quot;bui.router/loadPart&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;6. 页面传参,配合load,获取参数 {{#crossLink &quot;bui.router/getPageParams&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;7. 局部传参,配合loadPart,获取参数 {{#crossLink &quot;bui.router/getPartParams&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;8. 检测当前页面是否已经加载一次 {{#crossLink &quot;bui.router/isLoad&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;9. 返回当前页面Dom对象 {{#crossLink &quot;bui.router/currentPage&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;10. 返回当前模块对象 {{#crossLink &quot;bui.router/currentModule&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;11. 预加载模板 {{#crossLink &quot;bui.router/preload&quot;}}{{/crossLink}}&lt;/p&gt;
                                 *     &lt;p&gt;12. 修改切换效果&lt;/p&gt;
                                 *   &lt;/div&gt;
                                 *   &lt;div class=&quot;span4&quot;&gt;&lt;a href=&quot;http://www.easybui.com/demo/index.html#pages/router/index.html&quot; target=&quot;_blank&quot;&gt;&lt;img src=&quot;http://www.easybui.com/static/images/controls/bui-router_low.gif&quot; alt=&quot;BUI单页路由&quot;/&gt;&lt;/a&gt;&lt;/div&gt;
                                 * &lt;/div&gt;
                                 * @namespace  bui
                                 * @class  router
                                 * @since 1.4.0
                                 * @param {object} [option]
                                 * @param {string} option.id [路由初始化的id]
                                 * @param {boolean} [option.progress] 默认: false 关闭 | true 开启, 页面跳转是否开启进度条
                                 * @param {string} [option.effect] 默认: push | slide | cover | zoom | fadein | fadeinslide | none 
                                 * @param {string} [option.backEffect] 1.7.4 新增，用于单独处理后退动画，比方iphone手势后退会看上去两次效果，设置为&quot;none&quot; 以后，关闭掉所有后退动画 默认: &quot;&quot; | none ||  &quot;push&quot; || &quot;slide&quot; || &quot;cover&quot; || &quot;fadein&quot;
                                 * @param {object} [option.indexModule]  1.4.3新增, 首页地址配置, 默认: { moduleName: &quot;main&quot;,template: &quot;pages/main/main.html&quot;, script: &quot;pages/main/main.js&quot; } 
                                 * @param {string} [option.errorPage]  自定义404页面 默认为&quot;&quot; | &quot;pages/404.html&quot;
                                 * @param {number} [option.height] 1.4.7新增 默认: 0 
                                 * @param {boolean} [option.swipe] 1.6.3新增 不建议用了，默认: false | true 开启滑动swipeleft,swiperight事件 ，可以用来处理ios的手势滑动有2次的效果
                                 * @param {boolean} [option.swipeBack] 1.6.3新增 默认: false | true 开启滑动返回, 必须在swipe为true才会生效 
                                 * @param {boolean} [option.pageMove] 1.6.3新增 默认: true | false 往右滑动的时候,页面跟着一起移动 
                                 * @param {number} [option.distance] 1.6.3新增 默认: 100  按下位置 必须在 0-100之间
                                 * @param {number} [option.startDistance] 1.6.3新增 默认: 5  开始滑动的距离先大于5 防止误操作
                                 * @param {number} [option.swipeDistance] 1.6.3新增 默认: 50 开始滑动的距离且大于50 防止误操作
                                 * @param {function} [option.onBeforeSwipeRight] 1.6.3新增 默认: null 往右滑动后触发,return false 则不触发后退 
                                 * @param {function} [option.onSwipeRight] 1.6.3新增 默认: null 往右滑动后触发 
                                 * @param {function} [option.onSwipeLeft] 1.6.3新增 默认: null 往左滑动后触发 
                                 * @param {function} [option.onSwipeUp] 1.6.3新增 默认: null 往左滑动后触发 
                                 * @param {function} [option.onSwipeDown] 1.6.3新增 默认: null 往左滑动后触发 
                                 * @param {boolean} [option.cache] 默认: true ,缓存模板,下次再进入不会继续请求,速度会快一些 
                                 * @param {boolean} [option.hash] 1.5.1新增 hash跳转模式 默认: false , 可以用来处理刷新以后后退不了的问题, 相比reloadCache参数,不用加载那么多缓存,但也就后退没有动画效果. 
                                 * @param {boolean} [option.reloadCache] 1.4.1新增 默认: false | true , 刷新是否可以后退, 为true时可以加载之前的路由页面, 建议部署的时候有必要再开启 
                                 * @param {boolean} [option.syncHistory] 默认: true ,同步浏览器历史记录,这样可以兼容手机的后退按键,为false则页面地址不会,例如:appcan平台,使用打包以后没有历史记录,所以需要设置false 
                                 * @param {boolean} [option.firstAnimate] 1.4.2默认: false 等数据加载结束再切换,本地打包速度较快 | true 先执行页面切换,再执行页面加载,这样切换速度较快,但页面会先空白,webapp受网络影响,建议开启,并且开启进度条 
                                 * @param {boolean} [option.needComponent] 1.6.0 默认: true 解析component标签 | false 不解析component标签 
                                 * @param {function} [option.beforeInit] 路由初始化前的判断
                                 * @param {function||boolean} [option.beforeLoad] 1.5.1默认: null 每次跳转前触发, 如果返回 false 则不跳转, 不返回或者返回true 都会跳转. 这时页面结构还不会有，到beforeShow才渲染结构. 第一次页面展示 beforeLoad-&gt;beforeShow-&gt;showed-&gt;loaded, 跳转 beforeHide（当前页隐藏前）-&gt;beforeLoad（下一页加载前）-&gt;showed（下一页html加载后）-&gt;loaded（下一页js加载后）-hided(当前页隐藏后)，后退 beforeHide（当前页隐藏前） -&gt; beforeShow（上一页展示前，动画未执行）- &gt; showed（上一页展示后，动画已执行） -&gt; hided （当前页隐藏后，动画已执行）
                                 * @param {function} [option.beforeShow] 1.8.0 在页面显示结构后，动画前执行 , 只跟前进后退有关
                                 * @param {function} [option.showed] 1.8.0 在页面显示结构后，动画后执行 , 只跟前进后退有关
                                 * @param {function} [option.beforeHide] 1.8.0 在第1次跳转前执行，判断当前页面是否可以隐藏, 只跟前进后退有关
                                 * @param {function} [option.hided] 1.8.0 在第1次跳转动画后执行, 只跟前进后退有关
                                 * @param {function} [option.loaded] 1.5.5 新增默认: null 每次跳转后触发, 相当于 router.on(&quot;complete&quot;,callback) . 
                                 * @param {function||boolean} [option.beforeBack] 1.5.1默认: null 每次后退前触发, 如果返回 false 则不后退, 不返回或者返回true 都会后退. 
                                 * @param {function} [option.backed] 1.5.5 新增默认: null 每次跳转后触发, 相当于 router.on(&quot;complete&quot;,callback) . 
                                 * @param {object} [option.loading] 1.8.0 loading 的配置，默认： {
                                            display: &quot;block&quot;,
                                            className: &quot;bui-router-loading&quot;,
                                            width: 30,
                                            height: 30,
                                            opacity: 0
                                        }
                                 * @constructor
                                 * @example
                                 *
                                 *   html: 
                                 &lt;xmp&gt;
                                    &lt;div id=&quot;bui-router&quot;&gt;&lt;/div&gt;
                                 &lt;/xmp&gt;
                                 *   js:
                                 *
                                 
                            
                                  // 把路由实例化给 window.router
                                  
                                  window.router = bui.router();
                            
                                  bui.ready(function(){
                                    // 路由初始化
                                    router.init({
                                        id: &quot;#bui-router&quot;,
                                        hash:true
                                    })
                                  })
                            
                                  js: 路由权限拦截, 
                                  // 判断示例,正常用户信息应该使用 bui.storage 来操作. 
                                  var userinfo = null;
                                  
                                  // 配置页面组件白名单
                                  var whitelist = [&quot;pages/login/login&quot;];
                                  bui.ready(function(){
                                        router.init({
                                            id: &quot;#bui-router&quot;,
                                            beforeLoad: function(e) {
                                                // 如果没有登录,并且当前页面不是登录页面,则执行跳转, 并且要return false; 这样没有历史记录,不能使用后退.
                                                // 1.6.x 统一使用 e.target.name , 1.4.x-1.5.x 使用 e.target.pid ;
                                                if( !userinfo &amp;&amp; !whitelist.includes(e.target.name) ){
                                                    router.load({
                                                        url:&quot;pages/login/login.html&quot;
                                                    })
                                                    return false;
                                                }
                                            }
                                        })
                                    })
                            
                                 */
                                ui.router = function (option) {
                                    var config = {
                                        id: &quot;&quot;,
                                        uid: &quot;&quot;,
                                        progress: false,
                                        syncHistory: true,
                                        autoInit: true,
                                        firstAnimate: false,
                                        path: &quot;&quot;,
                                        indexModule: {
                                            moduleName: &quot;main&quot;,
                                            template: &quot;pages/main/main.html&quot;,
                                            script: &quot;pages/main/main.js&quot;,
                                        },
                                        repairPath: true,
                                        parseurl: true,
                                        errorPage: &quot;&quot;,
                                        hash: false,
                                        cache: true, // 是否需要模板缓存
                                        reloadCache: false, // 是否需要刷新缓存
                                        reload: false,
                                        swipe: false,
                                        swipeBack: false,
                                        distance: 100, // 按下位置 必须在 0-100之间
                                        startDistance: 5, // 开始滑动的距离先大于10 防止误操作
                                        swipeDistance: 50, // 且大于50 
                                        onSwipeRight: null, //往右滑动触发
                                        onSwipeLeft: null, // 往左滑动触发
                                        onSwipeUp: null, // 往上滑动触发
                                        onSwipeDown: null, // 往下滑动触发
                                        onBeforeSwipeRight: null, // 后退后触发
                                        onSwipeCancel: null, // 后退不成功触发
                                        pageMove: true,
                                        needNative: false,
                                        needView: false, // 编译view标签, 交由 bui.store 处理,在路由层面用处不大
                                        needComponent: true, // 编译component标签
                                        useScroll: &quot;main,.bui-tab-main&gt;ul&gt;li,.bui-dialog-main,.bui-scroll,.bui-scroll-x&quot;,
                                        beforeBack: null,
                                        beforeLoad: null,
                                        beforeShow: null,   // html ok 以后执行
                                        showed: null,
                                        beforeHide: null,   // html ok 以后执行
                                        hided: null,
                                        loaded: null,
                                        store: null,
                                        width: 0,
                                        height: 0,
                                        async: true, // 是否需要刷新缓存
                                        effect: &quot;push&quot;, // push | slide | cover | zoom | zoomslide | fadein | fadeinslide | none
                                        backEffect: &quot;&quot;,
                                        hashPrefix: &quot;#&quot;,
                                        scriptSuffix: &quot;.js&quot;,
                                        pageSuffix: &quot;.html&quot;,
                                        beforeInit: null,
                                        inited: null,
                                        loading: {
                                            display: &quot;block&quot;,
                                            className: &quot;bui-router-loading&quot;,
                                            width: 30,
                                            height: 30,
                                            opacity: 0
                                        }
                                    }
                            
                                    var param = $.extend({}, config, ui.config.router, option);
                            
                                    var $prevPage = null,
                                        $nowPage = null,
                                        $router,
                                        _self = this,
                                        $routerMain = null,
                                        // 交互控件
                                        uiTogglePrev = null,
                                        uiToggleNow = null,
                                        // 事件是否初始化
                                        hasEventInit = false,
                                        // 依赖的控件
                                        uiLoading,
                                        uiMask,
                                        winWidth = &quot;&quot;,
                                        winHeight = &quot;&quot;,
                                        // 第1次加载,默认第一次加载不使用动画
                                        firstLoad = true,
                                        // 后退的开关
                                        backControl = true,
                                        isRefresh = false,
                                        isLoaded = false,
                                        // 是否通过修改初始化
                                        isOption = false,
                                        _currentPage = null,
                                        pageshowInit = true,
                                        // 动画效果
                                        effects = {
                                            &quot;none&quot;: {
                                                inRight: &quot;showIn&quot;,
                                                inLeft: &quot;showIn&quot;,
                                                outRight: &quot;showOut&quot;,
                                                outLeft: &quot;showOut&quot;,
                                            },
                                            &quot;fadein&quot;: {
                                                inRight: &quot;fadeIn&quot;,
                                                inLeft: &quot;fadeIn&quot;,
                                                outRight: &quot;fadeOut&quot;,
                                                outLeft: &quot;fadeOut&quot;,
                                            },
                                            &quot;fadeinslide&quot;: {
                                                inRight: &quot;fadeInRight&quot;,
                                                inLeft: &quot;fadeInLeft&quot;,
                                                outRight: &quot;fadeOutRight&quot;,
                                                outLeft: &quot;fadeOutLeft&quot;,
                                            },
                                            &quot;slide&quot;: {
                                                inRight: &quot;slideInRight&quot;,
                                                inLeft: &quot;slideInLeft&quot;,
                                                outRight: &quot;slideOutRight&quot;,
                                                outLeft: &quot;slideOutLeft&quot;,
                                            },
                                            &quot;push&quot;: {
                                                inRight: &quot;pushInRight&quot;,
                                                inLeft: &quot;pushInLeft&quot;,
                                                outRight: &quot;pushOutRight&quot;,
                                                outLeft: &quot;pushOutLeft&quot;,
                                            },
                                            &quot;zoom&quot;: {
                                                inRight: &quot;zoomIn&quot;,
                                                inLeft: &quot;zoomIn&quot;,
                                                outRight: &quot;zoomOut&quot;,
                                                outLeft: &quot;zoomOut&quot;,
                                            },
                                            &quot;cover&quot;: {
                                                inRight: &quot;coverInRight&quot;,
                                                inLeft: &quot;coverInLeft&quot;,
                                                outRight: &quot;coverOutRight&quot;,
                                                outLeft: &quot;coverOutLeft&quot;,
                                            },
                                            &quot;zoomslide&quot;: {
                                                inRight: &quot;zoomSlideInRight&quot;,
                                                inLeft: &quot;zoomSlideInLeft&quot;,
                                                outRight: &quot;zoomSlideOutRight&quot;,
                                                outLeft: &quot;zoomSlideOutLeft&quot;,
                                            },
                                            &quot;fadeinslideback&quot;: {
                                                inRight: &quot;fadeInLeft&quot;,
                                                inLeft: &quot;fadeInRight&quot;,
                                            },
                                            &quot;slideback&quot;: {
                                                inRight: &quot;slideInLeft&quot;,
                                                inLeft: &quot;slideInRight&quot;
                                            },
                                            &quot;pushback&quot;: {
                                                inRight: &quot;pushInLeft&quot;,
                                                inLeft: &quot;pushInRight&quot;
                                            },
                                            &quot;coverback&quot;: {
                                                inRight: &quot;coverInLeft&quot;,
                                                inLeft: &quot;coverInRight&quot;
                                            },
                                            &quot;zoomslideback&quot;: {
                                                inRight: &quot;zoomSlideInLeft&quot;,
                                                inLeft: &quot;zoomSlideInRight&quot;
                                            }
                                        },
                                        // 存储define注册的return 对象
                                        _instanceCache = {}, // { index: object }
                                        currentModuleName = [], // 当前模块名称
                                        // 路由的历史纪录
                                        historyModule = {},
                                        //缓存的页面,如果没有设置缓存,则没有这个对象
                                        _cachePages = {},
                                        // 存储局部加载的模块
                                        _historyPart = [],
                                        // 历史日志,所有模块的操作
                                        _log = {},
                                        // 用户物理刷新需要动画处理,其它不用管这个状态
                                        needAnimate = false,
                                        hasReady = false, // 路由的加载状态
                                        // 当前的模块,由路由历史记录决定
                                        _currentHistory = {},
                                        // 缓存模块
                                        cacheModule = {},
                                        // 日志模块
                                        logModule = {};
                            
                                    var _map = loader.map(param.indexModule);
                                    // 清空多页的历史记录
                                    // 历史记录 id: 唯一id, pid: 页面id ,url: 页面地址, src: 页面依赖的js, param: 页面传递的参数
                                    // 链接上 bui.history 的历史记录
                                    var _history = ui.history.empty(); // = []; // [{id: gid, pid: pageid, url: url, src: scripts, param: queryParam }]
                            
                                    var _modulesMap = _map[&quot;modules&quot;];
                            
                                    var handleGet = {};// 路由拦截事件
                                    var uiSessionStorage = ui.storage({
                                        local: false
                                    });
                            
                                    var hasRouter = false;
                            
                                    // 是单页模式
                                    ui.hasRouter = true;
                                    /**
                                     * 路由的历史记录对象(废弃), 1.6.x 以后使用 bui.history.xxx 替代 router.history 
                                     *  @method history
                                     *  @since 1.4.2
                                     *  @static
                                     *  @return {object} [option]
                                     *          {object.get} [获取历史记录]
                                     *          {object.getLast} [获取最后一个历史记录]
                                     *          {object.check} [ 1.5.4新增, 检测有没有当前页面的历史记录]
                                     *  @example
                            
                                        var _history = router.history.get();
                            
                                     *
                                     */
                                    historyModule.get = function () {
                                        return _history;
                                    }
                            
                                    // 增加历史记录
                                    historyModule.add = function (opt) {
                                        opt = opt || {};
                            
                                        // 外部操控对象
                                        if (opt.toggle) {
                                            var newopt = $.extend(true, {}, opt);
                                            // 浏览器的历史记录参数不能内嵌对象
                                            opt.toggle = null;
                            
                                            _history.push(newopt);
                                        } else {
                                            _history.push(opt);
                                        }
                            
                                        var url = window.location.origin + window.location.pathname + &quot;#&quot; + opt.pid;
                                        var newurl = ui.setUrlParams(url, opt.param);
                            
                                        // 第一次无需替换window的历史记录
                                        if (firstLoad) {
                                            opt.syncHistory &amp;&amp; &quot;replaceState&quot; in window.history &amp;&amp; window.history.replaceState(opt, null, newurl);
                                            return;
                                        }
                            
                                        opt.syncHistory &amp;&amp; &quot;pushState&quot; in window.history &amp;&amp; window.history.pushState(opt, null, newurl);
                                        return _history;
                                    }
                            
                            
                                    // 在当前历史前面增加
                                    historyModule.prepend = function (opt) {
                                        opt = opt || {};
                            
                                        var url = window.location.origin + window.location.pathname + &quot;#&quot; + opt.pid;
                                        var newurl = ui.setUrlParams(url, opt.param);
                            
                                        _history.unshift(opt);
                            
                                        return _history;
                                    }
                            
                                    // 替换历史记录
                                    historyModule.replace = function (opt) {
                                        opt = opt || {};
                            
                                        // 有替换时,最后一个历史记录的index
                                        var index = _history.length - 1;
                                        var url = window.location.origin + window.location.pathname + &quot;#&quot; + opt.pid;
                                        var newurl = ui.setUrlParams(url, opt.param);
                            
                                        // 如果存在则替换索引,否则添加记录
                                        if (index &gt; -1) {
                                            _history.splice(index, 1, opt);
                                            opt.syncHistory &amp;&amp; &quot;replaceState&quot; in window.history &amp;&amp; window.history.replaceState(opt, null, newurl);
                                        }
                            
                                        return _history;
                                    }
                            
                                    // 获取最后一条记录的某个字段
                                    historyModule.getLast = function (field) {
                                        var last = _history.length - 1;
                                        var lastHistory = _history[last] || {};
                            
                                        if (field) {
                                            return lastHistory[field];
                                        } else {
                                            return lastHistory;
                                        }
                                    }
                            
                                    // 删除指定的index包含之后的历史记录
                                    historyModule.removeNext = function (index) {
                                        var len = _history.length - index;
                                        _history.splice(index, len);
                                        var lastHistory = historyModule.getLast();
                                        var url = window.location.origin + window.location.pathname + &quot;#&quot; + lastHistory.pid;
                                        var newurl = ui.setUrlParams(url, lastHistory.param);
                            
                                        param.syncHistory &amp;&amp; &quot;replaceState&quot; in window.history &amp;&amp; window.history.replaceState(lastHistory[&quot;param&quot;], null, newurl);
                            
                                    }
                                    // 删除最后一条历史记录
                                    historyModule.removeLast = function () {
                                        var len = _history.length - 1;
                                        historyModule.removeNext(len);
                            
                                    }
                            
                                    // 检测有没有历史记录
                                    /*
                                     * 检测有没有当前页面历史记录
                                     *  @method history
                                     *  @since 1.5.4
                                     *  @static
                                     *  @param {string} [页面id,或者url,或者模块id]
                                     *  @example
                            
                                        //  var hasLoadLogin = router.history.check(&quot;pages/login/login.html&quot;);
                            
                                     *
                                     */
                                    historyModule.checkLoad = function (pageid) {
                                        var hasLoad = ui.array.compare(_history, pageid, &quot;pid&quot;) || ui.array.compare(_history, pageid, &quot;url&quot;) || ui.array.compare(_history, pageid, &quot;id&quot;);
                            
                                        return hasLoad;
                                    }
                            
                                    // 缓存模块的操作
                                    // 新增缓存
                                    cacheModule.add = function (key, value) {
                                        _cachePages[key] = value || {};
                            
                                        return _cachePages[key];
                                    }
                                    cacheModule.del = function (key) {
                                        delete _cachePages[key];
                                    }
                                    // 获取缓存
                                    cacheModule.get = function (key, field) {
                            
                                        if (field) {
                                            var mod = _cachePages[key] || {};
                                            return mod[field];
                                        } else {
                                            return _cachePages[key];
                                        }
                                    }
                            
                                    // 保存缓存, 用于页面刷新时
                                    cacheModule.save = function () {
                                        // 如果页面大于1个,才进行存储
                                        if (_history.length &gt; 1) {
                                            var html = $router.html();
                                            uiSessionStorage.set(&quot;cacheHtml&quot;, html);
                                            uiSessionStorage.set(&quot;cacheHistory&quot;, _history);
                                            uiSessionStorage.set(&quot;hasCache&quot;, &quot;true&quot;);
                                        }
                            
                                    }
                            
                                    // 加载缓存, 用于页面刷新时
                                    cacheModule.load = function () {
                                        // console.log(&quot;loading&quot;)
                                        var cacheHtml = uiSessionStorage.get(&quot;cacheHtml&quot;, 0);
                                        var historyCache = uiSessionStorage.get(&quot;cacheHistory&quot;, 0);
                                        var historyCaches = [];
                            
                                        if (historyCache.length &gt; 1) {
                            
                                            // 渲染html, 并切换当前操作的对象
                                            $router.html(cacheHtml);
                                            $routerMain = $router.children(&quot;.bui-router-main&quot;);
                            
                                            var queryparam = ui.history.getHash();
                            
                                            back({
                                                name: queryparam.pid
                                            })
                            
                                            // 把历史记录转成对象,并赋给路由的历史记录
                                            try {
                                                historyCache.forEach(function (item, i) {
                                                    var data = typeof item === &quot;string&quot; ? JSON.parse(item) : item;
                            
                                                    historyCaches.push(data);
                            
                                                })
                            
                                                // 执行最后一个模块
                                                var last = historyCaches[historyCaches.length - 1];
                                                _currentHistory = last;
                                                // 加载最后模块的脚本
                                                loader.require(last[&quot;pid&quot;], function (depend) {
                                                    // 存储页面的回调实例
                                                    _instanceCache[last[&quot;pid&quot;]] = depend || null;
                                                });
                            
                                                // 后退的时候再执行上一个模块,减少缓存加载的时候一次性全部应用
                                                on(&quot;back&quot;, function (mod) {
                                                    // 加载最后模块的脚本
                                                    loader.require(mod.target[&quot;pid&quot;], function (depend) {
                                                        // 存储页面的回调实例
                                                        _instanceCache[mod.target[&quot;pid&quot;]] = depend || null;
                                                    });
                                                })
                                            } catch (e) {
                                                ui.showLog(e);
                                            }
                            
                            
                                            // 赋值新的历史记录
                                            _history = historyCaches;
                            
                                            // 绑定后才能后退
                                            // 切换加载效果
                                            switchNowPage();
                                            // 隐藏上一页
                                            switchPrevPage();
                            
                                            // 不是第一次加载,后退以后再进入才有动画
                                            firstLoad = false;
                                            // 通过物理刷新以后, 下次加载模块,还是需要动画
                                            needAnimate = true;
                                            // 加载成功后清除掉
                                            cacheModule.clear();
                            
                                        }
                            
                                    }
                                    // 加载缓存, 用于页面刷新时
                                    cacheModule.clear = function () {
                            
                                        uiSessionStorage.remove(&quot;cacheHistory&quot;);
                                        uiSessionStorage.remove(&quot;cacheHtml&quot;);
                                        uiSessionStorage.remove(&quot;hasCache&quot;);
                                    }
                            
                            
                                    // 新增日志
                                    logModule.add = function (key, value) {
                                        _log[key] = value || {};
                            
                                        return _log[key];
                                    }
                                    // 获取日志
                                    logModule.get = function (key, field) {
                            
                                        if (field) {
                                            var mod = _log[key] || {};
                                            return mod[field];
                                        } else {
                                            return _log[key];
                                        }
                                    }
                            
                                    /**
                                     * 路由初始化,用于实例化以后的配置参数修改,参数同上
                                     *  @method init
                                     *  @param {object} [option]
                                     *  @chainable
                                     *  @example
                                     *
                                       // 路由初始化, 默认会加载main模块
                                        router.init({
                                            id: &quot;#bui-router&quot;
                                        })
                                     *
                                     */
                            
                                    function init(opt) {
                                        // store 挂载到路由
                                        module.store = opt.store || null;
                            
                                        // 如果有,则先删掉再合并参数
                                        delete opt.store;
                            
                                        opt = $.extend(true, {}, param, ui.config.router, opt);
                            
                            
                                        param = module.config = opt;
                            
                                        var urlparams = ui.history.getParams(&quot;url&quot;);
                                        // 如果有传module参数,自动解析为新页面.
                                        if (urlparams.module &amp;&amp; opt.parseurl) {
                                            var newpage = urlparams.module;
                                            delete urlparams.module;
                                            var newurl = ui.setUrlParams(newpage, urlparams);
                                            window.location.href = window.location.origin + window.location.pathname + &quot;#&quot; + newurl;
                                            return this;
                                        }
                            
                                        // 是单页模式
                                        // ui.hasRouter = true;
                            
                                        // 路由已经初始化
                                        hasRouter = true;
                                        // 如果不等于这个模板则进行修改
                                        // if (opt.indexModule.template !== &quot;pages/main/main.html&quot; || opt.indexModule.script !== &quot;pages/main/main.js&quot;) {
                                        // 修改首页地址
                                        _map = loader.map(opt.indexModule);
                            
                                        // }
                            
                                        // 通过修改的初始化的最后一个历史记录的效果需要一起修改
                                        if (isOption &amp;&amp; &quot;effect&quot; in opt) {
                                            _history.forEach(function (item, i) {
                                                item[&quot;effect&quot;] = opt.effect;
                                            })
                                        }
                                        if (!opt.id) {
                                            ui.showLog(&quot;id 不能为空&quot;, &quot;bui.router.init&quot;);
                                            return false;
                                        }
                                        $router = ui.objId(opt.id);
                            
                                        // 1.8.0
                                        let canInit = opt.beforeInit &amp;&amp; opt.beforeInit.call(module, {
                                            target: $router[0]
                                        });
                            
                                        if (canInit === false) {
                                            return false;
                                        }
                            
                                        // 防止2次点击
                                        uiMask = bui.mask({
                                            appendTo: $router,
                                            opacity: 0,
                                            autoClose: false
                                        });
                                        // 页面加载的进度条
                                        uiLoading = ui.loading(opt.loading);
                            
                                        $routerMain = $router.children(&quot;.bui-router-main&quot;);
                                        // 页面宽高
                                        winWidth = opt.width || window &amp;&amp; window.viewport &amp;&amp; window.viewport.width() || document.documentElement.clientWidth || &quot;100%&quot;;
                                        winHeight = opt.height || window &amp;&amp; window.viewport &amp;&amp; window.viewport.height() || document.documentElement.clientHeight || &quot;100%&quot;;
                            
                                        // 是否动态创建
                                        if (!$routerMain.length) {
                                            // 生成路由的初始化模板
                                            var routerTpl = templateInit(opt);
                                            $router.html(routerTpl);
                            
                                            $routerMain = $router.children(&quot;.bui-router-main&quot;);
                                        } // else {
                                        if (opt.width &gt; 0 || String(opt.width).indexOf(&quot;%&quot;) &gt; -1) {
                                            // 设置宽高
                                            $routerMain.width(opt.width)
                                        }
                                        if (opt.height &gt; 0 || String(opt.height).indexOf(&quot;%&quot;) &gt; -1) {
                                            // 设置宽高
                                            $routerMain.height(opt.height)
                                        }
                                        //}
                            
                                        // 绑定事件
                                        if (!hasEventInit) {
                                            bind(opt);
                                        }
                            
                                        // 存储实例
                                        opt.uid &amp;&amp; ui.history.setUI &amp;&amp; ui.history.setUI({
                                            uid: opt.uid,
                                            ui: module
                                        })
                            
                                        trigger.call(this, &quot;init&quot;, {
                                            target: $router[0]
                                        });
                            
                                        opt.inited &amp;&amp; opt.inited.call(module, {
                                            target: $router[0]
                                        })
                                        return module;
                                    }
                            
                                    /**
                                     * [重新设置路由宽高 ]
                                     * @method resize
                                     * @since  1.5.1
                                     * @example
                            
                                        // 重新设置路由宽高
                                        router.resize();
                            
                                     *
                                     */
                                    function resize(opt) {
                                        var opt = opt || {};
                                        opt.width = opt.width || param.width;
                                        opt.height = opt.height || param.height;
                                        // 获取新的视图
                                        window.viewport = ui.viewport();
                                        // 页面宽高 100% 有可能得到少去键盘的高度
                                        winWidth = opt.width || window &amp;&amp; window.viewport &amp;&amp; window.viewport.width() || document.documentElement.clientWidth || &quot;100%&quot;;
                                        winHeight = opt.height || window &amp;&amp; window.viewport &amp;&amp; window.viewport.height() || document.documentElement.clientHeight || &quot;100%&quot;;
                            
                                        // 设置宽高
                                        $routerMain.css({
                                            width: winWidth,
                                            height: winHeight
                                        })
                            
                                        trigger.call(this, &quot;resize&quot;, {
                                            target: _history[(_history.length - 1)]
                                        });
                                        return this;
                                    }
                            
                                    // 路由准备以后加载
                                    function readyLoad(opt) {
                                        var hasCache = uiSessionStorage.get(&quot;hasCache&quot;, 0);
                            
                                        // 如果是刷新并且有保存则加载缓存
                                        if (Boolean(hasCache) &amp;&amp; param.reloadCache) {
                                            cacheModule.load();
                                        } else {
                            
                                            loadUrl(opt);
                                        }
                                        // 路由已经初始化
                                        hasReady = true;
                                    }
                            
                                    function offSwipe() {
                                        $router.off(&quot;touchstart&quot;, &quot;.bui-router-item&quot;);
                                        $router.off(&quot;touchmove&quot;, &quot;.bui-router-item&quot;);
                                        $router.off(&quot;touchend&quot;, &quot;.bui-router-item&quot;);
                                    }
                                    // 允许滑动
                                    function swipe(opt) {
                            
                                        //针对手势滑动的处理
                                        var isTouchPad = (/hp-tablet/gi).test(navigator.appVersion),
                                            hasTouch = &#x27;ontouchstart&#x27; in window &amp;&amp; !isTouchPad,
                                            direction = &quot;&quot;,
                                            deltaX = 0,
                                            deltaY = 0,
                                            isTouchstart = false, //解决PC一直触发mousemove事件
                                            hasScroll = false,
                                            $target = null,
                                            $prevTarget = null,
                                            touch = {
                                                x1: 0,
                                                x2: 0,
                                                y1: 0,
                                                y2: 0,
                                                direction: &quot;&quot;
                                            };
                            
                                        $router.on(&quot;touchstart&quot;, function (e) {
                                            var targetTouches = e.originalEvent &amp;&amp; e.originalEvent.targetTouches || e.targetTouches;
                                            var point = hasTouch ? targetTouches[0] : e;
                                            touch.x1 = point.pageX;
                                            touch.y1 = point.pageY;
                                            hasScroll = $(e.target).closest(param.useScroll).length;
                            
                                            // 有历史记录, 且起始点的位置在靠近左边才会允许拖动
                                            if (_history.length &gt; 1 &amp;&amp; (touch.x1 &gt; 0 &amp;&amp; touch.x1 &lt; opt.distance)) {
                                                $target = $(&#x60;#${historyModule.getLast().id}&#x60;)
                                                $prevTarget = ui.history.getPrev().id ? $(&#x60;#${ui.history.getPrev().id}&#x60;) : null;
                                            }
                            
                                        })
                            
                                        $router.on(&quot;touchmove&quot;, function (e) {
                            
                                            var targetTouches = e.originalEvent &amp;&amp; e.originalEvent.targetTouches || e.targetTouches;
                                            var point = hasTouch ? targetTouches[0] : e;
                                            touch.x2 = point.pageX;
                                            touch.y2 = point.pageY;
                                            //当屏幕有多个touch或者页面被缩放过，就不执行move操作
                                            if (targetTouches.length &gt; 1 || e.scale &amp;&amp; e.scale !== 1) {
                                                return;
                                            }
                            
                                            // 防止滚动条等于0的时候也会触发uc
                                            hasScroll = $(e.target).closest(param.useScroll).length;
                            
                                            // 有滚动条就滚动优先
                                            if ((touch.x2 - touch.x1) &gt; 0 &amp;&amp; !hasScroll) {
                                                e.preventDefault();
                                            }
                                            //第一次下拉的方向
                                            if (!touch.direction) {
                                                //方向
                                                touch.direction = ui.swipeDirection(touch.x1, touch.x2, touch.y1, touch.y2);
                                            }
                                            //阻止默认事件,除了滚动条,解决红米不触发end问题
                                            if (touch.direction === &quot;swipeleft&quot; || touch.direction === &quot;swiperight&quot;) {
                                                e.preventDefault();
                                                // 滑动过程中只对左右做冒泡处理, 如果上下也处理,会影响到 pullrefresh
                                                e.stopPropagation();
                                            }
                                            deltaX = Math.abs(touch.x2 - touch.x1);
                                            deltaY = Math.abs(touch.y2 - touch.y1);
                            
                                            //滑动超出10, 在0-50的开始位置,往右滑动10以后看到效果
                                            if (touch.direction === &quot;swiperight&quot; &amp;&amp; deltaX &gt; opt.startDistance &amp;&amp; opt.swipeBack) {
                            
                                                $prevTarget &amp;&amp; $prevTarget.css(&quot;display&quot;, &quot;block&quot;);
                                                opt.pageMove &amp;&amp; $target &amp;&amp; $target.css(&quot;transform&quot;, &#x60;translateX(${deltaX}px)&#x60;);
                                                e.preventDefault();
                                            }
                            
                                        })
                                        $router.on(&quot;touchend&quot;, function (e) {
                                            hasScroll = $(e.target).closest(param.useScroll).length;
                                            if (touch.direction === &quot;swiperight&quot; &amp;&amp; touch.x1 &gt; opt.distance &amp;&amp; opt.swipeBack) {
                                                deltaX = 0;
                                            }
                                            if (touch.direction === &quot;swiperight&quot; &amp;&amp; deltaX &gt; opt.swipeDistance) {
                                                var canBack = opt.onBeforeSwipeRight &amp;&amp; opt.onBeforeSwipeRight();
                            
                                                canBack !== false &amp;&amp; opt.swipeBack &amp;&amp; ui.back({
                                                    effect: param.backEffect || &quot;none&quot;
                                                });
                                                opt.onSwipeRight &amp;&amp; opt.onSwipeRight(e);
                                                trigger.call(module, &quot;swiperight&quot;);
                                            }
                                            if (touch.direction === &quot;swipeleft&quot; &amp;&amp; deltaX &gt; opt.swipeDistance) {
                                                opt.onSwipeLeft &amp;&amp; opt.onSwipeLeft(e);
                                                trigger.call(module, &quot;swipeleft&quot;);
                                            }
                                            if (touch.direction === &quot;swipeup&quot; &amp;&amp; deltaY &gt; opt.swipeDistance &amp;&amp; !hasScroll) {
                                                opt.onSwipeUp &amp;&amp; opt.onSwipeUp(e);
                                                trigger.call(module, &quot;swipeup&quot;);
                                            }
                                            if (touch.direction === &quot;swipedown&quot; &amp;&amp; deltaY &gt; opt.swipeDistance &amp;&amp; !hasScroll) {
                                                opt.onSwipeDown &amp;&amp; opt.onSwipeDown(e);
                                                trigger.call(module, &quot;swipedown&quot;);
                                            }
                                            if (deltaX &lt; opt.swipeDistance) {
                                                $prevTarget &amp;&amp; $prevTarget.css(&quot;display&quot;, &quot;none&quot;);
                                                $target &amp;&amp; $target.css(&quot;transform&quot;, &#x60;translateX(0)&#x60;);
                                                // opt.onSwipeCancel &amp;&amp; opt.onSwipeCancel();
                                                // trigger.call(module, &quot;swipecancel&quot;);
                                            }
                                            deltaX = 0;
                                            hasScroll = false;
                                            isTouchstart = false;
                                            touch = {
                                                x1: 0,
                                                x2: 0,
                                                y1: 0,
                                                y2: 0,
                                                direction: &quot;&quot;
                                            }
                                            $target = null;
                                            $prevTarget = null;
                            
                                            e.stopPropagation();
                                            // e.preventDefault();
                                        })
                                    }
                                    // 绑定加载事件
                                    function bind(opt) {
                                        // 禁止UC的手势滑动, 无效
                                        // if (navigator.control &amp;&amp; navigator.control.gesture) {
                                        //     navigator.control.gesture(false);
                                        // }
                                        //页面加载
                                        // bui-ready 里面会比 load 慢,所以需要在pageready 里面监听处理
                                        // isWebapp = false 原生
                                        // if (!ui.isWebapp) {
                                        // 原生需要在pageready里面执行
                                        // ui.on(&quot;pageready&quot;, function() {
                            
                                        readyLoad(opt);
                                        // })
                            
                                        // } else {
                                        // webapp 在dom 加载便可以解析
                                        // window.addEventListener(&quot;DOMContentLoaded&quot;, function() {
                                        // readyLoad();
                                        // }, false)
                                        // }
                                        // 关掉滑动
                                        // offSwipe();
                                        // 允许滑动
                                        opt.swipe &amp;&amp; swipe(opt);
                            
                                        // 允许刷新的时候有路由缓存
                                        // if( param.reloadCache ){
                                        // 保存历史记录
                                        window.addEventListener(&quot;beforeunload&quot;, function (event) {
                            
                                            // 保存历史记录();
                                            param.reloadCache &amp;&amp; cacheModule.save();
                                            // 监听地址栏离开
                                            trigger.call(_self, &quot;beforeunload&quot;, {
                                                target: _history[(_history.length - 1)]
                                            });
                                            // 这句会弹出提醒
                                            // event.returnValue = &quot;离开将不会保存历史记录&quot;;
                                        });
                                        // }
                            
                                        // 针对hash跳转,没有动画
                                        if (opt.hash) {
                                            window.addEventListener(&#x27;hashchange&#x27;, function (event) {
                            
                                                // 拿到的是已经跳转的上一个页面
                                                // var lastPid = _history[_history.length - 1][&quot;pid&quot;];
                                                var params = ui.history.getHash(),
                                                    pid = (params.pid == &#x27;&#x27; || params.pid == &#x27;undefined&#x27;) ? (params.errorPage || &#x27;main&#x27;) : params.pid,
                                                    // 返回所有相同页面的索引
                                                    indexs = ui.array.indexs(_history, pid, &#x27;pid&#x27;),
                                                    lastIndex = indexs[indexs.length - 1],
                                                    // index = indexs.length &gt; 1 || lastPid == pid ? lastIndex : lastIndex - 1;
                                                    index = lastIndex;
                            
                                                // 如果是微信重置模块，应该跳转到首页，而不是出错页面
                                                pid = params.pid == &#x27;wechat_redirect&#x27; ? &#x27;main&#x27; : pid;
                                                var backEffect = sessionStorage.getItem(&quot;backEffect&quot;) || &quot;&quot;;
                            
                                                if (index &gt; -1) {
                            
                                                    back({
                                                        index: -((_history.length - index - 1) || 1),
                                                        backEffect: backEffect,
                                                    });
                                                    trigger.call(_self, &quot;popstate&quot;, {
                                                        type: &quot;back&quot;,
                                                        prevTarget: _history[index - 1],
                                                        target: _history[index]
                                                    });
                                                } else {
                            
                                                    load({
                                                        url: pid,
                                                        param: params.param,
                                                        iframe: params.param.iframe == &quot;true&quot; ? true : false,
                                                        replace: true
                                                    })
                                                    trigger.call(_self, &quot;popstate&quot;, {
                                                        type: &quot;load&quot;,
                                                        prevTarget: _history[_history.length - 2],
                                                        target: _history[_history.length - 1]
                                                    });
                                                }
                                            })
                            
                                            return this;
                                        }
                            
                                        // 兼容手机的后退按钮,只做后退,不做前进处理
                                        if (opt.syncHistory &amp;&amp; &quot;pushState&quot; in window.history) {
                                            window.addEventListener(&quot;popstate&quot;, function (e) {
                                                // 获取网址参数
                                                var params = ui.history.getHash(),
                                                    pid = params.pid == &quot;&quot; ? param.indexModule.moduleName : params.pid,
                                                    index = getBackNearIndex(pid),
                                                    historyIndex = ui.array.index(_history, pid, &quot;pid&quot;);
                            
                                                if (historyIndex &gt; -1) {
                                                    var backEffect = sessionStorage.getItem(&quot;backEffect&quot;);
                            
                                                    if (backEffect) {
                            
                                                        back({
                                                            index: index,
                                                            param: params.param,
                                                            effect: backEffect
                                                        });
                                                    } else {
                            
                                                        back({
                                                            index: index,
                                                            param: params.param
                                                        });
                                                    }
                            
                                                    sessionStorage.removeItem(&quot;backEffect&quot;);
                            
                                                    // 监听地址栏修改
                                                    trigger.call(_self, &quot;popstate&quot;, {
                                                        type: &quot;back&quot;,
                                                        prevTarget: _history[index - 1],
                                                        target: _history[index]
                                                    });
                                                } else {
                                                    load({
                                                        url: pid,
                                                        param: params.param,
                                                        iframe: params.param.iframe == &quot;true&quot; ? true : false
                                                    })
                                                    // 监听地址栏修改
                                                    trigger.call(_self, &quot;popstate&quot;, {
                                                        type: &quot;load&quot;,
                                                        prevTarget: _history[_history.length - 2],
                                                        target: _history[_history.length - 1]
                                                    });
                                                }
                                            })
                                        }
                            
                                        // 只在第一次加载的时候会触发
                                        // window.onpageshow=function(e){
                                        //     var a=e||window.event;
                                        //     if(a.persisted){
                                        //         window.location.refresh();
                                        //     }
                                        // }
                            
                            
                                        return this;
                                    }
                            
                                    // 加载默认页面, 默认返回路由首页
                                    function loadDefault(errorpage) {
                            
                                        var url = window.location.href,
                                            index = url.indexOf(param.hashPrefix),
                                            index = index &gt; -1 ? index : 0,
                                            newUrl = index &gt; -1 ? url.substr(0, (index)) : url;
                            
                                        // window.location.href = param.errorPage || newUrl;
                                        load({
                                            url: param.errorPage || newUrl,
                                            param: {
                                                error: errorpage
                                            }
                                        })
                            
                                        trigger.call(module, &quot;error&quot;, {
                                            target: errorpage,
                                            status: 404
                                        });
                                    }
                                    // 页面加载,默认是main
                                    function loadUrl(opt) {
                            
                                        try {
                            
                                            var params = ui.history.getHash();
                            
                                            if (params.pid) {
                                                // http 地址则认为是iframe模块
                                                if (params.pid.indexOf(&quot;http://&quot;) &gt; -1 || params.pid.indexOf(&quot;https://&quot;) &gt; -1) {
                                                    // 页面跳转
                                                    params.param.iframe = true;
                                                    load({
                                                        url: params.pid,
                                                        param: params.param,
                                                        iframe: true
                                                    });
                            
                                                    return;
                                                }
                                                // 页面跳转
                                                load({
                                                    url: params.pid,
                                                    param: params.param
                                                });
                            
                                            } else {
                                                // 加载默认页面
                                                load({
                                                    url: param.indexModule.moduleName,
                                                    param: params.param || {},
                                                });
                                            }
                            
                                        } catch (e) {
                                            ui.showLog(e, &quot;bui.router.loadUrl&quot;)
                                        }
                                    }
                            
                                    /**
                                     * [预加载页面及资源,webapp预加载有助于网络较慢时,或者网络不通时,点击无法跳转响应等问题. ]
                                     * @method preload
                                     * @since  1.4.2
                                     * @param  {object|array} option [description]
                                     * @param  {string} option.url [缓存的模板地址,会自动缓存模板对应的脚本文件]
                                     * @param  {string|array} [option.style] 非必须,缓存样式文件
                                     * @param  {string|array} [option.script] 非必须,缓存脚本文件,跟模板同名以外的脚本
                                     * @return {object}        [ 返回一个 Deferred 对象 ]
                                     * @example
                            
                                        // 预加载一个页面
                                        router.preload({ url: &quot;pages/page2/page2.html &quot; });
                            
                                        // 预加载多个页面
                                        router.preload([{
                                            url: &quot;pages/about/index.html&quot;
                                          },{
                                            url: &quot;pages/router/index.html&quot;
                                        }]).then(function () {
                                            // 全部加载以后执行
                                        })
                            
                            
                                     *
                                     */
                                    function preload(option) {
                            
                                        var def = $.Deferred();
                                        // 请求一个
                                        var requestOne = function (opt, callback) {
                                            // 请求地址
                                            requestUrl(opt.url, function (res) {
                                                var gid = ui.guid(),
                                                    urlObj = resolveUrl(opt.url),
                                                    pageid = urlObj.pid,
                                                    resp = templatePage({
                                                        id: gid,
                                                        content: res,
                                                        pid: pageid
                                                    });
                                                var depends = [];
                            
                                                // 缓存模板
                                                cacheModule.add(pageid, {
                                                    id: gid,
                                                    pid: pageid,
                                                    template: res
                                                });
                                                // 缓存脚本
                                                depends.push(pageid);
                            
                                                // 加载样式
                                                if (opt.style &amp;&amp; ui.typeof(opt.style) === &quot;array&quot;) {
                                                    opt.style.forEach(function (item, i) {
                                                        depends.push(item);
                                                    })
                            
                                                } else if (opt.style &amp;&amp; ui.typeof(opt.style) === &quot;string&quot;) {
                                                    depends.push(opt.style);
                                                }
                                                // 加载js
                                                if (opt.script &amp;&amp; ui.typeof(opt.script) === &quot;array&quot;) {
                                                    opt.script.forEach(function (item, i) {
                                                        depends.push(item);
                                                    })
                                                } else if (opt.script &amp;&amp; ui.typeof(opt.script) === &quot;string&quot;) {
                                                    depends.push(opt.script);
                                                }
                                                // 缓存资源,不管成功失败都执行
                                                loader.import(depends, function () {
                                                    trigger.call(module, &quot;preloadafter&quot;, {
                                                        prevTarget: null,
                                                        target: null
                                                    });
                                                    callback &amp;&amp; callback(option);
                                                }, function () {
                                                    trigger.call(module, &quot;preloadafter&quot;, {
                                                        prevTarget: null,
                                                        target: null
                                                    });
                                                    callback &amp;&amp; callback(option);
                                                });
                            
                                            }, function (res) {
                                                ui.showLog(opt.url + &quot;请求失败&quot;);
                            
                                                def.reject(opt.url);
                                            })
                            
                                            return def.promise();
                                        }
                                        if (option &amp;&amp; ui.typeof(option) === &quot;object&quot;) {
                            
                                            (&quot;url&quot; in option) &amp;&amp; requestOne(option, function () {
                                                def.resolve(option);
                                            });
                            
                                        } else if (option &amp;&amp; ui.typeof(option) === &quot;array&quot;) {
                            
                                            option.forEach(function (item, i) {
                                                var last = option.length - 1;
                                                if (i == last) {
                                                    (&quot;url&quot; in item) &amp;&amp; requestOne(item, function () {
                                                        def.resolve(option);
                                                    });
                            
                                                } else {
                                                    (&quot;url&quot; in item) &amp;&amp; requestOne(item);
                                                }
                                            })
                                        }
                            
                                        return def;
                                    }
                            
                                    /**
                                     * 页面跳转, 也支持定义好的模块跳转, 保持跟 bui.load一致
                                     *  @method load
                                     *  @param {object} [option]
                                     *  @param {string} option.url [页面跳转的地址,支持两种跳转方式, 一种是直接输入跳转的完整地址,一种是通过map方法注册页面key值,都要保持唯一]
                                     *  @param {object} option.param [传过去新页面的参数]
                                     *  @param {boolean} option.firstAnimate [是否动画优先，跳转的页面如果有很多接口及渲染，可以开启，优先跳转再请求 默认 false | true]
                                     *  @param {boolean} option.replace [是否是替换当前页面]
                                     *  @param {boolean} option.autoInit [1.5.2 默认是true, 自动计算 main 的高度, 如果跳转的页面有list,或者tab, 就可以不需要自动初始化]
                                     *  @param {boolean} option.iframe [1.4.2新增支持iframe加载外部html]
                                     *  @param {boolean} option.callback [1.4.6新增, 跳转后的回调]
                                     *  @param {function||boolean} [option.beforeLoad] 1.5.1默认: null 跳转前触发, 如果全局有,默认使用全局判断, 返回true 则忽略全局判断. 
                                     *  @chainable
                                     *  @example
                            
                            
                                      // 方法: 模块名为: pages/page2/page2
                            
                                        router.load({ url: &quot;pages/page2/page2.html&quot;, param: {} });
                            
                                     *
                                     */
                            
                                    function load(option) {
                                        var config = {
                                            id: &quot;&quot;,
                                            url: &quot;&quot;,
                                            param: {},
                                            effect: &quot;&quot;,
                                            command: &quot;html&quot;,
                                            path: param.path,
                                            repairPath: param.repairPath,
                                            firstAnimate: param.firstAnimate,
                                            progress: param.progress,
                                            reload: param.reload,
                                            autoInit: param.autoInit,
                                            needView: param.needView,
                                            needComponent: param.needComponent,
                                            syncHistory: param.syncHistory,
                                            replace: false,
                                            iframe: false,
                                            decode: false,
                                            part: false,
                                            cache: param.cache,
                                            callback: null,
                                            beforeShow: null,
                                            showed: null,
                                            beforeHide: null,
                                            hided: null,
                                            beforeLoad: null,
                                            loaded: null,
                                        }
                            
                                        var opt = $.extend(true, {}, config, option);
                                        var def = $.Deferred();
                            
                                        opt.beforeLoad = function (e) {
                                            let status = param.beforeLoad &amp;&amp; param.beforeLoad.call(this, e);
                                            let statusSingle = option.beforeLoad &amp;&amp; option.beforeLoad.call(this, e);
                            
                                            trigger.call(this, &quot;beforeload&quot;, e);
                                            // 兼容旧版
                                            trigger.call(this, &quot;loadbefore&quot;, e);
                                            return status &amp;&amp; statusSingle;
                                        }
                                        opt.loaded = function (e) {
                                            param.loaded &amp;&amp; param.loaded.call(this, e);
                                            option.loaded &amp;&amp; option.loaded.call(this, e);
                            
                                            trigger.call(this, &quot;loaded&quot;, e);
                                        }
                                        opt.beforeHide = function (e) {
                                            let status = param.beforeHide &amp;&amp; param.beforeHide.call(this, e);
                                            let statusSingle = option.beforeHide &amp;&amp; option.beforeHide.call(this, e);
                            
                                            trigger.call(this, &quot;beforehide&quot;, e);
                                            return status &amp;&amp; statusSingle;
                                        }
                                        opt.hided = function (e) {
                                            param.hided &amp;&amp; param.hided.call(this, e);
                                            option.hided &amp;&amp; option.hided.call(this, e);
                            
                                            trigger.call(this, &quot;hided&quot;, e);
                                        }
                                        opt.beforeShow = function (e) {
                                            let status = param.beforeShow &amp;&amp; param.beforeShow.call(this, e);
                                            let statusSingle = option.beforeShow &amp;&amp; option.beforeShow.call(this, e);
                            
                                            trigger.call(this, &quot;beforeshow&quot;, e);
                                            return status &amp;&amp; statusSingle;
                                        }
                                        opt.showed = function (e) {
                                            param.showed &amp;&amp; param.showed.call(this, e);
                                            option.showed &amp;&amp; option.showed.call(this, e);
                            
                                            trigger.call(this, &quot;showed&quot;, e);
                                        }
                            
                                        // 直接取当前页面的id
                                        var prevCurrentId = $routerMain.attr(&quot;data-main&quot;);
                                        // 上一个历史记录
                                        var prevHistory = historyModule.getLast() || null;
                            
                                        // if (curHisory &amp;&amp; (curHisory.id !== prevHistory.id)) {
                                        //     document.getElementById(curHisory.id).style.display = &quot;none&quot;;
                                        // }
                            
                                        var prevPrevHistory = _history[_history.length - 2] || null;
                            
                                        // 解析相对路径
                                        if (opt.url.indexOf(&quot;./&quot;) &gt; -1) {
                                            opt.url = resolvePath(opt.url, prevHistory);
                                        }
                                        // 暂不对第一个 / 处理
                                        if (opt.repairPath &amp;&amp; opt.url.indexOf(&quot;/&quot;) === 0) {
                                            // 把根路径写法改成相对根路径
                                            opt.url = opt.url.substr(1);
                                        }
                            
                                        // 最后的路径是否有 /
                                        if (opt.path) {
                                            opt.path = opt.path[opt.path.length - 1] == &quot;/&quot; ? opt.path : opt.path + &quot;/&quot;;
                                        }
                                        // 加上前面公共路径,如果先通过map配置的模块,则不管根路径
                                        opt.url = opt.url in _modulesMap || opt.iframe || opt.url.indexOf(&quot;http:&quot;) &gt; -1 ? opt.url : opt.path + opt.url;
                            
                                        // 取消手机的键盘,防止键盘占位
                                        document.activeElement.blur();
                            
                            
                                        var _self = this,
                                            // 传过来的参数
                                            queryParam = null,
                                            // url自带参数
                                            hrefParam = {};
                                        // 每个页面对应唯一id
                                        opt.id = (opt.id &amp;&amp; opt.id.indexOf(&quot;#&quot;) &gt; -1 ? opt.id.substr(1) : opt.id) || &quot;&quot;;
                                        var gid = opt.replace || opt.part ? prevHistory.id : opt.id || ui.guid(),
                                            $id = ui.objId(gid);
                            
                                        if (!opt.url) {
                                            ui.showLog(&quot;url 不能为空&quot;, &quot;bui.router.load&quot;)
                                            return def.promise();
                                        }
                            
                                        opt.url = opt.decode ? decodeURIComponent(opt.url) : opt.url;
                            
                                        // 使用外部打开
                                        if (opt.url.indexOf(&quot;tel:&quot;) &gt;= 0 || opt.url.indexOf(&quot;mailto:&quot;) &gt;= 0 || opt.url.indexOf(&quot;sms:&quot;) &gt;= 0) {
                                            ui.unit.openExtral(opt.url);
                                            return def.promise();
                                        }
                            
                                        // 解析url参数
                                        if (opt.url &amp;&amp; opt.url.indexOf(&quot;?&quot;) &gt; -1) {
                                            var paramArr = opt.url.split(&quot;?&quot;);
                                            hrefParam = ui.unit.keyStringToObject(paramArr[1]);
                                            opt.url = paramArr[0];
                                        }
                            
                                        // 合并参数
                                        queryParam = $.extend(true, {}, hrefParam, opt.param);
                            
                                        // 把布尔值转
                                        queryParam = ui.unit.changeParamBoolean(queryParam);
                            
                                        // 如果找不到页面,变成首页
                                        // 如果是微信的重置模块，跳转到main
                                        if (opt.url == &quot;wechat_redirect&quot;) {
                                            opt.url = &quot;main&quot;;
                                        } else if (opt.url == &quot;undefined&quot;) {
                                            opt.url = param.errorPage || &quot;main&quot;;
                                        }
                            
                                        opt.iframe == queryParam.iframe &amp;&amp; queryParam.iframe.toString() == &quot;true&quot; ? true : false;
                            
                                        // 解析url地址
                                        var urlObj = resolveUrl(opt.url),
                                            pageid = urlObj.pid || params.errorPage || &quot;main&quot;,
                                            // 如果是iframe, url 应该等于 http://
                                            url = opt.iframe ? opt.url : urlObj.url,
                                            // npm run package 以后是同步，需要通过loader.get(pageid).script 获取路径解析，npm run build 是异步，
                                            newurl = typeof url === &quot;string&quot; ? url : loader.get(pageid).script || opt.url,
                                            path = newurl.substr(0, newurl.lastIndexOf(&quot;/&quot;) + 1),
                                            // 记录在历史记录里面
                                            pageHistory = {
                                                id: gid,
                                                pid: pageid,
                                                name: pageid,
                                                url: typeof url === &quot;function&quot; ? opt.url : url,
                                                path: path,
                                                replace: opt.replace,
                                                param: queryParam,
                                                component: {},
                                                page: {},
                                                part: {},
                                                ui: {},
                                                toggle: null,
                                                exports: {},
                                                effect: option.effect || param.effect,
                                                syncHistory: opt.syncHistory,
                                            };
                            
                            
                                        // var curHisory = ui.history.getCurrent() || null;
                                        // 第一次跳转不触发
                                        if (!firstLoad) {
                            
                                            var canhide = opt.beforeHide &amp;&amp; opt.beforeHide.call(module, {
                                                type: &quot;load&quot;,
                                                prevTarget: prevHistory,
                                                target: prevHistory
                                            });
                            
                                            if (canhide === false) {
                                                return false;
                                            }
                                        }
                            
                            
                                        var canGoing = handleGet[pageid] &amp;&amp; handleGet[pageid][&quot;beforeLoad&quot;] &amp;&amp; handleGet[pageid][&quot;beforeLoad&quot;]({
                                            type: &quot;load&quot;,
                                            prevTarget: prevHistory,
                                            target: pageHistory
                                        })
                            
                                        // 不允许跳转
                                        if (canGoing === false) {
                                            firstLoad = false;
                            
                                            return this;
                                        }
                            
                            
                                        // 如果有存在提前加载函数,则进行判断,返回false 则不允许跳转.
                                        var canLoad = typeof opt.beforeLoad === &quot;function&quot; ? opt.beforeLoad.call(module, {
                                            type: &quot;load&quot;,
                                            prevTarget: prevHistory,
                                            target: pageHistory
                                        }) : opt.beforeLoad;
                            
                            
                                        // 不允许跳转
                                        if (canLoad === false) {
                                            firstLoad = false;
                            
                                            return this;
                                        }
                                        // 如果是局部加载,拿上一个页面的历史记录
                                        _currentPage = opt.part ? prevHistory : pageHistory;
                            
                            
                                        // 开启进度条,遮罩是为了防止快速多次点击
                                        uiMask &amp;&amp; uiMask.show();
                                        opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.show();
                            
                                        // 把页面的id 放到模块里用,便于跟vuejs 结合.
                                        loader.map({
                                            moduleName: pageid,
                                            path: path,
                                            id: gid
                                        })
                            
                                        // 模块的自身的生命周期,只在第2次执行,但无法阻止路由跳转
                                        var currentModule = loader.get(pageHistory.pid);
                                        // currentModule &amp;&amp; currentModule.beforeLoad &amp;&amp; currentModule.beforeLoad();
                            
                                        // 如果有单独传页面加载效果,需要修改上一个页面的效果
                                        if (_history.length &amp;&amp; opt.effect) {
                                            var lastHistoryIndex = _history.length - 1;
                                            _history[lastHistoryIndex][&quot;effect&quot;] = opt.effect;
                                        }
                            
                                        // 增加历史记录,除了刷新,跟替换
                                        !isRefresh &amp;&amp; !opt.part &amp;&amp; !opt.replace &amp;&amp; historyModule.add(pageHistory);
                                        // 替换历史记录
                                        opt.replace &amp;&amp; historyModule.replace(pageHistory);
                            
                                        // 最后一个历史记录
                                        var lastHistory = pageHistory;
                            
                            
                                        // 存储当前页面的局部模块信息
                                        if (opt.part) {
                                            // lastHistory[&quot;part&quot;] &amp;&amp; (lastHistory[&quot;part&quot;][gid] = {
                                            //     id: gid,
                                            //     pid: pageid,
                                            //     url: url,
                                            //     param: queryParam
                                            // })
                                            // 挂载组件参数
                                            ui.history.setComponent({
                                                id: gid,
                                                pid: pageid,
                                                url: url,
                                                param: queryParam
                                            })
                            
                                            // 给历史记录增加当前激活的id, 用于getPartParams  的id
                                            lastHistory.currentComponent = gid;
                            
                                            // 替换历史记录
                                            _history.splice((_history.length - 1), 1, lastHistory);
                                        }
                            
                                        if (!opt.part) {
                                            // 获取最后一个模块的历史,除了局部加载
                                            _currentHistory = pageHistory;
                                        }
                            
                                        // 如果有缓存,优先使用缓存
                                        if (_cachePages[pageid]) {
                            
                                            // 加载缓存
                                            loadCache({
                                                pid: pageid,
                                                progress: opt.progress,
                                                part: opt.part,
                                                firstAnimate: opt.firstAnimate
                                            })
                            
                                            // lastHistory[&quot;exports&quot;] = _instanceCache[pageid];
                            
                            
                                            // 编译组件
                                            param.needComponent &amp;&amp; loader.components();
                            
                                            if (!opt.firstAnimate) {
                            
                                                // 先执行公共,再执行单独的模块
                                                opt.loaded &amp;&amp; opt.loaded({
                                                    type: &quot;load&quot;,
                                                    prevTarget: prevHistory,
                                                    target: pageHistory
                                                });
                            
                                                opt.callback &amp;&amp; opt.callback({
                                                    type: &quot;load&quot;,
                                                    prevTarget: prevHistory,
                                                    target: pageHistory
                                                });
                            
                                                handleGet[pageid] &amp;&amp; handleGet[pageid][&quot;loaded&quot;] &amp;&amp; handleGet[pageid][&quot;loaded&quot;]({
                                                    prevTarget: prevHistory,
                                                    target: pageHistory
                                                })
                            
                                            }
                            
                                            // 触发complete事件
                                            trigger.call(module, &quot;complete&quot;, {
                                                type: &quot;load&quot;,
                                                prevTarget: prevHistory,
                                                target: pageHistory
                                            });
                                            // 移除占位
                                            $nowPage.removeClass(&quot;bui-router-placeholder&quot;);
                            
                                        } else {
                                            // iframe 加载,页面比较轻,不加载到页面缓存
                                            if (opt.iframe) {
                            
                                                // 加载iframe
                                                loadIframe({
                                                    id: gid,
                                                    pid: pageid,
                                                    url: opt.url,
                                                    param: queryParam
                                                })
                                                return def.promise();
                                            }
                            
                                            // 局部加载
                                            if (opt.part) {
                                                loadPagePart();
                                                // 不再继续执行
                                                return def.promise();
                                            }
                            
                                            // 在动画前加载数据
                                            loadBeforeAnmate();
                                        }
                            
                                        // 加载新页面
                                        function loadBeforeAnmate() {
                            
                                            // 异步加载页面
                                            requestUrl(url, function (res, status, xhr) {
                            
                                                // console.log(typeof res)
                                                // 文件找不到还是会进入到 success, 只是返回的内容为空对象
                                                if (typeof res === &quot;object&quot;) {
                            
                                                    requestFail(url, res, status, xhr)
                            
                                                    return false;
                                                }
                            
                                                // 切换加载的模板
                                                var resp = switchLoadTemplate(res);
                            
                                                // 增加缓存
                                                if (opt.cache) {
                                                    cacheModule.add(pageid, {
                                                        id: gid,
                                                        pid: pageid,
                                                        template: res
                                                    })
                                                }
                            
                                                // 初始化main高度
                                                autoInitMain();
                            
                                                // 能不能切换动画及页面加载
                                                var canshow = opt.beforeShow &amp;&amp; opt.beforeShow.call(module, {
                                                    type: &quot;load&quot;,
                                                    prevTarget: prevHistory,
                                                    target: pageHistory
                                                });
                            
                                                if (canshow === false) {
                                                    return false;
                                                }
                            
                                                // 动画优先
                                                if (opt.firstAnimate) {
                            
                                                    // 执行动画
                                                    doAnimate(function () {
                            
                                                        // 加载模块
                                                        requireModule(triggerEvent);
                                                        // 触发事件
                                                        // triggerEvent();
                            
                                                        opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                                        // 新增操作日志
                                                        logModule.add(pageid, {
                                                            id: gid,
                                                            pid: pageid,
                                                            param: queryParam
                                                        });
                                                    });
                            
                                                    return;
                                                }
                            
                                                // 执行动画
                                                doAnimate(function () {
                                                    opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                                });
                            
                            
                                                // 加载模块
                                                requireModule(triggerEvent);
                                                // 触发事件
                                                // triggerEvent();
                            
                                                // 新增操作日志
                                                logModule.add(pageid, {
                                                    id: gid,
                                                    pid: pageid,
                                                    param: queryParam
                                                });
                            
                            
                                            }, function (res, status, xhr) {
                            
                                                requestFail(url, res, status, xhr);
                            
                                                trigger.call(module, &quot;loadfail&quot;, res, status, xhr);
                                            })
                                        }
                            
                                        // 请求失败
                                        function requestFail(url, res, status, xhr) {
                            
                                            uiMask &amp;&amp; uiMask.hide();
                                            // 跳转默认页面
                                            opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                            
                                            // 删除最后一条记录,没网络的时候,会导致历史记录新增,需要删除
                                            historyModule.removeLast();
                            
                                            // 后退浏览器的历史, 上面只是删除替换, 删除记录跟跳转错误页面会出现冲突
                                            // param.syncHistory &amp;&amp; window.history.back();
                            
                                            def.reject(url);
                            
                                            if (typeof res === &quot;object&quot;) {
                                                ui.showLog(&quot;找不到页面&quot; + url, &quot;bui.router.load&quot;);
                            
                                                switch (window.location.protocol) {
                                                    case &#x27;file:&#x27;:
                                                        ui.hasRouter &amp;&amp; ui.showLog(&quot;PC调试预览单页时，需要开启跨域的Chrome，或使用部署站点才能访问，具体请查看官网调试章节&quot;);
                                                        break;
                                                    case &#x27;http:&#x27;:
                                                    case &#x27;https:&#x27;:
                                                        ui.showLog(&quot;请检查下网络是否正常&quot;);
                                                        break;
                                                }
                            
                                                param.errorPage &amp;&amp; loadErrorPage(url);
                            
                                                return false;
                                            }
                            
                                        }
                                        // 加载模块
                                        function requireModule(callback) {
                                            // 如果没有缓存切不是刷新,则创建脚本
                                            // 1.6.6 新增模块选择器，应对tab的新增，比router.$ 查找范围更小
                                            loader.set(pageid, {
                                                // 模块选择器
                                                &quot;props&quot;: queryParam,
                                                &quot;$&quot;: function (el) {
                                                    return $(&quot;#&quot; + gid).find(el);
                                                }
                                            });
                            
                                            // 非动画优先会在边动画边执行
                                            opt.showed &amp;&amp; opt.showed.call(module, {
                                                type: &quot;load&quot;,
                                                prevTarget: prevHistory,
                                                target: pageHistory
                                            });
                            
                                            if (isRefresh || _instanceCache[pageid]) {
                            
                                                lastHistory[&quot;exports&quot;] = _instanceCache[pageid];
                            
                                                refreshPage({
                                                    pid: pageid
                                                });
                            
                                                if (needAnimate) {
                                                    doAnimate();
                                                }
                                                // 触发事件
                                                callback &amp;&amp; callback();
                            
                                                if (param.needComponent) {
                                                    loader.components();
                                                }
                            
                                                triggerPageshow();
                            
                                                // 移除占位
                                                $nowPage.removeClass(&quot;bui-router-placeholder&quot;);
                            
                                            } else {
                            
                                                // 有部分模块被先require,跳转的时候,也要执行一次
                                                if (loader.checkLoad(pageid)) {
                            
                                                    refreshPage({
                                                        pid: pageid
                                                    });
                            
                                                    if (param.needComponent) {
                                                        loader.components();
                                                    }
                                                    // 触发事件
                                                    callback &amp;&amp; callback();
                            
                                                    triggerPageshow();
                            
                                                    // 移除占位
                                                    $nowPage.removeClass(&quot;bui-router-placeholder&quot;);
                            
                                                } else {
                                                    // 加载模块
                                                    // 组件标签优先加载,后再执行页面的模块脚本, 如果在模块里面执行, 会导致tab页面的everytime:true的情况,多次执行组件,导致组件找不到参数, 如例子: bui.floor_scrollto_tab
                                                    if (param.needComponent) {
                                                        loader.components();
                                                    }
                                                    loader.require(pageid, function (depend) {
                                                        try {
                            
                                                            opt.firstAnimate &amp;&amp; opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                            
                                                            // 存储页面的回调实例
                                                            _instanceCache[pageid] = depend || null;
                            
                                                            pageHistory[&quot;exports&quot;] = depend;
                            
                                                            def.resolve(depend);
                            
                                                            // 第一次加载或者是动画优先的时候,或者刷新是替换的时候
                                                            if (firstLoad || opt.firstAnimate || opt.replace) {
                                                                var lastModule = loader.get(pageid);
                                                                // 展示当前的模块
                                                                lastModule &amp;&amp; lastModule.show &amp;&amp; lastModule.show({
                                                                    type: &quot;firstload&quot;,
                                                                    target: pageHistory
                                                                });
                                                            }
                            
                                                            // 触发事件 triggerEvent
                                                            callback &amp;&amp; callback();
                            
                                                            // 先执行公共,再执行单独的模块
                                                            opt.loaded &amp;&amp; opt.loaded({
                                                                prevTarget: prevHistory,
                                                                target: pageHistory
                                                            });
                            
                                                            opt.callback &amp;&amp; opt.callback({
                                                                prevTarget: prevHistory,
                                                                target: pageHistory
                                                            });
                            
                                                            triggerPageshow();
                            
                                                            handleGet[pageid] &amp;&amp; handleGet[pageid][&quot;loaded&quot;] &amp;&amp; handleGet[pageid][&quot;loaded&quot;]({
                                                                prevTarget: prevHistory,
                                                                target: pageHistory
                                                            })
                            
                                                            // 动画优先这里获取不到历史记录
                                                            !pageshowInit &amp;&amp; opt.firstAnimate &amp;&amp; trigger.call(module, &quot;pageshow&quot;, {
                                                                type: &quot;load&quot;,
                                                                target: pageHistory
                                                            });
                            
                            
                                                            // 移除占位
                                                            $nowPage.removeClass(&quot;bui-router-placeholder&quot;);
                            
                                                        } catch (e) {
                                                            ui.showLog(e, &quot;bui.router.load&quot;);
                            
                                                            def.reject();
                                                        }
                            
                                                    });
                                                }
                                                // 触发complete事件
                                                trigger.call(module, &quot;complete&quot;, {
                                                    prevTarget: prevHistory,
                                                    target: pageHistory
                                                });
                            
                                            }
                            
                                        }
                            
                                        // 触发页面显示
                                        function triggerPageshow(lasthistory) {
                            
                                            // 页面刷新第一次进来后触发，跳转就不再触发了
                                            if (pageshowInit) {
                            
                                                var lastHistory = historyModule.getLast();
                            
                                                // 只监听某一个页面
                                                var showpid = &quot;pageshow-&quot; + lastHistory.pid;
                                                // firstanimate 在 加载模块以后才能执行，页面加载的时候，在外部执行
                                                !opt.firstAnimate &amp;&amp; trigger.call(module, &quot;pageshow&quot;, {
                                                    type: &quot;load&quot;,
                                                    target: lastHistory
                                                });
                                                trigger.call(module, showpid, {
                                                    type: &quot;load&quot;,
                                                    target: lastHistory
                                                });
                            
                                                pageshowInit = false;
                                            }
                                        }
                            
                                        // 触发页面显示
                                        function triggerPagehide() {
                            
                                            var lastHistory = historyModule.getLast();
                            
                                            // 只监听某一个页面
                                            var showpid = &quot;pageshow-&quot; + lastHistory.pid;
                            
                                            trigger.call(module, &quot;pageshow&quot;, {
                                                type: &quot;load&quot;,
                                                target: lastHistory
                                            });
                                            trigger.call(module, showpid, {
                                                type: &quot;load&quot;,
                                                target: lastHistory
                                            });
                            
                                        }
                            
                                        // 初始化main高度
                                        function autoInitMain() {
                                            $nowPage = ui.objId(lastHistory.id);
                                            var $nowPageInner = $nowPage &amp;&amp; $nowPage.find(&quot;.bui-page&quot;);
                                            // 自动初始化页面的main 高度
                                            $nowPageInner &amp;&amp; $nowPageInner.length &amp;&amp; opt.autoInit &amp;&amp; ui.init({
                                                id: $nowPageInner,
                                                height: winHeight
                                            });
                                        }
                            
                                        // 执行动画
                                        function doAnimate(callback) {
                            
                                            $nowPage = ui.objId(gid);
                            
                                            // go 要先隐藏上一个页面
                                            !opt.replace &amp;&amp; document.getElementById(prevCurrentId) &amp;&amp; (document.getElementById(prevCurrentId).style.display = &quot;none&quot;);
                            
                                            // 切换加载效果
                                            switchNowPage();
                                            // 隐藏上一页
                                            switchPrevPage();
                            
                                            try {
                                                // 加载模块以后执行动画
                                                if (!firstLoad &amp;&amp; !isRefresh &amp;&amp; !opt.replace &amp;&amp; !opt.part) {
                            
                            
                                                    uiTogglePrev &amp;&amp; uiTogglePrev.hide();
                                                    uiToggleNow &amp;&amp; uiToggleNow.show(function () {
                            
                                                        callback &amp;&amp; callback();
                            
                                                        !opt.firstAnimate &amp;&amp; opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                            
                                                        // 可以修复滑动的加载闪动问题
                                                        $nowPage &amp;&amp; $nowPage.css(&quot;zIndex&quot;, 5);
                            
                                                        uiMask &amp;&amp; uiMask.hide();
                            
                                                        var lastPrevHistory = _history[_history.length - 2] || {};
                                                        var lastHistory = historyModule.getLast();
                            
                                                        var lastModule = loader.get(lastHistory.pid);
                                                        var lastPrevModule = lastPrevHistory &amp;&amp; lastPrevHistory.pid &amp;&amp; loader.get(lastPrevHistory.pid) || null;
                                                        // 只监听某一个页面
                                                        var showpid = &quot;pageshow-&quot; + lastHistory.pid;
                                                        var hidepid = &quot;pagehide-&quot; + lastPrevHistory.pid;
                            
                            
                                                        // 展示当前的模块
                                                        lastPrevModule &amp;&amp; lastPrevModule.hide &amp;&amp; lastPrevModule.hide({
                                                            type: &quot;load&quot;,
                                                            target: lastPrevHistory
                                                        });
                                                        lastModule &amp;&amp; lastModule.show &amp;&amp; lastModule.show({
                                                            type: &quot;load&quot;,
                                                            target: historyModule.getLast()
                                                        });
                            
                            
                                                        // 能不能切换动画及页面加载
                                                        !firstLoad &amp;&amp; opt.hided &amp;&amp; opt.hided.call(module, {
                                                            type: &quot;load&quot;,
                                                            prevTarget: prevHistory,
                                                            target: lastPrevHistory
                                                        });
                            
                                                        trigger.call(module, hidepid, {
                                                            type: &quot;load&quot;,
                                                            target: lastPrevHistory
                                                        });
                            
                                                        trigger.call(module, showpid, {
                                                            type: &quot;load&quot;,
                                                            target: historyModule.getLast()
                                                        });
                            
                                                        trigger.call(module, &quot;pagehide&quot;, {
                                                            type: &quot;load&quot;,
                                                            target: lastPrevHistory
                                                        });
                            
                            
                                                        // 动画优先这里获取不到历史记录
                                                        if (opt.firstAnimate) {
                                                            // 第一次不触发，等到每次跳转有加载了才触发
                                                            loader.checkLoad(_history[_history.length - 1].pid) &amp;&amp; trigger.call(module, &quot;pageshow&quot;, {
                                                                type: &quot;load&quot;,
                                                                target: lastHistory
                                                            });
                                                        } else {
                            
                                                            trigger.call(module, &quot;pageshow&quot;, {
                                                                type: &quot;load&quot;,
                                                                target: lastHistory
                                                            });
                                                        }
                            
                            
                                                    });
                            
                                                } else {
                            
                            
                                                    callback &amp;&amp; callback();
                            
                                                    !opt.firstAnimate &amp;&amp; opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                                    uiMask &amp;&amp; uiMask.hide();
                                                    // 可以修复滑动的加载闪动问题
                                                    $nowPage &amp;&amp; $nowPage.css(&quot;zIndex&quot;, 5);
                            
                            
                                                }
                                            } catch (e) {
                                                ui.showLog(e, &quot;bui.router.doAnimate&quot;);
                                            }
                                        }
                            
                                        // 页面加载的模板内容,不同类型,使用的方式不同
                                        function switchLoadTemplate(res) {
                                            var resp = &quot;&quot;;
                            
                                            // 如果有挂载数据到路由,解析{{}}
                                            if (module.store) {
                                                res = module.store.compileHtml(res);
                                            }
                                            // 替换成新的页面结构 ,动态处理 #module.id 为页面id, 实现页面局部样式
                                            var lastHistory2 = ui.history.getLast();
                            
                                            res = ui.unit.handleContent(res);
                                            // todo: 要把样式的 #module.id 控制在 style 标签内。
                                            res = res.replace(/#module\.id/g, &quot;#&quot; + lastHistory2.id);
                                            // 替换路径
                                            res = res.replace(/#module\.path\//g, lastHistory2.path);
                            
                                            // 生成模板
                                            if (opt.part) {
                                                // 局部加载
                                                resp = templatePart({
                                                    content: res
                                                });
                            
                                                if (opt.id) {
                                                    // 局部加载必须有ID
                                                    $id.html(resp);
                                                } else {
                                                    ui.showLog(&quot;id 不能为空&quot;, &quot;router.loadPart&quot;);
                                                }
                            
                                            } else if (opt.replace) {
                            
                                                // 替换一个页面
                                                // 如果是替换,需要知道当前的模块id,或者指定ID
                                                var lastHistory = historyModule.getLast();
                                                // 没有历史记录时,则获取第一个父层元素
                                                $id = _history.length ? ui.objId(lastHistory[&quot;id&quot;]) : $routerMain;
                                                // 修改最后一个历史记录信息
                                                lastHistory[&quot;pid&quot;] = pageid;
                                                lastHistory[&quot;url&quot;] = url;
                                                lastHistory[&quot;param&quot;] = queryParam;
                            
                                                var index = ui.array.index(_history, pageid, &quot;pid&quot;);
                                                // 这里有bug, 重复替换页面加载过的会有问题,替换后,后退,再进入替换,会有问题
                                                // 如果该页面已经加载过, 缓存是带 bui-router-item
                                                if (pageid in _cachePages) {
                                                    // 生成每个页面内容,不需要外层地址
                                                    // var cacheid = cacheModule.get(pageid,&quot;id&quot;);
                            
                                                    // var $gid = ui.objId(cacheid);
                                                    // resp = $gid.html();
                                                    resp = cacheModule.get(pageid, &quot;template&quot;);
                                                } else {
                                                    // 生成每个页面内容
                                                    resp = templatePart({
                                                        content: res
                                                    });
                                                }
                            
                            
                                                // 替换成新的页面结构 ,动态处理 #module.id 为页面id, 实现页面局部样式
                                                var lastHistory2 = ui.history.getLast();
                            
                                                // todo: 要把样式的 #module.id 控制在 style 标签内。
                                                resp = resp.replace(/#module\.id/g, &quot;#&quot; + lastHistory2.id);
                                                // 替换路径
                                                resp = resp.replace(/#module\.path\//g, lastHistory2.path);
                            
                                                // 局部加载必须有ID
                                                $id.html(resp).attr(&quot;data-page&quot;, pageid)
                            
                            
                                            } else if (!isRefresh) {
                                                // 增加一个页面
                                                // 生成每个页面内容
                                                resp = templatePage({
                                                    id: gid,
                                                    content: res,
                                                    pid: pageid
                                                });
                                                // 渲染加载的页面结构,并设置为主页
                                                $routerMain &amp;&amp; $routerMain.attr(&quot;data-main&quot;, gid).append(resp);
                                            }
                            
                                            // 编译view便签
                                            param.needView &amp;&amp; loader.views({
                                                compiled: function () {
                                                    if (module.store &amp;&amp; !module.store.config.isPublic) {
                                                        // 解析选择器
                                                        module.store.config.needCompile &amp;&amp; module.store.compile(&quot;#&quot; + gid);
                                                    }
                                                }
                                            });
                                            // 编译component标签
                                            // param.needComponent &amp;&amp; loader.components({
                                            //     compiled: function() {
                                            //         console.log(111)
                                            //     }
                                            // });
                            
                                            // 非公共数据
                                            if (module.store &amp;&amp; !param.needView &amp;&amp; !module.store.config.isPublic) {
                                                // 解析选择器
                                                module.store.config.needCompile &amp;&amp; module.store.compile(&quot;#&quot; + gid);
                                            }
                            
                            
                                            return resp;
                                        }
                                        // 刷新页面
                                        function refreshPage(option) {
                                            // 获取最后一个历史记录
                                            var lastHistory = historyModule.getLast();
                            
                                            var lastModule = _modulesMap[option.pid] &amp;&amp; _modulesMap[option.pid] || {};
                                            // 刷新
                                            var callback = lastModule[&quot;loaded&quot;];
                            
                                            // 1.6.6 新增模块选择器，应对tab的新增，比router.$ 查找范围更小
                                            loader.set(option.pid, {
                                                // 模块选择器
                                                &quot;props&quot;: lastHistory.param,
                                                &quot;$&quot;: function (el) {
                                                    return $(&quot;#&quot; + lastHistory.id).find(el);
                                                }
                                            });
                            
                                            // 触发回调,并把公共方法抛出给另外的模块调用
                                            var shareMethod = callback &amp;&amp; callback.apply(lastModule, lastModule[&quot;dependExports&quot;]) || lastModule[&quot;exports&quot;];
                            
                                            // 存储页面的回调实例
                                            _instanceCache[option.pid] = shareMethod || null;
                            
                                            // 修复require的模块变成是第一次加载的模块
                            
                                            lastModule[&quot;exports&quot;] = shareMethod;
                            
                                            lastHistory[&quot;exports&quot;] = shareMethod;
                            
                                            isRefresh &amp;&amp; trigger.call(module, &quot;refresh&quot;, {
                                                prevTarget: prevHistory,
                                                target: lastHistory
                                            });
                            
                                            // 关闭遮罩
                                            uiMask &amp;&amp; uiMask.hide();
                                            // 关闭loading
                                            // param.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                            def.resolve(shareMethod);
                            
                                            isRefresh = false;
                            
                                            // 已经不是第1次加载
                                            firstLoad = false;
                                        }
                            
                                        // 触发事件监听
                                        function triggerEvent() {
                            
                                            var lastPrevHistory = _history[_history.length - 2] || null;
                            
                                            // 获取最后一个历史记录
                                            var lastHistory = historyModule.getLast();
                            
                                            // 清空当前事件
                                            if (firstLoad &amp;&amp; !opt.part) {
                                                // 第一次加载
                                                trigger.call(module, &quot;firstload&quot;, {
                                                    prevTarget: lastPrevHistory,
                                                    target: lastHistory
                                                });
                            
                                                firstLoad = false;
                                            }
                            
                                            // 只在第一次加载模板的时候触发
                                            if (opt.part) {
                                                trigger.call(module, &quot;loadpart&quot;, {
                                                    prevTarget: lastPrevHistory,
                                                    target: lastHistory
                                                });
                                            } else {
                                                trigger.call(module, &quot;load&quot;, {
                                                    prevTarget: lastPrevHistory,
                                                    target: lastHistory
                                                });
                                            }
                            
                                        }
                            
                                        // 加载缓存
                                        function loadCache(opt) {
                                            // 使用缓存
                                            var resHtml = cacheModule.get(opt.pid, &quot;template&quot;);
                                            // 切换模板
                                            switchLoadTemplate(resHtml);
                            
                            
                                            // 如果不是局部加载,需要初始化页面高度并且执行页面动画及回调.
                                            if (opt.part) {
                                                // 刷新局部模块,局部加载的模块没有在历史记录里.
                                                refreshPage(opt);
                                                // // 关闭遮罩
                                                // uiMask &amp;&amp; uiMask.hide();
                                                // // 关闭loading
                                                // opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                            
                                            } else {
                                                // 初始化main高度
                                                autoInitMain();
                            
                                                // 除了刷新,页面加载都需要动画
                                                !isRefresh &amp;&amp; doAnimate(function () {
                                                    if (opt.firstAnimate) {
                            
                                                        refreshPage(opt);
                            
                            
                                                        // 先执行公共,再执行单独的模块
                                                        opt.loaded &amp;&amp; opt.loaded({
                                                            prevTarget: prevHistory,
                                                            target: pageHistory
                                                        });
                            
                                                        opt.callback &amp;&amp; opt.callback({
                                                            prevTarget: prevHistory,
                                                            target: pageHistory
                                                        });
                                                    }
                                                    // 关闭loading
                                                    opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                                });
                                                // 刷新页面
                                                !opt.firstAnimate &amp;&amp; refreshPage(opt);
                                                // // 关闭遮罩
                                                // uiMask &amp;&amp; uiMask.hide();
                                                // isRefresh &amp;&amp;  opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                            }
                                        }
                            
                                        // 跳转到错误页面
                                        function loadErrorPage(url) {
                            
                                            // 如果有配置错误页面,自动跳转
                                            loadDefault(url);
                                        }
                            
                                        // 加载局部页面
                                        function loadPagePart() {
                                            // 异步加载页面
                                            requestUrl(url, function (res, status, xhr) {
                                                // 文件找不到还是会进入到 success, 只是返回的内容为空
                                                // if( res == &quot;&quot;){
                                                //   loadErrorPage(url);
                                                //   ui.showLog(&quot;找不到&quot;+url,&quot;bui.router.load&quot;);
                                                //   return false;
                                                // }
                                                var $gid = ui.objId(gid);
                                                // 切换加载的模板
                                                $gid[opt.command](res);
                            
                                                // 加载模块
                                                requireModule(triggerEvent);
                                                // 触发事件
                                                // triggerEvent();
                            
                                                // 增加缓存, 这个缓存不包含 bui-router-item
                                                if (opt.cache) {
                                                    cacheModule.add(pageid, {
                                                        id: gid,
                                                        pid: pageid,
                                                        template: res
                                                    });
                                                }
                            
                                                // 关闭点击及遮罩
                                                uiMask &amp;&amp; uiMask.hide();
                                                // 跳转默认页面
                                                opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                            }, function (res, status, xhr) {
                            
                                                requestFail(url, res, status, xhr);
                            
                                                trigger.call(module, &quot;loadfail&quot;, res, status, xhr);
                            
                                            })
                                        }
                            
                                        // 加载iframe
                                        function loadIframe(option) {
                                            // 切换加载的模板
                                            var resp = templateFramePage({
                                                id: option.id,
                                                pid: option.pid,
                                                url: option.url,
                                                param: option.param
                                            });
                            
                                            // 渲染加载的页面结构,并设置为主页
                                            $routerMain &amp;&amp; $routerMain.attr(&quot;data-main&quot;, option.id).append(resp);
                            
                                            // 先执行动画再执行事件
                                            doAnimate(function () {
                                                // 动画结束后关闭进度条
                                                opt.progress &amp;&amp; uiLoading &amp;&amp; uiLoading.hide();
                                            });
                                        }
                            
                                        return def.promise();
                                    }
                            
                                    /**
                                     * 局部加载, 1.5.6以后推荐使用 loader.load ,可以单页多页使用
                                     *  @method loadPart
                                     *  @param {object} [option]
                                     *  @param {string} option.id [ 加载的容器 ]
                                     *  @param {string} option.url [ 加载的地址,可以是一个模块 ]
                                     *  @param {object} [option.param]  传递给该模块的参数 
                                     *  @return {object} [ 新增1.4.2 返回一个 Deferred 对象 ]
                                     *  @chainable
                                     *  @example
                                     *
                                     *  方法1: 加载某个模块到页面的id=part2, 模块名为: pages/page2/page2
                            
                                        router.loadPart({ id:&quot;#part2&quot;, url: &quot;pages/page2/page2.html &quot;});
                            
                                     *
                                     */
                                    function loadPart(opt) {
                                        var config = {
                                            id: &quot;&quot;,
                                            url: &quot;&quot;,
                                            // command: &quot;html&quot;,
                                            param: {},
                                            loaded: null,
                                            // part: true
                                        }
                            
                            
                                        var defs = $.Deferred();
                            
                                        var option = $.extend(true, {}, config, opt);
                                        var loaded = function (instance) {
                            
                                            opt.loaded &amp;&amp; opt.loaded.call(module, instance);
                            
                                            defs.resolve(instance);
                                            trigger.call(module, &quot;loadpart&quot;, instance);
                                        }
                                        option.loaded = loaded;
                            
                                        loader.load(option);
                                        // var option = $.extend(true, {}, config, opt);
                            
                                        // // 局部加载
                                        // var defs = load(option);
                            
                                        return defs.promise();
                                    }
                            
                                    // 解析相对路径
                                    function resolvePath(url, prevHistory) {
                                        var newurl = url;
                                        var lastUrlIndex = prevHistory.url.lastIndexOf(&quot;/&quot;);
                            
                                        var lastPath = prevHistory.url.substr(0, lastUrlIndex);
                            
                                        if (url.indexOf(&quot;../&quot;) &gt; -1) {
                                            url = url.replace(/\..\//g, function (res) {
                                                var lastIndex = lastPath.lastIndexOf(&quot;/&quot;);
                                                lastPath = lastPath.substr(0, lastIndex);
                                                return &quot;&quot;;
                                            });
                                            newurl = lastPath ? lastPath + &quot;/&quot; + url : url;
                            
                                        } else if (url.indexOf(&quot;./&quot;) &gt; -1) {
                                            newurl = lastPath + &quot;/&quot; + url.replace(/\.\//g, &quot;&quot;);
                                        } else if (url.indexOf(&quot;/&quot;) === 0) {
                                            newurl = url.substr(1);
                                        }
                                        return newurl;
                                    }
                                    // 解析传进来的URL地址
                                    function resolveUrl(pid) {
                                        var url = &quot;&quot;,
                                            pageid = pid;
                                        // 拿到最新的模块地图
                                        _map = loader.map();
                                        _modulesMap = _map[&quot;modules&quot;];
                            
                                        // 页面是否存在.html结尾
                                        var pointIndex = pageid.indexOf(param.pageSuffix);
                                        // 如果是有html后缀的,直接跳转, 没有的则查找映射关系
                                        if (pointIndex &gt; -1) {
                                            url = pageid;
                                            pageid = url.substr(0, pointIndex);
                            
                                            // 如果有在模板里,拿template执行,可以减少请求
                                            if (_modulesMap.hasOwnProperty(pageid)) {
                                                // 拿配置好的template
                                                url = _modulesMap[pageid] &amp;&amp; _modulesMap[pageid][&quot;template&quot;] || url || &quot;&quot;
                                            }
                                            // else {
                                            // 默认没配置时,拿url去匹配模块名, 原本的设计是一个页面对应一个脚本,所以可以通过url模板匹配找到模块名, 但如果你的模板是一对多,则找到的模块名是不正确的.
                                            // pageid = getPagekey(url) || pageid;
                                            // }
                            
                                        } else {
                                            // main
                                            pageid = pageid;
                                            url = _modulesMap[pageid] &amp;&amp; _modulesMap[pageid][&quot;template&quot;] || pageid + param.pageSuffix || &quot;&quot;;
                                        }
                            
                                        return {
                                            pid: pageid,
                                            url: url
                                        }
                                    }
                            
                                    /**
                                     * 页面返回,支持回调,跟返回多层
                                     *  @method back
                                     *  @param {object} [option]
                                     *  @param {number} [option.index] 默认:-1, 后退1层 ,负数,如果后退的层级大于历史记录,则退回到首页
                                     *  @param {number} [option.name]  1.4.1新增 指定模块名称,该模块如果未存在,则后退一层
                                     *  @param {function||boolean} [option.beforeBack] 1.5.1默认: null 每次后退前触发, 如果返回 false 则不后退, 不返回或者返回true 都会后退. 
                                     *  @param {function||boolean} [option.beforeHide] 1.8.0 当前页隐藏前执行
                                     *  @param {function||boolean} [option.beforeShow] 1.8.0 上一页展示前，动画前
                                     *  @param {function||boolean} [option.showed] 1.8.0 上一页展示后，动画后
                                     *  @param {function||boolean} [option.hided] 1.8.0 隐藏后执行，当前页信息
                                     *  @param {function} [option.callback] 后退以后执行回调,回调里可以拿到后退模块的return值
                                     *  @chainable
                                     *  @example
                            
                            
                                        方法1:
                            
                                        router.back();
                            
                                        方法2: 后退上2页
                            
                                        router.back({ index: -2 });
                            
                                        方法3: 后退以后刷新
                            
                                        router.back({
                                          callback: function() {
                                            router.refresh();
                                          }
                                        });
                            
                                        方法4: 后退以后执行当前模块的方法
                            
                                        router.back({
                                          callback: function(mod) {
                                            mod.init();
                                          }
                                        });
                            
                                        方法5: 全局监听后退事件
                                        router.on(&quot;back&quot;,function (e) {
                                            // 如果回退到首页则刷新页面
                                              loader.require([&quot;main&quot;],function(main){
                                                // 刷新main
                                                main.init()
                                              })
                                        })
                                     *
                                     */
                                    function back(opts) {
                                        var _self = this;
                            
                                        // 如果直接传回调,值在callback参数
                                        var opt = {};
                                        if (typeof opts === &quot;function&quot;) {
                                            opt.callback = opts;
                                        } else {
                                            opt = opts || {};
                                        }
                            
                                        var option = $.extend(true, {
                                            index: -1,
                                            name: &quot;&quot;,
                                            beforeBack: null,
                                            callback: null,
                                            effect: param.backEffect || param.effect,
                                            beforeHide: null,
                                            beforeShow: null,
                                            showed: null,
                                            hided: null,
                                            loaded: null
                                        }, opt);
                            
                            
                                        // var curHisory = ui.history.getCurrent() || null;
                                        option.beforeBack = function (e) {
                                            let gstatus = param.beforeBack &amp;&amp; param.beforeBack.call(this, e);
                                            let astatus = opt.beforeBack &amp;&amp; opt.beforeBack.call(this, e);
                            
                                            trigger.call(this, &quot;beforeback&quot;, e);
                            
                                            return gstatus &amp;&amp; astatus
                            
                                        }
                                        option.loaded = function (e) {
                                            param.loaded &amp;&amp; param.loaded.call(this, e);
                                            opt.loaded &amp;&amp; opt.loaded.call(this, e);
                            
                                            trigger.call(this, &quot;loaded&quot;, e);
                            
                                        }
                                        option.beforeHide = function (e) {
                                            let gstatus = param.beforeHide &amp;&amp; param.beforeHide.call(this, e);
                                            let astatus = opt.beforeHide &amp;&amp; opt.beforeHide.call(this, e);
                                            trigger.call(this, &quot;beforehide&quot;, e);
                            
                                            return gstatus &amp;&amp; astatus
                                        }
                                        option.hided = function (e) {
                                            param.hided &amp;&amp; param.hided.call(this, e);
                                            opt.hided &amp;&amp; opt.hided.call(this, e);
                                            trigger.call(this, &quot;hided&quot;, e);
                                        }
                                        option.beforeShow = function (e) {
                                            let gstatus = param.beforeShow &amp;&amp; param.beforeShow.call(this, e);
                                            let astatus = opt.beforeShow &amp;&amp; opt.beforeShow.call(this, e);
                                            trigger.call(this, &quot;beforeshow&quot;, e);
                                            return gstatus &amp;&amp; astatus
                                        }
                                        option.showed = function (e) {
                                            param.showed &amp;&amp; param.showed.call(this, e);
                                            opt.showed &amp;&amp; opt.showed.call(this, e);
                                            trigger.call(this, &quot;showed&quot;, e);
                                        }
                            
                            
                                        var index = parseInt(option.index),
                                            historyLength = _history.length;
                            
                                        _map = loader.map();
                                        _modulesMap = _map[&quot;modules&quot;];
                            
                                        if (index &gt; 0) {
                                            ui.showLog(&quot;index 参数只能是负数&quot;, &quot;bui.router.back&quot;)
                                            return;
                                        }
                            
                                        // 后退前的最后一个历史记录
                                        var prevHistory = historyModule.getLast(),
                                            lastIndex = historyLength - 1;
                            
                                        var toggle = prevHistory[&quot;toggle&quot;];
                                        // 用于外部插入历史记录以后的操作
                                        if (toggle) {
                                            toggle.hide();
                                            switchNowPage();
                                            return;
                                        };
                            
                                        // 能不能后退
                                        var canback = option.beforeBack &amp;&amp; option.beforeBack.call(module, {
                                            prevTarget: null,
                                            target: prevHistory
                                        })
                                        // trigger.call(module, &quot;backbefore&quot;, { prevTarget: null, target: prevHistory });
                                        trigger.call(module, &quot;beforeback&quot;, {
                                            prevTarget: null,
                                            target: prevHistory
                                        });
                            
                                        var prevModule = loader.get(prevHistory.pid);
                                        prevModule &amp;&amp; prevModule.beforeDestroy &amp;&amp; prevModule.beforeDestroy()
                            
                                        // 不允许跳转
                                        if (canback === false) {
                                            return this;
                                        }
                            
                                        var currentHistory = bui.history.getPrev();
                            
                                        // 能不能后退 1.8.0
                                        var canhide = option.beforeHide &amp;&amp; option.beforeHide.call(module, {
                                            type: &quot;back&quot;,
                                            target: prevHistory
                                        });
                            
                                        // 不允许跳转
                                        if (canhide === false) {
                                            return this;
                                        }
                            
                                        // 能不能后退 1.8.0
                                        var canshow = option.beforeShow &amp;&amp; option.beforeShow.call(module, {
                                            type: &quot;back&quot;,
                                            target: currentHistory
                                        });
                            
                                        // 不允许跳转
                                        if (canshow === false) {
                                            return this;
                                        }
                            
                                        // 通过名称后退
                                        if (option.name) {
                                            // 获取模块在历史记录最接近的索引
                                            index = getBackNearIndex(option.name);
                                        }
                                        // 如果后退2层,需要记录有2层, 没有自动降为后退1层
                                        if (Math.abs(index) &gt; lastIndex) {
                                            index = -lastIndex;
                                        }
                            
                                        // 保留第一个加载的页面,并且只能后退一层
                                        if (historyLength &gt; 1 &amp;&amp; backControl) {
                            
                                            // 找到要切换成now的页面
                                            if (index &lt; -1) {
                                                switchPrevPage(index);
                                            }
                                            // 防止快速点击
                                            backControl = false;
                            
                                            // let prevEffect = opt.effect ? (effects[opt.effect] &amp;&amp; effects[opt.effect][&quot;inLeft&quot;]) : &quot;&quot;;
                                            // let nowEffect = opt.effect ? (effects[opt.effect] &amp;&amp; effects[opt.effect][&quot;outRight&quot;]) : &quot;&quot;;
                                            let prevEffect = effects[option.effect] &amp;&amp; effects[option.effect][&quot;inLeft&quot;];
                                            let nowEffect = effects[option.effect] &amp;&amp; effects[option.effect][&quot;outRight&quot;];
                            
                                            // 显示上一个页面
                                            uiTogglePrev &amp;&amp; uiTogglePrev.show(null, prevEffect);
                            
                                            uiToggleNow &amp;&amp; uiToggleNow.hide(function () {
                            
                                                // 指定位置
                                                var assignIndex = historyLength + index;
                            
                                                // 删除某个位置之后的所有元素
                                                // !param.cache &amp;&amp; removeNextAll(assignIndex)
                                                removeNextAll(assignIndex)
                                                // 删除某个索引之后的所有历史记录
                                                historyModule.removeNext(assignIndex);
                            
                                                switchPrevPage();
                                                // 切换成第几个,需要重新获取最后一个记录信息
                                                var lastHistory = switchNowPage();
                            
                                                // 历史记录的组件和ui
                                                let compkeys = Object.keys(lastHistory.component);
                                                let uikeys = Object.keys(lastHistory.ui);
                            
                                                compkeys.forEach((item, i) =&gt; {
                                                    let compdestroy = lastHistory.component[item]?.exports?.destroy;
                                                    // 执行组件的销毁
                                                    typeof compdestroy === &quot;function&quot; &amp;&amp; compdestroy();
                                                })
                            
                                                uikeys.forEach((item, i) =&gt; {
                                                    let compdestroy = lastHistory.ui[item]?.destroy;
                                                    // 执行ui的销毁
                                                    typeof compdestroy === &quot;function&quot; &amp;&amp; compdestroy();
                                                })
                            
                            
                                                var pid = lastHistory[&quot;pid&quot;];
                            
                                                // 每次后退以后把最后的层级提上来
                                                ui.objId(lastHistory[&quot;id&quot;]).css(&quot;zIndex&quot;, 5);
                            
                                                function callback() {
                                                    var obj = {};
                            
                                                    obj = _instanceCache[pid] || {};
                            
                                                    var lastModule = loader.get(lastHistory.pid);
                            
                                                    // 执行回调, 需要把回调的依赖返回回去
                                                    option.callback &amp;&amp; option.callback.call(_self, obj, lastHistory);
                                                    option.backed &amp;&amp; option.backed.call(module, {
                                                        prevTarget: prevHistory,
                                                        target: lastHistory
                                                    });
                                                    trigger.call(module, &quot;back&quot;, {
                                                        prevTarget: prevHistory,
                                                        target: lastHistory
                                                    });
                            
                                                    _currentHistory = lastHistory;
                            
                            
                                                    // 只监听某一个页面
                                                    var showpid = &quot;pageshow-&quot; + lastHistory.pid;
                                                    var hidepid = &quot;pagehide-&quot; + prevHistory.pid;
                            
                                                    // 隐藏上一个页面触发回调
                                                    prevModule &amp;&amp; prevModule.hide &amp;&amp; prevModule.hide({
                                                        type: &quot;back&quot;,
                                                        target: prevHistory
                                                    });
                                                    // 展示当前的模块
                                                    lastModule &amp;&amp; lastModule.show &amp;&amp; lastModule.show({
                                                        type: &quot;back&quot;,
                                                        target: lastHistory
                                                    });
                            
                                                    trigger.call(module, hidepid, {
                                                        type: &quot;back&quot;,
                                                        target: prevHistory
                                                    });
                                                    trigger.call(module, showpid, {
                                                        type: &quot;back&quot;,
                                                        target: lastHistory
                                                    });
                            
                                                    option.showed &amp;&amp; option.showed.call(module, {
                                                        type: &quot;back&quot;,
                                                        target: lastHistory
                                                    });
                            
                                                    option.hided &amp;&amp; option.hided.call(module, {
                                                        type: &quot;back&quot;,
                                                        target: prevHistory
                                                    });
                            
                                                    trigger.call(module, &quot;pageshow&quot;, {
                                                        type: &quot;back&quot;,
                                                        target: lastHistory
                                                    });
                                                    trigger.call(module, &quot;pagehide&quot;, {
                                                        type: &quot;back&quot;,
                                                        target: prevHistory
                                                    });
                            
                            
                            
                                                    // 调用模块的自身销毁事件
                                                    prevModule &amp;&amp; prevModule.destroyed &amp;&amp; prevModule.destroyed();
                            
                                                    backControl = true;
                                                }
                                                // 后退以后执行
                                                callback();
                            
                                                // 不缓存的时候销毁模块
                                                // if (!param.cache) {
                                                //     destroy(prevHistory[&quot;pid&quot;]);
                                                // }
                            
                                            }, nowEffect);
                            
                                        }
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 页面返回,支持回调,跟返回多层
                                     *  @method destroy
                                     *  @param {string} [销毁某个页面]
                                     *  @chainable
                                     *  @example
                            
                            
                                        方法1:
                            
                                        router.destroy(&quot;page&quot;);
                            
                                     *
                                     */
                                    function destroy(page) {
                            
                                        if (typeof page === &quot;string&quot; &amp;&amp; page !== &quot;main&quot;) {
                                            // 销毁模块
                                            loader.destroy(page);
                                            // 删除模板缓存,下次才会继续请求
                                            cacheModule.del(page);
                                            // 删除实例
                                            (page in _instanceCache) &amp;&amp; delete _instanceCache[page];
                                        } else {
                                            ui.showLog(&quot;参数只能是字符串&quot;)
                                        }
                            
                                        return this;
                                    };
                            
                                    // 获取模块最近的一次索引
                                    function getBackNearIndex(pid) {
                            
                                        var index,
                                            nameIndex = ui.array.indexs(_history, pid, &quot;pid&quot;),
                                            nameLen = nameIndex.length;
                            
                                        // 有多个同模块则采用就近模块
                                        if (nameLen) {
                                            var less = -(_history.length - nameIndex[nameLen - 1] - 1);
                                            index = less == 0 ? -1 : less;
                                        } else {
                                            index = -1;
                                        }
                            
                                        return index;
                                    }
                            
                            
                                    // 加载url
                                    function requestUrl(url, successCallback, failCallback) {
                                        if (typeof url === &quot;string&quot;) {
                                            var currentModule = null;
                                            // 模块的生命周期,只在第一次请求有beforeCreate
                                            // if (url.indexOf(&quot;.js&quot;) &gt; -1) {
                                            //     currentModule = loader.get(_currentHistory.pid);
                                            //     currentModule &amp;&amp; currentModule.beforeCreate &amp;&amp; currentModule.beforeCreate()
                                            // }
                            
                                            loader.importHtml(url, function (res, status, xhr) {
                                                // 原生的不能修改xhr的属性,IOS导致报错 TypeError: Attempted to assign to readonly property.
                                                // xhr.url = url;
                                                // 只是触发fail, 但实际上可以继续执行
                                                // if (res === &#x27;&#x27;) {
                                                //     trigger.call(module, &quot;fail&quot;, res, status, xhr);
                                                // }
                                                // 获取多页的body内容,script应该放在head标签里
                                                res = matchbody(res);
                                                // var lastHistory = ui.history.getLast();
                            
                                                // 替换成页面局部样式,互不冲突
                                                // res = res.replace(/#module\.id/g, &quot;#&quot; + lastHistory.id);
                            
                                                successCallback &amp;&amp; successCallback(res, status, xhr);
                            
                                                // 触发公共的监听事件
                                                trigger.call(module, &quot;success&quot;, res, status, xhr);
                            
                                                currentModule &amp;&amp; currentModule.created &amp;&amp; currentModule.created()
                                            }, function (res, status, xhr) {
                            
                                                failCallback &amp;&amp; failCallback(res, status, xhr);
                                                trigger.call(module, &quot;fail&quot;, res, status, xhr);
                                            })
                            
                                        } else if (typeof url === &quot;function&quot;) {
                                            // 早期url只支持分离模板
                                            var tpl = url &amp;&amp; url();
                            
                                            successCallback &amp;&amp; successCallback(tpl, 200, {});
                                            // 触发公共的监听事件
                                            trigger.call(module, &quot;success&quot;, tpl, 200, {});
                            
                                        } else {
                                            ui.showLog(&quot;url 不能为空&quot;, &quot;bui.router.requestUrl&quot;);
                                        }
                                    }
                            
                                    function matchbody(res) {
                                        var rule = /&lt;body[^&gt;]*&gt;([\s\S]*)&lt;\/body&gt;/;
                                        // 替换掉所有script标签
                                        var scriptRule = /&lt;script\b[^&lt;]*(?:(?!&lt;\/script&gt;)&lt;[^&lt;]*)*&lt;\/script&gt;/gi;
                                        var result = rule.exec(res);
                                        if (result &amp;&amp; result.length === 2) {
                                            return result[1].replace(scriptRule, &quot;&quot;);
                                        }
                                        return res;
                                    }
                            
                                    /**
                                     * 刷新当前页
                                     *  @method refresh
                                     *  @example
                            
                                        // 方法:
                                        router.refresh();
                                     *
                                     */
                                    function refresh() {
                            
                                        var lastIndex = _history.length - 1,
                                            lastHistory = _history[lastIndex],
                                            prevHistory = _history.length &gt; 1 ? _history[_history.length - 2] : null;
                            
                                        ui.history.refresh();
                            
                                        trigger.call(module, &quot;refresh&quot;, {
                                            prevTarget: prevHistory,
                                            target: lastHistory
                                        });
                                        return this;
                                    }
                            
                            
                                    /**
                                     * 替换当前页面,为新页面
                                     *  @method replace
                                     *  @param {object} [option]
                                     *  @param {string} option.url [加载的地址]
                                     *  @param {object} [option.param] 传参
                                     *  @return {object}
                                     *  @example
                            
                                        router.replace({
                                            url: &quot;pages/page3/page3.html&quot;
                                        });
                            
                                     *
                                     */
                                    function replace(opt) {
                            
                                        opt = opt || {};
                            
                                        load({
                                            url: opt[&quot;url&quot;] || &quot;&quot;,
                                            param: opt[&quot;param&quot;] || {},
                                            replace: true
                                        })
                            
                                        return this;
                                    }
                            
                            
                                    /**
                                     * 获取页面的参数,可以直接使用 bui.getPageParams() 方法获取
                                     *  @method getPageParams
                                     *  @return {object} option [返回对象]
                                     *  @example
                            
                                     *  方法:
                                     *
                                        var params = router.getPageParams();
                            
                            
                                     *
                                     *
                                     */
                                    function getPageParams() {
                                        var lastHistory = historyModule.getLast();
                            
                            
                                        return lastHistory.param;
                                    }
                            
                                    /**
                                     * [获取当前页面下的局部模块参数]
                                     * @method getPartParams
                                     * @param  {string} [id] loadPart 局部加载的id, 1.5.2 可以不传,默认取最后一次执行的模块参数
                                     * @since 1.4.2
                                     * @return {[object]}     [返回得到的参数]
                                     * @example
                            
                                        loader.define(function(require,exports,module) {
                            
                                            var params = router.getPartParams();
                            
                                        })
                                     *
                                     *
                                     */
                                    function getPartParams(id) {
                                        // if (typeof pid === &quot;undefined&quot;) {
                                        //     ui.showLog(&quot;必须传模块id才能获取参数,可以通过define的module参数获取&quot;);
                                        //     return;
                                        // }
                                        var partParam = ui.history.getComponentParam(id);
                            
                                        return partParam;
                                    }
                            
                                    /**
                                     * 默认检查模块是否已经加载过,防止事件重复绑定
                                     *  @method isLoad
                                     *  @param {string} [pid] 检查某个模块是否已经加载过
                                     *  @return {boolean}
                                     *  @example
                            
                                        var isLoad = router.isLoad(&quot;main&quot;);
                            
                                     *
                                     */
                                    function isLoad(pid) {
                                        var bool;
                                        if (pid) {
                                            bool = pid in _instanceCache;
                                        }
                                        return bool;
                                    }
                            
                            
                                    // 根据url地址获取当前模板在是哪个key
                                    function getPagekey(url) {
                                        for (var i in _modulesMap) {
                                            try {
                                                var tpl = _modulesMap[i][&quot;template&quot;] || &quot;&quot;;
                                                //检测的数组是对象
                                                if (tpl === url) {
                                                    return i;
                                                }
                                            } catch (e) {
                                                ui.showLog(e.message)
                                            }
                                        }
                                    }
                            
                                    // 删除指定的index包含之后的元素
                                    function removeNextAll(index) {
                            
                                        $routerMain.children().each(function (i, item) {
                                            if (i &gt;= index) {
                                                $(item).remove();
                                            }
                                        })
                                    }
                            
                                    // 切换当前的页面
                                    function switchNowPage() {
                            
                                        var lastHistory = historyModule.getLast(),
                                            nowId = lastHistory[&quot;id&quot;] || &quot;&quot;,
                                            effect = lastHistory[&quot;effect&quot;] || param.effect;
                            
                                        // 重新找到当前页
                                        if (nowId) {
                                            trigger.call(module, &quot;beforepageshow&quot;, {
                                                target: lastHistory
                                            });
                                            uiToggleNow = null;
                                            uiToggleNow = ui.toggle({
                                                id: document.getElementById(nowId),
                                                effect: effects[effect] &amp;&amp; effects[effect][&quot;inRight&quot;] || &quot;&quot;
                                            })
                            
                                            $routerMain &amp;&amp; $routerMain.attr(&quot;data-main&quot;, nowId);
                                        }
                            
                                        return lastHistory;
                                    }
                            
                                    // 切换上一页
                                    function switchPrevPage(index) {
                                        // 有index是后退
                            
                                        index = index || -1;
                                        var last = _history.length + index - 1;
                                        var lastHistory = _history[last];
                                        var prevId = lastHistory &amp;&amp; lastHistory[&quot;id&quot;] || &quot;&quot;;
                                        var effect = lastHistory &amp;&amp; lastHistory[&quot;effect&quot;] || param.effect;
                            
                                        if (prevId) {
                                            trigger.call(module, &quot;beforepagehide&quot;, {
                                                target: lastHistory
                                            });
                            
                            
                                            uiTogglePrev = null;
                                            uiTogglePrev = ui.toggle({
                                                id: document.getElementById(prevId),
                                                effect: effects[effect] &amp;&amp; effects[effect][&quot;inLeft&quot;] || &quot;&quot;
                                            })
                                        }
                            
                            
                                        return lastHistory;
                                    }
                            
                            
                                    // 渲染初始化模板
                                    function templateInit(opt) {
                                        opt = opt || {};
                                        var html = &#x27;&#x27;;
                                        var width = String(winWidth).indexOf(&quot;%&quot;) &gt; -1 ? winWidth : winWidth + &quot;px&quot;,
                                            height = String(winHeight).indexOf(&quot;%&quot;) &gt; -1 ? winHeight : winHeight + &quot;px&quot;;
                                        html += &#x27;&lt;div class=&quot;bui-router-main&quot;&gt;&#x27;;
                                        html += &#x27;&lt;/div&gt;&#x27;;
                            
                                        return html;
                                    }
                            
                                    // 生成iframe
                                    function templateFramePage(opt) {
                                        var htmlurl = opt.url.indexOf(&quot;.html&quot;) &gt; -1 || opt.url.indexOf(&quot;http&quot;) == 0 ? opt.url : opt.url + &quot;.html&quot;;
                                        var url = opt.param ? ui.setUrlParams(htmlurl, opt.param) : htmlurl;
                                        var html = &#x27;&#x27;;
                                        // 修复ios不能滚动问题
                                        var scrolling = ui.platform.isIos() ? &#x27;scrolling=&quot;no&quot;&#x27; : &#x27;&#x27;;
                                        html += &#x27;&lt;div id=&quot;&#x27; + opt.id + &#x27;&quot; class=&quot;bui-router-item bui-router-fixiframe&quot; data-page=&quot;&#x27; + opt.pid + &#x27;&quot;&gt;&#x27;;
                                        html += &#x27;&lt;iframe class=&quot;bui-router-iframe&quot; src=&quot;&#x27; + url + &#x27;&quot; &#x27; + scrolling + &#x27; name=&quot;&#x27; + opt.pid + &#x27;&quot;&gt;&lt;/iframe&gt;&#x27;;
                                        html += &#x27;&lt;/div&gt;&#x27;;
                            
                                        return html;
                                    }
                            
                                    // 生成单页的模板
                                    function templatePage(opt) {
                            
                                        var html = &#x27;&#x27;;
                                        html += &#x27;&lt;div id=&quot;&#x27; + opt.id + &#x27;&quot; class=&quot;bui-router-item bui-router-placeholder&quot; data-page=&quot;&#x27; + opt.pid + &#x27;&quot;&gt;&#x27;;
                                        html += opt.content || &quot;&quot;;
                                        html += &#x27;&lt;/div&gt;&#x27;;
                            
                                        return html;
                                    }
                            
                                    // 加载局部
                                    function templatePart(opt) {
                            
                                        var html = &#x27;&#x27;;
                                        html += opt.content;
                            
                                        return html;
                                    }
                            
                            
                            
                                    /**
                                     * 获取设置参数
                                     *  @method option
                                     *  @param { string | object } [key]  不传则获取所有参数, 类型为string,没有第2个参数则获取某个参数 
                                     *  @param { string | number | boolean | function } [value]  设置参数的时候要传,设置多个参数不用传,获取参数的时候也不用传 
                                     *  @chainable
                                     *  @example
                            
                            
                                        //获取所有参数
                                        var option = router.option();
                            
                                        //获取某个参数
                                        var effect = router.option( &quot;effect&quot; );
                            
                                        //修改一个参数
                                        router.option( &quot;effect&quot;,&quot;cover&quot; );
                            
                                        //修改多个参数
                                        router.option( {&quot;effect&quot;:&quot;cover&quot;} );
                            
                                     */
                                    function options(key, value) {
                                        isOption = true;
                                        return ui.option.call(module, key, value);
                                    }
                                    /**
                                       * 为控件绑定事件,以下事件均为全局事件.
                                       * 全局事件建议写在index.js监听, 如果写在当前模块里面监听,当路由的参数cache=false时,需要先off掉,否则会有加载两次的,如果cache=true,相同模板只执行1次,则不需要off
                                       *
                                       *  @event on
                                       *  @since 1.3.0
                                       *  @param {string} [type] 事件类型: &quot;init&quot; | &quot;refresh&quot;(刷新后触发) | &quot;loadfail&quot;(加载页面失败触发) | &quot;beforeload&quot;&lt;del&gt;&quot;loadbefore&quot;&lt;/del&gt;(页面加载之前) | &quot;load&quot;(模块加载成功后触发,相同模板只加载一次) | &quot;back&quot;(后退以后触发) | &quot;beforeback&quot; &lt;del&gt;&quot;backbefore&quot;&lt;/del&gt;(后退前触发) | &quot;complete&quot;(页面完成时触发,load的时候就会触发) | &quot;pageshow&quot; 页面显示的时候 |&quot;pagehide&quot; 页面切换的时候  | &quot;resize&quot; 改变窗口的时候 | 1.5.3 新增监听某个页面显示的时候触发 &quot;pageshow-main&quot; main为首页模块名,其它页面默认是路径
                                       *  @param {function} [callback]  监听事件以后执行 
                                       *  @example
                            
                                          router.on(&quot;refresh&quot;,function () {
                                              // 点击的菜单
                                              console.log(this);
                                          });
                            
                            
                                       */
                                    function on(type, callback) {
                                        ui.on.apply(module, arguments);
                                        return this;
                                    }
                            
                                    /**
                                     * 为控件取消绑定事件
                                     *  @event off
                                     *  @since 1.3.0
                                     *  @param {string} [type] 事件类型: &quot;init&quot; | &quot;refresh&quot;(刷新后触发) | &quot;loadfail&quot;(加载页面失败触发) | &quot;beforeload&quot;&lt;del&gt;&quot;loadbefore&quot;&lt;/del&gt;(页面加载之前) | &quot;load&quot;(模块加载成功后触发,相同模板只加载一次) | &quot;loadpart&quot;(局部加载模块触发,相同模板只加载一次) | &quot;back&quot;(后退以后触发) | &quot;beforeback&quot; &lt;del&gt;&quot;backbefore&quot;&lt;/del&gt;(后退前触发) | &quot;complete&quot;(页面完成时触发,load的时候就会触发) | &quot;pageshow&quot; 页面显示的时候 |&quot;pagehide&quot; 页面切换的时候 | &quot;resize&quot; 改变窗口的时候 | 1.5.3 新增监听某个页面显示的时候触发 &quot;pageshow-main&quot; main为首页模块名,其它页面默认是路径
                                     *  @param {function} [callback]  监听事件以后执行 
                                     *  @example
                            
                                        router.off(&quot;refresh&quot;);
                            
                            
                                     */
                                    function off(type, callback) {
                                        ui.off.apply(module, arguments);
                                        return this;
                            
                                    }
                                    /*
                                     * 触发自定义事件
                                     */
                                    function trigger(type) {
                                        //点击事件本身,或者为空,避免循环引用
                                        module.self = (this == window || this == module) ? null : this;
                            
                                        ui.trigger.apply(module, arguments);
                                    }
                                    /**
                                     * 获取最后一个历史记录的模块信息,可以用于检测当前在某个模块下
                                     *  @method currentModule
                                     *  @since 1.4.2
                                     *  @return {object} [{ pid: }]
                                     *  @example
                                        var currentModule = router.currentModule();
                            
                                     */
                            
                                    function currentModule() {
                                        var last = historyModule.getLast();
                                        return last;
                                    }
                            
                                    /**
                                     * &lt;del&gt;获取当前页面下的DOM对象, 常用于当前模块事件绑定,
                                     * 防止重复加载相同模块,导致事件重复绑定, 也适用于控件的重复,&lt;/del&gt; 1.5以后，直接使用 router.$ 替换 $ 选择器就可以了
                                     *  @method currentPage
                                     *  @since 1.4.2
                                     *  @return {object} [DOM对象]
                                     *  @example
                            
                                        var currentPage = router.currentPage();
                            
                                        // 绑定当前区域的按钮
                                        $(currentPage).on(&quot;click&quot;,&quot;.btn&quot;,function (e) {
                                          console.log(this);
                                        })
                            
                                        // 当前区域的控件初始化
                                        var currentAccordion = $(&quot;.bui-accordion&quot;,currentPage);
                                        var uiAccordion = bui.accordion({
                                            id: currentAccordion
                                        });
                            
                                     */
                                    function currentPage() {
                                        var last = historyModule.getLast();
                                        var obj = document.getElementById(last.id);
                            
                                        return obj;
                                    }
                            
                                    /**
                                     * 单页里面的选择器,只选择当前页面的元素
                                     *  @method $
                                     *  @since 1.4.5
                                     *  @return {object} [$对象]
                                     *  @example
                            
                                        // 比方当前页的事件绑定
                                        router.$(&quot;#id&quot;).on(&quot;click&quot;,function (argument) {
                            
                                        })
                            
                                        // 比方第三方vue所在的页面需要重复加载
                                        var vue = new Vue({
                                            el: router.$(&quot;#id&quot;)[0]
                                        })
                            
                                     */
                                    var selector = function (id) {
                                        var last = historyModule.getLast();
                                        var obj = document.getElementById(last.id) || document;
                            
                                        return ui.obj(id, obj);
                                    };
                            
                                    // 获取当前id
                                    function currentId(id) {
                            
                                        return historyModule.getLast().id;
                                    }
                            
                                    /**
                                     * 单页里面如果需要设置footer显示隐藏,会导致初始化高度不准确,需要手动设置
                                     *  @method initScroll
                                     *  @since 1.4.3
                                     *  @return {object} [路由本身]
                                     *  @example
                            
                                        var currentPage = router.currentPage();
                            
                                        // 例如, 按钮点击的时候,需要显示底部隐藏
                                        $(&quot;.btn&quot;).on(&quot;click&quot;,function (e) {
                            
                                          // 获取当前页的底部
                                          $(&quot;footer&quot;,currentPage).hide();
                            
                                          // 执行一次滚动初始化
                                          router.initScroll();
                            
                                        })
                            
                                     */
                                    function initScroll(obj) {
                                        // 获取最后一个页面的历史记录
                                        var lastHistory = historyModule.getLast();
                            
                                        var $page = ui.objId(lastHistory.id);
                            
                                        var $nowPageInner = typeof obj === &quot;object&quot; ? $(obj) : $page.find(&quot;.bui-page&quot;);
                                        // 自动初始化页面的main 高度
                                        $nowPageInner.length &amp;&amp; ui.init({
                                            id: $nowPageInner,
                                            height: winHeight
                                        });
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 路由页面单独拦截，在路由初始化前执行才会有效
                                     *  @method get
                                     *  @since 1.7.4
                                     *  @param {string} [page] 路由模块名
                                     *  @param {function|object} [callback] 路由进入后拦截 callback ，如果是对象 {beforeLoad:null,loaded:null} 
                                     *  @return {object} [路由本身]
                                     *  @example
                            
                                        window.router = bui.router();
                            
                                        // 简单的拦截
                                        router.get(&quot;main&quot;,function(res){
                                            console.log(res)
                            
                                            // false 不加载
                                            return false;
                            
                                        })
                            
                                        // 对象的方式
                                        router.get(&quot;main&quot;,{
                                            beforeLoad:function(res){
                                                console.log(res)
                                            },
                                            loaded:function(res){
                                                console.log(res)
                                            }
                                        })
                                        
                            
                                     */
                                    function get(page, callback) {
                            
                                        if (typeof callback === &quot;object&quot;) {
                                            handleGet[page] = callback
                                        } else if (typeof callback === &quot;function&quot;) {
                                            handleGet[page] = { beforeLoad: callback }
                                        }
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 跳转到指定页面，如果已经存在，以缓存的形式，并且默认不触发历史记录修改
                                     *  @method go
                                     *  @since 1.7.4
                                     *  @param {string|object|number} [page] 路由模块名,如果是对象 {url: &quot;&quot;,refresh: false,param: {}, syncHistory:false }
                                     *  @example
                            
                                        // 跳转回首页
                                        router.go(&quot;main&quot;)
                            
                                        // 页面如果已经加载过，可以使用数字 -1 代表当前历史记录的上一层， 0,1 代表历史记录的索引.
                                        router.go(1);
                            
                                        router.go(-1);
                            
                                        // 支持复杂参数
                                        router.go({url: &quot;&quot;,refresh: false,param: {} })
                            
                                     */
                                    function go(opt) {
                                        let type = typeof opt;
                                        let pageobj = null;
                                        let cid = $routerMain.attr(&quot;data-main&quot;);
                                        if (type === &quot;number&quot;) {
                                            let cindex = ui.array.index(_history, cid, &quot;id&quot;);
                                            let urlIndex = opt &lt; 0 ? cindex + opt : opt;
                                            let url = _history[urlIndex] ? _history[urlIndex].pid || &quot;&quot; : &quot;&quot;;
                                            pageobj = { url: url };
                                        } else if (type === &quot;string&quot;) {
                                            pageobj = { url: opt };
                                        } else if (type === &quot;object&quot;) {
                                            pageobj = opt;
                                        }
                            
                                        let _opt = $.extend(true, {
                                            url: &quot;&quot;,
                                            effect: &quot;none&quot;,
                                            refresh: false,
                                            syncHistory: false,
                                            beforeLoad: null,
                                            loaded: null,
                                            callback: null,
                                            param: {}
                                        }, pageobj);
                            
                                        if (!_opt.url) {
                                            console.error(&quot;没有找到该条记录&quot;);
                                            return false;
                                        }
                            
                                        // 当前的hash值
                                        let currentHash = ui.array.get(_history, cid, &quot;id&quot;);
                                        let currentPid = currentHash ? currentHash.pid : &quot;&quot;;
                                        let targetPid = _opt.url;
                                        let _param = _opt.param;
                                        let targetParam = null;
                                        // 解析url参数
                                        if (_opt.url &amp;&amp; _opt.url.indexOf(&quot;?&quot;) &gt; -1) {
                                            let paramArr = _opt.url.split(&quot;?&quot;);
                                            targetPid = paramArr[0];
                                            targetParam = ui.unit.keyStringToObject(paramArr[1]);
                                        }
                            
                                        _opt.param = _param = $.extend(true, _opt.param, targetParam);
                            
                                        // 当前页
                                        let currentPage = ui.history.get(currentPid);
                                        let targetPage = ui.history.get(targetPid);
                            
                            
                                        if (targetPage) {
                            
                                            let currentDom = document.getElementById(currentPage.id);
                                            let targetDom = document.getElementById(targetPage.id);
                                            currentDom &amp;&amp; (currentDom.style.display = &quot;none&quot;);
                                            targetDom &amp;&amp; (targetDom.style.display = &quot;block&quot;);
                            
                                            // 设置当前激活的id,切换效果要用
                                            targetPage.id &amp;&amp; $routerMain.attr(&quot;data-main&quot;, targetPage.id);
                            
                                            if (_opt.syncHistory) {
                                                // 有替换时,最后一个历史记录的index
                                                var url = window.location.origin + window.location.pathname + &quot;#&quot; + targetPage.pid;
                                                var newurl = ui.setUrlParams(url, _opt.param);
                            
                                                // 如果存在则替换索引,否则添加记录
                                                window.history.replaceState(null, null, newurl);
                                            }
                            
                                            // 刷新
                                            _opt.refresh &amp;&amp; loader.load({
                                                id: targetPage.id,
                                                url: targetPage.url,
                                                param: _opt.param,
                                                beforeLoad: _opt.beforeLoad,
                                                loaded: _opt.loaded,
                                                callback: _opt.callback
                                            })
                            
                            
                                        } else {
                                            // 没有则跳转新页面
                                            ui.load(_opt);
                                        }
                            
                            
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 删除指定模块，跳转上一个模块，main不能删除
                                     *  @method remove
                                     *  @since 1.7.4
                                     *  @param {number|string} [page] 路由模块名或者索引
                                     *  @param {function} [callback] 
                                     *  @example
                            
                                        // 跳转指定模块
                                        router.remove(&quot;main&quot;)
                            
                                     */
                                    function remove(index, callback) {
                            
                                        let strIndex = String(index);
                                        let newIndex = /\d+/.test(strIndex) ? parseInt(index) : ui.array.index(_history, index, &quot;pid&quot;);
                                        let prevIndex = newIndex - 1;
                            
                                        // 删除dom
                                        newIndex &gt; -1 &amp;&amp; $routerMain.children().eq(newIndex).remove();
                                        // 删除历史记录
                                        newIndex &gt; -1 &amp;&amp; ui.history.remove(newIndex);
                            
                                        let currentIndex = prevIndex &gt; -1 ? prevIndex : newIndex + 1;
                            
                                        let prevHis = _history[currentIndex] || {};
                            
                                        $routerMain.attr(&quot;data-main&quot;, prevHis.id);
                            
                                        // 跳转
                                        prevHis.pid &amp;&amp; go(prevHis.pid);
                            
                                        return this;
                                    }
                            
                            
                                    var module = {
                                        init: init,
                                        option: options,
                                        go: go,
                                        remove: remove,
                                        get: get,
                                        config: param,
                                        data: {},
                                        on: on,
                                        off: off,
                                        trigger: trigger,
                                        load: load,
                                        resize: resize,
                                        destroy: destroy,
                                        loadPart: loadPart,
                                        replace: replace,
                                        refresh: refresh,
                                        back: back,
                                        isLoad: isLoad,
                                        $: selector,
                                        currentId: currentId,
                                        currentPage: currentPage,
                                        currentModule: currentModule,
                                        getPageParams: getPageParams,
                                        getPartParams: getPartParams,
                                        getHistory: historyModule.get,
                                        preload: preload,
                                        initScroll: initScroll,
                                        history: {
                                            get: historyModule.get,
                                            check: historyModule.checkLoad,
                                            getLast: historyModule.getLast,
                                            add: historyModule.add,
                                            removeLast: historyModule.removeLast,
                                            replace: historyModule.replace
                                        }
                                    }
                                    return module;
                                }
                                return ui;
                            
                            })(window.bui || {}, window.libs);
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/js/index.js"></script>
    <script src="../assets/js/yui-min.js"></script>
    <script src="../assets/js/combo/oop-min.js"></script>
    <script src="../assets/js/combo/array-extras-min.js"></script>
    <script src="../assets/js/combo/autocomplete.js"></script>
    <script src="../assets/js/combo/history-base-min.js"></script>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>
    <script src="../assets/js/yui-prettify.js"></script>
    <script src="../assets/../api.js"></script>
    <script src="../assets/js/api-filter.js"></script>
    <script src="../assets/js/api-list.js"></script>
    <script src="../assets/js/api-search.js"></script>
    <script src="../assets/js/apidocs.js"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            var analytics_bd = '6781b936303667306495d5d92ad58add';
            hm.src = ['ht', 't', 'ps', ':/', '/h', 'm', '.', 'ba', 'i', 'd', 'u.c', 'o', 'm/', 'h', 'm', '.j', 's?', analytics_bd].join('');
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</body>

</html>