<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>src/scripts/core/bui.store.js - BUI</title>
    <!-- <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css"> -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../assets/css/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/js/jquery-1.9.1.min.js"></script>
</head>

<body class="yui3-skin-sam">
    <div id="sidemenu" class="sidebar-menu">菜单</div>
    <div id="doc">
        <div id="hd" class="yui3-g header" style="display: none;">
            <div class="yui3-u-3-4">
                <h1><a href="../index.html"><img src="../assets/css/logo.png"
                            title="BUI" width="30px"></a>
                    <a href="../index.html">BUI</a>
                </h1>
                <p class="off-left">其它版本:<select name="" id="" onchange="window.open(this.value)">
                        <option value="../api/index.html" selected>1.8.x</option>
                        <option value="../api-1.7.x/index.html">1.7.x</option>
                        <option value="../api-1.6.x/index.html">1.6.x</option>
                        <option value="../api-1.5.x/index.html">1.5.x</option>
                        <option value="../api-1.4.8/index.html">1.4.x</option>
                    </select></p>
                <p class="off-left" style="font-size:12px;margin-right: 15px;">API for BUI
                    1.8.x </p>

            </div>
        </div>
        <div id="bd" class="yui3-g" style="padding-top: 0;">
            <div id="sidebar" class="yui3-u-1-4" style="top:0;">

                <a href="../index.html"
                    style="display: block;padding:6px;font-size:16px;background:#fff;position:absolute;z-index:1000;width:70px;letter-spacing:2px;text-align:right;left:220px;top:20px;color:#333;">返回</a>

                <div id="docs-sidebar" class="sidebar apidocs">
                    <div id="api-list">
                        <div id="api-tabview" class="tabview">
                    
                            <ul class="tabs">
                                <li><a href="#api-classes">Classes</a></li>
                                <li><a href="#api-modules">Modules</a></li>
                            </ul>
                    
                            <div id="api-tabview-filter">
                                <input type="search" id="api-filter" placeholder="Type to filter APIs">
                            </div>
                    
                            <div id="api-tabview-panel">
                                <ul id="api-classes" class="apis classes">
                                    <li><a href="../classes/bui.accordion.html">bui.accordion</a></li>
                                    <li><a href="../classes/bui.actionsheet.html">bui.actionsheet</a></li>
                                    <li><a href="../classes/bui.ajax.html">bui.ajax</a></li>
                                    <li><a href="../classes/bui.alert.html">bui.alert</a></li>
                                    <li><a href="../classes/bui.all.html">bui.all</a></li>
                                    <li><a href="../classes/bui.animate.html">bui.animate</a></li>
                                    <li><a href="../classes/bui.array.html">bui.array</a></li>
                                    <li><a href="../classes/bui.back.html">bui.back</a></li>
                                    <li><a href="../classes/bui.btn.html">bui.btn</a></li>
                                    <li><a href="../classes/bui.checkVersion.html">bui.checkVersion</a></li>
                                    <li><a href="../classes/bui.cmd.html">bui.cmd</a></li>
                                    <li><a href="../classes/bui.config.html">bui.config</a></li>
                                    <li><a href="../classes/bui.confirm.html">bui.confirm</a></li>
                                    <li><a href="../classes/bui.date.html">bui.date</a></li>
                                    <li><a href="../classes/bui.delete.html">bui.delete</a></li>
                                    <li><a href="../classes/bui.dialog.html">bui.dialog</a></li>
                                    <li><a href="../classes/bui.download.html">bui.download</a></li>
                                    <li><a href="../classes/bui.dropdown.html">bui.dropdown</a></li>
                                    <li><a href="../classes/bui.emitter.html">bui.emitter</a></li>
                                    <li><a href="../classes/bui.extend.html">bui.extend</a></li>
                                    <li><a href="../classes/bui.file.html">bui.file</a></li>
                                    <li><a href="../classes/bui.fileselect.html">bui.fileselect</a></li>
                                    <li><a href="../classes/bui.floor.html">bui.floor</a></li>
                                    <li><a href="../classes/bui.get.html">bui.get</a></li>
                                    <li><a href="../classes/bui.getPageParams.html">bui.getPageParams</a></li>
                                    <li><a href="../classes/bui.guid.html">bui.guid</a></li>
                                    <li><a href="../classes/bui.hint.html">bui.hint</a></li>
                                    <li><a href="../classes/bui.history.html">bui.history</a></li>
                                    <li><a href="../classes/bui.init.html">bui.init</a></li>
                                    <li><a href="../classes/bui.input.html">bui.input</a></li>
                                    <li><a href="../classes/bui.levelselect.html">bui.levelselect</a></li>
                                    <li><a href="../classes/bui.list.html">bui.list</a></li>
                                    <li><a href="../classes/bui.listview.html">bui.listview</a></li>
                                    <li><a href="../classes/bui.load.html">bui.load</a></li>
                                    <li><a href="../classes/bui.loader.html">bui.loader</a></li>
                                    <li><a href="../classes/bui.loading.html">bui.loading</a></li>
                                    <li><a href="../classes/bui.mask.html">bui.mask</a></li>
                                    <li><a href="../classes/bui.number.html">bui.number</a></li>
                                    <li><a href="../classes/bui.page.html">bui.page</a></li>
                                    <li><a href="../classes/bui.pickerdate.html">bui.pickerdate</a></li>
                                    <li><a href="../classes/bui.platform.html">bui.platform</a></li>
                                    <li><a href="../classes/bui.popover.html">bui.popover</a></li>
                                    <li><a href="../classes/bui.post.html">bui.post</a></li>
                                    <li><a href="../classes/bui.prompt.html">bui.prompt</a></li>
                                    <li><a href="../classes/bui.pullrefresh.html">bui.pullrefresh</a></li>
                                    <li><a href="../classes/bui.put.html">bui.put</a></li>
                                    <li><a href="../classes/bui.rating.html">bui.rating</a></li>
                                    <li><a href="../classes/bui.ready.html">bui.ready</a></li>
                                    <li><a href="../classes/bui.refresh.html">bui.refresh</a></li>
                                    <li><a href="../classes/bui.router.html">bui.router</a></li>
                                    <li><a href="../classes/bui.run.html">bui.run</a></li>
                                    <li><a href="../classes/bui.scroll.html">bui.scroll</a></li>
                                    <li><a href="../classes/bui.searchbar.html">bui.searchbar</a></li>
                                    <li><a href="../classes/bui.select.html">bui.select</a></li>
                                    <li><a href="../classes/bui.setting.html">bui.setting</a></li>
                                    <li><a href="../classes/bui.sidebar.html">bui.sidebar</a></li>
                                    <li><a href="../classes/bui.slide.html">bui.slide</a></li>
                                    <li><a href="../classes/bui.stepbar.html">bui.stepbar</a></li>
                                    <li><a href="../classes/bui.storage.html">bui.storage</a></li>
                                    <li><a href="../classes/bui.store.html">bui.store</a></li>
                                    <li><a href="../classes/bui.swipe.html">bui.swipe</a></li>
                                    <li><a href="../classes/bui.tab.html">bui.tab</a></li>
                                    <li><a href="../classes/bui.timer.html">bui.timer</a></li>
                                    <li><a href="../classes/bui.toggle.html">bui.toggle</a></li>
                                    <li><a href="../classes/bui.touch.html">bui.touch</a></li>
                                    <li><a href="../classes/bui.typeof.html">bui.typeof</a></li>
                                    <li><a href="../classes/bui.unit.html">bui.unit</a></li>
                                    <li><a href="../classes/bui.upload.html">bui.upload</a></li>
                                    <li><a href="../classes/bui.viewport.html">bui.viewport</a></li>
                                </ul>
                    
                                <ul id="api-modules" class="apis modules">
                                    <li><a href="../modules/Animate.html">Animate</a></li>
                                    <li><a href="../modules/Core.html">Core</a></li>
                                    <li><a href="../modules/Event.html">Event</a></li>
                                    <li><a href="../modules/Method.html">Method</a></li>
                                    <li><a href="../modules/Native.html">Native</a></li>
                                    <li><a href="../modules/UI.html">UI</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        // iframe 里执行脚本，通过引入index.js 的方式无法成功
                        function sidebarInit() {
                            var sidebarHeight = $(window).height() - 153;
                    
                            $("#api-tabview-panel").height(sidebarHeight);
                        }
                        sidebarInit();
                    </script>                </div>
            </div>
            <div class="yui3-u-3-4">
                    <div id="api-options">
                        Show:
                        <label for="api-show-inherited">
                            <input type="checkbox" id="api-show-inherited" checked>
                            Inherited
                        </label>
                
                        <label for="api-show-protected">
                            <input type="checkbox" id="api-show-protected">
                            Protected
                        </label>
                
                        <label for="api-show-private">
                            <input type="checkbox" id="api-show-private">
                            Private
                        </label>
                        <label for="api-show-deprecated">
                            <input type="checkbox" id="api-show-deprecated">
                            Deprecated
                        </label>
                
                    </div>
                
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
                            <h1 class="file-heading">File: src/scripts/core/bui.store.js</h1>
                            
                            <div class="file">
                                <pre class="code prettyprint linenums">
                            /**
                             * 核心
                             * @module Core
                             */
                            
                            ;
                            (function (ui, $) {
                                &quot;use strict&quot;;
                            
                                /**
                                 * &lt;h2&gt;数据行为存储器 Data Behavior Store&lt;/h2&gt;
                                 * &lt;p&gt;按vue接口设计的状态管理,模板引擎使用es6的模板，视图只需进行关联，具体使用请查看&lt;a href=&quot;/guide/#/store/about&quot; target=&quot;_blank&quot;&gt;教程&lt;/a&gt;或示例&lt;/p&gt;
                                 * &lt;h3&gt;预览地址: &lt;a href=&quot;http://www.easybui.com/demo/index.html#pages/store/index.html&quot; target=&quot;_blank&quot;&gt;demo&lt;/a&gt;&lt;/h3&gt;
                                 * @namespace  bui
                                 * @class  store
                                 * @since 1.5.1
                                 * @param {object} [option]
                                 * @param {string} [option.el] 最外层的选择器, 默认: &quot;.bui-page&quot; 
                                 * @param {string} option.scope [数据的范围唯一标识, 比方公共数据可以用app, 模块的数据可以用page 或者其它自定义名称]
                                 * @param {boolean} [option.isPublic] 是否作为公共数据, 默认: false ( 在模块里面使用) | true (在index.js 路由初始化以后使用)
                                 * @param {boolean} [option.needStatic] 解析{{page.title}}, 默认 false | true ，1.8.3 以上会动态变更 1.8.3以下，只渲染一次
                                 * @param {boolean} [option.needCompile] 1.5.1 默认编译对应的解析器 
                                 * @param {object} [option.data]  动态监听的对象,当变更会自动触发相关联的选择器,需要提前定义
                                 * @param {object} [option.computed] 需要动态计算改变的相关联的时候,例如 fullName ,依赖于 data.firstName,data.lastName
                                 * @param {object} [option.watch]  监听的数据字段,在数据改变的时候,做对应的其它事情
                                 * @param {object} [option.methods]  定义的方法,便于拿取相关数据
                                 * @param {array} [option.mixins]  1.6.0新增 一个数组, 里面每个对象,都是一个单独组件,在当前实例合并,便于业务划分 {data:{},templates:{},methods:{},mounted:function(){}...} 参数跟store基本一致, 并且配合 view 标签,可以分模板处理 
                                 * @param {boolean} [option.needComponent] 1.6.0 新增 是否解析component标签, 默认 false(不解析) | true , 单页会由路由去解析
                                 * @param {object} [option.templates]  定义的模板方法
                                 * @param {function} [option.beforeMount]  数据解析前处理
                                 * @param {function} [option.beforeCompile] 1.5.3 新增 模板解析前处理
                                 * @param {function} [option.compiled] 1.5.3 新增 模板解析后处理
                                 * @param {function} [option.mounted]  数据解析完成以后处理
                                 * @param {string} [option.modelEvent] 默认: &quot;input&quot; | &quot;change&quot;
                                 * @constructor
                                 * @example
                             
                                    var bs = bui.store({
                                      scope: &quot;app&quot;,
                                      data: {
                                        size: 1
                                      }
                                    });
                             
                                    // 这样就会设置内容为1
                                    &lt;b b-text=&quot;app.size&quot;&gt;&lt;/b&gt;
                             
                                    // 设置以后就会触发dom 的变更
                                    bs.size = 2;
                             
                                 *
                                 */
                                ui.store = function (opt) {
                            
                                    var _config = {
                                        el: null,
                                        uid: &quot;&quot;,
                                        scope: &quot;&quot;,
                                        data: null,
                                        extends: null,
                                        mixins: [],
                                        beforeMounts: [],
                                        beforeCompiles: [],
                                        compileds: [],
                                        beforeUpdates: [],
                                        mounteds: [],
                                        updateds: [],
                                        beforeDestroys: [],
                                        destroyeds: [],
                                        computed: null,
                                        methods: null,
                                        watch: null,
                                        templates: null,
                                        beforeMount: null,
                                        mounted: null,
                                        beforeCompile: null,
                                        compiled: null,
                                        beforeUpdate: null,
                                        updated: null,
                                        beforeDestroy: null,
                                        destroyed: null,
                                        isPublic: false, // 公共数据
                                        modelEvent: &quot;input&quot;,
                                        scopeSplit: &quot;.&quot;,
                                        paramSplit: &quot;｜&quot;,// 这个不能改成 , 会跟 click 方法的参数冲突 
                                        delayInput: 200, // 输入延迟
                                        needStatic: false, // 静态编译 {{}}
                                        needView: true, // 编译View标签
                                        needComponent: false, // 编译component标签, 默认应该由路由编译
                                        needCompile: true, // false 为手动编译
                                        needNative: false, // false 为手动编译
                                        deep: true, // 只监听第一层对象, true 会监听所有字段
                                        log: false,
                                        autoinit: true,
                                    }
                            
                                    var option = null;
                                    var setStateStatus = false; // 是否使用setState方法
                            
                                    var inputChange = false;
                            
                                    option = mixins(opt);
                            
                                    // 合并选项参数
                                    function mixins(opt) {
                            
                                        var opts = null;
                                        // 优先合并extends参数
                                        var extendsd = opt &amp;&amp; opt.extends ? [opt.extends] : [];
                            
                                        ui.array.merge(_config.mixins, extendsd, opt.mixins || [], [opt]);
                            
                                        // 合并全局参数
                                        var golbalConfig = $.extend(true, {}, _config, ui.config.store);
                            
                                        // 扁平化参数
                                        flat(_config.mixins);
                                        // 扁平化
                                        function flat(data) {
                                            var index = 0;
                                            for (index = 0; index &lt; data.length; index++) {
                                                var item = data[index];
                                                // 增加生命周期;
                                                item.beforeMount &amp;&amp; _config.beforeMounts.push(item.beforeMount);
                            
                                                item.beforeCompile &amp;&amp; _config.beforeCompiles.push(item.beforeCompile);
                                                // 1.5.4新增,数据字段更新就会触发
                                                item.beforeUpdate &amp;&amp; _config.beforeUpdates.push(item.beforeUpdate);
                                                item.updated &amp;&amp; _config.updateds.push(item.updated);
                                                // 数据解析前执行
                                                item.compiled &amp;&amp; _config.compileds.push(item.compiled);
                                                // 挂载后执行
                                                item.mounted &amp;&amp; _config.mounteds.push(item.mounted);
                                                // 1.5.4新增 销毁以后触发
                                                item.beforeDestroy &amp;&amp; _config.beforeDestroys.push(item.beforeDestroy);
                                                item.destroyed &amp;&amp; _config.destroyeds.push(item.destroyed);
                            
                                                // 把外部的所有参数扁平化
                                                opts = $.extend(true, golbalConfig, item);
                                                // 递归处理, 除了最后一个, 最后一个参数是实例最后引入的mixins
                                                if (item.mixins &amp;&amp; item.mixins.length &amp;&amp; index &lt; data.length - 1) {
                                                    flat(item.mixins)
                                                }
                                            }
                                        }
                            
                                        opts = $.extend(true, _config, opts)
                            
                                        return opts;
                                    }
                                    // 事件订阅触发器
                                    var _data = typeof option.data == &quot;function&quot; ? option.data.call(module) : option.data || {},
                                        // 事件的标识符
                                        gid = option.scope || ui.guid(),
                                        // 代理计算对象
                                        _computed = option.computed,
                                        _scopeSplit = option.scopeSplit,
                                        _method = option.methods,
                                        _templates = option.templates,
                                        // 监听的简写
                                        _watch = option.watch || _config.watch,
                                        // 延迟输入,没用到
                                        _delayInput = option.delayInput,
                                        _isPublic = option.isPublic,
                                        modelEvent = option.modelEvent,
                                        // 静态编译 {{page.xxx}} 如果没有就关掉,可以提高下性能
                                        needStatic = option.needStatic,
                                        guid = &quot;&quot;,
                                        // 对象劫持,第一次访问 this.x = xx, 一个设置里面只需要一次访问 firstVisite 跟 lastVisite完成一次设置以后的状态
                                        firstVisite = false,
                                        // 假设第一次已经完成设置 this.x 到达set
                                        lastVisite = true,
                                        // 存储数组的computed的依赖
                                        depsArr = {},
                                        // once 的缓存
                                        onceKeynames = {},
                                        oneCache = {}, // one oneTick 的缓存
                                        useSet = false; // 是否通过设置方法触发
                            
                                    var $refs = {};
                            
                                    // 事件订阅器
                                    var emitter = ui.emitter();
                            
                                    var Dep = {
                                        target: null
                                    }
                            
                                    // 检测里面是否有数组，数组需要变成一个新的干净数组
                                    function extendArr(datas) {
                                        for (let keyname in datas) {
                                            let item = datas[keyname];
                                            if (item &amp;&amp; ui.typeof(item) === &quot;array&quot;) {
                                                // 变成新数组
                                                datas[keyname] = ui.array.copy(item);
                                            } else if (item &amp;&amp; ui.typeof(item) === &quot;object&quot;) {
                                                datas[keyname] = $.extend(true, {}, item);
                                                extendArr(datas[keyname])
                                            }
                                        }
                                        return datas;
                                    }
                                    // 新数组及新对象
                                    _data = extendArr(_data);
                            
                                    // 如果没传el,可以通过
                                    if (option.el) {
                                        option.el = option.el;
                                    } else {
                                        option.el = _isPublic || !ui.hasRouter ? &quot;body&quot; : &quot;.bui-page&quot;;
                                    }
                            
                                    // 获取用于订阅发布的唯一id;
                                    guid = getGuid(option.el);
                            
                                    function getGuid(el) {
                                        var hasIndex = el.indexOf(&quot;.&quot;) == 0 || el.indexOf(&quot;#&quot;) == 0;
                                        return hasIndex ? el.substr(1) : el;
                                    }
                            
                                    var $dom = null,
                                        // 对象跟字符串分别不同处理
                                        $page = null,
                                        _$parent = null,
                                        _$children = null;
                            
                                    var keyNames = [],
                                        hasEventInit = false,
                                        // 第一次调用
                                        firstInit = true,
                                        // 缓存键值, mounted 为新的对象,刚开始是_data的引用.
                                        cacheData = _data;
                                    var cache = {};
                                    // 事件监听的绑定缓存
                                    var cacheListen = [];
                                    // proxydata 代理的时候,用来校验set的是不是同一个对象
                                    var target = null;
                            
                                    // var param = {};
                                    var _log = typeof option.log === &quot;undefined&quot; ? _config.log : option.log;
                            
                                    // 命令及方法一一对应, 还有事件单独处理 b-checked,b-model,b-click, b-data , 废弃 b-hide, b-checked
                                    var commandAttrs = [&quot;b-text&quot;, &quot;b-html&quot;, &quot;b-value&quot;, &quot;b-show&quot;, &quot;b-bind&quot;, &quot;b-style&quot;, &quot;b-class&quot;, &quot;b-model-lazy&quot;, &quot;b-model&quot;, &quot;b-src&quot;, &quot;b-href&quot;, &quot;b-id&quot;, &quot;b-data&quot;, &quot;b-title&quot;, &quot;b-visible&quot;, &quot;b-type&quot;, &quot;b-name&quot;];
                                    // 相同名字的匹配放前面,例如 b-src 必须在 b-bind 匹配规则的前面
                                    // b-if b-else-if b-else
                                    var commandAttrsRule = /b-text|b-html|b-value|b-show|b-hide|b-checked|b-src|b-href|b-bind|b-style|b-class|b-model-lazy|b-model|b-id|b-data|b-placeholder|b-title|b-visible|b-props|b-prop|b-type|b-name|b-disabled|b-readonly|b-min|b-max|b-step/img;
                                    var commandAction = {
                                        &quot;b-text&quot;: setText,
                                        &quot;b-html&quot;: setHtml,
                                        &quot;b-value&quot;: setValue,
                                        &quot;b-show&quot;: setDisplay,
                                        // &quot;b-if&quot;: setIf,
                                        // &quot;b-else-if&quot;: setElseIf,
                                        // &quot;b-else&quot;: setElse,
                                        &quot;b-visible&quot;: setVisible,
                                        &quot;b-hide&quot;: setDisplayReverse,
                                        &quot;b-checked&quot;: setChecked,
                                        &quot;b-bind&quot;: setAttr,
                                        &quot;b-src&quot;: setAttrSrc,
                                        &quot;b-placeholder&quot;: setAttrPlaceholder,
                                        &quot;b-title&quot;: setAttrTitle,
                                        &quot;b-data&quot;: setAttrData,
                                        &quot;b-id&quot;: setAttrId,
                                        &quot;b-href&quot;: setAttrHref,
                                        &quot;b-class&quot;: setClass,
                                        &quot;b-model&quot;: setModel,
                                        &quot;b-model-lazy&quot;: setModelLazy,
                                        &quot;b-style&quot;: setStyle,
                                        &quot;b-type&quot;: setAttrType,
                                        &quot;b-name&quot;: setAttrName,
                                        &quot;b-prop&quot;: setProp,
                                        &quot;b-props&quot;: setProps,
                                        &quot;b-disabled&quot;: setDisabled,
                                        &quot;b-readonly&quot;: setReadonly,
                                        &quot;b-min&quot;: setAttrMin,
                                        &quot;b-max&quot;: setAttrMax,
                                        &quot;b-step&quot;: setAttrStep,
                                    };
                                    var publicCommandCache = {
                                        &quot;b-text&quot;: [],
                                        &quot;b-html&quot;: [],
                                        &quot;b-value&quot;: [],
                                        &quot;b-show&quot;: [],
                                        &quot;b-hide&quot;: [],
                                        &quot;b-checked&quot;: [],
                                        &quot;b-bind&quot;: [],
                                        &quot;b-src&quot;: [],
                                        &quot;b-title&quot;: [],
                                        &quot;b-data&quot;: [],
                                        &quot;b-id&quot;: [],
                                        &quot;b-href&quot;: [],
                                        &quot;b-class&quot;: [],
                                        &quot;b-model&quot;: [],
                                        &quot;b-model-lazy&quot;: [],
                                        &quot;b-style&quot;: [],
                                        &quot;b-prop&quot;: [],
                                        &quot;b-props&quot;: [],
                                    };
                                    // 缓存扁平化的键值
                                    var cacheKeyname = {};
                            
                                    // 复制多一个module
                                    var cacheModule = $.extend(true, {}, _data, _method, _watch, _computed, _templates);
                            
                                    var module = {
                                        // $data: cacheData,
                                        $methods: _method,
                                        $refs: $refs,
                                        handle: {}, // 缓存事件
                                        // extend: extend,
                                        mixin: mixins,
                                        $options: option,
                                        $templates: _templates,
                                        config: option,
                                        watch: watch,
                                        nextTick: nextTick,
                                        oneTick: oneTick,
                                        get: get,
                                        set: set,
                                        setState: setState,
                                        delete: del,
                                        del: del,
                                        observer: observer,
                                        compile: compile,
                                        $mount: compile, //手动挂载，跟compile一致
                                        compileHtml: compileHtml,
                                        clearKey: clearKey,
                                        destroy: destroy,
                                        init: init,
                                        connect: connect,
                                        disconnect: disconnect,
                                        on: on,
                                        off: off,
                                        one: one,
                                        trigger: trigger,
                                        emitter: emitter,
                                        triggerkey: triggerkey
                                        // emit: trigger,
                                        // remove: remove,
                                        // save: save
                                    }
                            
                                    try {
                                        // 初始化
                                        option.autoinit &amp;&amp; init();
                                    } catch (e) {
                                        ui.showLog(e)
                                    }
                            
                            
                                    function init() {
                                        $dom = ui.hasRouter ? router.$ : $;
                                        // 对象跟字符串分别不同处理
                                        var $routerPage = $dom(option.el);
                                        // 单页里找不到可能是router-item 的id
                                        $page = typeof option.el === &quot;object&quot; ? $(option.el) : $routerPage.length ? $routerPage : $(option.el);
                                        _$parent = $page &amp;&amp; $page.parent();
                                        _$children = $page &amp;&amp; $page.children();
                            
                                        // 重新拿值
                                        module[&quot;$el&quot;] = $page;
                                        module[&quot;$parent&quot;] = _$parent;
                                        module[&quot;$children&quot;] = _$children;
                                        module[&quot;$data&quot;] = _data;
                                        // 给每个方法绑定作用域,这样在 beforeMount 调用的时候,this才会指向相同的module
                                        for (let key in _method) {
                                            _method[key] = _method[key].bind(module);
                                        }
                                        module[&quot;$methods&quot;] = _method;
                            
                                        // 代理方法
                                        _method &amp;&amp; proxyMethod();
                                        // 代理模板
                                        _templates &amp;&amp; proxyTemplate();
                            
                                        trigger.call(module, &quot;beforemount&quot;);
                            
                                        // 先处理同步后
                                        async function mounte() {
                            
                                            for (let i = 0; i &lt; option.beforeMounts.length; i++) {
                                                let item = option.beforeMounts[i];
                                                await item.call(module);
                                            }
                            
                                            // 监听对象的变更
                                            observer(_data);
                                            // 把以上所有key值挂载到module上
                                            proxyData();
                                            // 处理监听的键值对
                                            _watch &amp;&amp; proxyWatch(_watch);
                                            // 代理计算的属性
                                            _computed &amp;&amp; proxyComputed();
                                            // console.log(_isPublic)
                                            // 单页使用模块加载
                                            if (_isPublic) {
                            
                                                // 模块加载以后,解析模板
                                                option.needCompile &amp;&amp; router &amp;&amp; router.on(&quot;complete&quot;, function (e) {
                            
                                                    // 解析加载后的页面的{{}}
                                                    // needStatic &amp;&amp; compilePage();
                                                    // 解析动态模板, 公共数据不使用view标签,会跟模块里的view标签编译冲突, 造成第2次进入编译了view没有数据的情况
                                                    // if (option.needView) {
                                                    //     compileView({
                                                    //         id: $page,
                                                    //         compiled: function() {
                            
                                                    //             // 路由的view不确定在什么时候结束
                                                    //             // 解析选择器
                                                    //             option.needCompile &amp;&amp; compile();
                            
                                                    //             // 数据处理之后
                                                    //             // firstInit &amp;&amp; option.mounted &amp;&amp; option.mounted.call(module, e);
                                                    //             firstInit &amp;&amp; option.mounteds.forEach(function(item, index) {
                                                    //                 // 数据处理之前
                                                    //                 item.call(module, e);
                                                    //             })
                                                    //         }
                                                    //     });
                                                    // } else {
                            
                                                    // 解析选择器
                                                    option.needCompile &amp;&amp; compile();
                            
                                                    // 数据处理之后
                                                    // firstInit &amp;&amp; option.mounted &amp;&amp; option.mounted.call(module, e);
                                                    firstInit &amp;&amp; option.mounteds.forEach(function (item, index) {
                                                        // 数据处理之前
                                                        item.call(module, e);
                                                    })
                                                    // }
                            
                                                    // 变成一个新的变量,用于同步赋值
                                                    cacheData = $.extend(true, {}, _data);
                            
                                                    // 渲染以后重新回到第一次
                                                    firstVisite = false;
                                                    lastVisite = true;
                            
                                                    trigger.call(module, &quot;mounted&quot;, e);
                            
                                                    firstInit = false;
                            
                                                    keyNames = [];
                            
                                                    // 移除b-cloak属性, 这个属性默认为 display:none
                                                    $page.removeAttr(&quot;b-cloak&quot;);
                                                    $page.find([&quot;b-cloak&quot;]).removeAttr(&quot;b-cloak&quot;);
                                                })
                                            } else {
                                                // 重复调用 init 先清理掉所有订阅
                                                if (!firstInit) {
                                                    off()
                                                }
                                                // 解析加载后的页面的{{}}
                                                needStatic &amp;&amp; compilePage();
                            
                                                // 路由的view是异步的,可能存在没执行完的情况.
                                                if (option.needView) {
                                                    compileView({
                                                        id: $page,
                                                        compiled: function () {
                            
                                                            // 解析选择器
                                                            option.needCompile &amp;&amp; compile();
                            
                                                            // 数据处理之后
                                                            // option.mounted &amp;&amp; option.mounted.call(module);
                                                            option.mounteds.forEach(function (item, index) {
                                                                // 数据处理之前
                                                                item.call(module);
                                                            })
                            
                                                            // 移除b-cloak属性, 这个属性默认为 display:none
                                                            $page.removeAttr(&quot;b-cloak&quot;);
                            
                                                            // console.log($page, $page.find([&quot;b-cloak&quot;]), 123)
                            
                                                        }
                                                    });
                                                } else {
                                                    // 解析选择器
                                                    option.needCompile &amp;&amp; compile();
                            
                                                    // 数据处理之后
                                                    // option.mounted &amp;&amp; option.mounted.call(module);
                                                    option.mounteds.forEach(function (item, index) {
                                                        // 数据处理之前
                                                        item.call(module);
                                                    })
                            
                                                    // 移除b-cloak属性, 这个属性默认为 display:none
                                                    $page.removeAttr(&quot;b-cloak&quot;);
                                                    // $page.find([&quot;b-cloak&quot;]).removeAttr(&quot;b-cloak&quot;);
                            
                                                }
                            
                                                // 变成一个新的变量,用于同步赋值
                                                cacheData = $.extend(true, {}, _data);
                                                // 渲染以后重新回到第一次
                                                firstVisite = false;
                                                lastVisite = true;
                                                keyNames = [];
                                                trigger.call(module, &quot;mounted&quot;);
                            
                                                firstInit = false;
                                            }
                            
                            
                                            // 存储实例
                                            option.uid &amp;&amp; ui.history.setUI &amp;&amp; ui.history.setUI({
                                                uid: option.uid,
                                                ui: module
                                            })
                            
                            
                                        }
                            
                                        // 加载前处理
                                        mounte();
                            
                                        return this;
                                    };
                            
                                    // option 以数组的方式
                                    function mixin() {
                            
                                        return this;
                                    }
                                    // option 以数组的方式
                                    function extend() {
                            
                                        return this;
                                    }
                                    // 重新渲染页面
                                    function compilePage() {
                                        // 解析 {{}}
                                        let html = $page.html();
                            
                                        html = compileHtml(html);
                                        $page.html(html);
                            
                                        return this;
                                    }
                            
                                    // 把data 文件代理到实例上
                                    function proxyData() {
                                        // 数据代理到this
                                        for (let key in _data) {
                                            Object.defineProperty(module, key, {
                                                configurable: true,
                                                get() {
                            
                                                    // 1-1-3-4 会有几次1读取的情况, 前面的1 不需要累计, 有一种 1-3-1-3-4 是第二个1开始不用累计
                                                    // 如果完成一次设置,就需要重新读取
                                                    if (this === module || (!firstVisite &amp;&amp; lastVisite)) {
                                                        firstVisite = true;
                                                        lastVisite = false;
                                                        // 通过this读取前,先清空,会进入observerObj, 那里会累计keyNames,用于触发对应的管道修改
                                                        keyNames = [];
                                                        useSet = false;
                                                    } else {
                                                        firstVisite = false;
                                                        lastVisite = false;
                                                    }
                            
                                                    // 读取,触发 data 的 observer
                                                    let val = _data[key];
                                                    //  _log &amp;&amp; console.log(&#x60;1. data getting ${keyNames.join(&quot;.&quot;)}&#x60;,val);
                                                    // 针对一级数组的依赖
                                                    if (Array.isArray(val)) {
                            
                                                        if (Dep.target) {
                                                            // 不清空，这样computed 同一个数组的时候，才会累计
                                                            if (!Array.isArray(depsArr[key])) {
                                                                depsArr[key] = [];
                                                            }
                                                            depsArr[key].push(Dep.target);
                                                        }
                                                    }
                            
                                                    return val; // 如this.a = {b: 1}
                                                },
                                                set(newVal) {
                                                    _log &amp;&amp; console.log(&#x60;2. data setting ${key}&#x60;, newVal);
                            
                                                    // 2-4, 1-3-2-4 需要进入2 的都是只有一层数据,前面累计的都不用 this.x = 123
                                                    keyNames = [];
                            
                                                    // 针对数组的赋值, 保持统一的 this.xxx.$replace([]) 的方式，不直接赋值数组
                                                    // if( Array.isArray(newVal)){
                                                    //     set(key,newVal);
                                                    //     return;
                                                    // }
                                                    // 是否使用set方法，这里读取的设置不是set方法，所以需要触发
                                                    useSet = false;
                                                    // 进入observerObj的get
                                                    _data[key] = newVal;
                                                    // 这样才能先拿到上一个值
                                                    cacheData[key] = newVal;
                            
                                                }
                                            });
                                        }
                                    }
                            
                                    // 绑定自定义的监听, 相当于 module.on 但这里的形参只有新旧2个值, on可以监听多个
                                    function proxyWatch(opt) {
                                        try {
                                            // watch:{}
                                            watchObj(opt)
                                            // let datakeys = Object.keys(opt);
                                            // let watchkeys = [];
                                            // datakeys.forEach(function(item, i) {
                                            //     // 拿当前watch的function
                                            //     let handler = typeof opt[item] === &quot;object&quot; ? opt[item][&quot;handler&quot;] : opt[item];
                                            //     watchkeys.push(item);
                            
                                            //     let watchkey = watchkeys.join(&quot;.&quot;);
                            
                                            //     // watch 的 value 为对象的时候
                                            //     let val = opt[item];
                                            //     // 深度监听
                                            //     if (ui.typeof(val) === &quot;object&quot; &amp;&amp; val[&quot;deep&quot;]) {
                                            //         let dataskey = Object.keys(_data[item]);
                                            //         dataskey.forEach(function(dat, datindex) {
                                            //             let newkey = watchkey + &quot;.&quot; + dat;
                                            //             // 数据
                                            //             let deepitem = _data[dat];
                                            //             // 数组里面的对象
                                            //             if (ui.typeof(deepitem) === &quot;object&quot;) {
                                            //                 // console.log(&quot;deep&quot;)
                                            //                 watchObj(deepitem, newkey, handler);
                                            //             }
                            
                                            //             watch(newkey, handler);
                                            //             watchkeys = [];
                                            //         });
                            
                                            //         // 立即执行
                                            //         if (val[&quot;immediate&quot;]) {
                                            //             val[&quot;handler&quot;] &amp;&amp; val[&quot;handler&quot;].call(module, _data[item], cacheData[item])
                                            //         }
                                            //     } else {
                                            //         watch(watchkey, handler);
                                            //         watchkeys = [];
                                            //     }
                            
                                            // })
                                        } catch (e) {
                                            ui.showLog(e)
                                        }
                                    }
                            
                                    // 绑定自定义的监听, 相当于 module.on 但这里的形参只有新旧2个值, on可以监听多个
                                    function watchObj(opt, prevkey, handle) {
                                        opt = opt || _watch;
                                        try {
                                            // watch:{}
                                            let datakeys = Object.keys(opt);
                                            let watchkeys = [];
                                            datakeys.forEach(function (item, i) {
                                                // 拿当前watch的function
                                                let handler = handle || (typeof opt[item] === &quot;object&quot; ? opt[item][&quot;handler&quot;] : opt[item]);
                                                watchkeys.push(item);
                                                // 如果有上一级字段
                                                if (prevkey) {
                                                    watchkeys.unshift(prevkey);
                                                }
                            
                                                let watchkey = watchkeys.join(&quot;.&quot;);
                            
                                                // watch 的 value 为对象的时候
                                                let val = opt[item];
                                                // 深度监听
                                                if (ui.typeof(val) === &quot;object&quot;) {
                                                    // 有深度监听时, 取整个对象的键值, 数组则是 0,1,2
                                                    let dataskey = val[&quot;deep&quot;] ? Object.keys(_data[item]) : Object.keys(opt[item]);
                                                    let datas = ui.unit.getKeyValue(item, _data);
                                                    dataskey.forEach(function (dat, datindex) {
                                                        let newkey = watchkey + &quot;.&quot; + dat;
                            
                                                        let deepitem = datas[dat];
                            
                                                        if (ui.typeof(deepitem) === &quot;object&quot;) {
                            
                                                            watchObj(deepitem, newkey, handler);
                                                        }
                            
                                                        watch(newkey, handler);
                                                        watchkeys = [];
                            
                                                    })
                            
                                                    if (val[&quot;immediate&quot;]) {
                                                        val[&quot;handler&quot;] &amp;&amp; val[&quot;handler&quot;].call(module, _data[item], cacheData[item])
                                                    }
                            
                                                }
                            
                                                // 包含对象本身
                                                watch(watchkey, handler);
                                                watchkeys = [];
                            
                                            })
                                        } catch (e) {
                                            ui.showLog(e)
                                        }
                                    }
                            
                                    /**
                                     * [$el 返回当前 el选项的$dom, 可以直接使用jquery的操作方式]
                                     *  @attribute $el
                                     *  @since 1.5.4
                                     *  @example
                             
                                        //
                                        console.log( bs.$el )
                                     */
                            
                                    /**
                                     * [$parent 返回当前 el选项的父层$dom, 可以直接使用jquery的操作方式]
                                     *  @attribute $parent
                                     *  @since 1.5.4
                                     *  @example
                             
                                        //
                                        console.log( bs.$parent )
                                     */
                            
                                    /**
                                     * [$children 返回当前 el选项的缓存子集, 子集新增删除这个值还是不会改变]
                                     *  @attribute $children
                                     *  @since 1.5.4
                                     *  @example
                             
                                        //
                                        console.log( bs.$children )
                                     */
                            
                                    /**
                                     * [$options 传进去的参数]
                                     *  @attribute $options
                                     *  @since 1.5.4
                                     *  @example
                             
                                        //
                                        console.log( bs.$options )
                                     */
                            
                                    /**
                                     * [$refs 获取dom，在方法内可以操作dom ]
                                     *  @attribute $refs
                                     *  @since 1.5.4
                                     *  @example
                             
                                        // 页面的dom
                                        &lt;div class=&quot;bui-page&quot;&gt;
                                            &lt;main&gt;
                                                &lt;div ref=&quot;test&quot;&gt;通过$refs获取&lt;/div&gt;
                                            &lt;/main&gt;
                                        &lt;/div&gt;
                                        var bs = bui.store({
                                            methods:{
                                                init: functioin(){
                                                    console.log(this.$refs.test.innerText)
                                                }
                                            }
                                        })
                             
                                     */
                            
                            
                                    /**
                                     * [ 监听模板的数据字段,在dom每次更新以后都会处理回调,多次调用会有多个处理的&quot;nexttick&quot;回调 ]
                                     *  @method nextTick
                                     *  @param {function} callback [ 回调, 数据更新以后的在这个回调里面的方法再进行执行 ]
                                     *  @chainable
                                     *  @example
                             
                                        // 监听a变量变更的时候,触发回调
                                        bs.nextTick(function () {
                                            // 执行控件的初始化
                                        })
                                     */
                                    function nextTick(callback) {
                            
                                        on(&quot;nexttick&quot;, function (e) {
                                            try {
                                                callback &amp;&amp; callback.call(module, e)
                                            } catch (e) {
                                                ui.showLog(e)
                                            }
                                        })
                            
                                        return this;
                                    }
                                    /**
                                     * [只在某个keyname的数据更新,触发dom更新以后再处理回调,并且只监听一次,调用一次 ]
                                     *  @method oneTick
                                     *  @param {string} keyname [ 监听某个值更新的时候触发一次 ]
                                     *  @param {function} callback [ 回调, 数据更新以后的在这个回调里面的方法再进行执行 ]
                                     *  @chainable
                                     *  @example
                             
                                        // 监听a变量变更的时候,触发回调, 当模板上有多个size数据的时候, 会触发多次.
                                        bs.oneTick(&quot;size&quot;,function () {
                                            // 执行控件的初始化
                                        })
                             
                                        // 相同键值 size ,以第一个为主, 以下函数不会执行.
                                        bs.oneTick(&quot;size&quot;,function () {
                                            // 执行控件的初始化
                                        })
                                     */
                                    function oneTick(keyname, callback) {
                                        var type = &quot;nexttick&quot; + &quot;-&quot; + keyname;
                                        // 缓存,只监听一次
                                        if (oneCache.hasOwnProperty(type)) {
                                            return this;
                                        }
                                        // 缓存下来
                                        oneCache[type] = callback;
                                        on(&quot;nexttick&quot;, function (e) {
                                            if (e.keyname === keyname) {
                                                try {
                            
                                                    // 删掉相同的键值
                                                    onceKeynames[keyname] &amp;&amp; onceKeynames[keyname].pop();
                                                    // 只触发最后一次
                                                    if (onceKeynames[keyname].length == 0) {
                                                        oneCache[type] &amp;&amp; oneCache[type].call(module, e)
                                                    }
                                                } catch (e) {
                                                    ui.showLog(e)
                                                }
                                            }
                                        })
                                        return this;
                                    }
                            
                                    /**
                                     * [ watch方法跟选项的watch 表现一致,数据更新的时候执行, 还没到dom更新,这个主要是为了分离式监听]
                                     *  @method watch
                                     *  @param {string} keyname [ 这个的值是 data 选项里面的值, 监听该值改变的时候, 触发这里的回调. ]
                                     *  @param {function} callback [ 回调, 回调里面的参数可以拿到新值跟上一个值 ]
                                     *  @chainable
                                     *  @example
                             
                                        // 监听a变量变更的时候,触发回调
                                        var unwatcha = bs.watch(&quot;a&quot;,function (newVal,oldVal) {
                                            console.log(newVal);
                                            console.log(oldVal);
                                        })
                             
                                        1.6.2 新增 取消指定监听
                                        unwatcha();
                             
                                     */
                                    function watch(item, callback) {
                                        var watchCallback = function (e) {
                                            try {
                                                var params = [e.value, e.preValue || &quot;&quot;, e];
                                                if (e.action !== &quot;init&quot;) {
                            
                                                    var watchFun = callback;
                                                    switch (ui.typeof(watchFun)) {
                                                        case &quot;function&quot;:
                                                            // data的某个字段 改变的时候, 把新值跟旧值传给watch处理.
                                                            watchFun.apply(module, params);
                                                            break;
                                                        case &quot;array&quot;:
                                                            watchFun.forEach(function (watchItem, i) {
                                                                watchItem.apply(module, params);
                                                            })
                                                            break;
                                                        case &quot;string&quot;:
                                                            // 执行已经定义好的字符串
                                                            new Function(watchFun + &#x60;(${e.value},${e.preValue || &quot;&quot;})&#x60;)();
                                                            break;
                                                        default:
                                                            // data的某个字段 改变的时候, 把新值跟旧值传给watch处理.
                                                            watchFun.apply(module, params);
                                                            break;
                                                    }
                            
                                                }
                                            } catch (e) {
                                                ui.showLog(e)
                                            }
                                        }
                                        on(item, watchCallback);
                            
                                        return off.bind(this, item, watchCallback);
                                    }
                            
                                    // 处理计算属性
                                    function proxyComputed() {
                            
                                        // 遍历传进来的值定义到module上,便于用实例 store.a 这样来访问对象
                                        try {
                                            Object.keys(_computed).forEach(key =&gt; {
                                                if (_data.hasOwnProperty(key)) {
                                                    ui.showLog(&quot;不能跟data的键值相同:&quot; + key)
                                                    return;
                                                }
                                                var update = _computed[key];
                            
                                                Object.defineProperty(module, key, {
                                                    get: function () {
                                                        var func = typeof update === &#x27;function&#x27; ? update.bind(this) : update.get.bind(this);
                                                        var value;
                                                        // 获取自身的属性
                                                        if (Dep.target) {
                                                            depsArr[key] = [];
                                                            depsArr[key].push(Dep.target);
                                                        }
                            
                                                        // func 执行的时候,会去获取对应的键值, observerObj
                                                        Dep.target = function () {
                                                            var val = func();
                                                            // 执行computed的依赖
                                                            depsArr[key] &amp;&amp; depsArr[key].forEach(func =&gt; func());
                                                            // 触发 dom 的修改
                                                            trigger(key, {
                                                                target: null,
                                                                value: val,
                                                                action: &quot;set&quot;,
                                                                keyname: key,
                                                                param: [],
                                                                origin: cacheData
                                                            });
                            
                                                            // 清空依赖的关联
                                                            Dep.target = null;
                                                            // 清空键值
                                                            keyNames = [];
                                                        }
                                                        // console.log(depsArr,key,Dep.target,123)
                            
                                                        // 执行的时候会获取相关的keyname, 进入 get
                                                        value = func();
                                                        // 清空依赖的关联, 这里如果清空,computed里面对数组的操作,比方length则不会触发数组的修改
                                                        Dep.target = null;
                                                        // 清空键值
                                                        keyNames = [];
                            
                                                        return value;
                                                    },
                                                    set: update &amp;&amp; ui.typeof(update) === &#x27;object&#x27; ? update.set || function () { } : function () { }
                                                });
                            
                                            });
                                        } catch (e) {
                                            ui.showLog(e);
                                        }
                                    }
                            
                                    // 定义的公共方法
                                    function proxyMethod() {
                                        // 遍历传进来的值定义到module上,便于用实例 store.a 这样来访问对象
                                        try {
                                            Object.keys(_method).forEach(key =&gt; {
                                                if (_data.hasOwnProperty(key)) {
                                                    ui.showLog(&quot;不能跟data的键值相同:&quot; + key)
                                                    return;
                                                }
                                                Object.defineProperty(module, key, {
                                                    get: function () {
                                                        return _method[key].bind(this)
                                                    },
                                                    set: function () { }
                                                });
                                            });
                                        } catch (e) {
                                            ui.showLog(e);
                                        }
                            
                                    }
                                    // 把模板方法挂载到this
                                    function proxyTemplate() {
                                        // 遍历传进来的值定义到module上,便于用实例 store.a 这样来访问对象
                                        try {
                                            Object.keys(_templates).forEach(key =&gt; {
                                                if (_data.hasOwnProperty(key)) {
                                                    ui.showLog(&quot;不能跟data的键值相同:&quot; + key)
                                                    return;
                                                }
                                                Object.defineProperty(module, key, {
                                                    get: function () {
                                                        return _templates[key].bind(this);
                                                    },
                                                    set: function () { }
                                                });
                            
                                            });
                                        } catch (e) {
                                            ui.showLog(e)
                                        }
                            
                                    }
                            
                            
                                    /**
                                     * [$mount 跟 compile方法一致，这里多一个保持vue的写法，解析模板里面的数据选择器, 一般是 needCompile: false 才需要手动调用, 或者是TAB异步加载的公共数据]
                                     * @method $mount
                                     * @param  {string} el [选择器]
                                     * @chainable
                                     * @example
                             
                                        // 重新解析
                                        bs.$mount(&quot;.bui-page&quot;)
                                     */
                                    function compile(opt) {
                                        try {
                            
                                            var $targetId = null;
                                            var opts = null;
                                            if (typeof opt === &quot;undefined&quot;) {
                                                $targetId = $page;
                                                opts = option;
                                            } else if (typeof opt === &quot;string&quot;) {
                                                $targetId = $dom(opt);
                                                opts = option;
                                            } else if (opt &amp;&amp; typeof opt === &quot;object&quot;) {
                                                $targetId = $dom(opt) || $(opt);
                                                opts = $.extend(true, {}, option, opt);
                                            }
                            
                            
                                            var canCompile = true; //opts.beforeCompile &amp;&amp; opts.beforeCompile.call(module, opts);
                                            opts.beforeCompiles.forEach(function (item, index) {
                                                // 数据处理之前
                                                canCompile = item.call(module, opts);
                            
                                                if (canCompile === false) {
                                                    return false;
                                                }
                                            })
                                            if (canCompile === false) {
                                                // 清空键值
                                                keyNames = [];
                                                return false;
                                            }
                            
                                            // 解析通用的命令属性, template 里面会执行自己的compileCommon
                                            compileCommon({
                                                el: $targetId,
                                                action: &quot;first&quot;
                                            });
                            
                                            // 解析动态模板
                                            compileTemplate($targetId);
                            
                            
                                            // 解析watch
                                            compileWatch($targetId);
                            
                                            // 独立的组件,有可能通过父层修改当前参数,所以在后面执行, 执行以后不再compile
                                            if (opts.needComponent) {
                            
                                                loader.components({
                                                    id: $targetId,
                                                    compiled: function () {
                                                        // 解析点击事件绑定
                                                        compileEvent($targetId);
                                                        // 解析change事件绑定
                                                        compileEventChecked($targetId);
                                                        // 解析双向绑定事件绑定
                                                        compileModel($targetId);
                                                        compileModelLazy($targetId);
                                                        hasEventInit = true;
                                                        // }
                            
                                                        // 挂载dom
                                                        compileDom();
                            
                                                        // 清空键值
                                                        keyNames = [];
                            
                                                        // opts.compiled &amp;&amp; opts.compiled.call(module, opts);
                                                        opts.compileds.forEach(function (item, index) {
                                                            // 数据处理之前
                                                            item.call(module, opts);
                                                        })
                                                    }
                                                });
                                                return this;
                                            }
                                            // 事件通过委托形式, 只需要绑定一次
                                            // if (!hasEventInit) {
                            
                                            // 解析点击事件绑定 b-checked change 事件在前面，然后才处理 b-model，不然可能拿到数据变更的时候，数据状态还没修改
                                            compileEvent($targetId);
                                            // 解析change事件绑定, change 事件比 click 事件慢，所以修改状态的时候，获取到的是没修改前的状态
                                            compileEventChecked($targetId);
                            
                                            // 解析双向绑定事件绑定
                                            compileModel($targetId);
                                            compileModelLazy($targetId);
                            
                                            hasEventInit = true;
                                            // }
                            
                                            // 挂载dom
                                            compileDom();
                            
                                            // 清空键值
                                            keyNames = [];
                            
                                            // opts.compiled &amp;&amp; opts.compiled.call(module, opts);
                                            opts.compileds.forEach(function (item, index) {
                                                // 数据处理之前
                                                item.call(module, opts);
                                            })
                                        } catch (e) {
                                            ui.showLog(e);
                                        }
                            
                                        return this;
                                    }
                            
                            
                                    function compileComp($targetId) {
                            
                                        // 根据数据绑定模板
                                        var $datasource = typeof $targetId === &quot;string&quot; ? ui.$($targetId).find(&#x60;component&#x60;) : $targetId.find(&#x60;component&#x60;);
                            
                                        $datasource.each(function (index, item) {
                                            loader.component({
                                                id: item,
                                            });
                                        });
                                    }
                                    // 把dom拿到store实例里面解析，支持数组操作
                                    function compileDom() {
                                        // 挂载dom
                                        $page.find(&quot;[ref]&quot;).each(function () {
                                            let attrName = this.getAttribute(&quot;ref&quot;);
                                            let hasAttr = $refs.hasOwnProperty(attrName);
                                            let refs = null;
                                            // 多个dom节点
                                            if (hasAttr &amp;&amp; ui.typeof($refs[attrName]) === &quot;htmldivelement&quot;) {
                                                refs = [$refs[attrName]];
                                                refs.push(this);
                                                $refs[attrName] = refs;
                                            } else if (hasAttr &amp;&amp; ui.typeof($refs[attrName]) === &quot;array&quot;) {
                                                $refs[attrName].push(this);
                                                // } else if (this.tagName.toLowerCase()===&quot;component&quot;) {
                                                //     // ref 不指向component, 组件是异步的,不能实时获取, 
                                                //     $refs[attrName] = ui.history.getComponent(this.id);
                                            } else {
                                                $refs[attrName] = this;
                                            }
                                        })
                            
                                        return this;
                                    }
                            
                                    /**
                                     * [解析模板里面的{{}}, 通过这种方式的设置,值不会动态变更]
                                     * @method compileHtml
                                     * @param  {string} el [选择器]
                                     * @chainable
                                     * @example
                             
                                        // 解析模板里面的{{}}
                                        var html = bs.compileHtml(&quot;&lt;div title=&quot;{{app.name}}&quot;&gt;{{app.name}}&lt;/div&gt;&quot;);
                             
                                     */
                                    function compileHtml(htmlStr) {
                                        try {
                            
                                            var _self = this;
                                            // 第一次全文替换 {{}} 这类不更新,只渲染
                                            var html = typeof htmlStr === &quot;string&quot; ? htmlStr : &quot;&quot;;
                                            // 匹配一个空格,并且有 page. 开头, 不然不匹配, 这样才能使用 arttemplate 模板
                                            var rule = new RegExp(&quot;\{\{[\\s]?&quot; + gid + _scopeSplit + &quot;(.*?)\}\}&quot;, &quot;mg&quot;) ///\{\{(.*?)\}\}/mg;
                                            html = html.replace(rule, function (matched, placeholder) {
                            
                                                // return &#x60;&lt;b b-html=&quot;${gid}${_scopeSplit}${placeholder}&quot;&gt;&lt;/b&gt;&#x60;
                                                var keys = placeholder.split(gid + _scopeSplit);
                            
                                                if ($.trim(keys[0]) === &quot;&quot;) {
                                                    keys.shift()
                                                }
                            
                                                // 这里只是拿缓存值渲染,不需要劫持
                                                var value = keys.length &gt; 0 &amp;&amp; ui.unit.getKeyValue(keys.join(&quot;.&quot;), cacheData) || &quot;&quot;;
                                                return typeof value === &quot;function&quot; ? value.call(_self) : value;
                                            })
                            
                                            return html;
                                        } catch (e) {
                                            ui.showLog(e)
                                        }
                            
                                    }
                            
                                    // 通过当前dom向上查找模板，再查找子级
                                    function getItem(_self) {
                                        let $parent = $(_self).closest(&#x27;[b-template]&#x27;);
                            
                                        let firstChild = $parent.length ? $parent.children()[0] : null;
                                        let itemChild = firstChild &amp;&amp; firstChild.classList[0] ? &#x27;.&#x27; + firstChild.classList[0] : (firstChild &amp;&amp; firstChild.nodeName || &quot;&quot;);
                                        let $item = itemChild &amp;&amp; $(_self).closest(itemChild);
                            
                                        return $item;
                                    }
                                    // 获取缓存键值
                                    function getKeyValue(keyname, source) {
                                        let value;
                            
                                        if (cacheKeyname &amp;&amp; cacheKeyname.hasOwnProperty(keyname)) {
                                            value = cacheKeyname[keyname];
                            
                                        } else {
                                            // 获取值
                                            value = ui.unit.getKeyValue(keyname, source);
                                            if (typeof value === &quot;undefined&quot;) {
                                                _log &amp;&amp; console.warn(&#x60;请检查 ${keyname} 在bui.store scope:${gid} 中有没有声明定义&#x60;);
                                                // return;
                                            }
                                            cacheKeyname[keyname] = value;
                                        }
                            
                                        return value;
                                    }
                            
                                    // 通用属性
                                    function compileCommon(opt) {
                                        var isReplace = opt.replace == true ? true : false;
                                        try {
                            
                                            var $targetId = ui.typeof(opt) === &quot;object&quot; ? opt.el : opt;
                            
                                            var cachekeynames = [];
                            
                                            // 最好模板在一个div容器里面, 同时有多个容器, 会出现只匹配到第一个的情况.
                                            var html = $targetId.prop(&quot;outerHTML&quot;) || $targetId.html() || &quot;&quot;;
                            
                                            // 匹配页面中已有的属性进行去重
                                            var regRules = html.match(commandAttrsRule) || [];
                            
                                            // 这里动态replace要留意html是否正确匹配到正确指令;
                                            // console.log(html, regRules)
                                            // reverse 把 b-prop 提往后面编译，这样 b-bind 这类属性就可以获取得到了
                                            var comands = ui.array.uniq(regRules).reverse();
                            
                                            // 绑定命令处理, 先通过正则匹配到属性再进行筛选,可以减少遍历次数.
                                            comands.length &amp;&amp; comands.forEach(function (command, i) {
                                                // 先从子集查找
                                                var comandDoms = $targetId.find(&#x60;[${command}*=${gid}]&#x60;);
                            
                                                // 如果找不到对应的命令,尝试从自身查找, 比方push 模板一般命令在第一层
                                                if (comandDoms.length &lt; 1) {
                                                    comandDoms = $targetId.closest(&#x60;[${command}*=${gid}]&#x60;);
                                                }
                            
                                                // 注意tab的父层如果都是 bui-page 可能会造成多次遍历
                                                comandDoms.length &amp;&amp; comandDoms.each(function (i, item) {
                            
                                                    var _self = this;
                            
                                                    var commandItem = &quot;&quot;;
                            
                                                    var uid = getAttrs.call(this, &#x60;${command}&#x60;);
                            
                                                    var keyname = uid[0] &amp;&amp; uid[0][&quot;keyname&quot;] || &quot;&quot;; // 对象,方法,数组
                                                    // 长度不算在触发的keyname 里面
                                                    var hasLength = keyname.indexOf(&quot;.length&quot;);
                                                    var filterKeyname = hasLength &gt; -1 ? keyname.substr(0, hasLength) : keyname;
                                                    var param = uid[0] &amp;&amp; uid[0][&quot;param&quot;]; // 执行的形参
                                                    var value = null;
                            
                                                    // 缓存的键值
                                                    // 获取值 这里如果是用 cacheData , computed里面的值会报提醒信息
                                                    value = getKeyValue(filterKeyname, module);
                            
                                                    // 针对关联的处理, store 不像vue 一样所有视图更新,所以需要有个地方绑定关联字段触发
                                                    var linked = getAttrs.call(this, &quot;b-linked&quot;);
                            
                                                    if (linked.length) {
                                                        // 根据关联字段改变触发对应选择器
                                                        linked.forEach(function (link, n) {
                            
                                                            on(link.keyname, function (e) {
                                                                // 这里的value 不能使用 getKeyValue ,这个方法是会缓存值的,会不准确
                                                                // 手动触发该选择器
                                                                trigger(keyname, {
                                                                    target: null,
                                                                    value: ui.unit.getKeyValue(keyname, module),
                                                                    action: &quot;set&quot;,
                                                                    keyname: keyname,
                                                                    param: param,
                                                                    origin: cacheData
                                                                });
                            
                                                            })
                                                        })
                                                    }
                            
                            
                                                    // 截胡, 针对rule做一些简单处理
                                                    if (command === &quot;b-show&quot;) {
                                                        switch (uid[0] &amp;&amp; uid[0][&quot;rule&quot;]) {
                                                            case &quot;!&quot;:
                                                                commandItem = &quot;b-hide&quot;;
                                                                // command = &quot;b-hide&quot;
                                                                break;
                                                            default:
                                                                commandItem = &quot;b-show&quot;;
                                                        }
                            
                                                    } else {
                                                        commandItem = command;
                                                    }
                            
                            
                                                    // 公共数据先清理订阅
                                                    if (_isPublic) {
                            
                                                        var hasCache = ui.array.compare(publicCommandCache[commandItem], filterKeyname);
                                                        // hasCache &amp;&amp; off(filterKeyname);
                                                        // 公共数据的命令只能有1个,用的是动态选择器
                                                        !hasCache &amp;&amp; publicCommandCache[commandItem].push(filterKeyname);
                                                        // 不重复加回调
                                                        !hasCache &amp;&amp; on(filterKeyname, commandAction[commandItem].bind(_self));
                                                    } else {
                                                        // 每次compiled,先把这个相同keyname的取消订阅
                                                        !firstInit &amp;&amp; i === 0 &amp;&amp; off(filterKeyname, handleCommon);
                            
                                                        // 替换的数据,清除掉原本的订阅
                                                        isReplace &amp;&amp; off(filterKeyname, handleCommon);
                                                        // 订阅字段的触发方法,不要length
                                                        let orginAttr = this.getAttribute(command) || &quot;&quot;;
                                                        let orginKey = orginAttr.replace(gid + _scopeSplit, &quot;&quot;);
                            
                                                        on(filterKeyname, function () {
                            
                                                            handleCommon.apply(_self, arguments);
                                                        });
                            
                            
                            
                                                        function handleCommon(res) {
                            
                                                            try {
                            
                                                                // 处理动态$index
                                                                // 采用 $itemIndex 的方式，直接跳过这里的处理
                                                                if (orginKey.indexOf(&quot;$index&quot;) &gt; -1) {
                                                                    // 匹配到多个数字  page.list.1.obj.5.name
                                                                    let newindexs = filterKeyname.match(/([0-9]+)/g);
                                                                    // 只需要 最后的索引 5 对应 $index
                                                                    let lastindex = newindexs[newindexs.length - 1];
                                                                    let $targetChild = $targetId.find(&#x60;[${command}=&quot;${orginAttr}&quot;]&#x60;);
                            
                                                                    // 如果找不到对应的命令,尝试从自身查找, 比方push 模板一般命令在第一层
                                                                    // if ($targetChild.length &lt; 1) {
                                                                    //     $targetChild = $targetId.closest(&#x60;[${command}*=${gid}]&#x60;);
                                                                    // }
                            
                                                                    let hasTarget = $targetChild.attr(&quot;b-target&quot;);
                            
                                                                    $targetChild.each(function (i, el) {
                            
                                                                        hasTarget = $(el).attr(&quot;b-target&quot;);
                                                                        if (hasTarget) {
                                                                            return;
                                                                        }
                                                                    })
                            
                            
                                                                    // 找到跟数组对应的子集第几条索引, 没有则按个数来, 这里b-target 不能是通用的样式名, 比方 .bui-btn 容易找错.
                                                                    let newtarget = hasTarget ? $targetId.find(hasTarget).eq(lastindex) : null;
                                                                    let args = arguments;
                            
                                                                    if (hasTarget &amp;&amp; newtarget &amp;&amp; newtarget.length) {
                            
                                                                        // 处理子集属性
                                                                        newtarget.find(&#x60;[${command}=&quot;${orginAttr}&quot;]&#x60;).each(function (i, el) {
                                                                            let targetObj = el || _self;
                            
                                                                            commandAction[commandItem].apply(targetObj, args);
                                                                        })
                                                                        // 自身的属性也要处理
                                                                        newtarget.closest(&#x60;[${command}=&quot;${orginAttr}&quot;]&#x60;).each(function (i, el) {
                                                                            let targetObj = el || _self;
                            
                                                                            commandAction[commandItem].apply(targetObj, args);
                                                                        })
                                                                    } else {
                            
                                                                        $targetChild.each(function (i, el) {
                                                                            let targetObj = el || _self;
                                                                            // 影响template的例子, 正常数组有数据的时候,在最后才触发, 动态修改的数据,是每次都要触发
                                                                            if (i == lastindex &amp;&amp; opt.action === &quot;first&quot;) {
                                                                                commandAction[commandItem].apply(targetObj, args);
                                                                                return;
                                                                            }
                                                                            if (opt.action !== &quot;first&quot;) {
                                                                                commandAction[commandItem].apply(targetObj, args);
                                                                            }
                                                                        })
                                                                        // 自身的属性也要处理
                                                                        $targetId.closest(&#x60;[${command}=&quot;${orginAttr}&quot;]&#x60;).each(function (i, el) {
                                                                            let targetObj = el || _self;
                                                                            commandAction[commandItem].apply(targetObj, args);
                                                                        })
                                                                    }
                            
                                                                    return;
                                                                } else if (orginKey.indexOf(&quot;$key&quot;) &gt; -1) {
                            
                                                                    // 通过批量动态处理键值的形式，跟$itemIndex 处理不一样，那些是监听一次，只触发一次，$key 是监听多个以后，只触发对应的索引的值
                                                                    let $item = getItem(_self);
                                                                    let $itemIndex = $item &amp;&amp; $item.index();
                                                                    let nindex = $itemIndex || 0;
                            
                                                                    if (orginKey.indexOf(&quot;$key1&quot;) &gt; -1) {
                                                                        nindex = $itemIndex + 1;
                                                                    } else if (orginKey.indexOf(&quot;$key01&quot;) &gt; -1) {
                                                                        nindex = $itemIndex &lt; 10 ? &quot;0&quot; + ($itemIndex + 1) : $itemIndex + 1;
                                                                    }
                                                                    res.value = nindex;
                            
                                                                }
                                                                //  else if( orginKey.indexOf(&quot;$keyValue&quot;) &gt; -1 ){
                                                                //     // 通过批量动态处理键值的形式，跟$itemIndex 处理不一样，那些是监听一次，只触发一次，$key 是监听多个以后，只触发对应的索引的值
                                                                //     let $item = getItem(_self);
                                                                //     let $itemIndex = $item &amp;&amp; $item.index();
                                                                //     let parentKeyname = res.keyname.replace(&quot;.$value&quot;,&quot;&quot;)
                                                                //     let parentVal = ui.unit.getKeyValue(parentKeyname,_data);
                            
                                                                //     res.value = JSON.stringify(parentVal[$itemIndex]);
                                                                // }
                            
                                                                if (orginKey.includes(&quot;$itemIndex&quot;)) {
                            
                                                                    let nums = res.keyname.match(/[\d]+/g);
                                                                    // 取最后一个数字，因为$itemIndex 用来描述最后一个数组
                                                                    let num = +nums[nums.length - 1];
                            
                                                                    // 说明有用到模板，需要反应为真实的dom数据，第一次建立的时候是正确的，删除以后索引不正确就不继续执行了
                                                                    //  let $item = getItem(_self) ;
                                                                    //  let $itemIndex = $item &amp;&amp; $item.index();
                                                                    // 如果触发的索引跟当前的索引不匹配，则不进行渲染，这里会导致删除后 b-text 之类的this跟dom绑定在一块了，无法更新
                                                                    // 比如 之前的索引是2，在前面有一个删除了，这个时候 b-text 绑定的dom仍然是2，所以不会进行更新
                                                                    //  if( num !== $itemIndex ){
                                                                    //      return;
                                                                    //  }
                                                                    let $commonItems = null;
                            
                                                                    if (orginKey.includes(&quot;$parentItemIndex&quot;)) {
                                                                        let tplKeyname = gid + _scopeSplit + orginKey.replace(/\.\$parentItemIndex.+/, &quot;&quot;);
                                                                        let tplChildKeyname = gid + _scopeSplit + orginKey.replace(/\.\$itemIndex.+/, &quot;&quot;).replace(/\$parentItemIndex/, &quot;$itemIndex&quot;);
                            
                                                                        $page.find(&#x60;[b-template$=&quot;${tplKeyname})&quot;]&#x60;).each(function (i, child) {
                                                                            let $parentChildren = $(child).children().eq(nums[0]);
                            
                                                                            $commonItems = $parentChildren.find(&#x60;[b-template*=&quot;${tplChildKeyname}&quot;]&#x60;).children().eq(num).find(&#x60;[${commandItem}*=&quot;${orginKey}&quot;]&#x60;);
                                                                        })
                                                                        // let $parentChildren = $page.find(&#x60;[b-template*=&quot;${tplKeyname}&quot;]&#x60;).children().eq(nums[0])
                                                                        // $commonItems = $parentChildren.find(&#x60;[b-template*=&quot;${tplChildKeyname}&quot;]&#x60;).children().eq(num).find(&#x60;[${commandItem}*=&quot;${orginKey}&quot;]&#x60;);
                                                                    } else {
                                                                        var $templateSelect = $page.find(&#x60;[${commandItem}*=&quot;${orginKey}&quot;]&#x60;).closest(&quot;[b-template]&quot;);
                                                                        $commonItems = $templateSelect.children().eq(num).find(&#x60;[${commandItem}*=&quot;${orginKey}&quot;]&#x60;)
                            
                                                                    }
                            
                                                                    // 元素被删掉以后通过this 的cloest从下往上找不到父级，只能通过上级往下找
                                                                    $commonItems.each((d, item) =&gt; {
                            
                                                                        commandAction[commandItem].apply(item, arguments);
                                                                    })
                            
                                                                } else {
                                                                    commandAction[commandItem].apply(_self, arguments);
                            
                                                                }
                            
                                                            } catch (e) {
                                                                ui.showLog(e)
                                                            }
                            
                                                        }
                                                    }
                            
                            
                                                    // 找到自己相同的数据源的最后一个再执行初始化
                                                    // 默认值初始化, 等找到最后一个相同数据源的时候,再进行触发
                                                    // 用于后面单独触发,
                                                    if (!ui.array.compare(cachekeynames, filterKeyname)) {
                                                        cachekeynames.push(filterKeyname);
                                                    }
                            
                                                    // 清空键值,防止读取的时候,直接累计
                                                    keyNames = [];
                            
                                                    // 渲染以后重新回到第一次
                                                    firstVisite = false;
                                                    lastVisite = true;
                            
                                                })
                            
                                            })
                            
                                            // 触发每个选项
                                            autoTrigger(cachekeynames, opt);
                            
                            
                                        } catch (e) {
                                            ui.showLog(e)
                                        }
                            
                                    }
                            
                                    // 触发指定键值
                                    function triggermethod() {
                                        // 通过b-trigger触发指定关联方法
                                        let triggerdom = getAttrs.call(this, &#x27;b-trigger&#x27;);
                                        let keyname = triggerdom &amp;&amp; triggerdom[0] &amp;&amp; triggerdom[0].keyname || &quot;&quot;;
                                        let triggerparam = triggerdom &amp;&amp; triggerdom[0] &amp;&amp; triggerdom[0].param || [];
                                        let triggers = [];
                                        if (keyname.indexOf(option.paramSplit) &gt; -1) {
                                            triggers = keyname.split(option.paramSplit);
                                        } else {
                                            triggers.push(keyname)
                                        }
                            
                                        for (let i = 0; i &lt; triggers.length; i++) {
                                            let item = triggers[i];
                                            if (item) {
                                                let preValue = ui.unit.getKeyValue(item, cacheData);
                            
                                                let vals = ui.unit.getKeyValue(item, module);
                                                // 方法的触发
                                                if (typeof vals === &quot;function&quot;) {
                                                    // 让4. 触发相关 trigger
                                                    useSet = false;
                                                    vals.apply(module, triggerparam);
                                                    return;
                                                }
                                                // computed 的触发
                                                item &amp;&amp; trigger(item, {
                                                    target: null,
                                                    value: vals,
                                                    preValue: preValue,
                                                    action: &quot;set&quot;,
                                                    keyname: item,
                                                    param: {},
                                                    origin: cacheData
                                                });
                                            }
                                        }
                                        //  triggers.forEach(function(item){
                            
                                        //      // 
                                        //     let preValue = ui.unit.getKeyValue(item,cacheData);
                            
                                        //      let vals = ui.unit.getKeyValue(item, module);
                                        //      // 方法的触发
                                        //      if( typeof vals ===&quot;function&quot;){
                                        //         // 让4. 触发相关 trigger
                                        //         useSet = false;
                                        //         vals.apply(module,triggerparam);
                                        //         return;
                                        //      }
                                        //      // computed 的触发
                                        //      item &amp;&amp; trigger(item, {
                                        //         target: null,
                                        //         value: vals,
                                        //         preValue: preValue,
                                        //         action: &quot;set&quot;,
                                        //         keyname: item,
                                        //         param: {},
                                        //         origin: cacheData
                                        //     });
                                        //  })
                            
                                        return this;
                                    }
                                    // 触发指定键值
                                    function triggerkey(keyname, param) {
                                        // 触发指定关联，与b-linked类似
                                        let params = param || [];
                                        var triggers = [];
                                        if (keyname.indexOf(option.paramSplit) &gt; -1) {
                                            triggers = keyname.split(option.paramSplit);
                                        } else {
                                            triggers.push(keyname)
                                        }
                                        triggers.forEach(function (item) {
                                            // 
                                            let preValue = ui.unit.getKeyValue(item, cacheData);
                            
                                            let vals = ui.unit.getKeyValue(item, module);
                                            // 方法的触发
                                            if (typeof vals === &quot;function&quot;) {
                                                // 让4. 触发相关 trigger
                                                useSet = false;
                                                vals.apply(module, params);
                                                return;
                                            }
                                            // computed 的触发
                                            trigger(item, {
                                                target: null,
                                                value: vals,
                                                preValue: preValue,
                                                action: &quot;set&quot;,
                                                keyname: item,
                                                param: {},
                                                origin: cacheData
                                            });
                                        })
                            
                                        return this;
                                    }
                                    // 触发每个keyname
                                    function autoTrigger(data, opt) {
                                        //相同数据源只触发一次
                            
                                        // console.log(cacheData, 123)
                                        data.forEach(function (item, i) {
                            
                                            // var values = cacheKeyname[item];
                            
                                            var values = ui.unit.getKeyValue(item, module);
                            
                                            trigger(item, {
                                                target: null,
                                                action: ui.typeof(opt) === &quot;object&quot; ? opt.action || &quot;init&quot; : &quot;init&quot;,
                                                value: values,
                                                param: null,
                                                keyname: item,
                                                origin: cacheData
                                            });
                            
                                            // 清空键值
                                            keyNames = [];
                                        })
                                    }
                            
                                    // 数据双向绑定, 除了通用绑定,还需要绑定事件
                                    function compileModelLazy(targetId) {
                                        var $targetId = targetId;
                            
                                        // 针对 input 的处理
                                        var inputTarget = &#x60;[type=&quot;text&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;search&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;password&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;url&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;number&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;email&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;range&quot;][b-model-lazy*=${gid}],
                                                             [type=&quot;tel&quot;][b-model-lazy*=${gid}],
                                                             textarea[b-model-lazy*=${gid}]&#x60;;
                            
                                        if (option.modelEvent === &quot;input&quot;) {
                            
                                            // 中文输入法的处理
                                            var zhFlag = false;
                                            var isInput = false;// 区分是输入，还是change，输入就无需再次触发change
                                            // 排除以下类型，以下类型会触发change事件
                                            var excludeType = [&#x27;checkbox&#x27;, &#x27;radio&#x27;, &#x27;select&#x27;, &#x27;select-multiple&#x27;];
                                            // 如果用 ui.unit.debounce 会死循环
                                            $targetId.off(&#x27;input compositionstart compositionend&#x27;, inputTarget).on(modelEvent, inputTarget, ui.unit.debounce(function (e) {
                                                if (zhFlag) {
                                                    return;
                                                }
                            
                                                isInput = true;
                            
                                                // 防止死循环，通过赋值的方式，不需要触发onInput
                                                (!inputChange || e.inputType === &quot;insertText&quot;) &amp;&amp; onInput.call(e.target, e);
                            
                                                inputChange = false;
                            
                                            }, _delayInput))
                                                .on(&#x27;compositionstart&#x27;, inputTarget, function (e) {
                                                    zhFlag = true;
                                                    // 阻止冒泡
                                                    e.stopPropagation();
                                                }).on(&#x27;compositionend&#x27;, inputTarget, ui.unit.debounce(function (e) {
                            
                                                    zhFlag = false;
                                                    isInput = true;
                                                    onInput.call(e.target, e);
                                                    // 阻止冒泡
                                                    e.stopPropagation();
                                                }, _delayInput))
                                                .on(&quot;change&quot;, function (e) {
                            
                                                    // change事件触及范围比较广，跟前面的checkbox，radio，select绑定会有冲突，导致checkbox的类型被修改，所以这里要单独处理
                                                    if (excludeType.includes(e.target.type) || !e.target.getAttribute(&quot;b-model-lazy&quot;)) {
                                                        return;
                                                    }
                            
                                                    // 日期的修改要触发b-model的变更 change
                                                    (!isInput || inputChange || e.hasOwnProperty(&quot;data&quot;)) &amp;&amp; onInput.call(e.target, e);
                                                    // 触发了input，就不再触发 change里的 onInput
                                                    isInput = false;
                                                    // 外部触发change后，跟内部保持同步
                                                    inputChange = false;
                                                    // 阻止冒泡
                                                    e.stopPropagation();
                                                })
                                        }
                            
                                        function onInput(e) {
                                            var val = e.target.value;
                                            var uid = getAttrs.call(this, &#x27;b-model-lazy&#x27;);
                            
                                            var keyname = uid[0] &amp;&amp; uid[0][&quot;keyname&quot;] || &quot;&quot;;
                            
                                            if (keyname === &quot;&quot;) {
                                                ui.showLog(&quot;b-model-lazy的值不能为空&quot;)
                                                return false;
                                            }
                                            // ui.unit.setKeyValue(keyname, val, _data);
                                            // ui.unit.setKeyValue(keyname, val, cacheData);
                            
                                            set(keyname, val);
                            
                                            // 触发指定关联，与b-linked类似
                                            triggermethod.call(this);
                            
                                            // 清空键值,防止读取的时候,直接累计
                                            keyNames = [];
                            
                                            // 阻止冒泡
                                            e.stopPropagation();
                                        }
                                    }
                                    function compileModel(targetId) {
                                        var $targetId = targetId;
                            
                                        // 针对 input 的处理
                                        var inputTarget = &#x60;[type=&quot;text&quot;][b-model*=${gid}],
                                                             [type=&quot;search&quot;][b-model*=${gid}],
                                                             [type=&quot;password&quot;][b-model*=${gid}],
                                                             [type=&quot;url&quot;][b-model*=${gid}],
                                                             [type=&quot;number&quot;][b-model*=${gid}],
                                                             [type=&quot;email&quot;][b-model*=${gid}],
                                                             [type=&quot;range&quot;][b-model*=${gid}],
                                                             [type=&quot;tel&quot;][b-model*=${gid}],
                                                             textarea[b-model*=${gid}]&#x60;;
                            
                                        if (option.modelEvent === &quot;input&quot;) {
                            
                                            // 中文输入法的处理
                                            var zhFlag = false;
                                            var isInput = false;// 区分是输入，还是change，输入就无需再次触发change
                                            // 排除以下类型，以下类型会触发change事件
                                            var excludeType = [&#x27;checkbox&#x27;, &#x27;radio&#x27;, &#x27;select&#x27;, &#x27;select-multiple&#x27;];
                            
                            
                                            $targetId.off(&#x27;input compositionstart compositionend change&#x27;, inputTarget).on(modelEvent, inputTarget, function (e) {
                                                if (zhFlag) {
                                                    return;
                                                }
                            
                                                isInput = true;
                                                // 防止死循环，通过赋值的方式，不需要触发onInput
                                                (!inputChange || e.inputType === &quot;insertText&quot;) &amp;&amp; onInput.call(e.target, e);
                            
                                                inputChange = false;
                            
                                            })
                                                .on(&#x27;compositionstart&#x27;, inputTarget, function (e) {
                                                    zhFlag = true;
                                                    // 阻止冒泡
                                                    e.stopPropagation();
                                                }).on(&#x27;compositionend&#x27;, inputTarget, function (e) {
                                                    zhFlag = false;
                            
                                                    isInput = true;
                                                    onInput.call(e.target, e);
                                                    // 阻止冒泡
                                                    e.stopPropagation();
                                                })
                                                .on(&quot;change&quot;, function (e) {
                            
                                                    // change事件触及范围比较广，跟前面的checkbox，radio，select绑定会有冲突，导致checkbox的类型被修改，所以这里要单独处理
                                                    if (excludeType.includes(e.target.type) || !e.target.getAttribute(&quot;b-model&quot;)) {
                                                        return;
                                                    }
                            
                                                    // 日期的修改要触发b-model的变更 change
                                                    (!isInput || inputChange || e.hasOwnProperty(&quot;data&quot;)) &amp;&amp; onInput.call(e.target, e);
                                                    // 触发了input，就不再触发 change里的 onInput
                                                    isInput = false;
                                                    // 外部触发change后，跟内部保持同步
                                                    inputChange = false;
                                                    // 阻止冒泡
                                                    e.stopPropagation();
                                                })
                            
                            
                                        } else {
                                            $targetId.off(modelEvent, inputTarget).on(modelEvent, inputTarget, onInput);
                                        }
                            
                                        function onInput(e) {
                                            let val = e.target.value;
                                            let uid = getAttrs.call(this, &#x27;b-model&#x27;);
                            
                                            var keyname = uid[0] &amp;&amp; uid[0][&quot;keyname&quot;] || &quot;&quot;;
                            
                                            if (keyname === &quot;&quot;) {
                                                ui.showLog(&quot;b-model不能为空&quot;)
                                                return false;
                                            }
                            
                                            //  ui.unit.setKeyValue(keyname, val, _data);
                                            //  ui.unit.setKeyValue(keyname, val, cacheData);
                                            // 使用set会导致多个日期设置的时候，触发到多余的选择器
                                            set(keyname, val);
                            
                                            // 触发指定关联，与b-linked类似
                                            triggermethod.call(this);
                            
                                            // 清空键值,防止读取的时候,直接累计
                                            keyNames = [];
                            
                                            // 阻止冒泡
                                            e.stopPropagation();
                                        }
                            
                                        // 针对 checkbox 的处理
                                        var checkTarget = &#x60;[type=&quot;checkbox&quot;][b-model*=${gid}],
                                                             [type=&quot;radio&quot;][b-model*=${gid}]&#x60;;
                                        $targetId.off(&quot;change&quot;, checkTarget).on(&quot;change&quot;, checkTarget, onChecked);
                            
                                        function onChecked(e) {
                                            try {
                            
                                                var that = this;
                                                var val = this.getAttribute(&quot;value&quot;) || this.checked,
                                                    type = this.getAttribute(&quot;type&quot;),
                                                    uid = getAttrs.call(this, &#x27;b-model&#x27;),
                                                    keyname = uid[0][&quot;keyname&quot;],
                                                    value = null;
                                                // 优先以有uncheck值为主
                                                var checkVal = this.getAttribute(&quot;check-value&quot;),
                                                    uncheckVal = this.getAttribute(&quot;uncheck-value&quot;),
                                                    check = this.getAttribute(&quot;check&quot;),
                                                    uncheck = this.getAttribute(&quot;uncheck&quot;);
                            
                                                // 自定义check
                                                if (check || uncheck || checkVal || uncheckVal) {
                                                    val = this.checked ? (checkVal || this.value || check) : (uncheckVal || uncheck || &quot;&quot;);
                            
                                                }
                            
                                                // 缓存的键值
                                                // 获取值
                                                value = getKeyValue(keyname, module);
                            
                                                let orgtype = typeof value;
                            
                                                var isObjectRule = /\{.+\}$/g;
                            
                                                var isObj = isObjectRule.test(val);
                            
                                                // 操作关联的 b-model keyname 相同,并且值相同
                                                var relatedModel = isObj ? null : $targetId.find(&#x60;[type=&quot;checkbox&quot;][b-model=&quot;${gid + &quot;.&quot; + keyname}&quot;][value=&quot;${val}&quot;],
                                             [type=&quot;radio&quot;][b-model=&quot;${gid + &quot;.&quot; + keyname}&quot;][value=&quot;${val}&quot;]&#x60;);
                                                // 全选的关联处理
                                                //  var relateAllModels = isObj ? null : $targetId.find(&#x60;[type=&quot;checkbox&quot;][b-model=&quot;${gid+&quot;.&quot;+keyname}&quot;]&#x60;);
                                                //  var relateAllModel = $targetId.find(&#x60;[type=&quot;checkbox&quot;][b-model=&quot;${gid+&quot;.&quot;+keyname}&quot;][checkall]&#x60;);
                            
                                                // 如果值是
                                                switch (type) {
                                                    case &quot;checkbox&quot;:
                            
                                                        // 用文本比对
                                                        var newval = isObj ? JSON.parse(val) : val;
                                                        let newvals = [];
                                                        if (typeof newval === &quot;string&quot; &amp;&amp; newval.indexOf(&quot;,&quot;) &gt; -1) {
                                                            newvals = newval.split(&quot;,&quot;);
                                                        } else {
                                                            newvals.push(newval);
                                                        }
                            
                                                        // 当前点击的状态
                                                        if (this.checked) {
                            
                            
                                                            if (value &amp;&amp; ui.typeof(value) === &quot;array&quot;) {
                                                                // let keyval = ui.unit.getKeyValue(keyname, module);
                                                                newvals.forEach(function (item, index) {
                                                                    // if (keyval &amp;&amp; ui.typeof(keyval) !== &quot;array&quot;) {
                                                                    //     console.warn(keyname + &quot;请检测是否为数组&quot;);
                                                                    //     return;
                                                                    // }
                                                                    !ui.array.compare(value, item) &amp;&amp; value.push(item);
                                                                })
                            
                                                                // 选中的时候，判断是否已经是全部个数，用于关联全部选中
                                                                // if( ui.unit.getKeyValue(keyname, module).length == (relateAllModels &amp;&amp; relateAllModels.length-(relateAllModel&amp;&amp;relateAllModel.length)) ){
                                                                //     relateAllModel.each(function(i,item){
                                                                //         this.checked = true;
                                                                //     })
                                                                // }
                                                            } else {
                                                                set(keyname, newval)
                                                            }
                                                            //  value &amp;&amp; ui.typeof(value) === &quot;array&quot; ? !ui.array.compare(value, val) &amp;&amp; ui.unit.getKeyValue(keyname, module).push(newval) : set(keyname, newval);
                                                            this.checked = true;
                            
                                                        }
                                                        if (!this.checked) {
                                                            if (value &amp;&amp; ui.typeof(value) === &quot;array&quot;) {
                            
                                                                newvals.forEach(function (item, index) {
                                                                    ui.array.remove(ui.unit.getKeyValue(keyname, module), item)
                                                                })
                                                            } else {
                                                                set(keyname, newval)
                                                            }
                                                            //  value &amp;&amp; ui.typeof(value) === &quot;array&quot; ? ui.array.remove(ui.unit.getKeyValue(keyname, module), newval) : set(keyname, newval);
                                                            this.checked = false;
                                                        }
                                                        // 选中相关联的
                                                        relatedModel &amp;&amp; relatedModel.each(function (i, item) {
                                                            this.checked = that.checked;
                                                        })
                            
                                                        triggermethod.call(this);
                                                        break;
                                                    case &quot;radio&quot;:
                                                    default:
                                                        let vals = ui.unit.getKeyValue(keyname, module);
                                                        // 如果原本的值是布尔值，则进行转换
                                                        if (orgtype === &quot;boolean&quot;) {
                                                            val = val === &quot;false&quot; ? false : (val === &quot;true&quot; ? true : val);
                                                        }
                            
                                                        value &amp;&amp; ui.typeof(value) === &quot;array&quot; ? vals.splice(0, 1, val) : set(keyname, val);
                            
                                                        triggermethod.call(this);
                            
                                                        // this.checked = true;
                                                        //  set(keyname, val);
                                                        // 单选不应该多处地方有关联选中
                                                        // relatedModel &amp;&amp; relatedModel.each(function(i, item) {
                                                        //     this.checked = true;
                                                        // })
                            
                                                        break;
                                                }
                            
                                                // 清空键值,防止读取的时候,直接累计
                                                keyNames = [];
                                                // 阻止冒泡
                                                e.stopPropagation();
                            
                                            } catch (e) {
                                                ui.showLog(e)
                                            }
                                        }
                            
                                        // 针对select标签单独处理
                                        var selectTarget = &#x60;select[b-model*=${gid}]&#x60;;
                            
                                        $targetId.off(&quot;change&quot;, selectTarget).on(&quot;change&quot;, selectTarget, onSelected);
                            
                                        function onSelected(e) {
                                            try {
                            
                                                var val = $(this).val(),
                                                    index = this.selectedIndex,
                                                    type = this.multiple,
                                                    uid = getAttrs.call(this, &#x27;b-model&#x27;),
                                                    keyname = uid[0][&quot;keyname&quot;],
                                                    value = null;
                            
                                                // 缓存的键值
                                                // 获取值
                                                value = getKeyValue(keyname, module);
                            
                                                // 如果值是
                                                switch (type) {
                                                    case true:
                                                        if (ui.typeof(value) !== &quot;array&quot;) {
                                                            ui.showLog(&#x60;${keyname}的类型必须为数组&#x60;);
                                                        };
                                                        // 把选中的值存储起来
                                                        val.splice(0, 0, 0, val.length + 1);
                                                        value.splice.apply(value, val);
                                                        break;
                                                    default:
                                                        set(keyname, val)
                                                        break;
                                                }
                                                // 触发trigger
                                                triggermethod.call(this);
                            
                                                // 清空键值,防止读取的时候,直接累计
                                                keyNames = [];
                                                // 阻止冒泡
                                                e.stopPropagation();
                            
                                            } catch (e) {
                                                ui.showLog(e)
                                            }
                            
                                        }
                            
                                    }
                            
                                    // 针对点击事件处理
                                    function compileEventChecked(targetId) {
                                        var $targetId = targetId;
                            
                                        // 双向绑定的处理
                                        $targetId.off(&quot;change&quot;, &#x60;[b-checked*=${gid}]&#x60;).on(&quot;change&quot;, &#x60;[b-checked*=${gid}]&#x60;, function (e) {
                                            var val = this.checked;
                                            var uid = getAttrs.call(this, &#x27;b-checked&#x27;);
                                            var keyname = uid[0][&quot;keyname&quot;];
                            
                                            set(keyname, val)
                                            // 关联触发
                                            triggermethod.call(this);
                                            // 清空键值,防止读取的时候,直接累计
                                            keyNames = [];
                            
                                            // 阻止冒泡
                                            e.stopPropagation();
                                        })
                            
                                    }
                                    // 针对点击事件处理
                                    function compileEvent(targetId) {
                                        var $targetId = targetId;
                            
                                        var eventGroup = [&#x27;b-click&#x27;, &#x27;b-submit&#x27;, &#x27;b-change&#x27;, &#x27;b-scroll-lazy&#x27;, &#x27;b-scroll&#x27;, &#x27;b-keydown&#x27;, &#x27;b-keyup&#x27;, &#x27;b-keypress&#x27;, &#x27;b-focus&#x27;, &#x27;b-input-lazy&#x27;, &#x27;b-input&#x27;, &#x27;b-blur&#x27;, &#x27;b-mousedown&#x27;, &#x27;b-mouseover&#x27;, &#x27;b-mousemove&#x27;, &#x27;b-mouseup&#x27;, &#x27;b-mouseleave&#x27;, &#x27;b-touchstart&#x27;, &#x27;b-touchmove&#x27;, &#x27;b-touchend&#x27;, &#x27;b-touchcancel&#x27;];
                            
                                        eventGroup.forEach(function (item, index) {
                                            var eventtype = item.substr(2);
                            
                                            let scrollFun = function (e) {
                                                // 所有绑定的事件开始触发前
                                                option.onBeforeEvent &amp;&amp; option.onBeforeEvent.call(this, e, item);
                                                // console.trace(item,123)
                                                var cansubmit = compileClick.call(this, e, item);
                                                // 阻止事件冒泡
                                                if (cansubmit === false) {
                                                    return false;
                                                }
                                                // 默认阻止事件冒泡
                                                if (cansubmit === undefined) {
                                                    e.stopPropagation();
                                                }
                                            } //ui.unit.debounce(loadMore, option.delayTime)
                                            if (eventtype === &quot;scroll-lazy&quot; || eventtype === &quot;scroll&quot;) {
                                                let $scroll = $targetId.find(&#x60;[${item}*=${gid}]&#x60;);
                                                // 通过属性配置scroll延迟时间
                                                let lazy = $scroll.attr(&quot;lazy&quot;) ? parseInt($scroll.attr(&quot;lazy&quot;)) : 300;
                            
                                                scrollFun = eventtype === &quot;scroll-lazy&quot; ? ui.unit.debounce(scrollFun, lazy) : scrollFun;
                            
                                                // zepto滚动事件不能使用事件委托方法
                                                $scroll.off(&quot;scroll&quot;).on(&quot;scroll&quot;, scrollFun);
                                            } else if (eventtype === &quot;input-lazy&quot; || eventtype === &quot;input&quot;) {
                                                // 实时输入
                                                let $scroll = $targetId.find(&#x60;[${item}*=${gid}]&#x60;);
                                                // 通过属性配置scroll延迟时间
                                                let lazy = $scroll.attr(&quot;lazy&quot;) ? parseInt($scroll.attr(&quot;lazy&quot;)) : 300;
                                                scrollFun = eventtype === &quot;input-lazy&quot; ? ui.unit.debounce(scrollFun, lazy) : scrollFun;
                                                // zepto滚动事件不能使用事件委托方法
                                                $scroll.off(&quot;input&quot;).on(&quot;input&quot;, scrollFun);
                                            } else if (eventtype === &quot;touchstart&quot; || eventtype === &quot;touchmove&quot; || eventtype === &quot;touchend&quot; || eventtype === &quot;touchcancel&quot;) {
                                                // 事件类型
                                                var eventTouch = {
                                                    touchstart: &quot;touchstart&quot;,
                                                    touchmove: &quot;touchmove&quot;,
                                                    touchend: &quot;touchend&quot;,
                                                    touchcancel: &quot;touchcancel&quot;,
                                                }
                                                if (ui.platform.isPC()) {
                                                    eventTouch = {
                                                        touchstart: &quot;mousedown&quot;,
                                                        touchmove: &quot;mousemove&quot;,
                                                        touchend: &quot;mouseup&quot;,
                                                        touchcancel: &quot;mouseleave&quot;,
                                                    }
                                                }
                            
                                                $targetId.off(eventTouch[eventtype], &#x60;[${item}*=${gid}]&#x60;).on(eventTouch[eventtype], &#x60;[${item}*=${gid}]&#x60;, scrollFun);
                                            } else {
                                                // 事件绑定
                                                $targetId.off(eventtype, &#x60;[${item}*=${gid}]&#x60;).on(eventtype, &#x60;[${item}*=${gid}]&#x60;, scrollFun);
                                            }
                                        })
                                    }
                            
                                    // 针对click事件的触发
                                    function compileClick(e, type) {
                                        var _self = this; // dom
                                        var uid = getAttrs.call(this, type);
                            
                                        var keyname = uid[0][&quot;keyname&quot;]; // 对象,方法,数组
                                        var param = uid[0][&quot;param&quot;]; // 执行的形参
                                        var value = null;
                            
                                        // 把当前点击的对象参数,放在最后一个,非必须使用
                                        param.push(e);
                            
                                        // 缓存的键值
                                        try {
                            
                                            // 获取值
                                            value = getKeyValue(keyname, module);
                            
                                            // 执行回调
                                            var res = typeof value === &quot;function&quot; &amp;&amp; value.apply(module, param);
                            
                                            // 清空键值,函数里面可能会读取一些键值,导致报错
                                            keyNames = [];
                                            // 手动触发初始值
                                            trigger(keyname, {
                                                target: this,
                                                value: value,
                                                action: &quot;set&quot;,
                                                keyname: keyname,
                                                param: param,
                                                origin: cacheData
                                            });
                            
                                            return res;
                                        } catch (err) {
                                            ui.showLog(err)
                                        }
                                    }
                                    // 针对数组的解析
                                    function compileView(opt) {
                                        loader.views({
                                            id: opt.id,
                                            loaded: function (item) {
                                                // 每次结束后继续编译动态属性, 如果有嵌套的view, 这个view的模板必须已经加载过的, 随时可能编译数据的时候,模板还在请求.
                                                compile(item.el);
                                            },
                                            compiled: opt.compiled
                                        })
                                    }
                            
                                    // function compileView($targetId) {
                                    //     // 根据数据绑定模板
                                    //     var $datasource = typeof $targetId === &quot;string&quot; ? ui.$($targetId).find(&#x60;view&#x60;) : $targetId.find(&#x60;view&#x60;);
                            
                                    //     var components = [];
                                    //     var _modules = loader.map()[&quot;modules&quot;];
                                    //     $datasource.each(function(index, item) {
                                    //         var name = item.getAttribute(&quot;name&quot;);
                                    //         var gid = ui.guid();
                                    //         !item.id &amp;&amp; item.setAttribute(&quot;id&quot;, gid);
                                    //         // 卡槽分发
                                    //         var slot = item.innerHTML;
                                    //         var tpl = _modules[name] &amp;&amp; _modules[name][&quot;template&quot;] ? _modules[name][&quot;template&quot;] : name + &quot;.html&quot;;
                                    //         components.push({
                                    //             id: item.id,
                                    //             el: item,
                                    //             name: name,
                                    //             url: tpl,
                                    //             slot: slot
                                    //         })
                            
                                    //     });
                                    //     // 同步请求
                                    //     ;
                                    //     (function createSource(i) {
                            
                                    //         if (i == components.length) {
                            
                                    //             components.forEach(function(item, index) {
                            
                                    //                 item.el.innerHTML = item.template; // &amp;&amp; item.template.replace(/\&lt;slot\&gt;\&lt;\/slot\&gt;/gi, item.slot);
                            
                                    //                 // 继续查找子模块
                                    //                 var rule = /&lt;view.+name=/g
                                    //                     // 如果存在子模板,继续请求创建
                                    //                 if (rule.test(item.template)) {
                                    //                     compileView($(item.el));
                                    //                 }
                                    //                 // 解析常用命令
                                    //                 compile(item.el);
                                    //             })
                                    //             return;
                                    //         }
                            
                                    //         if (!components[i]) {
                                    //             return;
                                    //         }
                            
                                    //         // 创建html并会缓存起来
                                    //         loader.importHtml(components[i][&quot;url&quot;], function(data) {
                                    //             // 缓存模板
                                    //             components[i][&quot;template&quot;] = data;
                                    //             //to do something
                                    //             createSource(i + 1);
                                    //         }, function(data) {
                                    //             // 缓存模板
                                    //             components[i][&quot;template&quot;] = &quot;&quot;;
                                    //             //to do something
                                    //             createSource(i + 1);
                                    //         })
                            
                                    //     })(0);
                            
                                    // }
                                    // 针对数组的解析
                                    function compileTemplate(targetId) {
                            
                                        var $targetId = targetId;
                            
                            
                                        // 根据数据绑定模板
                                        var $datasource = $targetId &amp;&amp; $targetId.find(&#x60;[b-template*=${gid}]&#x60;) || [];
                            
                                        var cachekeynames = [];
                            
                            
                                        if ($datasource.length) {
                            
                                            try {
                                                // 第一层模板是静态dom，如果嵌套模板，里面的dom需要动态查找，不能使用this,删除后会导致原本的模板处理不正确
                                                $datasource.each(function (i, item) {
                            
                                                    var target = this;
                                                    var $target = $dom(target);
                            
                                                    // 获取模板的键值
                                                    var tpl = getAttrs.call(this, &#x60;b-template&#x60;);
                                                    let origkey = this.getAttribute(&quot;b-template&quot;);
                            
                                                    var tplkeyname = tpl[0][&quot;keyname&quot;]; // 对象,方法,数组
                                                    var tplparam = tpl[0][&quot;param&quot;]; // 执行的形参
                            
                            
                                                    // 通过传的参数获取键值
                                                    var scopeSplit = gid + _scopeSplit; // page.
                            
                                                    if (!tplparam[0]) {
                                                        console.error(&#x27;b-template 没有找到数据源, 格式为: b-template=&quot;page.template(page.sources)&quot;&#x27;);
                                                        // return;
                                                    }
                            
                                                    var keyname = typeof tplparam[0] === &quot;string&quot; &amp;&amp; tplparam[0].replace(new RegExp(scopeSplit), &quot;&quot;) || &quot;&quot;; // 这里的keyname去掉 page.
                            
                            
                                                    // 支持自定义命令,默认是html,有部分模板是在结构里面的,需要放在dom
                                                    var command = $target.attr(&#x60;b-command&#x60;);
                                                    var commandName = command || &quot;html&quot;; // 默认数据的命令处理
                            
                                                    // 子集标签或样式, 用于子集不规则
                                                    var childrenItem = $target.attr(&quot;b-children&quot;) || $target.children()[0] &amp;&amp; $target.children()[0].tagName;
                                                    // 缓存的键值
                                                    var values = getKeyValue(keyname, module);
                            
                                                    // 公共数据先清理订阅
                                                    _isPublic &amp;&amp; off(keyname);
                            
                                                    // 缓存相同的键值字段,用于判断执行一次oneTick
                                                    if (onceKeynames.hasOwnProperty(keyname)) {
                                                        onceKeynames[keyname].push(keyname);
                                                    } else {
                                                        onceKeynames[keyname] = [keyname];
                                                    }
                                                    // var keynames = [keyname];
                                                    // 针对模板的传参转换成数据
                                                    // tplparam.forEach(function(item, index) {
                                                    //     if (typeof item === &quot;string&quot; &amp;&amp; item.indexOf(gid + _scopeSplit) == 0 &amp;&amp; index &gt; 0) {
                                                    //         var key = item.replace(new RegExp(scopeSplit), &quot;&quot;);
                                                    //         keynames.push(key);
                                                    //     }
                                                    // })
                            
                                                    function handleTpl(e) {
                            
                                                        try {
                            
                                                            if (origkey.includes(&quot;$itemIndex&quot;)) {
                                                                // 转换成动态索引，这样删除的索引才是正确的
                                                                let origkeyname = e.keyname.replace(/\d+/, &quot;$itemIndex&quot;);
                                                                let nums = e.keyname.match(/\d+/);
                            
                                                                $target = $page.find(&#x60;[b-template*=&quot;${origkey}&quot;]&#x60;).eq(nums[0]);
                                                            }
                            
                                                            // init 的时候, 没有param 传值
                                                            var param = e.param; // [1,0,&quot;&quot;] 从索引1开始插入数据 [1,1,&quot;11&quot;] 从索引1开始替换数据 [1,2] // 从索引1开始删除2个数据
                            
                                                            var value;
                            
                                                            switch (e.action) {
                                                                case &quot;push&quot;:
                                                                case &quot;unshift&quot;:
                                                                    // 这些方法的改变不一定是自身的数据变化,不做处理
                                                                    // case &quot;concat&quot;:
                                                                    // case &quot;filter&quot;:
                                                                    // case &quot;some&quot;:
                                                                    // case &quot;reduce&quot;:
                                                                    // case &quot;map&quot;:
                                                                    // case &quot;every&quot;:
                                                                    value = param;
                            
                                                                    break;
                                                                case &quot;splice&quot;:
                                                                    value = param.slice(2) || &quot;&quot;;
                                                                    break;
                                                                case &quot;setState&quot;:
                                                                    commandName = &quot;html&quot;;
                                                                    value = e.value;
                                                                    break;
                                                                default:
                                                                    // init
                                                                    value = e.value;
                                                            }
                            
                                                            var dom = null;
                            
                                                            if (_templates &amp;&amp; _templates.hasOwnProperty(tplkeyname)) {
                            
                                                                // 针对模板的传参转换成数据
                                                                tplparam = tplparam.map(function (item, index) {
                                                                    if (typeof item === &quot;string&quot; &amp;&amp; item.indexOf(gid + _scopeSplit) == 0 &amp;&amp; index &gt; 0) {
                                                                        var key = item.replace(new RegExp(scopeSplit), &quot;&quot;);
                                                                        return getKeyValue(key, cacheData);
                                                                    } else {
                                                                        return item;
                                                                    }
                                                                })
                            
                                                                // 把数据源替换成真实数据
                                                                tplparam[0] = value;
                                                                // 1.7.2 把参数发给外部的模板方法
                                                                tplparam[tplparam.length] = e;
                                                                // value 没有定义及值等于&quot;undefined&quot; 都不会进入模板
                                                                var html = typeof value !== &quot;undefined&quot; &amp;&amp; value !== &quot;undefined&quot; &amp;&amp; _templates[tplkeyname] &amp;&amp; _templates[tplkeyname].apply(module, tplparam);
                            
                                                                if (typeof html === &quot;undefined&quot;) {
                                                                    html = &quot;&quot;;
                                                                    ui.showLog(&#x60;${tplkeyname}模板方法需要返回内容，例如：return html;&#x60;)
                                                                }
                                                                // 解析{{}}
                                                                // html = compileHtml(html);
                                                                // 公共数据拿到动态selector
                                                                if (_isPublic) {
                                                                    $target = $dom(&#x60;[b-template*=&quot;${scopeSplit + keyname}&quot;]&#x60;);
                                                                }
                            
                                                                var preValue = e.preValue || [];
                            
                                                                // 如果操作数据前,数据为空,都应该清空下数据
                                                                if (preValue.length == 0 &amp;&amp; commandName == &quot;html&quot;) {
                            
                                                                    $target.empty();
                                                                }
                            
                            
                                                                var $children = childrenItem ? $target.children(childrenItem) : $target.children();
                                                                // 旧子集选择器
                                                                var $childrenOld = $children;
                                                                var paramLen = param &amp;&amp; param.length || 0;
                            
                                                                // !$children.length &amp;&amp; ui.showLog(&#x60;请检查b-template的子集是否正确,找不到对应${childrenItem}&#x60;)
                                                                var $newTarget = null;
                                                                // 触发 compileCommon ,避免删除旧的订阅
                                                                firstInit = true;
                            
                                                                switch (e.action) {
                                                                    case &quot;push&quot;:
                                                                        $target.append(html);
                                                                        $children = $target.children(childrenItem);
                                                                        // 第一次的值等于dom的长度
                                                                        if (paramLen &amp;&amp; paramLen == $children.length) {
                                                                            compileCommon({
                                                                                el: $children,
                                                                                action: &#x27;push&#x27;
                                                                            });
                            
                                                                            compileTemplate($newTarget);
                            
                                                                            // $children.attr(&quot;data-children&quot;, keyname);
                                                                        } else if (paramLen &gt; 1) {
                                                                            var oldLen = $childrenOld.length;
                                                                            // 添加多个值, 旧的长度,小余新的长度,找到新的选择器
                                                                            for (var i = oldLen; i &lt; $children.length; i++) {
                                                                                $newTarget = $children.eq(oldLen + i - 1);
                                                                                // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                                compileCommon({
                                                                                    el: $newTarget,
                                                                                    action: &#x27;push&#x27;
                                                                                });
                            
                                                                                // 编译组件
                                                                                compileComp($newTarget);
                            
                                                                                compileTemplate($newTarget);
                                                                            }
                            
                                                                        } else {
                                                                            // 只有一个值的时候
                                                                            $newTarget = $children.last();
                                                                            // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                            compileCommon({
                                                                                el: $newTarget,
                                                                                action: &#x27;push&#x27;
                                                                            });
                            
                                                                            // 编译组件
                                                                            compileComp($newTarget);
                            
                                                                            compileTemplate($newTarget);
                                                                        }
                            
                                                                        break;
                                                                    case &quot;unshift&quot;:
                                                                        $target.prepend(html);
                                                                        $children = $target.children(childrenItem);
                                                                        // 第一次的值等于dom的长度
                                                                        if (paramLen &amp;&amp; paramLen == $children.length) {
                                                                            compileCommon({
                                                                                el: $children,
                                                                                action: &#x27;unshift&#x27;
                                                                            });
                            
                                                                            // $children.attr(&quot;data-children&quot;, keyname);
                                                                        } else if (paramLen &gt; 1) {
                                                                            // 添加多个值, 旧的长度,小余新的长度,找到新的选择器
                                                                            for (var i = 0; i &lt; paramLen; i++) {
                                                                                $newTarget = $children.eq(i);
                                                                                // $newTarget.attr(&quot;data-children&quot;, keyname);
                            
                                                                                compileCommon({
                                                                                    el: $newTarget,
                                                                                    action: &#x27;unshift&#x27;
                                                                                });
                            
                                                                                // 编译组件
                                                                                compileComp($newTarget);
                            
                            
                                                                                compileTemplate($newTarget);
                                                                            }
                            
                                                                        } else {
                                                                            // 只有一个值的时候
                                                                            $newTarget = $children.first();
                                                                            // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                            compileCommon({
                                                                                el: $newTarget,
                                                                                action: &#x27;unshift&#x27;
                                                                            });
                            
                                                                            // 编译组件
                                                                            compileComp($newTarget);
                            
                                                                            compileTemplate($newTarget);
                                                                        }
                                                                        break;
                                                                    case &quot;pop&quot;:
                                                                        $children.last().remove();
                                                                        $children = $target.children(childrenItem);
                                                                        $newTarget = $children.last();
                                                                        // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                        compileCommon({
                                                                            el: $newTarget,
                                                                            action: &#x27;pop&#x27;
                                                                        });
                            
                                                                        // 编译组件
                                                                        compileComp($newTarget);
                            
                            
                                                                        compileTemplate($newTarget);
                                                                        break;
                                                                    case &quot;shift&quot;:
                                                                        $children.first().remove();
                                                                        $children = $target.children(childrenItem);
                                                                        $newTarget = $children.first();
                                                                        // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                        compileCommon({
                                                                            el: $newTarget,
                                                                            action: &#x27;shift&#x27;
                                                                        });
                            
                                                                        // 编译组件
                                                                        compileComp($newTarget);
                            
                                                                        compileTemplate($newTarget);
                                                                        break;
                                                                    case &quot;length&quot;:
                                                                        // 忽略
                                                                        break;
                                                                    case &quot;splice&quot;:
                                                                        var index = parseInt(param[0]),
                                                                            num = parseInt(param[1]);
                            
                                                                        // 如果数字大于当前数组的长度,则是要替换数据
                                                                        if (num &gt;= preValue.length &amp;&amp; commandName == &quot;html&quot;) {
                                                                            $target.empty();
                                                                            $children = $target.children(childrenItem);
                                                                        }
                                                                        var length = $children.length,
                                                                            hasLength = length &gt; 0;
                                                                        var isReplace = false;
                            
                            
                                                                        // 方法1: 不完全更新数据
                                                                        if (num == 0) {
                            
                                                                            // 插入数据, 必须有长度大于索引的时候
                                                                            if (hasLength &amp;&amp; ((length - 1) &gt;= index)) {
                            
                                                                                $children.eq(index).before(html)
                                                                                $children = $target.children(childrenItem);
                            
                                                                                // 解析模板里面是否有行为标签
                                                                                for (var i = 0; i &lt; value.length; i++) {
                            
                                                                                    $newTarget = $children.eq(index + i);
                                                                                    // $newTarget.attr(&quot;data-children&quot;, keyname);
                            
                                                                                    compileCommon({
                                                                                        el: $newTarget,
                                                                                        action: &#x27;splice&#x27;
                                                                                    });
                            
                                                                                    // 编译组件
                                                                                    compileComp($newTarget);
                            
                            
                                                                                    compileTemplate($newTarget);
                                                                                }
                                                                            } else {
                            
                                                                                $target.append(html);
                                                                                $children = $target.children(childrenItem);
                            
                                                                                for (var i = 0; i &lt; value.length; i++) {
                            
                                                                                    $newTarget = $children.eq(length + i);
                                                                                    // $newTarget.attr(&quot;data-children&quot;, keyname);
                            
                                                                                    compileCommon({
                                                                                        el: $newTarget,
                                                                                        action: &#x27;splice&#x27;
                                                                                    });
                            
                                                                                    // 编译组件
                                                                                    compileComp($newTarget);
                            
                                                                                    compileTemplate($newTarget);
                                                                                }
                                                                            }
                            
                                                                        } else if (num &gt; 0) {
                                                                            var targetArrs = ui.unit.getKeyValue(e.keyname, e.origin);
                            
                                                                            if (param[1] - param[0] &gt;= (targetArrs &amp;&amp; targetArrs.length)) {
                                                                                isReplace = true;
                                                                            }
                            
                                                                            // 插入新数据
                                                                            if (typeof param[2] !== &quot;undefined&quot;) {
                                                                                if (hasLength &amp;&amp; ((length - 1) &gt;= index)) {
                            
                                                                                    $children.eq(index).before(html)
                                                                                    $children = $target.children(childrenItem);
                                                                                    for (var i = 0; i &lt; value.length; i++) {
                                                                                        $newTarget = $children.eq(index + i);
                                                                                        // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                                        compileCommon({
                                                                                            el: $newTarget,
                                                                                            action: &#x27;splice&#x27;,
                                                                                            replace: isReplace
                                                                                        });
                            
                                                                                        // 编译组件
                                                                                        compileComp($newTarget);
                            
                            
                                                                                        compileTemplate($newTarget);
                                                                                    }
                                                                                } else {
                                                                                    $target.append(html);
                                                                                    $children = $target.children(childrenItem);
                                                                                    for (var i = 0; i &lt; value.length; i++) {
                                                                                        $newTarget = $children.eq(length + i);
                                                                                        // $newTarget.attr(&quot;data-children&quot;, keyname);
                                                                                        compileCommon({
                                                                                            el: $newTarget,
                                                                                            action: &#x27;splice&#x27;,
                                                                                            replace: isReplace
                                                                                        });
                            
                                                                                        // 编译组件
                                                                                        compileComp($newTarget);
                            
                                                                                        compileTemplate($newTarget);
                                                                                    }
                                                                                }
                                                                            }
                                                                            // 删除多少个
                            
                                                                            let fixindex = 0;
                                                                            switch (commandName) {
                                                                                case &quot;append&quot;:
                                                                                    fixindex = $children.length - e.preValue.length || 0;
                                                                                    break;
                                                                                case &quot;prepend&quot;:
                                                                                case &quot;html&quot;:
                                                                                default:
                                                                                    fixindex = 0;
                                                                                    break;
                                                                            }
                                                                            // 如果有修改，要测试这个例子，看是否正常 http://localhost:4949/#pages/store/selectm
                                                                            let vallen = value.length;
                                                                            for (var i = 0; i &lt; num; i++) {
                                                                                $children.eq(index + vallen + i + fixindex).remove();
                                                                            }
                                                                            // 如果模板有默认值
                                                                            // console.log(e,value,num)
                                                                            if (html &amp;&amp; !e.value.length) {
                                                                                $target.html(html);
                                                                            }
                            
                                                                        }
                            
                                                                        break;
                                                                    case &quot;reverse&quot;:
                                                                    case &quot;sort&quot;:
                                                                        $target.html(html);
                                                                        compileCommon({
                                                                            el: $target,
                                                                            action: e.action
                                                                        });
                                                                        // 编译组件
                                                                        compileComp($target);
                            
                            
                                                                        compileTemplate($target);
                                                                        break;
                                                                    default:
                            
                                                                        $target[commandName](html);
                            
                                                                        compileCommon({ el: $target, action: e.action });
                            
                                                                        // 编译组件
                                                                        compileComp($target);
                            
                                                                        compileTemplate($target);
                            
                                                                        // 默认配置好模板的子级.
                                                                        // $target.children().attr(&quot;data-children&quot;, keyname);
                                                                        break;
                                                                }
                            
                            
                            
                                                                // 解析通用的命令属性,如果解析,会导致增加的回调批量增加,如果设置为true,则会删掉所有相同的键值,这是缺陷,会误伤其它行为命令,暂不解析.
                                                                // firstInit = true;
                                                                // compileCommon($newTarget);
                            
                                                                //  if ($target.find(&#x60;[b-template*=${gid}]&#x60;).length) {
                                                                //      compileTemplate($target);
                                                                //  } else {
                            
                                                                // dom 更新以后
                                                                trigger.call(module, &quot;nexttick&quot;, e);
                                                                //  }
                            
                                                            } else {
                                                                ui.showLog(&#x60;找不到对应的模板,请检查下 scope:${gid} 的templates是否存在${tplkeyname}&#x60;, &quot;bui.store&quot;)
                                                            }
                            
                                                        } catch (e) {
                                                            ui.showLog(e)
                                                        }
                                                    }
                            
                                                    // 监听处理
                                                    // off(keyname, handleTpl);
                                                    on(keyname, handleTpl);
                            
                                                    // 找到自己相同的数据源的最后一个再执行初始化
                                                    // 一个数据源有多个模板
                            
                                                    // 用于后面单独触发
                                                    if (!ui.array.compare(cachekeynames, keyname)) {
                                                        cachekeynames.push(keyname);
                                                    }
                            
                                                    // 清空键值
                                                    keyNames = [];
                            
                                                })
                            
                                                //相同数据源只触发一次
                                                autoTrigger(cachekeynames);
                            
                                            } catch (e) {
                                                ui.showLog(e);
                                            }
                                        }
                                    }
                            
                                    // 针对数组的解析
                                    function compileWatch(targetId) {
                            
                                        var $targetId = targetId;
                            
                                        // 根据数据绑定模板
                                        var $datasource = $targetId.find(&#x60;[b-watch*=${gid}]&#x60;);
                                        var $dataone = $targetId.find(&#x60;[b-one*=${gid}]&#x60;);
                            
                                        if ($datasource.length) {
                            
                                            try {
                                                handleWatchAction($datasource, &quot;b-watch&quot;, on);
                            
                                            } catch (e) {
                                                ui.showLog(e);
                                            }
                                        }
                                        // 只监听一次
                                        if ($dataone.length) {
                                            try {
                                                handleWatchAction($dataone, &quot;b-one&quot;, one);
                            
                                            } catch (e) {
                                                ui.showLog(e);
                                            }
                                        }
                                    }
                                    // 处理 b-watch b-one 的监听处理
                                    function handleWatchAction($data, attr, action) {
                                        $data.each(function (i, item) {
                            
                                            var $target = $dom(this);
                                            // 获取模板的键值
                                            var tpl = getAttrs.call(this, attr);
                            
                                            var tplkeyname = tpl[0][&quot;keyname&quot;]; // 对象,方法,数组
                                            var tplparam = tpl[0][&quot;param&quot;]; // 执行的形参
                            
                                            // 通过传的参数获取键值
                                            var scopeSplit = gid + _scopeSplit; // page.
                            
                                            if (!tplparam[0]) {
                                                console.error(&#x60;${attr} 没有找到数据源, 格式为: ${attr}=&quot;page.doit(page.sources)&quot;&#x60;);
                                                // return;
                                            }
                            
                                            var keyname = typeof tplparam[0] === &quot;string&quot; &amp;&amp; tplparam[0].replace(new RegExp(scopeSplit), &quot;&quot;) || &quot;&quot;; // 这里的keyname去掉 page.
                            
                                            // 缓存的键值
                                            var values = getKeyValue(keyname, module);
                                            var that = this;
                                            tpl[0][&quot;paramKeyname&quot;].forEach(function (item, index) {
                                                // off(item, handleWatch);
                            
                                                action(item, handleWatch);
                                            })
                            
                                            function handleWatch(val) {
                                                // 获取模板的键值
                                                var tpl = getAttrs.call(that, attr);
                            
                                                var tplkeyname = tpl[0][&quot;keyname&quot;]; // 对象,方法,数组
                                                var tplparam = tpl[0][&quot;param&quot;]; // 执行的形参
                            
                                                tplparam.push(val);
                                                cacheModule[tplkeyname].apply(module, tplparam)
                                            }
                            
                                        })
                                    }
                            
                                    // 取相反值
                                    function getReverse(property) {
                                        var pro = this.getAttribute(property);
                                        return pro.indexOf(&quot;!&quot;) == 0 ? true : false;
                                    }
                                    // 针对不同命令的不同处理
                                    function setText(e) {
                            
                                        var property = &quot;b-text&quot;;
                                        var target = getTarget.call(this, e, property);
                                        var reverse = getReverse.call(this, property);
                            
                                        var value = &quot;&quot;,
                                            type = ui.typeof(e.value),
                                            attrVal = target.attr(property);
                            
                                        var uid = getAttrs.call(this, property);
                            
                                        var keyname = uid[0] &amp;&amp; uid[0][&quot;keyname&quot;] || &quot;&quot;; // 对象,方法,数组
                                        var param = uid[0] &amp;&amp; uid[0][&quot;param&quot;] || {}; // 执行的形参
                            
                                        switch (type) {
                                            case &quot;array&quot;:
                                                value = getLengthValue(e, attrVal);
                                                break;
                                            case &quot;function&quot;:
                                                value = e.value.apply(module, param);
                                                break;
                                            default:
                                                value = e.value;
                                                break;
                                        }
                            
                                        value = reverse ? !(value) : value;
                            
                                        this.innerText = value;
                            
                                        this.removeAttribute(&quot;b-cloak&quot;)
                            
                                        keyNames = [];
                                    }
                            
                                    // 获取是公共的还是私有的选择器
                                    function getTarget(e, command) {
                                        var bid = gid + _scopeSplit + e.keyname;
                                        var target = _isPublic ? $(&#x60;[${command}=&quot;${bid}&quot;]&#x60;) : $dom(this);
                            
                                        return target;
                                    }
                                    // 获取长度或者值
                                    function getLengthValue(e, type) {
                            
                                        if (type.indexOf(&quot;.length&quot;) &gt; -1) {
                                            return e.value[&quot;length&quot;] || 0;
                                        } else if (ui.typeof(e.value) === &quot;object&quot;) {
                                            try {
                                                return JSON.stringify(e.value);
                                            } catch (e) {
                                                return e.value;
                                            }
                                        } else if (ui.typeof(e.value) === &quot;array&quot;) {
                                            e.value = e.value.map((item, index) =&gt; {
                                                if (typeof item === &quot;object&quot;) {
                                                    try {
                                                        return JSON.stringify(item);
                                                    } catch (e) {
                                                        return item;
                                                    }
                                                } else {
                                                    return item;
                                                }
                                            })
                                            return e.value.join(&quot;,&quot;)
                                        } else {
                                            return e.value;
                                        }
                                        //  return type.indexOf(&quot;.length&quot;) &gt; -1 ? e.value[&quot;length&quot;] || 0 :
                                        //      (e.value instanceof Array) ? e.value.join(&quot;,&quot;) : e.value;
                                    }
                            
                                    function setHtml(e) {
                            
                                        var property = &quot;b-html&quot;;
                                        var target = getTarget.call(this, e, property);
                                        var reverse = getReverse.call(this, property);
                            
                                        var value = &quot;&quot;,
                                            type = ui.typeof(e.value),
                                            attrVal = target.attr(property);
                            
                                        var uid = getAttrs.call(this, property);
                                        var keyname = uid[0] &amp;&amp; uid[0][&quot;keyname&quot;] || &quot;&quot;; // 对象,方法,数组
                                        var param = uid[0] &amp;&amp; uid[0][&quot;param&quot;] || {}; // 执行的形参
                            
                                        switch (type) {
                                            case &quot;array&quot;:
                                                value = getLengthValue(e, attrVal);
                                                break;
                                            case &quot;function&quot;:
                                                value = e.value.apply(module, param);
                                                break;
                                            default:
                                                value = e.value;
                                                break;
                                        }
                            
                                        value = reverse ? !(value) : value;
                            
                                        target.html(value);
                                        keyNames = [];
                            
                                        this.removeAttribute(&quot;b-cloak&quot;);
                                    }
                            
                            
                                    function setValue(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-value&quot;);
                            
                                        if (_isPublic) {
                                            // 公共拿到的是多选择器
                                            target.each(function (i, item) {
                                                setSingleValue.call(this, e)
                                            })
                                        } else {
                                            setSingleValue.call(target[0], e)
                                        }
                                        keyNames = [];
                                    }
                                    // 获取自身的属性去设置
                                    function setSingleValue(e) {
                                        var type = this.getAttribute(&quot;type&quot;),
                                            value = this.value,
                                            _self = this,
                                            attrVal = this.getAttribute(&quot;b-value&quot;);
                            
                                        // 单选多选不设置值
                                        switch (type) {
                                            case &quot;radio&quot;:
                                                if (value == e.value) {
                                                    this.checked = true;
                                                } else {
                                                    this.checked = false;
                                                }
                                                break;
                                            case &quot;checkbox&quot;:
                                                if (ui.typeof(e.value) === &quot;array&quot;) {
                            
                                                    e.value.forEach(function (item, i) {
                            
                                                        if (value == item) {
                                                            _self.checked = true;
                                                        }
                                                    })
                                                }
                                                break;
                                            default:
                                                this.value = getLengthValue(e, attrVal);;
                                                break;
                                        }
                            
                                    }
                                    // 延迟设置
                                    function setModelLazy(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-model-lazy&quot;);
                            
                                        if (_isPublic) {
                                            // 公共拿到的是多选择器
                                            target.each(function (i, item) {
                                                setSingleModel.call(this, e)
                                            })
                                        } else {
                            
                                            setSingleModel.call(target[0], e)
                                        }
                                    }
                            
                            
                                    function setModel(e) {
                                        var target = getTarget.call(this, e, &quot;b-model&quot;);
                            
                                        if (_isPublic || target.length &gt; 1) {
                                            // 公共拿到的是多选择器
                                            target.each(function (i, item) {
                                                setSingleModel.call(this, e)
                                            })
                                        } else {
                                            setSingleModel.call(target[0], e)
                                        }
                                    }
                            
                                    let needTrigger = true;
                                    // 设置单个model
                                    function setSingleModel(e) {
                            
                                        var _self = this,
                                            type = _self.getAttribute(&quot;type&quot;),
                                            value = _self.value,
                                            param = e.param;
                            
                                        // 多选select 采用不一样的设置值的方式
                                        if (_self.nodeName === &quot;SELECT&quot; &amp;&amp; _self.multiple) {
                            
                                            if (e.value.length &gt; 1) {
                            
                                                e.value.forEach(function (item, i) {
                                                    if (typeof item === &quot;string&quot;) {
                                                        $(_self).find(&#x60;option[value=${item}]&#x60;).attr(&quot;selected&quot;, true);
                                                    } else {
                                                        $(_self).find(&#x60;option[value=${item.value}]&#x60;).attr(&quot;selected&quot;, true);
                                                    }
                                                })
                                            } else {
                                                _self.value = e.value[0];
                                            }
                            
                                            return;
                                        }
                                        // component
                                        if (_self.nodeName === &quot;COMPONENT&quot;) {
                            
                                            let id = _self.id ? _self.id : ui.guid();
                                            // 先设置一个id
                                            !_self.id &amp;&amp; (_self.id = id);
                                            let everytime = _self.getAttribute(&quot;everytime&quot;) === &quot;true&quot; ? true : false;
                            
                                            // 手动编译一次
                                            loader.delay({
                                                id: &#x60;#${_self.id}&#x60;,
                                                everytime: everytime,
                                                param: {
                                                    value: e.value,
                                                    keyname: e.keyname
                                                }
                                            });
                            
                                            return;
                                        }
                            
                                        // 单选多选不设置值
                                        switch (type) {
                                            case &quot;radio&quot;:
                            
                                                if (value == e.value || String(value) == String(e.value)) {
                                                    _self.checked = true;
                                                } else {
                                                    _self.checked = false;
                                                }
                                                break;
                                            case &quot;checkbox&quot;:
                            
                            
                                                if (value &amp;&amp; ui.typeof(e.value) === &quot;array&quot;) {
                            
                                                    // console.log(e,e.param,e.value,1234)
                                                    switch (e.action) {
                                                        case &quot;push&quot;:
                                                        case &quot;unshift&quot;:
                            
                                                            let firstVal = e.param ? e.param[0] : [];
                                                            let paras = typeof firstVal == &quot;string&quot; &amp;&amp; firstVal.indexOf(&quot;,&quot;) &gt; -1 ? firstVal.split(&quot;,&quot;) : e.param;
                                                            paras &amp;&amp; paras.filter(function (item, i) {
                                                                if (value === item) {
                                                                    _self.checked = true;
                                                                    return;
                                                                }
                                                            })
                                                            break;
                                                        case &quot;pop&quot;:
                                                        case &quot;shift&quot;:
                                                            e.param &amp;&amp; e.param.filter(function (item, i) {
                                                                if (value === item) {
                                                                    _self.checked = false;
                                                                }
                                                            })
                                                            break;
                                                        case &quot;splice&quot;:
                            
                                                            var arrayParam = e.param,
                                                                num = arrayParam &amp;&amp; arrayParam[1] &amp;&amp; parseInt(arrayParam[1]),
                                                                spliceValue = arrayParam &amp;&amp; arrayParam.slice(2); // 是否有插入值
                            
                                                            // 方法1: 不完全更新数据
                                                            if (num == 0) {
                                                                // e.preValue.filter(function(item, i) {
                                                                //     if (value === item) {
                                                                //         _self.checked = false;
                                                                //     }
                                                                // })
                            
                                                                spliceValue.forEach(function (item, i) {
                                                                    if (value === item) {
                                                                        _self.checked = true;
                                                                    }
                                                                })
                            
                                                            } else if (num &gt; 0) {
                                                                // 插入新数据
                                                                // if (typeof arrayParam[2] !== &quot;undefined&quot;) {
                                                                //     spliceValue.filter(function(item, i) {
                                                                //         if (value === item) {
                                                                //             _self.checked = true;
                                                                //         }
                                                                //     })
                                                                // }
                            
                                                                // 删除
                                                                // if (spliceValue.length == 0) {
                                                                e.preValue.forEach(function (item, i) {
                                                                    if (i &lt;= e.param[1]) {
                                                                        _self.checked = false;
                                                                    }
                                                                })
                                                                e.value.forEach(function (item, i) {
                                                                    if (value === item) {
                                                                        _self.checked = true;
                                                                    }
                                                                })
                                                                // }
                                                            }
                                                            break;
                                                        case &quot;length&quot;:
                                                            // 忽略
                                                            break;
                                                        default:
                            
                                                            e.value.filter(function (item, i) {
                                                                if (value == item) {
                                                                    _self.checked = true;
                                                                }
                                                            })
                                                            break;
                                                    }
                                                } else {
                                                    // value = _self.checked;
                                                    // console.log(1111, value, e.value)
                                                    // 布尔值的处理
                                                    if (e.value === value || e.value == true) {
                                                        _self.checked = true;
                                                    } else {
                                                        _self.checked = false;
                                                    }
                                                }
                            
                                                break;
                                            default:
                                                // input, select 单选
                            
                                                // IOS 设置value会导致焦点在后面,正在输入无需设置
                                                if (event &amp;&amp; event.target &amp;&amp; event.target.nodeName === &quot;INPUT&quot; &amp;&amp; event.target === _self &amp;&amp; _self.value === e.value) {
                            
                                                    break;
                                                }
                            
                            
                                                if (_self.nodeName === &quot;INPUT&quot; || _self.nodeName === &quot;TEXTAREA&quot;) {
                                                    // 不再触发自身的 onInput ，但会触发外部的 input
                                                    inputChange = true;
                                                    // 这个事件容易导致死循环
                                                    // 改变的时候自动触发自定义事件
                                                    $(_self).trigger(&quot;input&quot;, e);
                                                }
                            
                                                _self.value = e.value;
                            
                                                // 触发外部的change
                                                break;
                                        }
                                        keyNames = [];
                                    }
                            
                                    function setDisplay(e) {
                                        var target = getTarget.call(this, e, &quot;b-show&quot;);
                            
                                        // 0,[],&quot;&quot;,null 才能进入第2个判断
                                        if ((e.value &amp;&amp; e.value.length) || (typeof (e.value) !== &quot;object&quot; &amp;&amp; Boolean(e.value) == true)) {
                                            this.removeAttribute(&quot;style&quot;);
                                        } else if (e.value === &quot;&quot; || (e.value &amp;&amp; !e.value.length) || Boolean(e.value) == false) {
                                            target.css(&quot;display&quot;, &quot;none&quot;);
                                            // this.style.display = &quot;none&quot;;
                                        }
                            
                                        keyNames = [];
                                    }
                            
                                    function setVisible(e) {
                                        var target = getTarget.call(this, e, &quot;b-visible&quot;);
                            
                                        if (e.value &amp;&amp; e.value.length &amp;&amp; (typeof (e.value) !== &quot;object&quot; &amp;&amp; Boolean(e.value) == true)) {
                                            this.removeAttribute(&quot;style&quot;);
                            
                                        } else if (e.value === &quot;&quot; || (e.value &amp;&amp; !e.value.length) || Boolean(e.value) == false) {
                                            target.css(&quot;visibility&quot;, &quot;hidden&quot;);
                                        }
                                        keyNames = [];
                                    }
                                    // 修改隐藏
                                    function setDisplayReverse(e) {
                                        // 这里的选择器比较特殊,单独处理
                                        var bid = &quot;!&quot; + gid + _scopeSplit + e.keyname;
                                        var target = _isPublic ? $(&#x60;[b-show=&quot;${bid}&quot;]&#x60;) : $dom(this);
                            
                                        if ((ui.typeof(e.value) === &quot;array&quot; &amp;&amp; e.value.length) || (typeof (e.value) !== &quot;object&quot; &amp;&amp; Boolean(e.value) == true)) {
                                            target.css(&quot;display&quot;, &quot;none&quot;)
                                        } else if (e.value === &quot;&quot; || (e.value &amp;&amp; !e.value.length) || Boolean(e.value) == false) {
                                            target.removeAttr(&quot;style&quot;);
                                        }
                                    }
                                    // 修改状态
                                    function setChecked(e) {
                                        this.checked = !!e.value;
                                        keyNames = [];
                                    }
                            
                                    // 针对属性处理
                                    function setAttr(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-bind&quot;);
                            
                                        var _self = this;
                                        var keyname = e.keyname,
                                            value = e.value;
                                        // 设置对应的属性
                                        if (typeof value === &quot;object&quot;) {
                                            // 监听每个键值需要处理的事件
                                            for (let key in value) {
                                                // 监听到每个属性的改变
                                                on(keyname + &quot;.&quot; + key, function (ev) {
                            
                                                    var targets = getTarget.call(_self, e, &quot;b-bind&quot;);
                                                    // if( key === &quot;disabled&quot; ){
                                                    //   ev.value ? targets.attr(key, ev.value) : targets.removeAttr(key);
                                                    // }else if( key === &quot;checked&quot; ){
                                                    //   targets.prop(key, ev.value);
                                                    // }else{
                                                    //   targets.attr(key, ev.value);
                                                    // }
                                                    setProperty(targets, key, ev.value);
                                                })
                                                //  if( key === &quot;disabled&quot; ){
                                                //    value ? target.attr(key, value[key]) : target.removeAttr(key);
                                                //  }else if( key === &quot;checked&quot; ){
                                                //    target.prop(key, value[key]);
                                                //  }else{
                                                //   target.attr(key, value[key]);
                                                // }
                                                setProperty(target, key, value[key]);
                                            }
                                        } else {
                                            var ks = typeof keyname === &quot;string&quot; &amp;&amp; keyname.split(&quot;.&quot;),
                                                lastKeyname = ks[ks.length - 1];
                            
                                            setProperty(target, lastKeyname, value);
                                            // if( lastKeyname === &quot;disabled&quot; ){
                                            //   value ? target.attr(lastKeyname, value) : target.removeAttr(lastKeyname);
                                            // }else if( lastKeyname === &quot;checked&quot; ){
                                            //   target.prop(lastKeyname, value);
                                            // }else{
                                            //   target.attr(lastKeyname, value);
                                            // }
                                        }
                                    }
                            
                                    function setProperty(target, key, value) {
                            
                                        switch (key) {
                                            case &quot;disabled&quot;:
                                                value ? target.attr(key, value) : target.removeAttr(key);
                                                break;
                                            case &quot;checked&quot;:
                                                target.prop(key, value);
                                                break;
                                            default:
                                                var valStr = typeof value === &quot;object&quot; ? JSON.stringify(value) : value;
                                                target.attr(key, valStr);
                                                break;
                                        }
                                        keyNames = [];
                                    }
                            
                                    function setDisabled(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-disabled&quot;);
                            
                                        var _self = this;
                            
                                        e.value ? target.attr(&quot;disabled&quot;, e.value) : target.removeAttr(&quot;disabled&quot;);
                            
                                        keyNames = [];
                                    }
                            
                                    function setReadonly(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-readonly&quot;);
                            
                                        var _self = this;
                            
                                        e.value ? target.attr(&quot;readonly&quot;, e.value) : target.removeAttr(&quot;readonly&quot;);
                            
                                        keyNames = [];
                                    }
                            
                                    function setAttrSrc(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-src&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;src&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrMin(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-min&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;min&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrMax(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-max&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;max&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrStep(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-step&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;step&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrPlaceholder(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-placeholder&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;placeholder&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrTitle(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-title&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;title&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrData(e) {
                                        // 这里要改为支持多个自定义属性
                                        var target = getTarget.call(this, e, &quot;b-data&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;data&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrId(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-id&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;id&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrHref(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-href&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;href&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrType(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-type&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;type&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    function setAttrName(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-name&quot;);
                            
                                        var _self = this;
                            
                                        target.attr(&quot;name&quot;, e.value);
                                        keyNames = [];
                                    }
                            
                                    // 针对样式标签处理
                                    function setStyle(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-style&quot;);
                            
                                        var _self = this;
                            
                                        // 设置对应的属性
                                        if (typeof e.value === &quot;object&quot;) {
                                            // 监听每个键值需要处理的事件
                                            for (let key in e.value) {
                                                // 监听到每个属性的改变
                                                on(e.keyname + &quot;.&quot; + key, function (ev) {
                                                    var targets = getTarget.call(_self, e, &quot;b-style&quot;);
                            
                                                    targets.css(key, ev.value);
                                                })
                            
                                                target.css(e.value)
                                            }
                                        } else {
                                            target.css(e.keyname, e.value)
                                        }
                                        keyNames = [];
                                    }
                            
                                    // 针对组件参数同步处理，组件会重新编译接收参数
                                    function setProp(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-prop&quot;);
                            
                                        var _self = this;
                            
                                        let val = &quot;&quot;;
                                        // 如果监听到值不是对象，需要加上keyname
                                        if (ui.typeof(e.value) === &#x27;object&#x27;) {
                                            val = e.value;
                                        } else {
                                            let keyname = e.keyname.indexOf(&quot;.&quot;) &gt; -1 ? e.keyname.split(&quot;.&quot;).pop() : e.keyname;
                                            let obj = {};
                                            obj[keyname] = e.value;
                            
                                            val = obj;
                                        };
                            
                                        let id = this.id ? this.id : ui.guid();
                                        // 先设置一个id
                                        !this.id &amp;&amp; (this.id = id);
                                        let everytime = this.getAttribute(&quot;everytime&quot;) === &quot;false&quot; ? false : true;
                            
                                        ui.$(&#x60;#${this.id}&#x60;).attr(val);
                            
                                        loader.delay({
                                            id: &#x60;#${this.id}&#x60;,
                                            everytime: everytime,
                                            param: val
                                        })
                            
                                        keyNames = [];
                                    }
                                    // 针对组件参数同步处理,同步旧参数
                                    function setProps(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-props&quot;);
                            
                                        var _self = this;
                            
                                        let val = &quot;&quot;;
                                        // 如果监听到值不是对象，
                                        if (ui.typeof(e.value) === &#x27;object&#x27;) {
                                            val = e.value;
                                        } else {
                                            let keyname = e.keyname.indexOf(&quot;.&quot;) &gt; -1 ? e.keyname.split(&quot;.&quot;).pop() : e.keyname;
                                            let obj = {};
                                            obj[keyname] = e.value;
                            
                                            val = obj;
                                        };
                            
                            
                                        // 合并旧参数，每次改变可以只改变某个主要数据
                                        let comp = ui.history.getLast()[&#x27;component&#x27;][this.id];
                                        let oldparam = comp &amp;&amp; comp[&#x27;param&#x27;];
                                        let vals = $.extend(true, {}, oldparam, val);
                            
                                        let id = this.id ? this.id : ui.guid();
                                        // 先设置一个id
                                        !this.id &amp;&amp; (this.id = id);
                                        let everytime = this.getAttribute(&quot;everytime&quot;) === &quot;false&quot; ? false : true;
                            
                                        ui.$(&#x60;#${this.id}&#x60;).attr(vals);
                            
                                        loader.delay({
                                            id: &#x60;#${this.id}&#x60;,
                                            everytime: everytime,
                                            param: vals
                                        })
                            
                                        keyNames = [];
                                    }
                                    // 针对样式属性处理, 支持对象,布尔值,字符串
                                    function setClass(e) {
                            
                                        var target = getTarget.call(this, e, &quot;b-class&quot;);
                                        var _self = this;
                                        var classCache = this.classList;
                                        var keyname2 = e.keyname || &quot;&quot;;
                            
                                        // 样式的处理可以是对象,可以是数组
                                        if (typeof e.value === &quot;object&quot;) {
                                            if (ui.typeof(e.value) === &quot;array&quot;) {
                                                // 清空默认样式
                                                if (!e.value.length) {
                                                    target.attr(&quot;class&quot;, &quot;&quot;);
                                                }
                                                // 全部增加
                                                e.value.forEach(function (item, key) {
                            
                                                    !target.hasClass(item) &amp;&amp; target.addClass(item);
                                                })
                            
                                                // 监听到每个属性的改变
                                                var $index = keyname2.indexOf(&quot;.$index&quot;);
                                                if ($index &gt; -1) {
                                                    on(keyname2.substr(0, $index) + &quot;.&quot; + $(target).index(), function (ev) {
                            
                                                        var targets = getTarget.call(_self, e, &quot;b-class&quot;);
                            
                                                        classAdd(targets, ev.value[targets.index()], ev.value);
                                                    })
                                                } else {
                                                    on(keyname2, function (ev) {
                            
                                                        var targets = getTarget.call(_self, e, &quot;b-class&quot;);
                            
                                                        classAdd(targets, ev.value[targets.index()], ev.value);
                                                    })
                                                }
                                            } else {
                                                // 监听每个键值需要处理的事件
                                                for (let key in e.value) {
                                                    let val = e.value[key];
                                                    let preValue = e.preValue &amp;&amp; e.preValue[key] || &quot;&quot;;
                            
                                                    // 监听到每个属性的改变
                                                    on(keyname2 + &quot;.&quot; + key, function (ev) {
                            
                                                        var targets = getTarget.call(_self, e, &quot;b-class&quot;);
                            
                                                        classAdd(targets, key, ev.value);
                                                    })
                            
                                                    // 如果值是布尔值,增加样式名在键值
                                                    classAdd(target, key, val, preValue);
                            
                                                }
                                            }
                            
                                        } else if (typeof e.value === &quot;function&quot;) {
                                            var uid = getAttrs.call(this, &quot;b-class&quot;);
                                            var keyname = uid[0] &amp;&amp; uid[0][&quot;keyname&quot;] || &quot;&quot;; // 对象,方法,数组
                                            var param = uid[0] &amp;&amp; uid[0][&quot;param&quot;] || {}; // 执行的形参
                                            var val = e.value.apply(module, param);
                            
                                            classAdd(target, keyname, val, e.preValue);
                            
                                        } else {
                                            var ks = typeof e.keyname === &quot;string&quot; &amp;&amp; e.keyname.split(&quot;.&quot;),
                                                lastKeyname = ks[ks.length - 1];
                                            classAdd(target, lastKeyname, e.value, e.preValue);
                                        }
                                        keyNames = [];
                                    }
                            
                                    function classAdd(target, key, val, preValue) {
                                        if (typeof val === &quot;boolean&quot;) {
                                            val &amp;&amp; target.addClass(key);
                                            !val &amp;&amp; target.removeClass(key);
                                        } else if (typeof val === &quot;string&quot;) {
                            
                                            // target 是多选择器, 需要先一次性删除再进行增加
                                            _isPublic &amp;&amp; target.removeClass(val);
                            
                                            preValue &amp;&amp; target.removeClass(preValue);
                                            val &amp;&amp; !target.hasClass(val) &amp;&amp; target.addClass(val);
                                            // 如果为空,则删除上一个样式,避免之前有默认样式被误删, 并且初始化的时候为空不应该删除掉所有样式
                                            typeof preValue !== &quot;undefined&quot; &amp;&amp; val === &quot;&quot; &amp;&amp; target.removeClass(preValue);
                                        } else {
                                            Boolean(val) &amp;&amp; target.addClass(key);
                                            !Boolean(val) &amp;&amp; target.removeClass(key);
                                        }
                                    }
                            
                                    // 如果值是布尔值,增加样式名在键值
                                    // 示例: addClass.call(this, key, val, preValue);
                                    function addClass(keyname, value, preValue) {
                                        // 如果值是布尔值,增加样式名在键值
                                        if (typeof value === &quot;boolean&quot;) {
                                            value &amp;&amp; this.classList.add(keyname);
                                            !value &amp;&amp; this.classList.remove(keyname);
                                        } else if (typeof value === &quot;string&quot;) {
                                            if (value &amp;&amp; !this.classList.contains(value)) {
                                                // 删除旧的样式
                                                preValue &amp;&amp; this.classList.remove(preValue);
                                                this.classList.add(value);
                                            }
                                        }
                                    }
                            
                                    // 处理属性值, 返回,会有多个属性存在不同数据源的情况 [{scope:gid,keyname:&quot;&quot;,param:&quot;&quot;}]
                                    function getAttrs(name) {
                                        var attrs = [];
                                        var _self = this;
                                        var attr = this.getAttribute(name) || &quot;&quot;;
                                        // 原本的 &amp; 改成 | , 并且可以自行配置, &amp; 常用于url的传参
                                        var keynames = attr.indexOf(option.paramSplit) &gt; -1 ? attr.split(option.paramSplit) : attr &amp;&amp; [attr] || [];
                            
                                        try {
                            
                            
                                            keynames.forEach(function (item, i) {
                                                var keyobj = {};
                                                var getName = getArguments.call(_self, item, name);
                            
                                                keyobj[&quot;scope&quot;] = gid;
                                                keyobj[&quot;rule&quot;] = getName[&quot;rule&quot;];
                                                keyobj[&quot;keyname&quot;] = getName[&quot;name&quot;];
                                                keyobj[&quot;param&quot;] = getName[&quot;param&quot;];
                                                keyobj[&quot;paramKeyname&quot;] = getName[&quot;paramKeyname&quot;];
                                                keyobj[&quot;eventType&quot;] = getName[&quot;eventType&quot;];
                                                keyobj[&quot;eventProperty&quot;] = getName[&quot;eventProperty&quot;];
                                                attrs.push(keyobj);
                                            })
                            
                                        } catch (e) {
                                            ui.showLog(&quot;参数处理出错&quot;)
                                        }
                            
                                        return attrs
                                    }
                            
                                    // 参数转为数组
                                    function getArguments(str, type) {
                            
                                        try {
                            
                                            // var regex1 = /([^@|\(|\)]+)/g;
                                            var regex1 = /([^\(|\)]+)/g;
                                            // 属性值 app.getMessage({id:123})@click.prevent
                                            var val = str ? str.match(regex1) : [];
                                            var valparam = [];
                                            // 返回 [&quot;app.getMessage&quot;,&quot;{id:123}&quot;,&quot;click.prevent&quot;]
                                            var scope = &quot;&quot;,
                                                keyname = &quot;&quot;,
                                                scopes = null,
                                                param = [], // 传递的参数
                                                events = null,
                                                that = this,
                                                rule = &quot;&quot;,
                                                btarget = $(that).attr(&quot;b-target&quot;),
                                                _self = btarget ? $(that).parents(btarget)[0] || that : that,
                                                $item = null,   // 1.6.5 新增
                                                eventType = &quot;&quot;,
                                                itemindex = -1,
                                                eventProperty = &quot;&quot;;
                            
                                            // 这里是处理 b-template 里面的索引值，把value处理成有相应的索引的值
                                            val = val.map((item, index) =&gt; {
                                                // 先不做替换
                                                // let scop = gid+_scopeSplit;
                                                // let regx = new RegExp(scop)
                                                let it = item; //item.indexOf(scop)&gt;-1? item.replace(regx,&quot;&quot;) : item;
                                                let hasTemplate = that.getAttribute(&quot;b-template&quot;);
                                                if (hasTemplate &amp;&amp; (it.indexOf(&quot;$itemIndex&quot;) &gt; -1)) {
                                                    let firstChild = $(that).parents(&quot;[b-template]&quot;).children()[0];
                            
                                                    let child = firstChild.classList[0] ? &quot;.&quot; + firstChild.classList[0] : firstChild.nodeName;
                            
                                                    let $item = $(that).closest(child);
                                                    let itemindex = $item.index();
                            
                                                    it = it.replace(/\$itemIndex/g, itemindex);
                                                }
                            
                                                return it;
                                            })
                            
                                            // 第一个参数处理: app.getMessage
                                            scopes = val[0] &amp;&amp; val[0].indexOf(gid + _scopeSplit) &gt; -1 ? val[0].split(gid + _scopeSplit) : [gid, val[0]];
                                            // 处理 !page.show 取 !
                                            rule = scopes[0].split(gid);
                                            rule = rule[0] || rule[1] || &quot;&quot;;
                                            scope = gid;
                                            keyname = scopes[1] || &quot;&quot;;
                            
                            
                                            // 解析 page.test.$index.text
                                            if (keyname.indexOf(&quot;$index&quot;) &gt; -1) {
                                                // 1.6.5之前的处理 
                                                let index = $(_self).index();
                                                keyname = keyname.replace(&quot;$index&quot;, index);
                                            } else if (keyname.indexOf(&quot;$id&quot;) &gt; -1) {
                                                // 这些不会出现在keyname
                                                let index = _self.id;
                                                keyname = keyname.replace(&quot;$id&quot;, index);
                                            } else if (keyname.indexOf(&quot;$parentIndex&quot;) &gt; -1) {
                                                // 准备废弃掉 $parentIndex
                                                let pindex = $(_self).parent().index();
                                                keyname = keyname.replace(&quot;$parentIndex&quot;, pindex);
                                            }
                            
                                            var $thatTemplate = null,
                                                bchildren = &quot;&quot;;
                            
                                            let hasTemplate = that.getAttribute(&quot;b-template&quot;);
                            
                                            // 1.6.5新增获取 对应的数组索引，无需再使用 b-target指定
                                            // b-model 之类的会指定关联某个数据，b-template解析后，keyname是指模板方法
                                            if (!hasTemplate &amp;&amp; (str.indexOf(&quot;$itemIndex&quot;) &gt; -1 || str.indexOf(&quot;$itemId&quot;) &gt; -1 || str.indexOf(&quot;$item&quot;) &gt; -1)) {
                                                // 有些没有 b-template 通过查找常规的列表或者ul
                                                $thatTemplate = $(that).closest(&quot;[b-template]&quot;) || $(that).closest(&quot;.bui-template&quot;) || $(that).closest(&quot;.bui-list&quot;) || $(that).closest(&quot;ul&quot;);
                            
                                                let firstItem = $thatTemplate.children()[0];
                            
                                                // 优先自定义-》样式-》dom节点
                                                bchildren = $thatTemplate ? ($thatTemplate.attr(&quot;b-children&quot;) || (firstItem.classList[0] ? &quot;.&quot; + firstItem.classList[0] : null) || firstItem.nodeName) : &quot;&quot;;
                            
                                                $item = $(that).closest(bchildren);
                            
                                                let itemIndex = $item.index();
                                                keyname = keyname.replace(&quot;$itemIndex&quot;, itemIndex);
                            
                                            }
                            
                                            // 父级索引
                                            if (keyname.includes(&quot;$parentItemIndex&quot;)) {
                            
                                                let childIndex = getParentItemIndex(that);
                            
                                                keyname = keyname.replace(/\$parentItemIndex/g, childIndex);
                            
                                            }
                            
                                            // 第二个参数处理: 模板的数据源 {id:123}
                                            if (typeof val[1] !== &quot;undefined&quot;) {
                            
                                                // 指定 $index 是哪个选择器 // _self = b-template  $index 一般用在嵌套b-template上
                                                var btarget = $(_self).attr(&quot;b-target&quot;);
                                                var target = btarget ? $(_self).closest(btarget)[0] || _self : _self;
                                                //  let parentChildren = $(_self).parents(&quot;[b-template]&quot;).children()[0];
                                                let postparam = val[1].replace(/\$index/g, $(target).index()) || &quot;&quot;;
                                                try {
                            
                                                    var isObject = /\{.+\}$/g,
                                                        isArray = /\[.+\]$/g;
                            
                                                    // 参数的解析,多个跟单个的处理,$this 的处理
                                                    // 如果包含逗号,代表有多个参数
                                                    // 处理括号里面的各种参数 $index,page.test.a,[test,1321],{id:123,name:&quot;321&quot;}
                                                    let paramsRule = /(\&#x27;(.*?)\&#x27;.*?)|(\&quot;(.*?)\&quot;.*?)|(\w[-\w.+]*@([A-Za-z0-9][-A-Za-z0-9]+\.)+[A-Za-z]{2,14})|(^((https|http|ftp|rtsp|mms)?:\/\/)[^\,]+)|([a-zA-Z0-9][-a-zA-Z0-9\._]{0,62})|(\{.+\})|(\[.+])|([$\w\.]+)|([\d\.]+)|([\u4e00-\u9fa5|\w|\d]+)/g;
                                                    let params = postparam ? postparam.match(paramsRule) : [];
                            
                                                    // 处理 b-watch 的方法监听
                                                    val[1].split(&quot;,&quot;).forEach(function (item, index) {
                                                        if (item.indexOf(gid + _scopeSplit) &gt; -1) {
                                                            valparam.push(item.replace(gid + _scopeSplit, &quot;&quot;).replace(/\$index/g, $(target).index()));
                                                        }
                                                    })
                            
                                                    // 内置几个dom的对应值
                                                    param = params.map(function (item, i) {
                            
                                                        // 中横连接需要用引号包住
                                                        var paramItem = item.replace(/^\&quot;|^\&#x27;|\&quot;$|\&#x27;$/g, &#x27;&#x27;);
                            
                                                        //  if( paramItem === &quot;$key&quot; ){
                                                        //     let data = ui.unit.getKeyValue(valparam[0],_data);
                            
                                                        //     if( data instanceof Array ){
                                                        //         paramItem = data.length -1;
                                                        //     }
                                                        //  }
                                                        switch (item) {
                                                            case &quot;$this&quot;:
                                                                paramItem = target;
                                                                break;
                                                            case &quot;$index&quot;:
                                                                paramItem = $(target).index();
                                                                break;
                                                            case &quot;$parentItemIndex&quot;:
                            
                                                                paramItem = getParentItemIndex(that);
                                                                break;
                                                            case &quot;$itemIndex&quot;:
                                                                paramItem = $item.index();
                                                                break;
                                                            case &quot;$itemId&quot;:
                                                                paramItem = $item.attr(&quot;id&quot;);
                                                                break;
                                                            case &quot;$itemText&quot;:
                                                                paramItem = $item.text();
                                                                break;
                                                            case &quot;$itemHtml&quot;:
                                                                paramItem = $item.html();
                                                                break;
                                                            case &quot;$item&quot;:
                                                                paramItem = $item[0];
                                                                break;
                                                            case &quot;$parentIndex&quot;:
                                                                paramItem = $(target).parent().index();
                                                                break;
                                                            case &quot;$parent&quot;:
                                                                paramItem = target.parentNode;
                                                                break;
                                                            case &quot;$children&quot;:
                                                                paramItem = $(target).children();
                                                                break;
                                                            case &quot;$prev&quot;:
                                                                paramItem = $(target).prev();
                                                                break;
                                                            case &quot;$next&quot;:
                                                                paramItem = $(target).next();
                                                                break;
                                                            case &quot;$id&quot;:
                                                                paramItem = target.id;
                                                                break;
                                                            case &quot;$text&quot;:
                                                                paramItem = target.textContent;
                                                                break;
                                                            case &quot;$value&quot;:
                                                                paramItem = target.value;
                                                                break;
                                                            case &quot;$html&quot;:
                                                                paramItem = target.innerHTML;
                                                                break;
                                                        }
                            
                            
                                                        // 传数据源 page.xxx, b-template 在外层拿数据
                                                        if (type !== &quot;b-template&quot;) {
                            
                                                            var gidscope = gid + _scopeSplit;
                            
                                                            if (ui.unit.startWithStr(paramItem, gidscope)) {
                                                                let val = ui.unit.getKeyValue(paramItem.split(gidscope)[1], module);
                                                                paramItem = typeof val === &quot;undefined&quot; ? paramItem : val; //ui.unit.getKeyValue(paramItem, _data);
                                                            }
                                                        }
                            
                                                        // 数字大于16位的时候,会被四舍五入,这个时候返回字符串,才不会改变原本的数字
                                                        paramItem = /^\d+$/.test(paramItem) &amp;&amp; paramItem.length &lt; 17 ? parseFloat(paramItem) : paramItem;
                            
                                                        return isObject.test(item) || isArray.test(item) ? JSON.parse(item) : paramItem;
                                                    })
                            
                                                    // console.log({
                                                    //     scope: scope,
                                                    //     rule: rule,
                                                    //     name: keyname,
                                                    //     param: param,
                                                    //     paramKeyname: valparam,
                                                    //     eventType: eventType,
                                                    //     eventProperty: eventProperty
                                                    // })
                                                } catch (e) {
                                                    ui.showLog(e, &quot;getArguments&quot;);
                                                    param = [];
                                                }
                            
                                            }
                                            // 第三个参数, click.stop 或 click.prevent, 暂时取消这种方式的处理
                                            if (typeof val[2] !== &quot;undefined&quot;) {
                                                events = val[2].indexOf(&quot;.&quot;) &gt; -1 ? val[2].split(&quot;.&quot;) : [val[2]];
                                                eventType = events[0];
                                                eventProperty = events[1] || &quot;&quot;;
                                            }
                            
                                        } catch (e) {
                                            ui.showLog(&quot;参数格式错误:&quot; + str)
                                        }
                            
                                        return {
                                            scope: scope,
                                            rule: rule,
                                            name: keyname,
                                            param: param,
                                            paramKeyname: valparam,
                                            eventType: eventType,
                                            eventProperty: eventProperty
                                        };
                            
                                    }
                            
                                    // 获取父级索引
                                    function getParentItemIndex(that) {
                                        let $parentTemplates = $(that).parents(&#x60;[b-template]&#x60;);
                                        let $parentTemplate = $parentTemplates[1] || $parentTemplates[0];
                                        let firstChild = $parentTemplate.children[0];
                                        let firstChildClass = firstChild.classList[0] ? &quot;.&quot; + firstChild.classList[0] : firstChild.nodeName;
                                        let childIndex = $(that).closest(firstChildClass).index();
                            
                                        return childIndex;
                                    }
                            
                                    // 监听对象的定义
                                    function observer(obj, keyArr) {
                            
                                        // 不遍历ui组件, 容易死循环
                                        if (obj &amp;&amp; obj.hasOwnProperty(&quot;widget&quot;) &amp;&amp; typeof (obj[&quot;widget&quot;]) == &quot;function&quot;) {
                                            return;
                                        }
                                        return proxyObj(obj, keyArr);
                                    }
                            
                                    function proxyObj(obj, keyArr) {
                            
                                        // 如果数组之前是定义 &quot;&quot; 或者 null , 后面更改成数组, 可以通过赋值去修改
                                        if (keyArr &amp;&amp; ui.typeof(keyArr) === &quot;array&quot;) {
                            
                                            // 把最后一个值进行数组或对象的劫持处理就可以.
                                            if (keyArr.length &gt; 1) {
                                                var lastKey = keyArr.pop();
                                                var parentObj = ui.unit.getKeyValue(keyArr.join(&quot;.&quot;), obj);
                            
                                                observerAll(parentObj, lastKey);
                                            } else {
                            
                                                observerAll(obj, keyArr[0]);
                                            }
                                            return;
                                        }
                            
                                        // 默认遍历整个对象
                                        obj &amp;&amp; Object.keys(obj).forEach(function (key) {
                            
                                            observerAll(obj, key);
                            
                                        })
                                        //
                                        function observerAll(obj, key) {
                            
                                            // 缓存键值
                                            let value = obj &amp;&amp; obj[key];
                            
                                            // 监听对象赋值
                                            obj &amp;&amp; observerObj(obj, key);
                                            // 直接遍历已有数据 加上判断 value 的数据是否大于1,这样就可以通过赋值的方式修改默认为空的
                                            if (ui.typeof(value) === &quot;array&quot;) {
                            
                                                // 数组通过value监听，监听数组方法
                                                observerArr(value, key);
                                            }
                                            // 初始化的时候,把键值里的对象都进行递归拦截
                                            if (value &amp;&amp; ui.typeof(value) === &quot;object&quot;) {
                                                return observer(value);
                                            }
                                        }
                            
                                    }
                            
                            
                                    // 针对对象处理
                                    function observerObj(obj, key) {
                                        // 缓存键值, 支持方法, 方法需要返回
                                        let val = obj[key];
                                        let value = typeof val === &quot;function&quot; ? val.call(module) : val;
                            
                                        // computed 执行的时候,会缓存每个相关联的键值,重新计算并触发视图更新
                                        var deps = [];
                                        // 对象的属性通过defaineProperty监听
                                        Object.defineProperty(obj, key, {
                                            enumerable: true,
                                            configurable: true,
                                            get() {
                            
                                                //  _log &amp;&amp; console.log(&#x60;3. data getting ${key}:&#x60;, value);
                            
                                                // 如果没有最后一个键值, 说明已经重新开始读取 this.x = this.$data.xx 这种也会导致无法触发
                                                // var lastKey = keyNames[keyNames.length - 1];
                                                // // 如果刚好拥有相同的键值, 就会不支持 比如 this.a = this.$data.c.a
                                                // if (this.hasOwnProperty(lastKey)) {
                                                //     firstVisite = false;
                                                //     lastVisite = false;
                                                // }
                            
                                                // 第一次 null; 层级读取的时候,this等于下一个,所以keyNames 是累计的,等于父层的键值,
                                                // 比方: page.attr.title,  key = title 时,keyNames = [&quot;page&quot;,&quot;attr&quot;]
                                                // 但会变成最后一次读取的键值还在, 直到有赋值操作时清空.
                            
                                                // 这个一加以后, this.a.b = this.c.d 会报错, 不加的话, 如果有使用 this.xx 读取的情况, 则会导致下面的set 都会报错
                                                // if (emitter.target === this) {
                                                //     keyNames = [];
                                                // }
                                                // 让set 的时候,只有一层时,清空原本keyNames
                                                emitter.target = this;
                                                // 第一次才会存 1-3-2-4, 1-3-3-4, 3-3-3-4 , 1-3-4
                                                if (firstVisite || (!firstVisite &amp;&amp; lastVisite)) {
                                                    // 设置访问的时候扁平化键值
                                                    keyNames.push(key);
                                                }
                            
                                                // }
                                                // 增加computed的依赖
                                                if (Dep.target) {
                                                    deps.push(Dep.target)
                                                }
                                                return value;
                                            },
                                            set(newValue) {
                                                // 值相同时,不用触发页面更新
                                                if (newValue === value) {
                                                    keyNames = [];
                                                    useSet = false;
                                                    setStateStatus = false;
                                                    // 还原会第一次读取的状态值
                                                    firstVisite = false;
                                                    lastVisite = true;
                                                    return true;
                                                }
                                                if (emitter.target === this) {
                                                    keyNames = [];
                                                }
                                                emitter.target = this;
                                                var isValArr = ui.typeof(value) === &quot;array&quot; &amp;&amp; ui.typeof(newValue) === &quot;array&quot;;
                                                // 通过 this.xx 这样只有一层的时候,前面的keyNames累积都可以不需要
                                                // 第1次设置设置的时候,有一种情况是 4, 2-4 , 1-3-2-4, 1-3-1-3-4
                                                // if( key != keyNames[keyNames.length-1] ){
                                                //   keyNames = [];
                                                // }
                                                if (!lastVisite || (!firstVisite &amp;&amp; lastVisite)) {
                                                    // 累计get获取到的keyNames 设置访问的时候扁平化键值
                                                    keyNames.push(key);
                                                }
                            
                                                var keyNamesStr = keyNames.join(&quot;.&quot;);
                            
                                                let keyNamesCache = ui.array.copy(keyNames);
                            
                                                // 数据更新前
                                                !isValArr &amp;&amp; !useSet &amp;&amp; trigger.call(module, &quot;beforeupdate&quot;, {
                                                    action: &quot;set&quot;,
                                                    value: newValue,
                                                    preValue: value,
                                                    keyname: keyNamesStr,
                                                    origin: cacheData
                                                });
                                                !isValArr &amp;&amp; !useSet &amp;&amp; option.beforeUpdates.forEach(function (item, index) {
                                                    // 数据处理之前
                                                    item.call(module, {
                                                        action: &quot;set&quot;,
                                                        value: newValue,
                                                        preValue: value,
                                                        keyname: keyNamesStr,
                                                        origin: cacheData
                                                    });
                                                })
                            
                                                // 如果通过set的方式,直接设置值
                                                _log &amp;&amp; console.log(&#x60;4. data setting ${keyNamesStr}&#x60;, newValue);
                            
                                                // 获取上一个值
                                                var preValue = ui.unit.getKeyValue(keyNamesStr, cacheData);
                            
                                                // 设置新值
                                                if (isValArr) {
                            
                                                    // 把值为数组的复制一遍，这样设置的时候，才不会死循环
                                                    let vals = $.extend(true, [], newValue);
                                                    value.splice(0, value.length, ...vals);
                                                } else {
                                                    value = ui.typeof(newValue) === &quot;object&quot; ? $.extend(true, {}, newValue) : newValue;
                            
                                                    // 触发针对数据的监听事件
                                                    !useSet &amp;&amp; trigger(keyNamesStr, {
                                                        action: &quot;set&quot;,
                                                        value: value,
                                                        preValue: preValue,
                                                        keyname: keyNamesStr,
                                                        origin: cacheData
                                                    });
                                                    // 重新设置useSet
                                                    useSet = false;
                                                }
                            
                                                // 执行computed的依赖
                                                deps.forEach(func =&gt; func())
                            
                            
                                                // 保持同步数据,这个数据不进行实时变更
                                                ui.unit.setKeyValue(keyNamesStr, value, cacheData);
                            
                                                // 针对值是对象的继续使用递归处理, 如果
                                                if (ui.typeof(value) === &quot;array&quot;) {
                            
                                                    observer(_data, keyNamesCache);
                                                } else if (ui.typeof(value) === &quot;object&quot;) {
                            
                                                    option.deep &amp;&amp; observer(value);
                            
                                                    // 事件的键名
                                                    value &amp;&amp; Object.keys(value).forEach(function (item, i) {
                                                        var keychild = keyNamesStr + &quot;.&quot; + item;
                                                        // 清空键值层级
                                                        keyNames = [];
                                                        // keys.push(item);
                                                        hasWatch(keychild) &amp;&amp; trigger(keychild, {
                                                            target: null,
                                                            value: value[item],
                                                            preValue: preValue &amp;&amp; preValue[item],
                                                            action: &quot;set&quot;,
                                                            keyname: keychild,
                                                            origin: cacheData
                                                        });
                                                    })
                                                }
                            
                                                // 数据更新后
                                                // !useSet &amp;&amp; trigger.call(module, &quot;update&quot;, { action: &quot;set&quot;, value: value, preValue: preValue, keyname: keyNamesStr, origin: cacheData });
                                                !isValArr &amp;&amp; !useSet &amp;&amp; trigger.call(module, &quot;updated&quot;, {
                                                    action: &quot;set&quot;,
                                                    value: value,
                                                    preValue: preValue,
                                                    keyname: keyNamesStr,
                                                    origin: cacheData
                                                });
                                                !isValArr &amp;&amp; !useSet &amp;&amp; option.updateds.forEach(function (item, index) {
                                                    // 数据处理之前
                                                    item.call(module, {
                                                        action: &quot;set&quot;,
                                                        value: value,
                                                        preValue: preValue,
                                                        keyname: keyNamesStr,
                                                        origin: cacheData
                                                    });
                                                })
                            
                                                // console.log(keyNamesStr);
                                                // todo: 解析模板里面的指令，数组有解析
                                                var $tpl = $page.find(&#x60;[b-template*=&quot;${gid}.${keyNamesStr}&quot;]&#x60;);
                                                // 使用setStatus方法为true，已经有compileCommon，无需再次处理，这里是针对 直接变量赋值的方式
                                                if ($tpl.length &amp;&amp; !setStateStatus) {
                                                    $tpl.each(function (index, item) {
                                                        compileCommon({
                                                            el: $(item),
                                                            // 是否需要替换，取决于 value.length 大于或者等于上一个值
                                                            // replace: value.length &gt;= preValue.length,
                                                            action: &#x27;set&#x27;
                                                        });
                                                    })
                                                }
                            
                                                // 清空键值层级
                                                keyNames = [];
                            
                                                useSet = false;
                            
                                                // 使用setStatus方法为true
                                                setStateStatus = false;
                            
                                                // 完成一次设置的访问
                                                firstVisite = false;
                                                lastVisite = true;
                            
                                                return true;
                                            }
                                        })
                            
                                    }
                            
                                    // 针对数组的监听处理
                                    function observerArr(arr, key) {
                                        // 数组只能在第一层, 每次都会清空, 防止跟其它属性定义冲突
                                        // keyNames 是对象获取的键值
                                        var keynames = [];
                                        var arrayProto = Array.prototype;
                                        let arrayMethod = Object.create(arrayProto);
                            
                                        var deps = [];
                            
                                        [&#x27;push&#x27;, &#x27;pop&#x27;, &#x27;shift&#x27;, &#x27;unshift&#x27;, &#x27;splice&#x27;, &#x27;sort&#x27;, &#x27;reverse&#x27;].forEach(function (method) {
                                            var original = arrayProto[method];
                            
                                            Object.defineProperty(arrayMethod, method, {
                                                enumerable: true,
                                                configurable: true,
                                                value: function (item) {
                            
                                                    // 获取splice的参数
                                                    let args = [...arguments];
                            
                                                    trigger.call(module, &quot;beforeupdate&quot;, {
                                                        target: null,
                                                        action: method,
                                                        param: args,
                                                        value: this,
                                                        prevValue: [],
                                                        keyname: key,
                                                        origin: cacheData
                                                    });
                            
                                                    var dataKey = keynames.join(&quot;.&quot;) || key;
                            
                                                    // 如果数组在第一层，需要键值，如果数组在第二层，则不需要
                                                    if (!(_data.hasOwnProperty(key)) &amp;&amp; keyNames.length) {
                                                        // 如果有多层
                                                        keynames.unshift(keyNames.join(&quot;.&quot;))
                                                        dataKey = keynames.join(&quot;.&quot;) || key;
                                                    } else {
                                                        keynames.push(key);
                                                        dataKey = keynames.join(&quot;.&quot;);
                                                    }
                            
                                                    // 2层以上, 有部分拦截明明只有一层，但会出现拦截2次相同的情况，所以这里简单处理下
                                                    if (keyNames.length &gt; 1 &amp;&amp; keyNames[0] !== key) {
                                                        dataKey = keyNames.join(&quot;.&quot;);
                                                    }
                            
                                                    // 上一个值,watch 的时候,可以拿到新旧两个值
                                                    var preValue = this.slice(0); //ui.unit.getKeyValue(dataKey, cacheData);
                            
                                                    // 执行该方法
                                                    let res = original.apply(this, args);
                            
                                                    _log &amp;&amp; console.log(&#x60;5. ${dataKey} action ${method}, param:${args} &#x60;);
                            
                            
                                                    switch (method) {
                                                        case &quot;pop&quot;:
                                                        case &quot;shift&quot;:
                                                            // pop shift sort reverse 的操作需要
                                                            args = [res];
                                                            break;
                                                    }
                            
                                                    // 复制一个缓存,这样拿到的 preValue 才是正确的;
                                                    // let nowarr = ui.array.copy(this);
                                                    // 保持同步数据,这个数据不进行实时变更,
                            
                                                    // 要为this 才能监听数组实时变更
                                                    ui.unit.setKeyValue(dataKey, this, cacheData);
                            
                                                    var target = $page.find(&#x60;[b-template*=&quot;${gid}.${dataKey}&quot;]&#x60;);
                            
                                                    // 只有一个参数的时候，把相关索引字段也触发一下,等于0的时候是在索引前插入数据
                                                    if (method === &quot;splice&quot; &amp;&amp; args[1] &gt;= 0) {
                            
                                                        if ((typeof args[2] !== &quot;undefined&quot;)) {
                                                            // 新增,替换
                            
                                                            let nVals = [...args];
                                                            nVals.splice(0, 2);
                            
                                                            // 值的索引从0开始
                                                            let valIndex = 0;
                                                            let delIndex = args[0] + args[1];
                                                            for (let i = args[0]; i &lt; delIndex; i++) {
                                                                let newkeyname = dataKey + &quot;.&quot; + i;
                                                                let prevVal = ui.unit.getKeyValue(newkeyname, cacheData);
                                                                let nowVal = nVals[valIndex];
                                                                (typeof nowVal !== &quot;undefined&quot;) &amp;&amp; trigger(newkeyname, {
                                                                    target: target,
                                                                    action: method,
                                                                    param: args,
                                                                    value: nowVal,
                                                                    preValue: prevVal,
                                                                    keyname: newkeyname,
                                                                    origin: cacheData
                                                                })
                            
                                                                valIndex++;
                                                            }
                                                        } else {
                                                            // 删除
                                                            let delIndex = args[0] + args[1];
                            
                                                            for (let i = args[0]; i &lt; delIndex; i++) {
                                                                let newkeyname = dataKey + &quot;.&quot; + i;
                            
                                                                let prevVal = ui.unit.getKeyValue(newkeyname, cacheData);
                            
                                                                trigger(newkeyname, {
                                                                    target: target,
                                                                    action: method,
                                                                    param: args,
                                                                    value: &#x27;&#x27;,
                                                                    preValue: prevVal,
                                                                    keyname: newkeyname,
                                                                    origin: cacheData
                                                                })
                                                            }
                                                        }
                            
                                                    }
                            
                            
                                                    // 拦截数组的事件
                                                    trigger(dataKey, {
                                                        target: target,
                                                        action: method,
                                                        param: args,
                                                        value: this,
                                                        preValue: preValue,
                                                        keyname: dataKey,
                                                        origin: cacheData
                                                    });
                            
                                                    // 执行computed的依赖
                                                    let firstKey = keynames[0] || key;
                                                    (depsArr[firstKey] &amp;&amp; ui.typeof(depsArr[firstKey]) === &quot;array&quot;) &amp;&amp; depsArr[firstKey].forEach(func =&gt; func());
                            
                            
                                                    // 清空依赖的回调
                                                    // depsArr = [];
                            
                                                    // trigger.call(module, &quot;update&quot;, { target: target, action: method, param: args, value: this, preValue: preValue, keyname: key, origin: cacheData });
                                                    // 触发键值的形式
                                                    hasWatch(dataKey + &quot;.$key&quot;) &amp;&amp; trigger.call(module, dataKey + &quot;.$key&quot;, {
                                                        target: target,
                                                        action: method,
                                                        param: args,
                                                        value: this,
                                                        preValue: preValue,
                                                        keyname: key,
                                                        origin: cacheData
                                                    });
                                                    hasWatch(dataKey + &quot;.$key1&quot;) &amp;&amp; trigger.call(module, dataKey + &quot;.$key1&quot;, {
                                                        target: target,
                                                        action: method,
                                                        param: args,
                                                        value: this,
                                                        preValue: preValue,
                                                        keyname: key,
                                                        origin: cacheData
                                                    });
                                                    hasWatch(dataKey + &quot;.$key01&quot;) &amp;&amp; trigger.call(module, dataKey + &quot;.$key01&quot;, {
                                                        target: target,
                                                        action: method,
                                                        param: args,
                                                        value: this,
                                                        preValue: preValue,
                                                        keyname: key,
                                                        origin: cacheData
                                                    });
                            
                                                    //  trigger.call(module, dataKey+&quot;.$keyValue&quot;, {
                                                    //      target: target,
                                                    //      action: method,
                                                    //      param: args,
                                                    //      value: this,
                                                    //      preValue: preValue,
                                                    //      keyname: key,
                                                    //      origin: cacheData
                                                    //  });
                            
                                                    trigger.call(module, &quot;updated&quot;, {
                                                        target: target,
                                                        action: method,
                                                        param: args,
                                                        value: this,
                                                        preValue: preValue,
                                                        keyname: key,
                                                        origin: cacheData
                                                    });
                                                    option.updateds.forEach(function (item, index) {
                                                        // 数据处理之前
                                                        item.call(module, {
                                                            target: target,
                                                            action: method,
                                                            param: args,
                                                            value: this,
                                                            preValue: preValue,
                                                            keyname: key,
                                                            origin: cacheData
                                                        });
                                                    })
                            
                            
                                                    // 清空keyname
                                                    keynames = [];
                                                    // 清空父键值
                                                    keyNames = [];
                            
                                                    firstVisite = false;
                                                    lastVisite = true;
                            
                                                    return res;
                                                }
                                            })
                                        });
                            
                                        // 扩展数组的操作,只对store的数组起作用, 不推荐了
                                        arrayMethod.$index = function (value, key) {
                            
                                            return ui.array.index(this, value, key)
                                        }
                                        arrayMethod.$include = function (value, key) {
                            
                                            return ui.array.compare(this, value, key)
                                        }
                                        arrayMethod.$filter = function (value, key) {
                            
                                            return ui.array.filter(this, value, key)
                                        }
                                        arrayMethod.$empty = function () {
                                            return ui.array.empty(this)
                                        }
                                        arrayMethod.$replace = function (updates) {
                            
                                            return ui.array.replace(this, updates);
                                        }
                                        arrayMethod.$merge = function () {
                            
                                            return ui.array.merge(this, ...arguments);
                                        }
                                        arrayMethod.$get = function (name, key) {
                                            // 如果没有匹配,返回undefined
                                            return ui.array.get(this, name, key);
                                        }
                                        arrayMethod.$set = function (index, value, keyname) {
                            
                                            return ui.array.set(this, index, value, keyname);
                                        }
                                        arrayMethod.$delete = function (value, key) {
                                            return ui.array.delete(this, value, key)
                                        }
                                        arrayMethod.$deleteIndex = function (value) {
                                            return ui.array.deleteIndex(this, value)
                                        }
                            
                                        // 赋值到该数组的原型链
                                        arr.__proto__ = arrayMethod;
                            
                                        return arr;
                                    }
                            
                                    // 是否有订阅了，用于判断是否trigger
                            
                                    function hasWatch(name) {
                            
                                        let _scopes = gid + _scopeSplit;
                                        let keyname = name.includes(gid + _scopes) ? guid + &quot;_&quot; + name : guid + &quot;_&quot; + _scopes + name;
                            
                                        return emitter.has.call(module, keyname);
                                    }
                            
                                    /**
                                     * 获取数据
                                     *  @method get
                                     *  @param {string} [name]  取哪个键值的数据,不传则取全部 
                                     *  @chainable
                                     *  @example
                                     *
                                       var page = bs.get(&quot;size&quot;);
                                     *
                                     */
                                    function get(name) {
                                        if (typeof name === &quot;undefined&quot;) {
                                            cacheData = cacheData;
                                            return cacheData;
                                        } else if (typeof name === &quot;string&quot;) {
                                            // 清空键值,防止读取的时候,直接累计
                                            var val = ui.unit.getKeyValue(name, cacheData);
                                            keyNames = [];
                                            return val;
                                        }
                                        return cacheData;
                                    }
                            
                                    /**
                                     * 把两个不同的 bui.store 创建的实例里面data相同字段关联起来, 一般用于把父组件的参数同步给子组件
                                     *  @method connect
                                     *  @since 1.6.2
                                     *  @param {object} name [ store 的实例 ]
                                     *  @param {string} [field]  指定关联哪个字段 , 可以支持 &quot;xxx.xxxx&quot; 指定对象里面的字段  
                                     *  @param {string} [targetField]  指定目标name的哪个关联字段, 默认不需要,根据field相同字段即可, 如果为 &quot;&quot; 空字符串,则关联到该对象data上  
                                     *  @param {boolean} [bool]  默认true, 自动同步数据一次  
                                     *  @chainable
                                     *  @example
                                     *
                                        // html
                                        &lt;h3&gt;关联1: 关联相同字段&lt;/h3&gt;
                                        &lt;input b-model=&quot;page.attrs.test&quot; placeholder=&quot;&quot; type=&quot;text&quot;&gt;
                                        &lt;div class=&quot;scope1&quot;&gt;
                                            &lt;input b-model=&quot;page1.attrs.test&quot; placeholder=&quot;&quot; type=&quot;text&quot;&gt;
                                        &lt;/div&gt;
                                        &lt;h3&gt;关联2: 关联到不同字段&lt;/h3&gt;
                                        &lt;input b-model=&quot;page.attrs.test&quot; placeholder=&quot;&quot; type=&quot;text&quot;&gt;
                                        &lt;div class=&quot;scope1&quot;&gt;
                                            &lt;input b-model=&quot;page1.props.test&quot; placeholder=&quot;&quot; type=&quot;text&quot;&gt;
                                        &lt;/div&gt;
                                        &lt;h3&gt;关联3: 关联到根路径&lt;/h3&gt;
                                        &lt;input b-model=&quot;page.attrs.test&quot; placeholder=&quot;&quot; type=&quot;text&quot;&gt;
                                        &lt;div class=&quot;scope1&quot;&gt;
                                            &lt;input b-model=&quot;page1.test&quot; placeholder=&quot;&quot; type=&quot;text&quot;&gt;
                                        &lt;/div&gt;
                             
                                       // 可以在路由init以后,作为整个应用的联动数据处理
                                        var bs = bui.store({
                                            scope: &quot;page&quot;, // 用于区分公共数据及当前数据的唯一值
                                            data: {
                                                attrs: {
                                                    &quot;test&quot;: &quot;123&quot;,
                                                }
                                            },
                                            methods: {},
                                            watch: {},
                                            computed: {},
                                            templates: {},
                                            mounted: function() {
                             
                                            }
                                        })
                             
                             
                                        var bs2 = bui.store({
                                            el: &quot;.scope1&quot;,
                                            scope: &quot;page1&quot;, // 用于区分公共数据及当前数据的唯一值
                                            data: {
                                                attrs: {
                                                    test: &quot;111&quot;
                                                },
                                                props: {
                                                    test: &quot;111&quot;
                                                },
                                                test: &quot;111&quot;
                                            },
                                            methods: {},
                                            watch: {},
                                            computed: {},
                                            templates: {},
                                            mounted: function() {
                             
                                            }
                                        })
                             
                             
                                        // 关联1: 关联多个相同字段
                                        bs.connect(bs2);
                             
                                        // 关联2: 关联到不同字段
                                        // bs.connect(bs2, &quot;attrs&quot;, &quot;props&quot;);
                             
                                        // 关联3: 关联到根路径
                                        // bs.connect(bs2, &quot;attrs&quot;, &quot;&quot;);
                             
                                        
                                        // 关联4: 关联指定字段
                                        // bs.connect(bs2, &quot;attrs.test&quot;);
                             
                                     *
                                     */
                                    // 缓存连接了哪些字段实例
                                    var conects = [];
                            
                                    function checkConnect(bs, keyname) {
                                        var index = ui.array.index(conects, keyname, &quot;field&quot;);
                            
                                        if (index &gt; -1 &amp;&amp; (conects[index] &amp;&amp; bs.$options.el === conects[index][&quot;el&quot;])) {
                            
                                            conects[index][&quot;disconnect&quot;] &amp;&amp; conects[index][&quot;disconnect&quot;]();
                                            return true;
                                        } else {
                                            return false;
                                        }
                                    }
                            
                                    function connect(bs, field, targetField) {
                                        if (typeof bs !== &quot;object&quot; || !bs.hasOwnProperty(&quot;$refs&quot;)) {
                                            return module;
                                        }
                                        var that = this;
                                        if (typeof field === &quot;string&quot;) {
                                            var includeKeyname = checkConnect(bs, field) //ui.array.compare(conects, field, &quot;field&quot;);
                            
                                            var val = ui.unit.getKeyValue(field, that.$data);
                            
                                            if (ui.typeof(val) === &quot;object&quot;) {
                                                //     // 对象继续监听子字段
                                                conectObj(field, val, targetField || field);
                                            } else {
                            
                                                conectArrayAndString(targetField || field, val, field);
                                            }
                                        } else {
                                            // 默认自动同步一次
                                            var bool = true;
                                            var keynames = Object.keys(cacheData);
                                            let index = 0;
                                            for (; index &lt; keynames.length; index++) {
                                                let keyname = keynames[index];
                                                var hasConect = ui.array.compare(conects, keyname, &quot;field&quot;);
                                                if (hasConect) {
                                                    break;
                                                }
                                                var includeKeyname = checkConnect(bs, keyname)
                                                // if (includeKeyname) {
                                                //     break;
                                                // }
                            
                                                if (bs.$data.hasOwnProperty(keyname)) {
                                                    let targetItem = bs.$data[keyname];
                                                    let item = that.$data[keyname];
                            
                                                    // 支持两层字段监听
                                                    if (ui.typeof(item) === &quot;object&quot;) {
                                                        conectObj(keyname, item);
                            
                                                    } else {
                            
                                                        conectArrayAndString(keyname, item);
                                                    }
                                                }
                                            }
                                        }
                            
                            
                                        // 连接数组及字符串的处理 keyname为要设置的字段, data是数据, watchfiled是watch监听的字段
                                        function conectArrayAndString(keyname, data, watchfield) {
                                            if (ui.typeof(data) === &quot;array&quot;) {
                                                bs[keyname].$replace(data);
                                            } else {
                                                // 第一层
                                                bs.set(keyname, data);
                            
                                                // bs[keyname] = data;
                            
                                            }
                            
                                            let conect = null
                                            if (watchfield) {
                                                conect = watch(watchfield, function (val) {
                                                    if (ui.typeof(val) === &quot;array&quot;) {
                                                        bs[keyname].$replace(val);
                                                    } else {
                                                        // 第一层
                                                        bs.set(keyname, val);
                                                        // bs[keyname] = data;
                                                    }
                                                })
                                            }
                                            if (keyname) {
                                                conect = watch(keyname, function (val) {
                                                    if (ui.typeof(val) === &quot;array&quot;) {
                                                        bs[keyname].$replace(val);
                                                    } else {
                                                        // 第一层
                                                        bs.set(keyname, val);
                                                        // bs[keyname] = data;
                                                    }
                                                })
                                            }
                            
                                            let index = ui.array.index(conects, keyname, &quot;field&quot;);
                            
                                            if (index &lt; 0 || (conects[index] &amp;&amp; bs.$options.el !== conects[index][&quot;el&quot;])) {
                                                conects.push({
                                                    field: watchfield || keyname,
                                                    el: bs.$options.el,
                                                    disconnect: conect
                                                });
                                            }
                                        }
                            
                                        // 如果是对象,继续监听每个子字段
                                        function conectObj(keyname, data, field) {
                                            let names = Object.keys(data);
                            
                                            for (let i = 0; i &lt; names.length; i++) {
                                                let name = names[i];
                                                let newkey = keyname + &quot;.&quot; + name;
                                                let noTargetfield = typeof (targetField) === &quot;undefined&quot;;
                                                // 如果字段为空, 把对象的值赋值到 $data 层.
                                                let targetKey = noTargetfield ? name : (targetField == &quot;&quot; ? name : targetField + &quot;.&quot; + name);
                            
                                                let includeKeyname = checkConnect(bs, newkey)
                                                // if (includeKeyname) {
                                                //     break;
                                                // }
                            
                                                let val = ui.unit.getKeyValue(newkey, that.$data);
                            
                                                // 有传空 &quot;&quot; 则传到跟路径
                                                noTargetfield ? bs.set(newkey, val) : bs.set(targetKey, val);
                            
                                                let conect = watch(newkey, function (val) {
                                                    typeof targetField !== &quot;undefined&quot; ? bs.set(targetKey, val) : bs.set(newkey, val);
                                                })
                                                var index = ui.array.index(conects, newkey, &quot;field&quot;);
                                                if (index &lt; 0 || (conects[index] &amp;&amp; bs.$options.el !== conects[index][&quot;el&quot;])) {
                                                    conects.push({
                                                        field: newkey,
                                                        el: bs.$options.el,
                                                        disconnect: conect
                                                    });
                                                }
                                            }
                            
                                            // 触发整个对象的watch
                                            bs.trigger.call(bs, field || keyname, {
                                                action: &quot;set&quot;,
                                                target: null,
                                                value: cacheData[keyname],
                                                preValue: null,
                                                action: &quot;set&quot;,
                                                keyname: keyname,
                                                origin: cacheData
                                            });
                            
                                        }
                            
                                        return module;
                                    }
                            
                                    /**
                                     * 取消两个实例之间的关联字段.
                                     *  @method disconnect
                                     *  @since 1.6.2
                                     *  @param {string} [field]  指定关联哪个字段 , 可以支持 &quot;xxx.xxxx&quot; 指定对象里面的字段  
                                     *  @chainable
                                     *  @example
                                     *
                                       var bs = bui.store({
                                           el:&quot;&quot;,
                                           scope:&quot;&quot;,
                                           data: {
                                               test: &quot;2222&quot;
                                           }
                                       })
                                       // 取消关联test字段, 不传则是取消所有关联的相同字段. 下次改变就不会触发bs2.test变更.
                                       bs.disconect(&quot;test&quot;);
                             
                                     *
                                     */
                                    function disconnect(field) {
                            
                                        if (typeof field === &quot;string&quot;) {
                                            var con = ui.array.get(conects, field, &quot;field&quot;);
                                            // 取消监听
                                            con &amp;&amp; con.disconnect();
                                        } else {
                                            conects.forEach(function (item, index) {
                                                // 取消关联
                                                item.disconnect();
                                            })
                                        }
                            
                                        return module;
                                    }
                            
                                    /**
                                     * 保存数据,并会触发 通过 bs.on 监听的事件. 1.6.6有 setState 代替。
                                     *  @method set
                                     *  @param {string} [name]  存储数据在哪个键值,对象则存储多个 
                                     *  @param {string|object|array} [value]  存值 
                                     *  @chainable
                                     *  @example
                                     *
                                       方法1:
                                       var page = bs.setState(&quot;size&quot;,1);
                                       // { size: 1}
                             
                                       会触发以下dom的变更
                                       &lt;b b-text=&quot;page.size&quot;&gt;&lt;/b&gt;
                             
                                       方法2: 指定字段层级
                                       var page = bs.setState(&quot;size.num&quot;,1);
                                       // { size: { num: 1 }}
                             
                                       会触发以下dom的变更
                                       &lt;b b-text=&quot;page.size.num&quot;&gt;&lt;/b&gt;
                             
                                     *
                                     */
                                    function set(name, value) {
                                        var isString = typeof name === &quot;string&quot;;
                                        var keys = [];
                                        var newValue = value;
                                        keyNames = [];
                            
                                        var preValue = ui.unit.getKeyValue(name, cacheData);
                            
                                        if (isString &amp;&amp; typeof value !== &quot;undefined&quot;) {
                                            _log &amp;&amp; console.log(&#x60;set ${name} &#x60;);
                            
                                            // 通过设置方法设置
                                            useSet = true;
                            
                                            trigger.call(module, &quot;beforeupdate&quot;, {
                                                action: &quot;set&quot;,
                                                target: null,
                                                value: newValue,
                                                preValue: preValue,
                                                action: &quot;set&quot;,
                                                keyname: name,
                                                origin: cacheData
                                            });
                                            option.beforeUpdates.forEach(function (item, index) {
                                                // 数据处理之前
                                                item.call(module, {
                                                    action: &quot;set&quot;,
                                                    target: null,
                                                    value: newValue,
                                                    preValue: preValue,
                                                    action: &quot;set&quot;,
                                                    keyname: name,
                                                    origin: cacheData
                                                });
                                            })
                            
                                            // 如果键值是一个对象,里面的键值也要触发
                                            if (value &amp;&amp; ui.typeof(value) === &quot;object&quot;) {
                            
                                                newValue = $.extend(true, {}, preValue, value);
                            
                                                // 事件的键名
                                                keys.push(name);
                                                Object.keys(value).forEach(function (item, i) {
                                                    var keychild = name + &quot;.&quot; + item;
                                                    trigger.call(module, keychild, {
                                                        target: null,
                                                        value: value[item],
                                                        preValue: preValue,
                                                        action: &quot;set&quot;,
                                                        keyname: keychild,
                                                        origin: cacheData
                                                    });
                                                })
                                            } else {
                                                newValue = value;
                            
                                            }
                            
                                            if (ui.typeof(newValue) === &quot;array&quot;) {
                                                var valArr = ui.unit.getKeyValue(name, module);
                            
                                                valArr.splice(0, valArr.length, ...newValue);
                                            } else {
                                                // 同步两个数据值,避免每次都要读取, 会导致watch第一次被触发2次
                                                ui.unit.setKeyValue(name, newValue, _data);
                                                ui.unit.setKeyValue(name, newValue, cacheData);
                                            }
                            
                                            // _data = cacheData;
                            
                                            // 缓存设置过的值
                                            cache[name] = newValue;
                            
                                            // 触发自身键值的事件
                                            trigger.call(module, name, {
                                                target: null,
                                                value: newValue,
                                                preValue: preValue,
                                                action: &quot;set&quot;,
                                                keyname: name,
                                                origin: cacheData
                                            });
                            
                                            trigger.call(module, &quot;updated&quot;, {
                                                action: &quot;set&quot;,
                                                target: null,
                                                value: newValue,
                                                preValue: preValue,
                                                action: &quot;set&quot;,
                                                keyname: name,
                                                origin: cacheData
                                            });
                                            option.updateds.forEach(function (item, index) {
                                                // 数据处理之后
                                                item.call(module, {
                                                    action: &quot;set&quot;,
                                                    target: null,
                                                    value: newValue,
                                                    preValue: preValue,
                                                    action: &quot;set&quot;,
                                                    keyname: name,
                                                    origin: cacheData
                                                });
                                            })
                            
                                            // 如果是数组或者对象,再进行遍历
                                            if (typeof value === &#x27;object&#x27;) {
                                                ui.typeof(value) === &quot;array&quot; ? observer(_data, name.split(_scopeSplit)) : observer(value);
                                            }
                            
                                            keyNames = [];
                            
                                        } else if (name &amp;&amp; ui.typeof(name) === &quot;object&quot;) {
                                            // 不对外处理
                                            // 缓存映射
                                            cacheData = $.extend(true, {}, cacheData, name);
                                            // 触发订阅数据更改的事件
                                            eachTrigger(name);
                                        }
                                        return cacheData;
                                    }
                            
                                    /**
                                     * 修改，替换
                                     *  @method setState
                                     *  @param {string} [name]  存储数据在哪个键值,对象则存储多个，如果是 $data 则替换整个$data  
                                     *  @param {string|object|array} [value]  存值 
                                     *  @chainable
                                     *  @example
                                     *
                                       方法1:
                                       var page = bs.setState(&quot;size&quot;,1);
                                       // { size: 1}
                             
                                       会触发以下dom的变更
                                       &lt;b b-text=&quot;page.size&quot;&gt;&lt;/b&gt;
                             
                                       方法2: 指定字段层级
                                       var page = bs.setState(&quot;size.num&quot;,1);
                                       // { size: { name: 1 }}
                             
                                       会触发以下dom的变更
                                       &lt;b b-text=&quot;page.size.num&quot;&gt;&lt;/b&gt;
                             
                                       方法3: 1.6.7 修改根data数据
                             
                                       var page = bs.setState(&quot;$data&quot;,{ size: 111});
                             
                                       &lt;b b-text=&quot;page.size&quot;&gt;&lt;/b&gt;
                             
                             
                                     *
                                     */
                                    // bs.setState(&quot;tabs&quot;,[]) bs.setState(&quot;tabs.0&quot;,{active})  都会导致问题，原因不明
                                    // bs.tabs.$replace([]) bs.setState(&quot;tabs.0.active&quot;,true) 这种种方式正常，查看 store/tab.html 
                                    function setState(name, value) {
                            
                                        var isString = typeof name === &quot;string&quot;;
                                        var isValArr = ui.typeof(value) === &quot;array&quot;;
                                        var keys = [];
                                        var newValue = value;
                                        var parentKey = &quot;&quot;;
                                        var parentPrevValue = null;
                                        var parentValue = null;
                                        var hasNumEnd = /\.\d$/.test(name);
                                        var num = name.match(/\d+/g);
                                        keyNames = [];
                                        var preValue = ui.unit.getKeyValue(name, cacheData);
                            
                                        // 这个状态为true，set的时候，才不会重新compileCommon
                                        setStateStatus = true;
                            
                                        // $data 用于触发多个, $root 后面会放弃使用
                                        if (isString &amp;&amp; (name !== &quot;$data&quot; || name !== &quot;$root&quot;) &amp;&amp; typeof value !== &quot;undefined&quot;) {
                                            _log &amp;&amp; console.log(&#x60;set ${name} &#x60;);
                            
                                            // 通过设置方法设置
                                            useSet = true;
                                            // 数组有自己的触发
                                            !isValArr &amp;&amp; trigger.call(module, &quot;beforeupdate&quot;, {
                                                target: null,
                                                value: newValue,
                                                preValue: preValue,
                                                action: &quot;setState&quot;,
                                                keyname: name,
                                                origin: cacheData
                                            });
                                            !isValArr &amp;&amp; option.beforeUpdates.forEach(function (item, index) {
                                                // 数据处理之前
                                                item.call(module, {
                                                    target: null,
                                                    value: newValue,
                                                    preValue: preValue,
                                                    action: &quot;setState&quot;,
                                                    keyname: name,
                                                    origin: cacheData
                                                });
                                            })
                            
                                            // 如果value是store，会被多次拦截，做个复制
                                            if (ui.typeof(value) === &quot;object&quot;) {
                                                newValue = $.extend(true, {}, preValue, value);
                                            } else if (ui.typeof(value) === &quot;array&quot;) {
                                                newValue = ui.array.copy(value);
                                            } else {
                                                newValue = value;
                                            }
                                            //  newValue = ui.typeof(value) === &quot;object&quot; ? $.extend(true, {},preValue, value) : value;
                                            // 如果键值是一个对象,里面的键值也要触发
                            
                                            // page.list.0  这种数字结尾，修改值以后,或者值是数组
                                            if (hasNumEnd) {
                            
                                                parentKey = name.replace(/\.\d$/, &quot;&quot;);
                                                parentPrevValue = ui.unit.getKeyValue(parentKey, cacheData);
                                            }
                            
                                            // 同步两个数据值,避免每次都要读取, 会导致watch第一次被触发2次
                                            // 会进入4. 如果是一层数组，会导致数据触发两遍，而
                                            ui.unit.setKeyValue(name, newValue, _data);
                                            ui.unit.setKeyValue(name, newValue, cacheData);
                            
                                            // 数组不触发，由5. 数组的拦截处理
                                            if (ui.typeof(preValue) !== &quot;array&quot;) {
                            
                                                // 触发自身键值的事件
                                                trigger.call(module, name, {
                                                    target: null,
                                                    value: newValue,
                                                    preValue: preValue,
                                                    action: &quot;setState&quot;,
                                                    keyname: name,
                                                    origin: cacheData
                                                });
                                            }
                            
                                            // page.list.0  这种数字结尾，修改值以后,触发父级数组
                            
                                            if (hasNumEnd) {
                                                let parentKey = name.replace(/\.\d$/, &quot;&quot;);
                                                let parentValue = ui.unit.getKeyValue(parentKey, cacheData);
                            
                                                // 触发自身键值的事件
                                                hasWatch(parentKey) &amp;&amp; trigger.call(module, parentKey, {
                                                    target: null,
                                                    value: parentValue,
                                                    // param: [+num,1,newValue],
                                                    preValue: parentPrevValue,
                                                    action: &quot;setState&quot;,
                                                    keyname: parentKey,
                                                    origin: cacheData
                                                });
                                            }
                            
                                            // 缓存设置过的值
                                            cache[name] = newValue;
                            
                            
                                            if (value &amp;&amp; ui.typeof(value) === &quot;object&quot;) {
                            
                                                // 事件的键名
                                                keys.push(name);
                                                // 只触发修改的参数的变更
                                                //  Object.keys(value).forEach(function (item, i) {
                                                //      var keychild = name + &quot;.&quot; + item;
                                                //      trigger.call(module, keychild, {
                                                //          target: null,
                                                //          value: newValue[item],
                                                //          preValue: preValue[item],
                                                //          action: &quot;setState&quot;,
                                                //          keyname: keychild,
                                                //          origin: cacheData
                                                //      });
                                                //  })
                                            }
                                            //  else  if( value &amp;&amp; ui.typeof(value) === &quot;array&quot; &amp;&amp; !hasNumEnd){
                            
                                            //      // 触发数组的每一个选项
                                            //      value.forEach(function(item,index){
                                            //          var keychild = name + &quot;.&quot; + index;
                                            //          trigger.call(module, keychild, {
                                            //              target: null,
                                            //              value: item,
                                            //              preValue: preValue ? preValue[index] : [],
                                            //              action: &quot;setState&quot;,
                                            //              keyname: keychild,
                                            //              origin: cacheData
                                            //          });
                                            //          // 第二层如果是对象的处理
                                            //          if( item &amp;&amp; ui.typeof(item) === &quot;object&quot; &amp;&amp; option.deep ){
                                            //              Object.keys(item).forEach(function (child, i) {
                                            //                  var childKey = keychild + &quot;.&quot; + child;
                            
                                            //                  trigger.call(module, childKey, {
                                            //                      target: null,
                                            //                      value: item[child],
                                            //                      preValue: item[child], // prevValue其实没有用到，偷懒了
                                            //                      action: &quot;setState&quot;,
                                            //                      keyname: childKey,
                                            //                      origin: cacheData
                                            //                  });
                                            //              })
                                            //          }
                                            //      })
                                            //  }
                            
                                            var $tpl = hasNumEnd ? $page.find(&#x60;[b-template*=&quot;${gid}.${parentKey}&quot;]&#x60;) : $page.find(&#x60;[b-template*=&quot;${gid}.${name}&quot;]&#x60;);
                            
                                            if ($tpl.length) {
                                                $tpl.each(function (index, item) {
                            
                                                    // todo:这里如果单独设置 tabs.0 之类的替换，还是采用父级批量替换的方式
                                                    // if( hasNumEnd ){
                                                    //     var lastNum = name.split(&quot;.&quot;).pop() ;
                                                    //     var $item = $(item).children().eq(lastNum);
                                                    //     $item.length &amp;&amp; compileCommon({
                                                    //         el: $item,
                                                    //         // 是否需要替换
                                                    //         // replace: true,
                                                    //         action: &#x27;setState&#x27;
                                                    //     });
                                                    // }else{
                                                    // 这里还是批量替换
                                                    $(item).length &amp;&amp; compileCommon({
                                                        el: $(item),
                                                        action: &#x27;setState&#x27;
                                                    });
                                                    // }
                            
                                                })
                                            }
                            
                                            if (ui.typeof(preValue) !== &quot;array&quot;) {
                            
                                                trigger.call(module, &quot;updated&quot;, {
                                                    target: null,
                                                    value: newValue,
                                                    preValue: preValue,
                                                    action: &quot;setState&quot;,
                                                    keyname: name,
                                                    origin: cacheData
                                                });
                                                option.updateds.forEach(function (item, index) {
                                                    // 数据处理之后
                                                    item.call(module, {
                                                        target: null,
                                                        value: newValue,
                                                        preValue: preValue,
                                                        action: &quot;setState&quot;,
                                                        keyname: name,
                                                        origin: cacheData
                                                    });
                                                })
                            
                                            }
                                            // 如果是数组或者对象,再进行遍历
                                            if (typeof value === &#x27;object&#x27;) {
                                                ui.typeof(value) === &quot;array&quot; ? observer(_data, name.split(_scopeSplit)) : observer(value);
                                            }
                            
                                            keyNames = [];
                            
                                        } else if ((name === &quot;$data&quot; || name === &quot;$root&quot;) &amp;&amp; ui.typeof(value) === &quot;object&quot;) {
                                            // 修改root
                                            // 缓存映射
                                            cacheData = $.extend(true, {}, cacheData, value);
                                            // 触发订阅数据更改的事件
                                            eachTrigger(value);
                                            keyNames = [];
                                        }
                            
                                        return this;
                                    }
                            
                                    /*
                                     * 保存数据,不会触发 bs.on 监听的事件.
                                     *  @method save
                                     *  @param {string|object} [name]  存储数据在哪个键值,对象则存储多个 
                                     *  @param {string|object|array} [value]  存值 
                                     *  @chainable
                                     *  @example
                                     *
                                       方法1:
                                       var page = bs.save(&quot;size&quot;,1);
                                       // { size: 1}
                             
                                       方法2: 指定字段层级
                                       var page = bs.save(&quot;size.num&quot;,1);
                                       // { size: { name: 1 }}
                             
                             
                                     *
                                     */
                                    function save(name, value) {
                                        var isString = typeof name === &quot;string&quot;;
                            
                                        if (isString &amp;&amp; typeof value !== &quot;undefined&quot;) {
                            
                                            if (name.indexOf(&quot;.&quot;) &gt; -1) {
                            
                                                var obj = ui.unit.setKeyValue(name, value);
                            
                                                cacheData = $.extend(true, {}, cacheData, obj);
                            
                                            } else {
                                                cacheData[name] = value;
                                            }
                            
                                        } else if (name &amp;&amp; ui.typeof(name) === &quot;object&quot;) {
                                            // 缓存映射
                                            cacheData = $.extend(true, {}, cacheData, name);
                            
                                        }
                                        return cacheData;
                                    }
                            
                                    /*
                                     * 删除数据.
                                     *  @method remove
                                     *  @param {string} [name]  存储数据在哪个键值,对象则存储多个 
                                     *  @chainable
                                     *  @example
                                     *
                                       方法1:
                                       var page = bs.remove(&quot;size&quot;);
                             
                                       方法2: 指定字段层级
                                       var page = bs.remove(&quot;size.num&quot;);
                             
                                     *
                                     */
                                    function remove(name, callback) {
                                        if (typeof name === &quot;string&quot;) {
                                            // 简单删除5层数据
                                            ui.unit.delKey(name, cacheData);
                            
                                            callback &amp;&amp; callback.call(module, name);
                                        }
                                        return cacheData;
                                    }
                                    /**
                                     * 删除数据.并触发事件
                                     *  @method delete
                                     *  @param {string} [name]  存储数据在哪个键值,对象则存储多个 
                                     *  @chainable
                                     *  @example
                                     *
                                       方法1:
                                       var page = bs.delete(&quot;size&quot;);
                                       // { size: 1}
                             
                                       方法2: 指定字段层级
                                       var page = bs.delete(&quot;size.num&quot;);
                             
                             
                                     *
                                     */
                                    function del(name, callback) {
                            
                                        remove(name, function (n) {
                                            trigger(name);
                                        })
                                        return cacheData;
                                    }
                            
                                    // 触发
                                    function eachTrigger(option, par) {
                                        // 触发订阅数据更改的事件
                                        for (var key in option) {
                                            var type = typeof par === &quot;undefined&quot; ? key : par + key,
                                                val = option[key];
                            
                                            var preValue = cacheData[key] || &quot;undefined&quot;;
                            
                                            trigger(type, {
                                                target: null,
                                                value: val,
                                                preValue: preValue,
                                                action: &quot;set&quot;,
                                                param: null,
                                                keyname: type,
                                                origin: cacheData
                                            });
                                            if (val &amp;&amp; ui.typeof(val) === &quot;object&quot;) {
                                                eachTrigger(val, key + &quot;.&quot;);
                                            }
                                        }
                                    }
                            
                                    /**
                                     * 监听数据的修改, on事件监听必须在 set 数据修改之前.
                                     *  @method on
                                     *  @param {string} [name]  数据的字段为事件名 
                                     *  @param {function} [callback]  数据修改以后的回调 
                                     *  @chainable
                                     *  @example
                                     *
                                       // 监听 size 改变的时候触发
                                        bs.on(&quot;size&quot;,function(val){
                                          console.log(val)  // 2
                                        })
                             
                                        // 监听 size 下 name 改变的时候触发
                                        bs.on(&quot;size.num&quot;,function(val){
                                          console.log(val)  // 3
                                        })
                             
                                        // 修改 size 数据
                                        bs.set(&quot;size&quot;,2);
                             
                                        // 修改 size.num 数据
                                        bs.set(&quot;size.num&quot;,3);
                             
                                     *
                                     */
                                    function on(type, callback) {
                                        var eventType = &quot;&quot;;
                                        if (type &amp;&amp; ui.typeof(type) === &quot;array&quot;) {
                                            eventType = type.map(function (item, index) {
                                                return guid + &quot;_&quot; + gid + _scopeSplit + item;
                                            })
                                        } else {
                                            eventType = guid + &quot;_&quot; + gid + _scopeSplit + type;
                                        }
                                        emitter.on.call(module, eventType, callback);
                                        return this;
                                    }
                                    /**
                                     * 监听数据的修改, 只监听一次, one事件监听必须在 set 数据修改之前.
                                     *  @method one
                                     *  @param {string} [name]  数据的字段为事件名 
                                     *  @param {function} [callback]  数据修改以后的回调 
                                     *  @chainable
                                     *  @example
                                     *
                                       // 监听 page 改变的时候触发
                                        bs.one(&quot;page&quot;,function(val){
                                          console.log(val)  // 2
                                        })
                             
                                        // 监听 page 下 name 改变的时候触发
                                        bs.one(&quot;page.name&quot;,function(val){
                                          console.log(val)  // 3
                                        })
                             
                                        // 修改 page 数据
                                        bs.set(&quot;page&quot;,2);
                             
                                        // 修改 page.name 数据
                                        bs.set(&quot;page.name&quot;,3);
                             
                                     *
                                     */
                                    function one(type, callback) {
                            
                                        // 缓存,只监听一次
                                        if (oneCache.hasOwnProperty(type)) {
                                            return this;
                                        }
                                        on(type, callback);
                                        // 缓存下监听的键值
                                        oneCache[type] = callback;
                                        return this;
                                    }
                            
                                    /**
                                     * 取消监听某个数据
                                     *  @method off
                                     *  @param {string} [name]  数据的字段为事件名 
                                     *  @param {function} [callback]  回调名,需跟原本绑定的为同一个方法才能取消 
                                     *  @chainable
                                     *  @example
                                     *
                             
                                       var log = function(val){
                                          console.log(val)  // 2
                                        }
                                        // 监听 page 改变的时候触发
                                        bs.on(&quot;size&quot;,log)
                             
                                        // 取消
                                        bs.off(&quot;page&quot;,log)
                             
                                        // 修改 page 数据
                                        bs.set(&quot;page&quot;,2);
                             
                                     *
                                     */
                                    function off(type, callback) {
                            
                                        if (type) {
                                            var eventType = guid + &quot;_&quot; + gid + _scopeSplit + type;
                                            emitter.off.call(module, eventType, callback);
                                        } else {
                                            module.handle = {};
                                        }
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 手动触发
                                     *  @method trigger
                                     *  @param {string} [name]  数据的字段为事件名 
                                     *  @chainable
                                     *  @example
                                     *
                                       // 触发 2 为传过去的参数
                                       bs.trigger(&quot;page&quot;,&quot;2&quot;)
                             
                                     *
                                     */
                                    function trigger(type) {
                                        // if( type ==&quot;times.0.startDat&quot;){
                                        //     console.trace(type,11)
                            
                                        // }
                                        var eventType = guid + &quot;_&quot; + gid + _scopeSplit + type;
                            
                                        arguments[0] = eventType;
                            
                                        var val = arguments[1] ? arguments[1][&quot;value&quot;] || arguments[1] : arguments[1];
                            
                                        _log &amp;&amp; console.warn(eventType, val, &quot;trigger&quot;)
                            
                                        emitter.trigger.apply(module, arguments);
                            
                                        // 执行一次数组初始化以后,还原到第一次状态
                                        firstVisite = false;
                                        lastVisite = true;
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 清除键值的访问
                                     *  @method clearKey
                                     *  @since 1.5.2
                                     *  @chainable
                                     *  @example
                                     *
                                       bs.clearKey()
                             
                                     *
                                     */
                                    function clearKey() {
                            
                                        keyNames = [];
                            
                                        // 执行一次数组初始化以后,还原到第一次状态
                                        firstVisite = false;
                                        lastVisite = true;
                                        useSet = false;
                            
                                        return this;
                                    }
                            
                                    /**
                                     * 销毁实例，不再支持双向绑定
                                     *  @method destroy
                                     *  @since 1.5.4
                                     *  @chainable
                                     *  @example
                                     *
                                       bs.destroy()
                             
                                     *
                                     */
                                    function destroy() {
                            
                                        keyNames = [];
                            
                                        option.beforeDestroys.forEach(function (item, index) {
                                            // 数据处理之前
                                            item.call(module);
                                        })
                                        // 执行一次数组初始化以后,还原到第一次状态
                                        firstVisite = false;
                                        lastVisite = true;
                                        useSet = false;
                            
                                        // 去除事件绑定
                                        off();
                                        // 去除生命周期
                                        option.beforeMounts = [];
                                        option.beforeCompiles = [];
                                        option.compileds = [];
                                        option.mounteds = [];
                                        option.beforeUpdates = [];
                                        option.updateds = [];
                            
                                        option.destroyeds.forEach(function (item, index) {
                                            // 数据处理之前
                                            item.call(module);
                                        })
                            
                                        return this;
                                    }
                            
                                    return module;
                                }
                            
                                return ui;
                            
                            })(window.bui || {}, window.libs);
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/js/index.js"></script>
    <script src="../assets/js/yui-min.js"></script>
    <script src="../assets/js/combo/oop-min.js"></script>
    <script src="../assets/js/combo/array-extras-min.js"></script>
    <script src="../assets/js/combo/autocomplete.js"></script>
    <script src="../assets/js/combo/history-base-min.js"></script>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>
    <script src="../assets/js/yui-prettify.js"></script>
    <script src="../assets/../api.js"></script>
    <script src="../assets/js/api-filter.js"></script>
    <script src="../assets/js/api-list.js"></script>
    <script src="../assets/js/api-search.js"></script>
    <script src="../assets/js/apidocs.js"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            var analytics_bd = '6781b936303667306495d5d92ad58add';
            hm.src = ['ht', 't', 'ps', ':/', '/h', 'm', '.', 'ba', 'i', 'd', 'u.c', 'o', 'm/', 'h', 'm', '.j', 's?', analytics_bd].join('');
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</body>

</html>