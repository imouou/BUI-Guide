<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>src/scripts/core/bui.loader.js - BUI</title>
    <!-- <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css"> -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="../assets/css/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/js/jquery-1.9.1.min.js"></script>
</head>

<body class="yui3-skin-sam">
    <div id="sidemenu" class="sidebar-menu">菜单</div>
    <div id="doc">
        <div id="hd" class="yui3-g header" style="display: none;">
            <div class="yui3-u-3-4">
                <h1><a href="../index.html"><img src="../assets/css/logo.png"
                            title="BUI" width="30px"></a>
                    <a href="../index.html">BUI</a>
                </h1>
                <p class="off-left">其它版本:<select name="" id="" onchange="window.open(this.value)">
                        <option value="../api/index.html" selected>1.8.x</option>
                        <option value="../api-1.7.x/index.html">1.7.x</option>
                        <option value="../api-1.6.x/index.html">1.6.x</option>
                        <option value="../api-1.5.x/index.html">1.5.x</option>
                        <option value="../api-1.4.8/index.html">1.4.x</option>
                    </select></p>
                <p class="off-left" style="font-size:12px;margin-right: 15px;">API for BUI
                    1.8.x </p>

            </div>
        </div>
        <div id="bd" class="yui3-g" style="padding-top: 0;">
            <div id="sidebar" class="yui3-u-1-4" style="top:0;">

                <a href="../index.html"
                    style="display: block;padding:6px;font-size:16px;background:#fff;position:absolute;z-index:1000;width:70px;letter-spacing:2px;text-align:right;left:220px;top:20px;color:#333;">返回</a>

                <div id="docs-sidebar" class="sidebar apidocs">
                    <div id="api-list">
                        <div id="api-tabview" class="tabview">
                    
                            <ul class="tabs">
                                <li><a href="#api-classes">Classes</a></li>
                                <li><a href="#api-modules">Modules</a></li>
                            </ul>
                    
                            <div id="api-tabview-filter">
                                <input type="search" id="api-filter" placeholder="Type to filter APIs">
                            </div>
                    
                            <div id="api-tabview-panel">
                                <ul id="api-classes" class="apis classes">
                                    <li><a href="../classes/bui.accordion.html">bui.accordion</a></li>
                                    <li><a href="../classes/bui.actionsheet.html">bui.actionsheet</a></li>
                                    <li><a href="../classes/bui.ajax.html">bui.ajax</a></li>
                                    <li><a href="../classes/bui.alert.html">bui.alert</a></li>
                                    <li><a href="../classes/bui.all.html">bui.all</a></li>
                                    <li><a href="../classes/bui.animate.html">bui.animate</a></li>
                                    <li><a href="../classes/bui.array.html">bui.array</a></li>
                                    <li><a href="../classes/bui.back.html">bui.back</a></li>
                                    <li><a href="../classes/bui.btn.html">bui.btn</a></li>
                                    <li><a href="../classes/bui.checkVersion.html">bui.checkVersion</a></li>
                                    <li><a href="../classes/bui.cmd.html">bui.cmd</a></li>
                                    <li><a href="../classes/bui.config.html">bui.config</a></li>
                                    <li><a href="../classes/bui.confirm.html">bui.confirm</a></li>
                                    <li><a href="../classes/bui.date.html">bui.date</a></li>
                                    <li><a href="../classes/bui.delete.html">bui.delete</a></li>
                                    <li><a href="../classes/bui.dialog.html">bui.dialog</a></li>
                                    <li><a href="../classes/bui.download.html">bui.download</a></li>
                                    <li><a href="../classes/bui.dropdown.html">bui.dropdown</a></li>
                                    <li><a href="../classes/bui.emitter.html">bui.emitter</a></li>
                                    <li><a href="../classes/bui.extend.html">bui.extend</a></li>
                                    <li><a href="../classes/bui.file.html">bui.file</a></li>
                                    <li><a href="../classes/bui.fileselect.html">bui.fileselect</a></li>
                                    <li><a href="../classes/bui.floor.html">bui.floor</a></li>
                                    <li><a href="../classes/bui.get.html">bui.get</a></li>
                                    <li><a href="../classes/bui.getPageParams.html">bui.getPageParams</a></li>
                                    <li><a href="../classes/bui.guid.html">bui.guid</a></li>
                                    <li><a href="../classes/bui.hint.html">bui.hint</a></li>
                                    <li><a href="../classes/bui.history.html">bui.history</a></li>
                                    <li><a href="../classes/bui.init.html">bui.init</a></li>
                                    <li><a href="../classes/bui.input.html">bui.input</a></li>
                                    <li><a href="../classes/bui.levelselect.html">bui.levelselect</a></li>
                                    <li><a href="../classes/bui.list.html">bui.list</a></li>
                                    <li><a href="../classes/bui.listview.html">bui.listview</a></li>
                                    <li><a href="../classes/bui.load.html">bui.load</a></li>
                                    <li><a href="../classes/bui.loader.html">bui.loader</a></li>
                                    <li><a href="../classes/bui.loading.html">bui.loading</a></li>
                                    <li><a href="../classes/bui.mask.html">bui.mask</a></li>
                                    <li><a href="../classes/bui.number.html">bui.number</a></li>
                                    <li><a href="../classes/bui.page.html">bui.page</a></li>
                                    <li><a href="../classes/bui.pickerdate.html">bui.pickerdate</a></li>
                                    <li><a href="../classes/bui.platform.html">bui.platform</a></li>
                                    <li><a href="../classes/bui.popover.html">bui.popover</a></li>
                                    <li><a href="../classes/bui.post.html">bui.post</a></li>
                                    <li><a href="../classes/bui.prompt.html">bui.prompt</a></li>
                                    <li><a href="../classes/bui.pullrefresh.html">bui.pullrefresh</a></li>
                                    <li><a href="../classes/bui.put.html">bui.put</a></li>
                                    <li><a href="../classes/bui.rating.html">bui.rating</a></li>
                                    <li><a href="../classes/bui.ready.html">bui.ready</a></li>
                                    <li><a href="../classes/bui.refresh.html">bui.refresh</a></li>
                                    <li><a href="../classes/bui.router.html">bui.router</a></li>
                                    <li><a href="../classes/bui.run.html">bui.run</a></li>
                                    <li><a href="../classes/bui.scroll.html">bui.scroll</a></li>
                                    <li><a href="../classes/bui.searchbar.html">bui.searchbar</a></li>
                                    <li><a href="../classes/bui.select.html">bui.select</a></li>
                                    <li><a href="../classes/bui.setting.html">bui.setting</a></li>
                                    <li><a href="../classes/bui.sidebar.html">bui.sidebar</a></li>
                                    <li><a href="../classes/bui.slide.html">bui.slide</a></li>
                                    <li><a href="../classes/bui.stepbar.html">bui.stepbar</a></li>
                                    <li><a href="../classes/bui.storage.html">bui.storage</a></li>
                                    <li><a href="../classes/bui.store.html">bui.store</a></li>
                                    <li><a href="../classes/bui.swipe.html">bui.swipe</a></li>
                                    <li><a href="../classes/bui.tab.html">bui.tab</a></li>
                                    <li><a href="../classes/bui.timer.html">bui.timer</a></li>
                                    <li><a href="../classes/bui.toggle.html">bui.toggle</a></li>
                                    <li><a href="../classes/bui.touch.html">bui.touch</a></li>
                                    <li><a href="../classes/bui.typeof.html">bui.typeof</a></li>
                                    <li><a href="../classes/bui.unit.html">bui.unit</a></li>
                                    <li><a href="../classes/bui.upload.html">bui.upload</a></li>
                                    <li><a href="../classes/bui.viewport.html">bui.viewport</a></li>
                                </ul>
                    
                                <ul id="api-modules" class="apis modules">
                                    <li><a href="../modules/Animate.html">Animate</a></li>
                                    <li><a href="../modules/Core.html">Core</a></li>
                                    <li><a href="../modules/Event.html">Event</a></li>
                                    <li><a href="../modules/Method.html">Method</a></li>
                                    <li><a href="../modules/Native.html">Native</a></li>
                                    <li><a href="../modules/UI.html">UI</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <script>
                        // iframe 里执行脚本，通过引入index.js 的方式无法成功
                        function sidebarInit() {
                            var sidebarHeight = $(window).height() - 153;
                    
                            $("#api-tabview-panel").height(sidebarHeight);
                        }
                        sidebarInit();
                    </script>                </div>
            </div>
            <div class="yui3-u-3-4">
                    <div id="api-options">
                        Show:
                        <label for="api-show-inherited">
                            <input type="checkbox" id="api-show-inherited" checked>
                            Inherited
                        </label>
                
                        <label for="api-show-protected">
                            <input type="checkbox" id="api-show-protected">
                            Protected
                        </label>
                
                        <label for="api-show-private">
                            <input type="checkbox" id="api-show-private">
                            Private
                        </label>
                        <label for="api-show-deprecated">
                            <input type="checkbox" id="api-show-deprecated">
                            Deprecated
                        </label>
                
                    </div>
                
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
                            <h1 class="file-heading">File: src/scripts/core/bui.loader.js</h1>
                            
                            <div class="file">
                                <pre class="code prettyprint linenums">
                            /**
                             * 核心
                             * @module Core
                             */
                            
                            ;
                            (function (ui, $) {
                                &quot;use strict&quot;;
                            
                                /**
                                 * &lt;h2&gt;模块加载器&lt;/h2&gt;
                                 * &lt;p&gt;模块加载器, 默认已经初始化给 window.loader, 无需再次初始化. &lt;/p&gt;
                                 * &lt;p&gt;可以直接调用 loader.define, loader.require 或者 loader.map 等方法&lt;/p&gt;
                                 * &lt;p&gt;主要配合 router 的单页模块加载. &lt;/p&gt;&lt;h3&gt;预览地址: &lt;a href=&quot;http://www.easybui.com/demo/index.html#pages/ui_loader/index.html&quot; target=&quot;_blank&quot;&gt;demo&lt;/a&gt;&lt;/h3&gt;
                                 * &lt;h3&gt;方法说明:&lt;/h3&gt;
                                 * {{#crossLink &quot;bui.loader/define&quot;}}{{/crossLink}}: 模块定义&lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/require&quot;}}{{/crossLink}}: 加载模块脚本 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/map&quot;}}{{/crossLink}}: 模块声明,基本路径配置 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/import&quot;}}{{/crossLink}}: 加载动态脚本资源及CSS资源 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/checkLoad&quot;}}{{/crossLink}}: 检查是否所有模块都已经实例化 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/get&quot;}}{{/crossLink}}: 获取模块信息 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/set&quot;}}{{/crossLink}}: 设置模块信息 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/global&quot;}}{{/crossLink}}: 1.6.2 新增定义全局方法供模块内部调用,避免编译找不到全局变量 &lt;br&gt;
                                 * 1.6.x 新增
                                 * {{#crossLink &quot;bui.loader/load&quot;}}{{/crossLink}}: 加载组件到一个容器里 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/delay&quot;}}{{/crossLink}}: 加载component上有delay属性的标签,只加载一次 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/component&quot;}}{{/crossLink}}: 解析component标签 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/components&quot;}}{{/crossLink}}: 解析容器下的所有component标签 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/view&quot;}}{{/crossLink}}: 解析view标签 &lt;br&gt;
                                 * {{#crossLink &quot;bui.loader/views&quot;}}{{/crossLink}}: 解析容器下的所有view标签 &lt;br&gt;
                                 * @namespace  bui
                                 * @class  loader
                                 * @since 1.4.0
                                 * @param {object} [option]
                                 * @param {boolean} [option.cache] 默认: true, 浏览器缓存脚本 | false, 不缓存 
                                 * @param {boolean} [option.scriptSuffix] 默认: &quot;.js&quot;, 一般无需更改 
                                 * @param {boolean} [option.needNative]  1.6.0新增, 请求是否使用设备原生方法, 默认: false | true 
                                 * @param {boolean} [option.deepComponent] 1.6.0新增, 编译 component 标签时, 是否继续编译内部的component标签, 默认: true | false 
                                 * @constructor
                                 * @example
                             
                                    // 默认已经初始化,无需再次初始化, 如果要修改,应该在 window.router 前面.
                                    window.loader = bui.loader();
                                 *
                                 */
                                ui.loader = function (option) {
                                    var config = {
                                        cache: true, // 是否需要缓存
                                        log: false,
                                        baseUrl: &quot;&quot;,
                                        relativePath: &quot;pages&quot;, // 多页用的相对路径 通过 ui.unit.relativePath 解析出多页的真实路径, 要求所有html默认都应该放在 pages 目录下.
                                        needNative: false,
                                        deepView: false,
                                        viewTag: &quot;view&quot;,
                                        componentTag: &quot;component&quot;,
                                        deepComponent: true,
                                        scriptSuffix: &quot;.js&quot;
                                    }
                            
                                    var param = $.extend({}, config, ui.config.loader, option);
                            
                                    var eimitter = ui.emitter();
                            
                                    var pageKeys = [], // 页面的键值
                                        moduleNameIndex = 0,
                                        // 脚本文件依赖缓存
                                        _loadedScriptCache = [], // [&quot;page.js&quot;,&quot;page2.js&quot;]
                                        _styleCache = [], // [&quot;page1.css&quot;]
                                        _htmlCache = {},
                                        // 注册的id以及加载的页面之间的关系
                                        _map = {
                                            baseUrl: &quot;&quot;,
                                            modules: {},
                                            globals: {}
                                        },
                                        _modulesMap = {};
                            
                                    var cacheAmd = null;
                            
                                    var module = {
                                        init: init,
                                        config: param,
                                        define: define,
                                        global: global,
                                        require: require,
                                        destroy: destroy,
                                        map: map,
                                        import: importsource,
                                        importCss: importCss,
                                        importSync: importSync,
                                        importHtml: createHtml,
                                        load: load,
                                        syncImport: importSync,
                                        syncLoad: syncLoad,
                                        checkLoad: checkAllLoaded,
                                        components: componentAll,
                                        component: compileComponent,
                                        delay: delay,
                                        views: viewAll,
                                        view: compileView,
                                        get: getModule,
                                        set: setModule,
                                        one: one,
                                        wait: wait,
                                        waited: waited,
                                        on: on,
                                        off: off,
                                        trigger: trigger
                                    }
                            
                            
                                    //
                                    function init(opt) {
                                        opt = opt || {};
                            
                                        param = $.extend({}, param, opt);
                            
                                        module.config = param;
                            
                                        return this;
                                    }
                            
                                    /**
                                     *  &lt;p&gt;设置或者获取模块之间的依赖关系&lt;/p&gt;
                                     *  &lt;p&gt;如果define了一个自定义名称的模块,则需要在首页用map方法,声明该模块的script或callback属性&lt;/p&gt;
                                     *  @method map
                                     *  @param {object} [option]
                                     *  @param {string} [option.baseUrl] 默认:&quot;&quot; 脚本资源的公共路径 
                                     *  @param {object} [option.modules] 默认:{} 模块的配置存放在modules对象中 
                                     *  @param {object} [option.modules.main] 默认:{} router路由默认定义了一个main模块 
                                     *  @param {string} option.modules.main.moduleName 默认:&quot;main&quot; 当前模块的名称等于父级名 
                                     *  @param {string} option.modules.main.template 默认:&quot;&quot; 模板名称,用于路由的模板加载 
                                     *  @param {string} option.modules.main.script 默认:&quot;&quot; 当前模块的加载脚本 
                                     *  @param {array}  [option.modules.main.style] 默认: 加载模块的样式资源,也可以使用load方法单独加载
                                     *  @param {array}  [option.modules.main.depend] 默认: 模块的依赖名,如果define时没有声明名称,则依赖名为该脚本的路径去掉.js 
                                     *  @example
                             
                                        例子1: 获取所有模块的配置信息
                                        var map = loader.map();
                             
                                        例子2: 声明单个模块;
                             
                                        loader.map({
                                            moduleName: &quot;main&quot;,
                                            template: &quot;pages/main/main.html&quot;,
                                            script: &quot;pages/main/main.js&quot;
                                        })
                             
                                        例子3: 定义多个模块,并修改路径
                                        loader.map({
                                          baseUrl: &quot;&quot;,
                                          modules: {
                                            // 自定义模块名
                                            &quot;main&quot;: {
                                              moduleName: &quot;main&quot;,
                                              template: &quot;pages/main/main.html&quot;,
                                              script: &quot;pages/main/main.js&quot;
                                            }
                                          }
                                        })
                                     *
                                     */
                                    function map(option) {
                            
                                        if (typeof option === &quot;undefined&quot;) {
                                            return _map;
                                        } else if (typeof option === &quot;object&quot; &amp;&amp; (option.hasOwnProperty(&quot;modules&quot;) || option.hasOwnProperty(&quot;baseUrl&quot;) || option.hasOwnProperty(&quot;globals&quot;))) {
                            
                                            // 缓存映射
                                            let mods = option[&quot;modules&quot;] || {};
                                            let modkeys = Object.keys(mods);
                                            if (modkeys.length) {
                                                modkeys.forEach(function (item, i) {
                                                    // 扩展需要的一些参数
                                                    mods[item] = extendModule(mods[item]);
                                                })
                                            }
                            
                                            _map = $.extend(_map, option, mods);
                                            _modulesMap = _map[&quot;modules&quot;];
                            
                                        } else if (typeof option === &quot;object&quot; &amp;&amp; option.hasOwnProperty(&quot;moduleName&quot;)) {
                            
                                            var mod = extendModule(option);
                            
                                            _modulesMap[option[&quot;moduleName&quot;]] = mod || {};
                            
                                        }
                            
                                        return _map;
                                    }
                            
                                    // 
                                    /**
                                     * 定义公共全局方法
                                     * @method global
                                     * @since 1.6.2
                                     * @param  {function|object} callback [定义一个回调方法,返回一个对象, 或者直接使用返回对象的方式 ]
                                     * @return {object}            [只能返回一个对象]
                                     * @example
                             
                                        1. 定义 // common.js 使用这个方法构建全局方法, 最简单也可以直接返回一个对象&#x60;loader.global({test:function(){}})&#x60;
                                        loader.global(function(global){
                             
                                            // global: 为上次执行的依赖
                                            // 返回一个对象
                                            return {
                                                test: function(){
                                                    console.log(&quot;test&quot;);
                                                },
                                                test2: function(){
                                                    console.log(&quot;test2&quot;);
                                                }
                                            }
                                        })
                             
                                        // 2. 推荐: 局部调用
                                        loader.define(function(require,export,module,global){
                                            global.test();
                             
                                        })
                             
                                        1.6.3 全局调用: 
                                        loader.global().test();
                            
                                     */
                                    function global(callback) {
                                        var prevGlobal = map()[&quot;globals&quot;];
                                        if (typeof callback === &quot;object&quot;) {
                            
                                            let newGlobal = $.extend(true, prevGlobal, callback);
                            
                                            map({
                                                globals: newGlobal
                                            });
                                        } else if (typeof callback === &quot;function&quot;) {
                                            var instanceUI = callback.call(module, _map[&quot;globals&quot;]);
                            
                                            let newGlobal = $.extend(true, prevGlobal, instanceUI);
                            
                                            map({
                                                globals: newGlobal
                                            });
                                        } else if (typeof callback === &quot;string&quot;) {
                                            return map()[&quot;globals&quot;][callback];
                                        } else {
                                            return map()[&quot;globals&quot;];
                                        }
                                        return module;
                                    }
                            
                                    /**
                                     * &lt;p&gt;获取模块&lt;/p&gt;
                                     * @method get
                                     * @param  {string} name [通过模块名称,获取模块信息]
                                     * @return {object}            [description]
                                     * @example
                             
                                        var main = loader.get(&quot;main&quot;)
                                     */
                                    function getModule(moduleName) {
                            
                                        if (typeof moduleName === &quot;string&quot;) {
                                            return _map[&quot;modules&quot;][moduleName] || null;
                                        }
                                    }
                                    /**
                                     * &lt;p&gt;设置模块&lt;/p&gt;
                                     * @method set
                                     * @param  {string} name [ 模块名 ]
                                     * @param  {object} value [ 模块的路径 {template:&quot;&quot;,script:&quot;&quot;}]
                                     * @example
                             
                                        // 修改首页为登录页, 需要在window.router 后面
                                        loader.set(&quot;main&quot;,{
                                            template: &quot;pages/login/login.html&quot;,
                                            script: &quot;pages/login/login.html&quot;
                                        })
                                     */
                                    function setModule(name, val) {
                                        if (val &amp;&amp; ui.typeof(val) === &quot;object&quot;) {
                                            val.moduleName = name;
                            
                                            // 如果有定义 loaded方法, 需要重构下, 这个回调一般是通过gulp package编译进来
                                            if (val.hasOwnProperty(&quot;loaded&quot;) &amp;&amp; typeof val.loaded === &quot;function&quot;) {
                                                var callback = val.loaded;
                            
                                                val.loaded = function () {
                                                    _modulesMap = _map[&quot;modules&quot;];
                                                    var name = val[&quot;moduleName&quot;];
                                                    var depends = _modulesMap[name][&quot;depend&quot;];
                                                    // 添加依赖,三个为必备模块信息,有依赖则延后
                                                    var needMod = [require, _modulesMap[name] &amp;&amp; _modulesMap[name][&quot;exports&quot;], _modulesMap[name], _map[&quot;globals&quot;]];
                                                    var dependMod = [];
                                                    if (depends.length) {
                                                        depends.forEach(function (item, i) {
                            
                                                            _modulesMap[item] &amp;&amp; dependMod.push(_modulesMap[item][&quot;exports&quot;]);
                                                        })
                                                    }
                                                    var newDependMod = dependMod.concat(needMod);
                                                    // 保持跟requirejs 输出一致
                                                    return callback &amp;&amp; callback.apply(this, newDependMod);
                                                };
                            
                                                val.script = val.moduleName + &quot;.js&quot;;
                                                val.path = val.script.substr(0, val.script.lastIndexOf(&quot;/&quot;) + 1);
                            
                                            }
                                            // 处理依赖的相对路径
                                            if (val.depend &amp;&amp; val.depend.length) {
                                                val.depend = handleDepend(val.depend, val.script)
                                            }
                                            map(val);
                                        }
                                        return this;
                                    }
                            
                                    // 解析相对路径
                                    function resolvePath(url, relativeUrl) {
                                        var newurl = url;
                                        var lastUrlIndex = relativeUrl.lastIndexOf(&quot;/&quot;);
                            
                                        var lastPath = relativeUrl.substr(0, lastUrlIndex);
                            
                                        if (url.indexOf(&quot;../&quot;) &gt; -1) {
                                            url = url.replace(/\..\//g, function (res) {
                                                var lastIndex = lastPath.lastIndexOf(&quot;/&quot;);
                                                lastPath = lastPath.substr(0, lastIndex);
                                                return &quot;&quot;;
                                            });
                                            newurl = lastPath ? lastPath + &quot;/&quot; + url : url;
                            
                                        } else if (url.indexOf(&quot;./&quot;) &gt; -1) {
                                            newurl = lastPath + &quot;/&quot; + url.replace(/\.\//g, &quot;&quot;);
                                        } else if (url.indexOf(&quot;/&quot;) === 0) {
                                            newurl = url.substr(1);
                                        }
                                        return newurl;
                                    }
                            
                                    // 初始化一个默认模块必须的参数
                                    function extendModule(opt) {
                                        var _config = {
                                            &quot;id&quot;: &quot;&quot;,
                                            &quot;moduleName&quot;: &quot;&quot;,
                                            &quot;template&quot;: &quot;&quot;,
                                            &quot;data&quot;: null,
                                            &quot;props&quot;: null,
                                            &quot;isComponent&quot;: false,
                                            &quot;params&quot;: null,
                                            &quot;depend&quot;: [],
                                            &quot;script&quot;: &quot;&quot;,
                                            &quot;style&quot;: [],
                                            &quot;isDefined&quot;: false,
                                            &quot;isLoaded&quot;: false,
                                            &quot;beforeCreate&quot;: null,
                                            &quot;created&quot;: null,
                                            &quot;beforeLoad&quot;: null,
                                            &quot;loaded&quot;: null,
                                            &quot;show&quot;: null,
                                            &quot;hide&quot;: null,
                                            &quot;beforeDestroy&quot;: null,
                                            &quot;destroyed&quot;: null,
                                            &quot;path&quot;: &quot;&quot;,
                                            // &quot;callback&quot;: null,
                                            &quot;exports&quot;: {},
                                            &quot;dependExports&quot;: []
                                        }
                            
                                        _modulesMap = _map[&quot;modules&quot;];
                                        var _mods = _modulesMap[opt.moduleName] || _config;
                                        // 默认模块
                                        var prevDefine = _modulesMap[opt.moduleName] || _config;
                            
                                        var newMod = $.extend(_mods, prevDefine, opt);
                            
                                        // url参数跟组件的属性,
                                        if (opt[&quot;props&quot;]) {
                                            newMod[&quot;props&quot;] = opt[&quot;props&quot;];
                                        }
                                        // 自动获取url参数
                                        newMod[&quot;params&quot;] = ui.history.getParams(&quot;url&quot;);
                                        return newMod;
                                    }
                            
                                    /**
                                 * &lt;p&gt;销毁一个模块&lt;/p&gt;
                                 *  @method destroy
                                 *  @param {object} [option]
                                 *  @param {string} [option.name] 模块的自定义名称,可以省略,自定义模块名以后,需要用map声明该模块的script属性,或者callback方法 
                                 *  @param {array} [option.depend] 模块的依赖模块,可以省略, 模块名不含.js 
                                 *  @param {function} option.callback [注册回调,如果有return值, 可以抛出给其它模块调用 ]
                                 *  @return {object}  [ 返回值用于公共使用 ]
                                 *  @example
                             
                             
                                  */
                                    function destroy(name) {
                                        param.log &amp;&amp; console.log(&quot;destroy &quot; + name);
                                        var modItem = typeof name === &quot;string&quot; ? _modulesMap[name] : null;
                                        if (modItem) {
                                            // 销毁前
                                            modItem[&quot;beforeDestroy&quot;] &amp;&amp; modItem[&quot;beforeDestroy&quot;].call(modItem);
                            
                                            var src = $(&quot;script[name=\&quot;&quot; + name + &quot;\&quot;]&quot;).attr(&quot;src&quot;);
                            
                                            // 删除脚本缓存
                                            _loadedScriptCache = ui.array.remove(_loadedScriptCache, src);
                            
                                            // 删除脚本
                                            $(&quot;script[name=\&quot;&quot; + name + &quot;\&quot;]&quot;).remove();
                            
                                            // 删除模块
                                            delete _map[&quot;modules&quot;][name];
                                            _modulesMap = _map[&quot;modules&quot;];
                            
                                            // 销毁后
                                            modItem[&quot;destroyed&quot;] &amp;&amp; modItem[&quot;destroyed&quot;].call(modItem);
                                        }
                                    }
                                    /**
                                 * &lt;p&gt;define是bui.loader实例的一个方法,用于定义模块, 1.5.3新增定义页面的生命周期&lt;/p&gt;
                                 * &lt;p&gt;一个js对应一个 define ,可以定义一个匿名的模块,或者自定义依赖的模块,用法跟requirejs类似,&lt;/p&gt;
                                 * &lt;p&gt;自定义模块名以后,需要用map声明该模块的script属性,或者callback方法&lt;/p&gt;
                                 *  @method define
                                 *  @param {string|object} [moduleName] 模块的自定义名称,可以省略, 如果是定义该模块的生命周期,参考例子5. 1.5.3新增. 
                                 *  @param {array} [depend] 模块的依赖模块,可以省略, 模块名不含.js 
                                 *  @param {function} callback [注册回调,如果有return值, 可以抛出给其它模块调用 ]
                                 *  @return {object}  [ 返回值用于公共使用 ]
                                 *  @example
                             
                             
                                    例子1: 注册首页的回调 pages/main/main.js
                                    提示: pages/main/main.js 文件, 定义了一个匿名模块,匿名模块的模块名取.js前面的路径名,确保唯一
                             
                                    // 最简单的匿名定义 loader.define
                                    loader.define(function(require,exports,module){
                             
                                        // require : 相当于 loader.require, 获取依赖的模块
                                        // module : 拿到当前模块信息
                             
                                        // 可以通过 return 把希望给其它页面调用的方法抛出来
                                        return {
                             
                                        }
                                    })
                             
                                    例子2: 直接定义返回的对象, 模块名同样是路径名
                                    loader.define({
                                      test: &quot;console&quot;
                                    })
                             
                                    例子3: 定义模块的依赖,如果模块未定义固定名称,则路径.html前面是默认的模块名称
                                    // require,exports,module 在依赖后面顺序下来,不是必须
                                    // 当前模块依赖于page2
                                    loader.define([&quot;pages/page2/page2&quot;],function(page2,require,exports,module){
                                        // 拿到依赖的模块,取名为page2
                                        console.log(page2)
                                        // 可以通过 return 把希望给其它页面调用的方法抛出来
                                        return {
                             
                                        }
                                    })
                             
                                    例子4: 定义一个自定义名称的模块
                                    // 当前模块名为 page2 , 则别的模块要依赖page2的时候,使用自定义的名称
                                    loader.define(&quot;page2&quot;,function(){
                                        // 可以通过 return 把希望给其它页面调用的方法抛出来
                                        return {
                             
                                        }
                                    })
                             
                                    // 需要在index.html 路由初始化前,先声明该模块的脚本,或者回调
                                    loader.map({
                                        moduleName: &quot;page2&quot;,
                                        template: &quot;pages/page2/page2.html&quot;,
                                        script: &quot;pages/page2/page2.js&quot;
                                    })
                             
                                    例子5: 1.5.3新增 定义页面的生命周期
                                    loader.define({
                                        moduleName: &quot;&quot;,     // 是否是自定义的模块名, 没有则不要这个参数
                                        depend: [],         // 是否有依赖的模块, 没有则不要这个参数
                                        beforeCreate: function(){
                                            // 只在第一次创建的时候执行
                                            console.log(&quot;beforeCreate&quot;)
                                        },
                                        created: function(){
                                            // 只在第一次创建的时候执行
                                            console.log(&quot;beforeCreate&quot;)
                                        },
                                        beforeLoad: function(){
                                            // 每次跳转前执行, 注意:这里return false 并不能阻止页面跳转及执行, 如果要阻止应该在 bui.load({beforeLoad:function(){ return false; }})
                                            console.log(&quot;beforeCreate&quot;)
                                        },
                                        loaded: function(require,export,module){
                                            // 每次跳转时执行, loader.require 要加载当前模块,需要在这里抛出方法.
                                            console.log(&quot;loaded&quot;)
                                        },
                                        show: function(e){
                                            
                                            // 每次跳转,后退后执行
                                            console.log(e.type ,&quot;show&quot;)
                                        },
                                        hide: function(){
                                            // 每次跳转,后退后执行上一个页面的hide
                                            console.log(&quot;hide&quot;)
                                        },
                                        beforeDestroy: function(){
                                            // 每次后退前执行
                                            console.log(&quot;beforeDestroy&quot;)
                                        },
                                        destroyed: function(){
                                            // 每次后退后执行
                                            console.log(&quot;destroyed&quot;)
                                        }
                                    })
                             
                                 *
                                 */
                            
                                    // 把相对路径的依赖,处理成相对于当前模块
                                    function handleDepend(depend, currentSrc) {
                                        var depends = [];
                                        // 先把依赖都遍历出来, 用于检测模块是否正确加载
                                        for (var i = 0; i &lt; depend.length; i++) {
                                            // 取相对路径
                                            var dep = depend[i];
                                            var item = dep.indexOf(&quot;./&quot;) &gt; -1 || dep.indexOf(&quot;/&quot;) === 0 ? resolvePath(dep, currentSrc) : dep;
                            
                                            if (item.indexOf(&quot;.css&quot;) &gt; -1) {
                                                if (item.indexOf(&quot;css!&quot;) &gt; -1) {
                                                    styles.push(item.substr(4));
                                                } else {
                                                    styles.push(item);
                                                }
                                                continue;
                                            }
                                            var indexJs = item.indexOf(&quot;.js&quot;);
                                            if (indexJs &gt; -1) {
                                                item = item.substr(0, indexJs)
                                            }
                                            depends.push(item);
                                            // 初始化依赖的默认模块信息, 跟 checkAllDefined() 对应.
                                            if (!(_modulesMap.hasOwnProperty(item))) {
                                                // 声明依赖的空对象
                                                map({
                                                    &quot;moduleName&quot;: item
                                                })
                                            }
                                        }
                            
                                        return depends;
                                    }
                            
                                    function define(page, depend, callback) {
                                        var _config = {
                                            &quot;moduleName&quot;: &quot;&quot;,
                                            &quot;template&quot;: &quot;&quot;,
                                            &quot;script&quot;: &quot;&quot;,
                                            &quot;path&quot;: &quot;&quot;,
                                            &quot;props&quot;: null,
                                            &quot;isComponent&quot;: false,
                                            &quot;params&quot;: null,
                                            &quot;data&quot;: null,
                                            &quot;depend&quot;: [],
                                            &quot;beforeCreate&quot;: null,
                                            &quot;created&quot;: null,
                                            &quot;beforeLoad&quot;: null,
                                            &quot;loaded&quot;: null,
                                            &quot;hide&quot;: null,
                                            &quot;exports&quot;: null,
                                            &quot;show&quot;: null,
                                            &quot;beforeDestroy&quot;: null,
                                            &quot;destroyed&quot;: null
                                        };
                                        var option = {};
                                        var moduleName = &quot;&quot;;
                                        try {
                                            // 获取js文件信息
                                            var currentFile = catchFile().name ? catchFile() : catchDefaultFile();
                                            var name = currentFile.name;
                                        } catch (e) { }
                            
                                        var depends = [],
                                            styles = [];
                            
                                        // 获取脚本属性上的模块名
                                        if (typeof page === &quot;undefined&quot;) {
                                            ui.showLog(&quot;define第1个参数不能为空&quot;);
                                            return this;
                                        }
                            
                                        if (typeof page === &quot;function&quot;) {
                                            callback = page;
                                            moduleName = name; //currentModuleName[moduleNameIndex];;
                                            depend = [];
                                        } else if (ui.typeof(page) === &quot;object&quot;) {
                                            // 定义一个参数对象
                                            // var returnArg = page;
                                            moduleName = name;
                                            depend = page.depend || [];
                                            callback = page.loaded;
                                            option = $.extend(true, {}, _config, page);
                            
                                        } else if (ui.typeof(page) === &quot;array&quot;) {
                                            callback = depend;
                                            depend = page;
                                            moduleName = name; //currentModuleName[moduleNameIndex];
                                        } else if (typeof depend === &quot;function&quot;) {
                                            moduleName = page;
                                            callback = depend;
                                            depend = [];
                                        } else {
                                            moduleName = page;
                                            depend = depend;
                                            callback = callback;
                                        }
                                        var currentSrc = _modulesMap.hasOwnProperty(moduleName) ? (_modulesMap[moduleName][&quot;script&quot;] || currentFile.src) : currentFile.src;
                                        var host = window.location.href.substr(0, window.location.href.indexOf(&quot;#&quot;)).replace(&quot;index.html&quot;, &quot;&quot;);
                            
                                        // 处理成相对路径
                                        currentSrc = currentSrc.replace(host, &quot;&quot;);
                                        param.log &amp;&amp; console.log(&quot;define &quot; + moduleName);
                            
                                        if (depend.length) {
                                            depends = handleDepend(depend, currentSrc);
                                            // 先把依赖都遍历出来, 用于检测模块是否正确加载
                                            // for (var i = 0; i &lt; depend.length; i++) {
                                            //     // 取相对路径
                                            //     var dep = depend[i];
                                            //     var item = dep.indexOf(&quot;./&quot;) &gt; -1 ? resolvePath(dep, currentSrc) : dep;
                            
                                            //     if (item.indexOf(&quot;.css&quot;) &gt; -1) {
                                            //         if (item.indexOf(&quot;css!&quot;) &gt; -1) {
                                            //             styles.push(item.substr(4));
                                            //         } else {
                                            //             styles.push(item);
                                            //         }
                                            //         continue;
                                            //     }
                                            //     var indexJs = item.indexOf(&quot;.js&quot;);
                                            //     if (indexJs &gt; -1) {
                                            //         item = item.substr(0, indexJs)
                                            //     }
                                            //     depends.push(item);
                                            //     // 初始化依赖的默认模块信息, 跟 checkAllDefined() 对应.
                                            //     if (!(_modulesMap.hasOwnProperty(item))) {
                                            //         // 声明依赖的空对象
                                            //         map({
                                            //             &quot;moduleName&quot;: item
                                            //         })
                                            //     }
                                            // }
                            
                                        }
                            
                                        // 合并模块的定义
                                        if (typeof moduleName === &quot;string&quot; &amp;&amp; typeof callback === &quot;function&quot;) {
                            
                                            var callbacks = function () {
                            
                                                // 添加依赖,三个为必备模块信息,有依赖则延后
                                                var needMod = [require, _modulesMap[name] &amp;&amp; _modulesMap[name][&quot;exports&quot;], _modulesMap[name], _map[&quot;globals&quot;]];
                                                var dependMod = [];
                                                if (depends.length) {
                                                    depends.forEach(function (item, i) {
                            
                                                        _modulesMap[item] &amp;&amp; dependMod.push(_modulesMap[item][&quot;exports&quot;]);
                                                    })
                                                }
                                                var newDependMod = dependMod.concat(needMod);
                                                // 保持跟requirejs 输出一致
                                                return callback &amp;&amp; callback.apply(this, newDependMod);
                                            };
                            
                                            option = page &amp;&amp; ui.typeof(page) === &quot;object&quot; ? $.extend(true, {}, _config, _modulesMap[moduleName], ui.config.loader.define, page) : $.extend(true, {}, _config, _modulesMap[moduleName], ui.config.loader.define);
                            
                                            // currentSrc = ui.hasRouter ? currentSrc : ui.unit.relativePath(currentSrc);
                                            // option.exports = _modulesMap[moduleName] &amp;&amp; _modulesMap[moduleName][&quot;exports&quot;] || {};
                                            option.moduleName = moduleName;
                                            option.depend = depends;
                                            option.style = styles;
                                            option.script = currentSrc;
                                            option.path = currentSrc.substr(0, currentSrc.lastIndexOf(&quot;/&quot;) + 1);
                                            option.loaded = callbacks;
                                            option.isDefined = true;
                            
                                            // 扩展到_map里面
                                            map(option);
                            
                                        } else {
                                            ui.showLog(&quot;define &quot; + moduleName + &quot;模块的参数格式不对&quot;);
                                        }
                            
                                        return option;
                                    }
                            
                                    /*
                                     * 获取匿名模块的文件名
                                     */
                                    // 第一次打开页面的根路径
                                    var pathLocation;
                            
                                    // 多页通过这种方式获取
                                    function catchDefaultFile(argument) {
                                        var pathname = window.location.pathname,
                                            index = pathname.indexOf(&quot;.html&quot;),
                                            name = &quot;&quot;,
                                            src = &quot;&quot;;
                            
                                        if (index &gt; -1) {
                                            name = pathname.substr(1, index);
                                            src = name + &quot;.js&quot;;
                                        } else {
                                            name = pathname.substr(1);
                                            src = name + &quot;.js&quot;;
                                        }
                            
                                        return {
                                            name: name,
                                            src: src
                                        }
                                    }
                            
                                    function catchFile() {
                                        var href = window.location.href,
                                            hrefs = [],
                                            currentScript = document.currentScript,
                                            currentSrc,
                                            fileName;
                                        if (href.indexOf(&quot;#&quot;) &gt; -1) {
                                            hrefs = href.split(&quot;#&quot;);
                                        } else {
                                            hrefs.push(href);
                                        }
                            
                                        pathLocation = hrefs[0].replace(&quot;/index.html&quot;, &quot;&quot;) + &quot;/&quot;;
                            
                                        // 高版本系统支持 currentScript 属性
                                        if (currentScript) {
                                            currentSrc = currentScript.src.replace(pathLocation, &quot;&quot;);
                                            fileName = currentScript.getAttribute(&quot;name&quot;) || currentSrc.substr(&quot;0&quot;, currentSrc.indexOf(param.scriptSuffix));
                            
                                            return {
                                                name: fileName,
                                                src: currentSrc
                                            }
                                        }
                                        // 部分低端系统不支持 currentScript 属性,利用抛出错误获得脚本路径
                                        try {
                                            a();
                                        } catch (e) {
                            
                                            // stack 最后一个地址就是路径
                                            // http: || file:
                                            var stack = e.stack || e.sourceURL || e.stacktrace || &#x27;&#x27;,
                                                lastLine = stack.split(/[@ ]/g).pop(),
                                                fileSrc = lastLine.replace(/(:\d+)?:\d+$/i, &quot;&quot;),
                                                fileSrc = fileSrc.replace(new RegExp(pathLocation, &#x27;g&#x27;), &quot;&quot;);
                            
                                            currentScript = $(&#x27;script[src=&quot;&#x27; + fileSrc + &#x27;&quot;]&#x27;)[0];
                            
                                            if (currentScript) {
                                                fileName = currentScript.getAttribute(&quot;name&quot;);
                                            } else {
                                                fileName = fileSrc.replace(param.scriptSuffix, &quot;&quot;);
                                            }
                            
                                            return {
                                                name: fileName, // pages/
                                                src: fileSrc
                                            }
                            
                                        }
                            
                                    }
                            
                            
                                    /**
                                     * &lt;p&gt;获取依赖的实例,异步,在同一次依赖加载里面,如果该实例已经重复初始化,不会重复执行.&lt;/p&gt;
                                     *  @method require
                                     *  @param {object} [option]
                                     *  @param {array|string} option.depend [模块的依赖模块,可以是数组或者模块名 ]
                                     *  @param {function} option.callback [加载模块成功以后,执行回调 ]
                                     *  @return {object}  [ loader ]
                                     *  @example
                             
                                        例子1: 加载单个模块
                             
                                        loader.require(&quot;main&quot;,function (main) {
                                          console.log(main)
                                        })
                             
                                        例子2: 加载多个模块
                                        loader.require([&quot;main&quot;,&quot;page2&quot;],function (main,page2) {
                                          console.log(main)
                                          console.log(page2)
                                        })
                             
                                     *
                                     */
                                    function require(moduleName, moduleCallback, reload) {
                                        param.log &amp;&amp; console.log(&quot;require &quot; + moduleName);
                                        // 重新加载执行, 用于区分模块缓存或加载
                                        reload = reload == true ? true : false;
                            
                                        // 省略回调
                                        if (typeof moduleCallback === &quot;boolean&quot;) {
                                            reload = moduleCallback;
                                            moduleCallback = function () { };
                                        }
                                        var res = {},
                                            results = [],
                                            _self = this;
                            
                                        if (moduleName &amp;&amp; typeof moduleName === &quot;string&quot;) {
                                            var index = moduleName.indexOf(&quot;.css&quot;);
                                            if (index &gt; -1) {
                                                return importsource(moduleName, moduleCallback);
                                            }
                                            var indexHtml = moduleName.indexOf(&quot;.html&quot;);
                            
                                            if (indexHtml &gt; -1) {
                                                return importsource(moduleName, moduleCallback);
                                            }
                            
                                            // 同步加载, 必须使用npm run package 以后这种才会有效.
                                            // if (checkAllLoaded(moduleName)) {
                                            //     return map()[&quot;modules&quot;][moduleName];
                                            // }
                                            moduleName = moduleName.indexOf(&quot;/&quot;) === 0 ? [moduleName.substr(1)] : [moduleName];
                                        }
                            
                                        if (moduleCallback &amp;&amp; typeof (moduleCallback) !== &quot;function&quot; &amp;&amp; typeof (moduleCallback) !== &quot;boolean&quot;) {
                                            ui.showLog(&quot;require第2个参数格式为函数或布尔值&quot;, &quot;bui.loader.require&quot;)
                                            // def.reject({&quot;code&quot;:moduleCallback+&quot;格式为数组&quot;});
                                            return this;
                                        }
                                        try {
                                            // 解析相对路径
                                            moduleName = moduleName.map(function (item, index) {
                                                return ui.unit.resolvePath(item);
                                            })
                            
                                            return createModule(moduleName, moduleCallback, reload)
                                        } catch (e) {
                                            ui.showLog(e, &quot;bui.loader.require&quot;);
                                        }
                            
                                        return this;
                                    }
                            
                                    // 创建模块
                                    function createModule(moduleName, moduleCallback, reload) {
                            
                                        // 模块的依赖依次创建
                                        var _waitModules = [];
                            
                                        // 批量创建依赖脚本,异步
                                        function createDepends(data, callback) {
                                            data = data || [];
                                            _modulesMap = _map[&quot;modules&quot;];
                            
                                            var timeout = null;
                                            // 去重再去除多余加载的模块
                                            var newData = ui.array.uniq(data);
                            
                                            // 筛选掉已经加载过都模块, 但会导致第2次加载都时候,不执行脚本
                                            if (newData.length &gt; 1) {
                                                newData.forEach(function (item, index) {
                                                    var _mod = _modulesMap[item];
                                                    // 如果模块多层依赖相同文件,loaded 也是已经创建完成的, 如果不删掉, 最后的 i 不一定等于 newData.length-1; 
                                                    // isLoaded 是代表已经执行过的, loaded只是定义完成
                            
                                                    if (_mod &amp;&amp; (_mod[&quot;isLoaded&quot;] == true || _mod[&quot;loaded&quot;])) {
                                                        newData.splice(index, 1);
                                                    }
                                                })
                                            }
                            
                                            // 这里的循环里面执行创建脚本,得到的结果是不稳定,如果改成同步,又会太慢.
                                            newData.forEach(function (item, i) {
                            
                                                // 缓存的模块, 不能用做进行时的处理
                                                var modItem = _modulesMap[item];
                            
                                                // 创建样式,通过map定义的样式这里就可以处理
                                                if (_modulesMap[item] &amp;&amp; _modulesMap[item][&quot;style&quot;] &amp;&amp; _modulesMap[item] &amp;&amp; _modulesMap[item][&quot;style&quot;].length) {
                                                    createCssAll(_modulesMap[item][&quot;style&quot;]);
                                                }
                                                // ui.array.remove(_waitModules, item);
                                                // _waitModules.unshift(item);
                                                // 等待的模块不要重复
                                                if (!ui.array.compare(_waitModules, item)) {
                                                    // 等待的模块
                                                    _waitModules.unshift(item);
                                                }
                            
                                                // 如果已经加载,则无需创建
                                                if (modItem &amp;&amp; modItem[&quot;isLoaded&quot;]) {
                            
                                                    // 创建脚本后才有生命周期--创建依赖前
                                                    var canLoad = modItem &amp;&amp; modItem[&quot;beforeLoad&quot;] &amp;&amp; modItem[&quot;beforeLoad&quot;].call(modItem, modItem[&quot;depend&quot;]);
                                                    if (canLoad === false) {
                                                        return false;
                                                    }
                                                    // 最后一个执行
                                                    if (i == newData.length - 1) {
                                                        // console.log(modItem, item)
                                                        // if (timeout) {
                                                        //     clearTimeout(timeout);
                                                        // }
                                                        // 延迟执行, checkAllDefine 才会获取到正确都define状态, 因为多个依赖创建脚本需要时间, 或者把已经加载过都依赖,放在前面,这样后面创建都依赖就不会导致不执行.
                                                        // timeout = setTimeout(function() {
                                                        callback &amp;&amp; callback.apply(modItem);
                            
                                                        // 清空等待的模块
                                                        _waitModules = [];
                                                        // }, 300)
                                                    }
                            
                                                } else {
                            
                                                    // 如果有回调,但没有script,也无需创建
                                                    if (modItem &amp;&amp; modItem[&quot;loaded&quot;]) {
                                                        // 如果有依赖,继续创建依赖的脚本
                                                        checkDepends(item, i);
                            
                                                        // 创建脚本后才有生命周期-- 创建样式及模板前
                                                        var isFalse = _modulesMap[item][&quot;beforeCreate&quot;] &amp;&amp; _modulesMap[item][&quot;beforeCreate&quot;].call(_modulesMap[item]);
                                                        if (isFalse === false) {
                                                            return false;
                                                        }
                                                        // 创建脚本后才有生命周期--创建样式及模板后
                                                        _modulesMap[item][&quot;created&quot;] &amp;&amp; _modulesMap[item][&quot;created&quot;].call(_modulesMap[item]);
                            
                                                    } else {
                            
                                                        // 创建脚本
                                                        createScript(item, function () {
                                                            var modSrcItem = _modulesMap[item];
                                                            // 创建脚本后才有生命周期-- 创建样式及模板前
                                                            var isFalse = modSrcItem &amp;&amp; modSrcItem[&quot;beforeCreate&quot;] &amp;&amp; modSrcItem[&quot;beforeCreate&quot;].call(_modulesMap[item]);
                                                            if (isFalse === false) {
                                                                return false;
                                                            }
                                                            // 通过require 依赖里面加载的样式需要在这里处理
                                                            if (modSrcItem &amp;&amp; modSrcItem[&quot;style&quot;] &amp;&amp; modSrcItem[&quot;style&quot;].length) {
                                                                createCssAll(modSrcItem[&quot;style&quot;]);
                                                            }
                                                            // 创建脚本后才有生命周期--创建样式及模板后
                                                            modSrcItem &amp;&amp; modSrcItem[&quot;created&quot;] &amp;&amp; modSrcItem[&quot;created&quot;].call(_modulesMap[item]);
                            
                                                            // 执行define以后,如果有依赖,继续创建依赖的脚本
                                                            checkDepends(item, i);
                            
                                                        }, function () {
                            
                                                            // 最后一个执行
                                                            if (i == newData.length - 1) {
                                                                callback &amp;&amp; callback.apply(null);
                                                                // 清空等待的模块
                                                                _waitModules = [];
                                                            }
                                                        })
                                                    }
                            
                                                }
                            
                                                // 检查是否有依赖,如果有继续执行
                                                function checkDepends(item, i) {
                                                    var mod = _modulesMap[item];
                                                    // 定义要在依赖创建前确定,这样_waitmodule才能得到正确的值.z
                                                    mod &amp;&amp; (mod[&quot;isDefined&quot;] = true);
                            
                                                    // 同时加载同一个脚本的时候,由于是异步的,id跟对应的参数只获取到最后一个版本的信息.这里需要重新赋值.
                                                    mod[&quot;id&quot;] = modItem ? modItem[&quot;id&quot;] : &quot;&quot;;
                                                    mod[&quot;props&quot;] = modItem ? modItem[&quot;props&quot;] : {};
                            
                                                    // 创建脚本后才有生命周期--创建依赖前
                                                    var canLoad = mod &amp;&amp; mod[&quot;beforeLoad&quot;] &amp;&amp; mod[&quot;beforeLoad&quot;].call(mod, mod[&quot;depend&quot;]);
                            
                                                    if (canLoad === false) {
                                                        return false;
                                                    }
                            
                                                    if (mod &amp;&amp; mod[&quot;depend&quot;] &amp;&amp; mod[&quot;depend&quot;].length) {
                                                        param.log &amp;&amp; console.warn(mod[&quot;moduleName&quot;] + &quot; depend:&quot;)
                                                        param.log &amp;&amp; console.log(mod[&quot;depend&quot;])
                                                        createDepends(mod[&quot;depend&quot;], callback);
                                                        return;
                                                    }
                            
                                                    // 最后一个执行 有时候会先为true 再为 false, 顺序不一致
                                                    if (i == newData.length - 1) {
                            
                                                        callback &amp;&amp; callback.apply(mod);
                                                        // mod &amp;&amp; mod[&quot;show&quot;] &amp;&amp; mod[&quot;show&quot;].apply(mod);
                                                    }
                                                }
                                            })
                            
                            
                            
                                        }
                                        return new Promise(function (resolve, reject) {
                            
                                            // 依次创建依赖:异步
                                            createDepends(moduleName, function () {
                                                // console.log(checkAllDefined(_waitModules), _waitModules)
                                                // 执行define定义
                                                // 创建完依赖以后 checkAllDefined 在最后一次执行
                            
                                                if (checkAllDefined(_waitModules)) {
                                                    var deps = [];
                            
                                                    moduleName.forEach(function (item, i) {
                            
                                                        // 依次执行依赖
                                                        let mods = execute(item, reload);
                            
                                                        // 把最后的依赖导出给回调使用
                                                        deps.push(_modulesMap[item] &amp;&amp; _modulesMap[item][&quot;exports&quot;]);
                                                        if (i === (moduleName.length - 1)) {
                            
                                                            moduleCallback &amp;&amp; moduleCallback.apply(module, deps || []);
                                                            resolve.apply(module, deps || []);
                                                        }
                                                    })
                                                }
                                            });
                            
                                        })
                            
                                    }
                            
                                    // 执行模块实例化,同步
                                    function execute(_mod, reload) {
                            
                                        _modulesMap = _map[&quot;modules&quot;];
                            
                                        var _module = typeof (_mod) === &quot;string&quot; ? _modulesMap[_mod] || {} : _mod,
                                            depend = _module[&quot;depend&quot;] || [],
                                            // 输出的单个实例
                                            exportModule = null,
                                            // 输出的依赖实例
                                            exportDep = [];
                            
                                        // 清空之前的依赖
                                        _module[&quot;dependExports&quot;] = [];
                            
                                        try {
                            
                                            if (depend.length) {
                                                for (var i = 0; i &lt; depend.length; i++) {
                                                    var item = depend[i];
                                                    // 获取依赖的模块名
                                                    var depItem = _modulesMap[item];
                            
                                                    if (depItem[&quot;isLoaded&quot;]) {
                                                        // 继续实例化依赖的模块,并抛出给自身的export属性
                                                        exportDep[i] = depItem[&quot;exports&quot;];
                                                    } else {
                                                        // 继续实例化依赖的模块,并抛出给自身的export属性
                                                        exportDep[i] = execute(depItem) || depItem[&quot;exports&quot;];
                                                    }
                            
                                                    // 导出对象
                                                    depItem[&quot;exports&quot;] = exportDep[i];
                                                    _module[&quot;dependExports&quot;].push(exportDep[i]);
                                                    // 确认当前模块已经加载完毕
                                                    depItem[&quot;isLoaded&quot;] = true;
                                                }
                                            }
                            
                                            // 通过isCommponent 状态,来判断是否需要多次执行, 正常 require 没有回调只执行一次.而loader.load加载相同组件是需要多次执行的
                                            // console.log(_module)
                                            if ((_module[&quot;isLoaded&quot;] &amp;&amp; !_module[&quot;isComponent&quot;]) || _module[&quot;isLoaded&quot;] &amp;&amp; !reload) {
                                                exportModule = _module[&quot;exports&quot;];
                            
                                            } else {
                                                // 支持return,也支持module.exports
                                                // 加入组件以后,存在同时加载相同组件,不同数据的情况,这个时候,如果通过isLoaded是被修改,但是没有执行的,还不确定有什么其它问题.
                                                exportModule = _module[&quot;loaded&quot;] &amp;&amp; _module[&quot;loaded&quot;].apply(_module, exportDep);
                                            }
                            
                                            // 这里有个问题，return bui.store 的实例的时候，第2次加载过的，无法直接访问实例的拦截，需要通过 bs.$methods.xxx bs.$data.xxx 之类的去访问执行
                                            // 已经执行过一次
                                            _module[&quot;exports&quot;] = exportModule || _modulesMap[_module[&quot;moduleName&quot;]] &amp;&amp; _modulesMap[_module[&quot;moduleName&quot;]][&quot;exports&quot;];
                            
                                            _module[&quot;isLoaded&quot;] = true;
                            
                                            // 触发模块完成
                                            trigger(_module[&quot;moduleName&quot;], _module, _module[&quot;exports&quot;])
                            
                                            param.log &amp;&amp; console.log(&quot;execute &quot; + _module[&quot;moduleName&quot;])
                            
                                        } catch (e) {
                                            ui.showLog(e, &quot;bui.loader.execute&quot;)
                                        }
                            
                                        return exportModule;
                                    }
                            
                                    /*
                                     * &lt;p&gt;检测模块是否已经动态创建完成,动态创建完成以后才会执行define方法&lt;/p&gt;
                                     *  @method checkDefine
                                     *  @param {object} [option]
                                     *  @param {array} [option.modules]  模块的依赖, 如果不传,则检测所有加载的模块, 对应模块的isDefined属性 
                                     *  @return {boolean}  [ 全部创建完成以后会返回 true ]
                                     *  @example
                             
                                        例子1: 检测所有模块是否都创建完毕
                             
                                        var bool = loader.checkDefine();
                                        console.log(bool)
                             
                                     *
                                     */
                                    function checkAllDefined(depend) {
                                        var status = true,
                                            depends = depend || [];
                                        _modulesMap = _map[&quot;modules&quot;];
                            
                                        if (depends.length) {
                                            let i = 0;
                                            for (; i &lt; depends.length; i++) {
                                                let item = depends[i];
                                                var _mod = _modulesMap[item];
                                                // 除了创建脚本以后, 还要模块有loaded函数
                                                if (_mod &amp;&amp; _mod[&quot;isDefined&quot;] === false) {
                                                    status = false;
                                                    // console.count();
                                                    param.log &amp;&amp; console.warn(&quot;check defined false:&quot; + _mod[&quot;moduleName&quot;]);
                                                    param.log &amp;&amp; console.warn(&quot;wait modules:&quot;);
                                                    param.log &amp;&amp; console.warn(depends);
                            
                                                    return status;
                                                }
                                            }
                            
                                        } else {
                            
                                            for (var key in _modulesMap) {
                                                if (_modulesMap[key] &amp;&amp; _modulesMap[key][&quot;isDefined&quot;] === false) {
                                                    status = false;
                                                    param.log &amp;&amp; console.warn(&quot;check defined false:&quot; + _mod[&quot;moduleName&quot;]);
                                                    return status;
                                                }
                                            }
                                        }
                                        return status;
                                    }
                            
                            
                                    /**
                                     * &lt;p&gt;检测模块名的加载状态,加载完成,该模块会有一个export对象,就是callback的回调&lt;/p&gt;
                                     *  @method checkLoad
                                     *  @param {object} [option]
                                     *  @param {array} [option.modules]  模块名称, 如果不传,则检测所有加载的模块 
                                     *  @return {boolean}  [ 全部创建完成以后会返回 true ]
                                     *  @example
                             
                                        例子1: 检测所有模块是否都加载完毕
                             
                                        var bool = loader.checkLoad([&quot;main&quot;]);
                                        console.log(bool)
                             
                                     *
                                     */
                                    function checkAllLoaded(depend) {
                            
                            
                                        var status = true,
                                            depends = [];
                                        _modulesMap = _map[&quot;modules&quot;];
                            
                                        if (typeof depend === &quot;string&quot;) {
                                            var isSplit = depend.indexOf(&quot;,&quot;) &gt; -1 ? true : false;
                            
                                            if (isSplit) {
                                                depends = depend.split(&quot;,&quot;);
                                            } else {
                                                depends.push(depend);
                                            }
                            
                            
                                        } else if (depend &amp;&amp; ui.typeof(depend) === &quot;array&quot;) {
                                            depends = depend || [];
                                        }
                            
                                        if (depends.length) {
                                            depends.forEach(function (item, i) {
                                                // if (!(item in _modulesMap)) {
                                                if (!(_modulesMap.hasOwnProperty(item))) {
                                                    status = false;
                                                }
                                                if (_modulesMap[item] &amp;&amp; _modulesMap[item][&quot;isLoaded&quot;] === false) {
                                                    status = false;
                                                }
                                            })
                                        } else {
                                            for (var key in _modulesMap) {
                                                if (_modulesMap[key] &amp;&amp; _modulesMap[key][&quot;isLoaded&quot;] === false) {
                                                    status = false;
                                                }
                                            }
                                        }
                            
                                        return status;
                                    }
                            
                                    /**
                                     * &lt;p&gt;1.6.0 新增, 页面加载, require加载脚本, load 加载模板跟执行脚本, 每次调用都执行一次&lt;/p&gt;
                                     *  @method load
                                     *  @since 1.6.0
                                     *  @param {object} [option]
                                     *  @param {string|object} option.id 模板需要加载到哪个容器下 
                                     *  @param {string} option.url  一般是页面的路径,或者模块名 
                                     *  @param {object} option.param 传参给组件, 可以这样传 { id:&quot;111&quot;} 
                                     *  @param {object} [option.command]  1.7.3 新增 默认 html | append | prepend
                                     *  @param {string} [option.script]  可选,如果模板跟模块如果是分离的,则需要指明模块的路径,建议一般使用同名规范. 
                                     *  @param {function} [option.beforeLoad]  加载前的回调, return false 则不执行 
                                     *  @param {function} [option.loaded]  加载成功以后的回调 
                                     *  @example
                             
                                        例子1: 
                                        html:
                                        &lt;div id=&quot;tab1&quot;&gt;&lt;/div&gt;
                             
                                        js: 把模板加载进来并执行模块脚本
                                        loader.load({
                                            id:&quot;#tab1&quot;,
                                            url:&quot;pages/main/home.html&quot;
                                        });
                             
                                     *
                                     */
                                    function load(opts) {
                            
                                        return new Promise(function (resolve, reject) {
                            
                                            var opt = $.extend(true, {
                                                id: &quot;&quot;,
                                                cacheHtml: false, // 不再渲染模板,主要用于配合编译
                                                cache: false,
                                                url: &quot;&quot;,
                                                script: &quot;&quot;,
                                                param: null,
                                                command: &quot;html&quot;,
                                                template: null,
                                                beforeLoad: null,
                                                reload: true,
                                                loaded: null,
                                            }, ui.config.loader.load, opts);
                            
                                            if (opt.id == &quot;&quot;) {
                                                ui.showLog(&quot;id不能为空&quot;)
                                                return;
                                            }
                            
                                            if (opt.url == &quot;&quot;) {
                                                ui.showLog(&quot;url不能为空&quot;)
                                                return;
                                            }
                            
                                            var canLoad = typeof opt.beforeLoad === &quot;function&quot; ? opt.beforeLoad.call(module) : opt.beforeLoad;
                            
                                            // 不允许跳转
                                            if (canLoad === false) {
                                                return this;
                                            }
                            
                                            // 解析url
                                            var urlModule = parsingUrl(opt.url);
                            
                                            // 可以自定义脚本路径
                                            if (opt.script) {
                                                var index = opt.script.indexOf(&quot;.js&quot;);
                                                urlModule.module = opt.script.substr(0, index);
                                            }
                            
                                            var $id = null;
                            
                                            if (typeof opt.id === &quot;object&quot; || (typeof opt.id === &quot;string&quot; &amp;&amp; (opt.id.indexOf(&quot;#&quot;) &gt; -1 || opt.id.indexOf(&quot;.&quot;) &gt; -1))) {
                                                $id = ui.$(opt.id);
                                            } else if (typeof opt.id === &quot;string&quot;) {
                                                $id = ui.$(&quot;#&quot; + opt.id);
                                            }
                            
                                            // 动态设置id
                                            for (let i = 0; i &lt; $id.length; i++) {
                                                let item = $id[i];
                                                if (!item.id) {
                                                    item.id = ui.guid();
                                                }
                                            }
                            
                                            // 修改模块局部加载的
                                            // var id = typeof opt.id == &quot;string&quot; ? (opt.id.indexOf(&quot;#&quot;) &gt; -1 || opt.id.indexOf(&quot;.&quot;) &gt; -1 ? opt.id.substr(1) : opt.id) : opt.id;
                            
                                            opt.id = $id[0].id;
                            
                                            opt.name = urlModule.module;
                                            opt.url = urlModule.url;
                                            // 把参数的false字符串改成布尔值
                                            opt.param = ui.unit.changeParamBoolean(opt.param);
                            
                                            // 给模块增加id
                                            map({
                                                id: opt.id,
                                                moduleName: urlModule.module,
                                                props: opt.param,
                                            })
                                            var lastHistory = ui.history.getLast();
                                            // 修改最后一个历史记录的页面加载,用于模块内部的参数获取  bui.history.getParams(&quot;part&quot;) 可以获取
                                            lastHistory[&quot;currentComponent&quot;] = opt.id;
                            
                                            ui.history.setComponent({
                                                id: opt.id,
                                                name: opt.name,
                                                url: opt.url,
                                                param: opt.param || null
                                            })
                            
                                            // opt.moduleName = urlModule.module;
                                            // 获取模块
                                            var _module = map()[&quot;modules&quot;][opt.name];
                            
                                            // 如果模板通过定义返回直接处理渲染
                                            if (_module &amp;&amp; typeof _module[&quot;template&quot;] === &quot;function&quot;) {
                            
                                                var tplhtml = _module[&quot;template&quot;].call(_module) || &quot;&quot;;
                                                // 处理成局部样式
                                                tplhtml = ui.unit.handleContent(tplhtml);
                                                tplhtml = tplhtml.replace(/#module\.id/g, &quot;#&quot; + opt.id);
                                                tplhtml = tplhtml.replace(/#module\.path\//g, _module.path);
                            
                                                // 创建成功以后执行回调
                                                !opt.cacheHtml &amp;&amp; ui.obj(opt.id)[opt.command](tplhtml);
                                                loaded(opt);
                                                return this;
                                            }
                            
                                            // 不用渲染html则直接执行模块;
                                            if (opt.cacheHtml) {
                                                loaded(opt);
                                                return this;
                                            }
                                            // 如果是方法,直接执行返回
                                            if (typeof urlModule.url === &quot;function&quot;) {
                                                var res = urlModule.url(opt) || &quot;&quot;;
                                                // 处理局部样式
                                                res = ui.unit.handleContent(res);
                            
                                                res = res.replace(/#module\.id/g, &quot;#&quot; + opt.id);
                            
                                                var path = urlModule.url.substr(0, urlModule.url.lastIndexOf(&quot;/&quot;) + 1);
                                                res = res.replace(/#module\.path\//g, path);
                                                // 创建成功以后执行回调
                                                !opt.cacheHtml &amp;&amp; ui.obj(opt.id)[opt.command](res);
                                                // 执行模块;
                                                loaded(opt);
                                                return this;
                                            }
                            
                                            // 动态加载模板
                                            importsource(urlModule.url, function (res) {
                            
                                                // 处理成局部样式
                                                res = ui.unit.handleContent(res);
                                                res = res.replace(/#module\.id/g, &quot;#&quot; + opt.id);
                            
                                                var path = urlModule.url.substr(0, urlModule.url.lastIndexOf(&quot;/&quot;) + 1);
                                                res = res.replace(/#module\.path\//g, path);
                                                // 创建成功以后执行回调
                                                !opt.cacheHtml &amp;&amp; ui.obj(opt.id)[opt.command](res);
                            
                                                // 执行模块;
                                                loaded(opt);
                                            }, function (res) {
                                                opt.onFail &amp;&amp; opt.onFail.call(this, urlModule);
                            
                                                reject(urlModule)
                                            });
                            
                            
                                            // load模块以后每次都执行模块的loaded方法.
                                            function loaded(opt) {
                                                var _mod = map()[&quot;modules&quot;][opt.name];
                                                var canLoad = _mod[&quot;beforeLoad&quot;] &amp;&amp; _mod[&quot;beforeLoad&quot;].call(_mod, _mod[&quot;depend&quot;]);
                                                if (canLoad === false) {
                                                    return false;
                                                }
                            
                                                setModule(opt.name, {
                                                    id: opt.id,
                                                    props: opt.param || null,
                                                    isComponent: true,
                                                    // 模块选择器
                                                    &quot;$&quot;: function (el) {
                                                        return $(&quot;#&quot; + opt.id).find(el);
                                                    }
                                                });
                            
                                                // 在 cache为false的情况下, 每次执行loaded
                                                if (_mod[&quot;isLoaded&quot;] &amp;&amp; typeof _mod[&quot;loaded&quot;] === &quot;function&quot; &amp;&amp; !opt.cache) {
                            
                                                    _mod[&quot;id&quot;] = opt.id;
                                                    _mod[&quot;exports&quot;] = _mod[&quot;loaded&quot;] &amp;&amp; _mod[&quot;loaded&quot;].call(_mod, _mod[&quot;exports&quot;]) || _mod[&quot;exports&quot;];
                            
                                                    // 修改历史记录传参
                                                    var comparam = {
                                                        id: opt.id,
                                                        name: opt.name,
                                                        url: opt.url,
                                                        param: opt.param || null,
                                                        exports: _mod[&quot;exports&quot;] || {}
                                                    };
                                                    ui.history.setComponent(comparam);
                            
                                                    // 挂载公共数据
                                                    window.store &amp;&amp; window.store.$mount &amp;&amp; window.store.$mount(opt.id);
                            
                                                    opt.loaded &amp;&amp; opt.loaded.call(_mod, _mod[&quot;exports&quot;]);
                            
                                                    resolve(_mod[&quot;exports&quot;]);
                            
                                                    trigger(opt.id, comparam);
                                                    return module;
                                                }
                            
                                                var hasLoad = ui.checkLoad(opt.name);
                            
                                                // 执行脚本
                                                require(opt.name, function (mod) {
                                                    // 
                                                    var comparam = {
                                                        id: opt.id,
                                                        name: opt.name,
                                                        url: opt.url,
                                                        param: opt.param || null,
                                                        exports: mod || {}
                                                    };
                                                    ui.history.setComponent(comparam);
                            
                                                    // 挂载公共数据
                                                    window.store &amp;&amp; window.store.$mount &amp;&amp; window.store.$mount(opt.id);
                            
                                                    opt.loaded &amp;&amp; opt.loaded.call(_mod, mod);
                            
                                                    resolve(mod);
                            
                                                    trigger(opt.id, comparam);
                                                }, opt.reload)
                                            }
                                        })
                                    }
                            
                            
                                    /**
                                     * &lt;p&gt;1.6.0新增, 编译页面 component标签, 默认路由跳转的时候就会编译, 一般无需手动处理&lt;/p&gt;
                                     *  @method component
                                     *  @since 1.6.0
                                     *  @param {object} option 
                                     *  @param {string|object} option.id component 本身id 
                                     *  @param {function} [option.loaded]  每次编译完一个commponent执行 
                                     *  @param {object} [option.command]  1.7.3 新增 默认 html | append | prepend 可以通过 component 标签上的command属性指定 
                                     *  @param {function} [option.loaded]  每次编译完一个commponent执行 
                                     *  @param {function} [option.compiled]  编译完同级1个或多个commponent后执行,存在嵌套则会多次执行 
                                     *  @example
                             
                                        例子1: 
                             
                                        html: 
                                        &lt;component id=&quot;slide&quot; name=&quot;pages/components/slide/index&quot;&gt;&lt;/component&gt;
                             
                                        js: 
                                        loader.component({
                                            id:&quot;#slide&quot;
                                        });
                                     *
                                     */
                            
                                    function compileComponent(opts) {
                            
                                        var opt = $.extend(true, {
                                            id: &quot;&quot;,
                                            isSelf: true, // 选择器是否是自身
                                            deepComponent: param.deepComponent,
                                            cache: false,
                                            cacheHtml: false,
                                            command: &quot;html&quot;,
                                            delay: true, // 编译延迟加载,有delay属性的时候
                                            param: null,
                                            beforeLoad: null,
                                            loaded: null,
                                            compiled: null,
                                        }, ui.config.loader.component, opts);
                            
                                        var $datasource = null;
                                        if (opt.id === &quot;&quot;) {
                                            $datasource = ui.$(param.componentTag);
                                        } else if (opt.isSelf) {
                                            $datasource = ui.$(opt.id);
                                        } else {
                                            $datasource = ui.$(opt.id).find(param.componentTag);
                                        }
                            
                            
                                        var componentsModule = [], // 模块的模板已经是方法,则执行这里的.
                                            // 把component标签解析成一个对象, 以下三个为了同步处理;
                                            components = [],
                                            urls = [],
                                            srcs = [];
                                        var _modules = map()[&quot;modules&quot;];
                            
                                        for (let index = 0; index &lt; $datasource.length; index++) {
                                            let item = $datasource[index];
                                            var gid = ui.guid();
                                            // 没有名字则跳过
                                            if (!item.getAttribute(&quot;name&quot;)) {
                                                continue;
                                            }
                                            !item.id &amp;&amp; item.setAttribute(&quot;id&quot;, gid);
                            
                            
                                            // 获取所有属性
                                            var params = ui.unit.getAttributes(item);
                            
                                            var parentIdObj = params[&quot;parentId&quot;] = opt &amp;&amp; opt.id || ui.history.getLast()[&quot;id&quot;] || &quot;bui-page&quot;;
                                            var parentComp = ui.$(parentIdObj).parents(&quot;component&quot;);
                            
                                            var pid = opt.isSelf ? parentComp[0] &amp;&amp; parentComp[0].id : opt.id;
                            
                                            // 如果传的是jq对象, store 传jq对象
                                            if (ui.typeof(parentIdObj) === &quot;array&quot;) {
                                                // var className = parentIdObj[0].className;
                                                pid = opt.isSelf ? parentComp &amp;&amp; parentComp[0].id : parentIdObj[0].id //|| (className.indexOf(&quot; &quot;) &gt; -1 ? &quot;.&quot; + className.split(&quot; &quot;).join(&quot;.&quot;) : &quot;.&quot; + className); //.replaceAll(&quot; &quot;, &quot;.&quot;);
                                            } else if (typeof (params[&quot;parentId&quot;]) == &quot;object&quot; &amp;&amp; ui.typeof(params[&quot;parentId&quot;]).indexOf(&quot;element&quot;) &gt; -1) {
                                                // dom对象的判断
                                                // var domClassName = parentIdObj.className;
                                                pid = opt.isSelf ? parentComp[0] &amp;&amp; parentComp[0].id : parentIdObj.id // || (domClassName.indexOf(&quot; &quot;) &gt; -1 ? &quot;.&quot; + domClassName.split(&quot; &quot;).join(&quot;.&quot;) : &quot;.&quot; + domClassName); //.replaceAll(&quot; &quot;, &quot;.&quot;);
                                            }
                            
                            
                                            // 获取模块名
                                            var parentName = pid &amp;&amp; ui.history.getComponent(pid, &quot;name&quot;);
                            
                                            if (parentName) {
                                                params[&quot;parentId&quot;] = pid;
                                                params[&quot;parentName&quot;] = parentName;
                                            } else {
                                                var lastHis = ui.history.getLast();
                                                params[&quot;parentId&quot;] = lastHis[&quot;id&quot;];
                                                params[&quot;parentName&quot;] = lastHis[&quot;name&quot;];
                                            }
                            
                            
                                            var name = params[&quot;name&quot;] || item.getAttribute(&quot;name&quot;);
                                            name = name.replace(/\.html?.+/g, &quot;&quot;);
                            
                                            var command = params[&quot;command&quot;] || item.getAttribute(&quot;command&quot;) || opt.command;
                            
                                            // 是否已经渲染了结构,外部编译,是则告诉 loader.load 不再渲染html
                                            var cacheHtml = params[&quot;rendered&quot;] === &quot;true&quot; ? true : opt.cacheHtml;
                            
                                            if (!name) {
                                                continue;
                                            }
                                            // 延迟加载由属性跟参数两个因素, 默认有delay属性就不编译, delay方法会修改
                                            // delay属性 改成 false 代表已经使用 delay方法编译了, delay参数为false 代表执行编译
                                            if (params[&quot;delay&quot;] &amp;&amp; opt.delay) {
                                                continue;
                                            }
                                            var isObject = /\{.+\}$/g,
                                                isArray = /\[.+\]$/g,
                                                isFun = /\(function.+\)$/g;//function 需要以表达式形式书写 (function(){})()
                            
                                            for (let keyname in params) {
                                                let val = params[keyname];
                                                let type = typeof val;
                                                try {
                            
                                                    if (type === &quot;string&quot; &amp;&amp; (isObject.test(val) || isArray.test(val))) {
                                                        params[keyname] = new Function(&#x27;return &#x27; + val)();
                                                    }
                                                    // 修改function字符串为可执行方法，简单用字符串比较判断，如果使用isFun判断，会出现下面注释说的结果，很怪异。
                                                    type === &quot;string&quot; &amp;&amp; val.indexOf(&quot;(function&quot;) &gt; -1 &amp;&amp; (params[keyname] = new Function(&#x27;return &#x27; + val));
                                                    // 如果用isFun去这条语句不会成立，但又不能缺少，少了这条语句，会导致多个 callback 属性，有的是function,有的是string, 没找到原因,具体例子看 pages/components/headbar/demo。
                                                    // if( isArray.test(val) ){}
                            
                                                } catch (e) {
                                                    ui.showLog(e)
                                                }
                                            }
                            
                                            params = $.extend(true, {}, params, opt.param)
                            
                                            var _module = _modules[name];
                                            // 卡槽分发
                                            var slot = item.innerHTML;
                                            var tpl = _module &amp;&amp; typeof (_module[&quot;template&quot;]) === &quot;string&quot; ? _module[&quot;template&quot;] : name + &quot;.html&quot;;
                                            var src = _module &amp;&amp; _module[&quot;script&quot;] ? _module[&quot;script&quot;] : name + &quot;.js&quot;;
                                            tpl = tpl || name + &quot;.html&quot;;
                                            // 通过编译以后模块里面有模板的方法,而不是url
                                            if (_module &amp;&amp; typeof _module[&quot;template&quot;] === &quot;function&quot;) {
                                                componentsModule.push({
                                                    id: item.id,
                                                    el: item,
                                                    name: name,
                                                    command: opt.command,
                                                    cacheHtml: cacheHtml,
                                                    cache: opt.cache,
                                                    deepComponent: opt.deepComponent,
                                                    template: _module[&quot;template&quot;] || &quot;&quot;, // 模板通过方法返回
                                                    url: tpl,
                                                    srcript: src,
                                                    slot: slot,
                                                    param: params
                                                });
                                                // 跳过那些是方法的处理;
                                                continue;
                                            }
                            
                                            // 需要请求模板的处理
                                            urls.push(tpl);
                                            srcs.push(src);
                            
                                            components.push({
                                                id: item.id,
                                                el: item,
                                                name: name,
                                                cacheHtml: cacheHtml,
                                                cache: opt.cache,
                                                deepComponent: opt.deepComponent,
                                                url: tpl,
                                                srcript: src,
                                                slot: slot,
                                                param: params
                                            })
                                        };
                            
                                        // 通过定义template的加载
                                        if (componentsModule.length) {
                                            componentsModule.forEach(function (item, index) {
                                                // 加载执行
                                                load({
                                                    id: item[&quot;id&quot;],
                                                    url: item[&quot;url&quot;],
                                                    command: item[&quot;command&quot;] || &quot;html&quot;,
                                                    param: item[&quot;param&quot;] || null,
                                                    template: item.template,
                                                    cacheHtml: item[&quot;cacheHtml&quot;], // 默认要渲染html,除非外部编译了html,并且修改了属性为rendered=&quot;true&quot;
                                                    cache: item[&quot;cache&quot;], // 是否要每次执行脚本&quot;
                                                    beforeLoad: opt.beforeLoad
                                                });
                                            })
                                            // 全部加载以后,检测是否有子组件
                                            opt.data = componentsModule;
                                            checkingComponent(opt);
                                        }
                            
                                        // 如果没有url则不执行, 下面的方法合并以后数组一定会有
                                        if (!components.length) {
                                            // 每次执行
                                            opt.compiled &amp;&amp; opt.compiled(opt.data);
                                            trigger(&quot;componentcompiled&quot;, opt.data);
                                            return false;
                                        }
                                        // 同步请求所有html以后,再同步请求所有js
                                        var sources = ui.array.merge(urls, srcs);
                            
                                        importSync(sources, function (res) {
                                            (function createSource(i) {
                                                var _mod = components[i];
                            
                                                if (i == components.length) {
                                                    opt.data = components;
                                                    checkingComponent(opt);
                            
                                                    return this;
                                                }
                            
                                                if (!_mod) {
                                                    return this;
                                                }
                            
                                                _mod[&quot;template&quot;] = res[i];
                            
                                                // 赋值模板
                                                // _mod.el.innerHTML = _mod.template;
                                                // createSource(i + 1);
                            
                                                // 执行加载
                                                load({
                                                    id: _mod[&quot;id&quot;],
                                                    url: _mod[&quot;url&quot;],
                                                    param: _mod[&quot;param&quot;] || null,
                                                    cacheHtml: _mod[&quot;cacheHtml&quot;], // 默认要渲染html,除非外部编译了html,并且修改了属性为rendered=&quot;true&quot;
                                                    cache: _mod[&quot;cache&quot;], // 是否要每次执行脚本&quot;
                                                    beforeLoad: opt.beforeLoad,
                                                    loaded: function (mod) {
                            
                                                        createSource(i + 1);
                                                    },
                                                    onFail: function () {
                                                        createSource(i + 1);
                                                    }
                                                })
                            
                                            })(0);
                                        });
                            
                                        return this;
                                    }
                            
                                    /**
                                     * &lt;p&gt;1.6.0新增, 编译容器下的 所有component标签 一般无需使用, router(默认needComponent:true), store(默认needComponent:false), page(默认needComponent:false) &lt;/p&gt;
                                     *  @method components
                                     *  @since 1.6.0
                                     *  @param {string|object} id 哪个容器下的 
                                     *  @param {object} [param] 动态传参 1.6.2新增, 同名会覆盖属性上的参数
                                     *  @param {function} [beforeLoad]  每次模块加载前执行 
                                     *  @param {function} [loaded]  每次编译完一个commponent执行 
                                     *  @param {function} [compiled]  编译完同级1个或多个commponent后执行,存在嵌套则会多次执行 
                                     *  @example
                             
                                        例子1: 
                             
                                        html: 
                                        &lt;div id=&quot;coms&quot;&gt;
                                            &lt;component name=&quot;pages/components/slide/index&quot;&gt;&lt;/component&gt;
                                            &lt;component name=&quot;pages/components/list/index&quot;&gt;&lt;/component&gt;
                                        &lt;/div&gt;
                             
                                        js: 
                                        loader.components({
                                            id:&quot;#coms&quot;
                                        });
                             
                                     *
                                     */
                            
                                    function componentAll(opts) {
                            
                                        var opt = $.extend(true, {
                                            id: &quot;&quot;,
                                            isSelf: false, // 选择器是否是自身
                                            deepComponent: param.deepComponent,
                                            cache: false,
                                            cacheHtml: false,
                                            beforeLoad: null,
                                            loaded: null,
                                            compiled: null,
                                        }, opts);
                            
                                        compileComponent(opt);
                            
                                        return this;
                                    }
                            
                                    // 继续检测是否有子组件
                                    function checkingComponent(opt) {
                                        for (let index = 0; index &lt; opt.data.length; index++) {
                                            let item = opt.data[index];
                            
                                            // 继续查找子模板
                                            var ruleView = new RegExp(&#x60;&lt;${param.viewTag}.+name=&#x60;, &quot;gi&quot;);
                                            // 如果存在子模板,继续请求创建
                                            if (ruleView.test(item.template)) {
                                                viewAll({
                                                    id: item.id
                                                });
                                            }
                            
                                            // 继续查找子模块
                                            var rule = new RegExp(&#x60;&lt;${param.componentTag}.+name=&#x60;, &quot;gi&quot;);
                                            var ruleComponentRepeat = new RegExp(&#x60;&lt;${param.componentTag}.+name=&quot;${item.name}&quot;&#x60;, &quot;gi&quot;);
                                            if (ruleComponentRepeat.test(item.template)) {
                                                ui.showLog(&#x60;请检查代码, &lt;${param.componentTag} name=&quot;${item.name}&quot;&gt;&lt;/${param.componentTag}&gt;的模板里面存在循环嵌套&#x60;);
                                                continue;
                                            }
                                            // 如果存在子模板,继续请求创建
                                            if (opt.deepComponent &amp;&amp; rule.test(item.template)) {
                                                componentAll({
                                                    id: item.id
                                                });
                                            }
                                            // 每次执行
                                            opt.loaded &amp;&amp; opt.loaded(item);
                                            trigger(&quot;componentloaded&quot;, item);
                                        }
                            
                                        // 最后执行
                                        opt.compiled &amp;&amp; opt.compiled(opt.data);
                                        // var id = &quot;&quot;;
                                        // if (typeof opt.id === &quot;object&quot;) {
                                        //     id = opt.id.attr(&quot;id&quot;);
                                        // } else {
                                        //     id = opt.id.substr(1);
                                        // }
                            
                                        // 每编译完一个组件+子组件后就会触发
                                        // trigger(id + &quot;-compiled&quot;, opt.data);
                                        trigger(&quot;componentcompiled&quot;, opt.data);
                                    }
                            
                                    /**
                                     * &lt;p&gt;加载之前延迟加载的组件&lt;/p&gt;
                                     *  @method delay
                                     *  @since 1.6.0
                                     *  @param {string|object} id 哪个容器下的 
                                     *  @param {object} [param]  动态传参 1.6.2新增, 同名会覆盖属性上的参数 
                                     *  @param {boolean} [everytime]  1.6.2新增 是否每次都执行, 默认 false | true  
                                     *  @param {function} [loaded]  每次编译完一个commponent执行,存在嵌套则会多次执行 
                                     *  @param {function} [compiled]  编译完同级1个或多个commponent后执行,存在嵌套则会多次执行 
                                     *  @example
                             
                                        例子1: 
                             
                                        html: 
                                        &lt;component id=&quot;delayCom&quot; name=&quot;pages/components/slide/index&quot; delay=&quot;true&quot;&gt;&lt;/component&gt;
                                        
                                        js: 
                                        loader.delay({
                                            id:&quot;#delayCom&quot;,
                                        });
                             
                                     *
                                     */
                            
                                    function delay(opts) {
                            
                                        var opt = $.extend(true, {
                                            id: &quot;&quot;,
                                            deepView: param.deepView,
                                            deepComponent: param.deepComponent,
                                            delay: false,
                                            everytime: false,
                                            param: null,
                                            beforeLoad: null,
                                            loaded: null,
                                            compiled: null,
                                        }, opts);
                            
                            
                                        if (!opt.id) {
                                            ui.showLog(&quot;id 不能为空&quot;);
                                            return;
                                        }
                                        var $id = ui.$(opt.id);
                            
                                        for (let i = 0; i &lt; $id.length; i++) {
                                            let item = $id[i];
                                            let hasDelay = item &amp;&amp; item.getAttribute(&quot;delay&quot;);
                                            let tagName = item &amp;&amp; item.tagName.toLowerCase();
                            
                                            // 跳过编译 
                                            if (hasDelay !== &quot;true&quot; &amp;&amp; !opt.everytime) {
                                                continue;
                                            }
                            
                                            // 判断是否是自身的加载
                            
                                            if (hasDelay === &quot;true&quot; &amp;&amp; tagName === param.componentTag || opt.everytime) {
                            
                                                opt.isSelf = true;
                                                opt.id = item;
                            
                                                // delay 改成 false 代表已经使用 delay方法编译了, delay参数为false 代表执行编译
                                                opt.everytime ? item.removeAttribute(&quot;delay&quot;) : item.setAttribute(&quot;delay&quot;, &quot;false&quot;);
                            
                                                compileComponent(opt);
                                            } else if (hasDelay === &quot;true&quot; &amp;&amp; tagName === param.viewTag || opt.everytime) {
                                                opt.isSelf = true;
                                                opt.id = item;
                                                // 移除属性才能编译
                                                item.removeAttribute(&quot;delay&quot;);
                            
                                                compileView(opt);
                                            } else {
                                                opt.isSelf = false;
                                                tagName = $(item).find(&#x27;[delay=&quot;true&quot;]&#x27;)[0] &amp;&amp; $(item).find(&#x27;[delay=&quot;true&quot;]&#x27;)[0].tagName.toLowerCase();
                                                // 移除属性才能编译
                                                $(item).find(&#x27;[delay=&quot;true&quot;]&#x27;).removeAttr(&quot;delay&quot;);
                                                tagName === param.componentTag &amp;&amp; compileComponent(opt);
                                                tagName === param.viewTag &amp;&amp; compileView(opt);
                                            }
                            
                                        }
                            
                                        return this;
                                    }
                            
                                    /**
                                     * &lt;p&gt;同步加载&lt;/p&gt;
                                     *  @method syncLoad
                                     *  @since 1.6.7
                                     *  @param {object} option 
                                     *  @param {string|object} option.id 哪个容器下的,通过id，返回一个对象，通过样式名，返回一个数组，看例子
                                     *  @param {string} [option.url]  可选，如果component标签属性有name值，可以不传
                                     *  @param {object} [option.param]  传参给组件
                                     *  @param {object} [option.command] 1.7.3 新增 默认 html | append | prepend 
                                     *  @param {function} [option.beforeLoad]  每次编译commponent前执行， return false 则不执行 
                                     *  @param {function} [option.loaded]  每次编译commponent后执行
                                     *  @example
                             
                                        例子1: 
                             
                                        html: 
                                        &lt;component id=&quot;delayCom&quot; name=&quot;pages/components/slide/index&quot; delay=&quot;true&quot;&gt;&lt;/component&gt;
                             
                                        &lt;component id=&quot;delayCom1&quot; class=&quot;delay&quot; name=&quot;pages/components/slide/index&quot; delay=&quot;true&quot;&gt;&lt;/component&gt;
                                        &lt;component id=&quot;delayCom2&quot; class=&quot;delay&quot; name=&quot;pages/components/slide/index&quot; delay=&quot;true&quot;&gt;&lt;/component&gt;
                                        
                                        js: 
                                        // 同步编译组件，这样在传
                                        const loadall = async function(){
                                            
                                            // 通过id编译1个，comp为返回的实例
                                            const comp = await loader.syncLoad({
                                                id:&quot;#delayCom&quot;,
                                                param: {
                                                    data: []
                                                }   // 传参给组件
                                            })
                                            console.log(comp) // delayCom 的实例
                             
                                            // 通过样式名编译多个
                                            const [comp1,comp2] = await loader.syncLoad({
                                                id:&quot;.delay&quot;,
                                            })
                             
                                            console.log(comp1)// delayCom1 的实例
                                            console.log(comp2)// delayCom2 的实例
                                        }
                             
                                        loadall();
                                     *
                                     */
                            
                                    function syncLoad(opts) {
                            
                                        return new Promise((resolve, reject) =&gt; {
                            
                                            (async function () {
                                                var opt = $.extend(true, {
                                                    id: &quot;&quot;,
                                                    url: &quot;&quot;,
                                                    param: null,
                                                    command: &quot;html&quot;,
                                                    beforeLoad: null,
                                                    loaded: null,
                                                }, opts);
                            
                                                if (opt.id == &quot;&quot;) {
                                                    ui.showLog(&quot;id不能为空&quot;);
                                                    return;
                                                }
                            
                                                if (opt.url == &quot;&quot;) {
                                                    ui.showLog(&quot;url不能为空&quot;)
                                                    return;
                                                }
                            
                                                var $id = opt.id.indexOf(&quot;#&quot;) &gt; -1 || opt.id.indexOf(&quot;.&quot;) &gt; -1 ? ui.$(opt.id) : ui.$(&quot;#&quot; + opt.id);
                                                let distances = [];
                                                for (let i = 0; i &lt; $id.length; i++) {
                                                    let item = $id[i];
                            
                                                    let param = ui.unit.getAttributes(item);
                            
                                                    var parentComp = ui.$(item).parents(&quot;component&quot;);
                                                    var pid = parentComp[0] &amp;&amp; parentComp[0].id || &quot;&quot;;
                                                    // 获取模块名
                                                    var parentName = pid &amp;&amp; ui.history.getComponent(pid, &quot;name&quot;);
                                                    // 获取父模块id及模块名
                                                    if (parentName) {
                                                        param[&quot;parentId&quot;] = pid;
                                                        param[&quot;parentName&quot;] = parentName;
                                                    } else {
                                                        var lastHis = ui.history.getLast();
                                                        param[&quot;parentId&quot;] = lastHis[&quot;id&quot;];
                                                        param[&quot;parentName&quot;] = lastHis[&quot;name&quot;];
                                                    }
                            
                                                    // console.log(param)
                                                    opt.url = opt.url || param.url || param.name + &quot;.html&quot;;
                            
                                                    opt.param = $.extend(true, {}, param, opt.param);
                            
                                                    // 生成新的gid
                                                    if (!param.id) {
                                                        item.id = param.id = ui.guid();
                                                    }
                                                    opt.id = param.id;
                                                    // console.log(param)
                                                    distances[i] = await load(opt);
                                                }
                                                // id输出对象，样式名输出数组
                                                opts.id.indexOf(&quot;.&quot;) &gt; -1 ? resolve(distances) : resolve(distances[0]);
                                            })();
                            
                                        })
                                    }
                            
                            
                                    // 继续检测是否有子view
                                    function checkingView(opt) {
                                        for (let index = 0; index &lt; opt.data.length; index++) {
                                            let item = opt.data[index];
                            
                                            if (!item.cacheHtml) {
                            
                                                item.el.innerHTML = item.template; // &amp;&amp; item.template.replace(/\&lt;slot\&gt;\&lt;\/slot\&gt;/gi, item.slot);
                            
                                                // 继续查找子模块
                                                var rule = new RegExp(&#x60;&lt;${param.componentTag}.+name&#x60;, &quot;gi&quot;);
                                                var ruleRepeat = new RegExp(&#x60;&lt;${param.componentTag}.+name=&quot;${item.name}&quot;&#x60;, &quot;gi&quot;);
                            
                                                // 如果存在子模板,继续请求创建
                                                if (rule.test(item.template)) {
                                                    componentAll({
                                                        id: item.id
                                                    });
                                                }
                                                // // 继续查找子模板
                                                var ruleView = new RegExp(&#x60;&lt;${param.viewTag}.+name=&quot;${item.name}&quot;&#x60;, &quot;gi&quot;);
                                                var ruleViewRepeat = new RegExp(&#x60;&lt;${param.viewTag}.+name=&quot;${item.name}&quot;&#x60;, &quot;gi&quot;);
                                                if (ruleViewRepeat.test(item.template)) {
                                                    ui.showLog(&#x60;请检查代码, &lt;${param.viewTag} name=&quot;${item.name}&quot;&gt;&lt;/${param.viewTag}&gt;的模板里面存在循环嵌套&#x60;);
                                                    continue;
                                                }
                            
                                                // 如果存在子模板,继续请求创建
                                                if (opt.deepView &amp;&amp; ruleView.test(item.template) &amp;&amp; !ruleViewRepeat.test(item.template)) {
                                                    // 
                                                    viewAll({
                                                        id: $(item.el)
                                                    });
                                                }
                                            }
                            
                                            // 解析常用命令, 传el 给bui.store 解析
                                            // 每次执行
                                            opt.loaded &amp;&amp; opt.loaded(item);
                                            trigger(&quot;viewloaded&quot;, item);
                                        }
                            
                                        // 最后执行
                                        opt.compiled &amp;&amp; opt.compiled(opt.data);
                            
                                        trigger(&quot;viewcompiled&quot;, opt.data);
                                    }
                            
                                    /**
                                     * &lt;p&gt;1.6.0新增, 编译容器下的 多个view标签, 一般无需使用, router(默认needView:false), store(默认needView:true), page(默认needView:false) &lt;/p&gt;
                                     *  @method views
                                     *  @since 1.6.0
                                     *  @param {string|object} id [ 哪个容器下的 ]
                                     *  @param {function} [loaded]  每次编译完一个commponent执行 
                                     *  @param {function} [compiled]  编译完同级1个或多个commponent后执行,存在嵌套则会多次执行 
                                     *  @example
                             
                                        例子: 
                                        html: 
                                        &lt;div id=&quot;views&quot;&gt; 
                                            &lt;view name=&quot;pages/views/slide/index&quot;&gt;&lt;/view&gt;
                                            &lt;view name=&quot;pages/views/list/index&quot;&gt;&lt;/view&gt;
                                        &lt;/div&gt;
                             
                                        js: 
                                        loader.views({
                                            id:&quot;#views&quot;
                                        });
                             
                                     *
                                     */
                            
                                    function viewAll(opts) {
                            
                                        var opt = $.extend(true, {
                                            id: &quot;&quot;,
                                            isSelf: false,
                                            deepView: param.deepView,
                                            loaded: null,
                                            compiled: null,
                                        }, opts);
                            
                                        compileView(opt);
                            
                                        return this;
                                    }
                                    /**
                                     * &lt;p&gt;1.6.0新增, 编译页面 view标签, 把模板加载进来, 默认只编译一次,一般不需要调用, view标签主要配合 bui.store 的mixins而来, 自带解析view标签&lt;/p&gt;
                                     *  @method view
                                     *  @since 1.6.0
                                     *  @param {string|object} id [ view标签本身 ]
                                     *  @param {function} [loaded]  每次编译完commponent执行 
                                     *  @param {function} [compiled]  编译完同级commponent执行,存在嵌套则会多次执行 
                                     *  @example
                             
                                        例子: 
                                        html: 
                                        &lt;view id=&quot;views&quot; name=&quot;pages/views/slide/index&quot;&gt;&lt;/view&gt;
                             
                                        js: 
                                        loader.view({
                                            id:&quot;#views&quot;
                                        });
                             
                                     *
                                     */
                                    function compileView(opts) {
                            
                                        var opt = $.extend(true, {
                                            id: &quot;&quot;,
                                            isSelf: true,
                                            deepView: param.deepView,
                                            loaded: null,
                                            compiled: null,
                                        }, opts);
                            
                                        var $datasource = null;
                                        if (opt.id === &quot;&quot;) {
                                            $datasource = ui.$(param.viewTag);
                                        } else if (opt.isSelf) {
                                            // 如果是view标签本身
                                            $datasource = ui.$(opt.id);
                                        } else {
                                            $datasource = ui.$(opt.id).find(param.viewTag);
                                        }
                            
                            
                                        var components = [], // 存储模板url的对象
                                            componentsModule = []; // 存储有模板template方法的模块,说明已经加载好的,不需要请求
                                        var _modules = loader.map()[&quot;modules&quot;];
                            
                                        for (let index = 0; index &lt; $datasource.length; index++) {
                                            let item = $datasource[index];
                                            var name = item.getAttribute(&quot;name&quot;);
                                            var delay = item.getAttribute(&quot;delay&quot;);
                                            var _moduelsItem = _modules[name];
                                            // 是否已经渲染了结构,外部编译,是则告诉 loader.load 不再渲染html
                                            var cacheHtml = item.getAttribute(&quot;rendered&quot;) === &quot;true&quot; ? true : false;
                                            var gid = ui.guid();
                            
                                            if (!item.getAttribute(&quot;name&quot;)) {
                                                continue;
                                            }
                            
                                            !item.id &amp;&amp; item.setAttribute(&quot;id&quot;, gid);
                            
                                            // map({
                                            //     id: item.id,
                                            //     moduleName: name
                                            // })
                                            if (delay === &quot;true&quot;) {
                                                continue;
                                            }
                                            // 卡槽分发
                                            var slot = item.innerHTML;
                                            var tpl = _moduelsItem &amp;&amp; _moduelsItem[&quot;template&quot;] ? _moduelsItem[&quot;template&quot;] : name + &quot;.html&quot;;
                                            // 通过编译以后模块里面会有template方法,而不是url
                                            if (_moduelsItem &amp;&amp; typeof _moduelsItem[&quot;template&quot;] === &quot;function&quot;) {
                            
                                                componentsModule.push({
                                                    id: item.id,
                                                    el: item,
                                                    name: name,
                                                    cacheHtml: cacheHtml,
                                                    template: _moduelsItem[&quot;template&quot;].call(_moduelsItem) || &quot;&quot;,
                                                    url: tpl,
                                                    slot: slot
                                                })
                                                continue;
                                            }
                            
                                            components.push({
                                                id: item.id,
                                                el: item,
                                                name: name,
                                                cacheHtml: cacheHtml,
                                                url: tpl,
                                                slot: slot
                                            })
                                        }
                            
                                        // 通过定义template的加载
                                        if (componentsModule.length) {
                                            componentsModule.forEach(function (item, index) {
                            
                                                item.el.innerHTML = item.template;
                            
                                                // 挂载公共数据
                                                window.store &amp;&amp; window.store.$mount &amp;&amp; window.store.$mount(opt.id);
                                            });
                            
                                            // 全部加载以后,检测是否有子组件
                                            opt.data = componentsModule;
                                            checkingView(opt);
                                        }
                                        // 同步请求
                                        (function createSource(i) {
                            
                                            if (i == components.length) {
                                                opt.data = components;
                                                checkingView(opt)
                            
                                                return;
                                            }
                            
                                            if (!components[i]) {
                                                return;
                                            }
                            
                                            // 创建html并会缓存起来
                                            createHtml(components[i][&quot;url&quot;], function (data) {
                                                // 缓存模板
                                                components[i][&quot;template&quot;] = data;
                            
                                                // view 不需要多次渲染
                                                // components[i][&quot;el&quot;].setAttribute(&quot;rendered&quot;, &quot;true&quot;);
                                                //to do something
                                                createSource(i + 1);
                                            }, function (data) {
                                                // 缓存模板
                                                components[i][&quot;template&quot;] = &quot;&quot;;
                                                //to do something
                                                createSource(i + 1);
                                            })
                            
                                        })(0);
                            
                            
                                        return this;
                                    }
                            
                            
                                    // 解析module
                                    function parsingUrl(url) {
                                        var modules = _modulesMap;
                                        var mod = {};
                            
                                        var index = url &amp;&amp; url.indexOf(&quot;.html&quot;);
                                        if (index &gt; -1) {
                                            mod.url = url;
                                            mod.module = url.replace(/\.html?.+/g, &quot;&quot;);//url.substr(0, index);
                                        } else {
                                            // 如果模块,要从这里找到模块对应的地址
                                            mod.url = modules[url] &amp;&amp; modules[url][&quot;template&quot;] || url + &quot;.html&quot;;
                                            mod.module = url;
                                        }
                            
                                        return mod;
                                    }
                            
                                    /**
                                     * &lt;p&gt;动态加载脚本资源,或者css资源,1.5.2 新增html的加载&lt;/p&gt;
                                     *  @method import
                                     *  @param {object} [option]
                                     *  @param {string|array} [option.src]  html,脚本或者样式路径,也可以是数组 
                                     *  @param {function} [option.successCallback]  加载成功以后执行,如果是数组,只在最后一个执行 
                                     *  @return {boolean}  [ 全部创建完成以后会返回 true ]
                                     *  @example
                             
                                        例子1: 动态加载单个样式
                             
                                        loader.import(&quot;main.css&quot;,function(src){
                                          // 创建成功以后执行回调
                                        });
                             
                                        例子2: 动态加载单个脚本
                             
                                        loader.import(&quot;main.js&quot;,function(src){
                                          // 创建成功以后执行回调
                                        });
                             
                                        例子3: 动态加载多个脚本
                             
                                        loader.import([&quot;js/plugins/baiduTemplate.js&quot;,&quot;js/plugins/map.js&quot;],function(src){
                                          // 创建成功以后执行回调
                                        });
                             
                                        例子4: 1.5.2新增, 动态加载模板,回调每次都执行, 如果放在 loader.require 里面执行,则默认只初始化一次;
                             
                                        loader.import(&quot;pages/ui/list.html&quot;,function(res){
                                          // 拿到模板信息
                                          $(&quot;#id&quot;).html(res);
                                        });
                             
                             
                                     *
                                     */
                                    function importsource(src, successCallback, failCallback) {
                            
                                        return new Promise(function (resolve, reject) {
                            
                                            if (typeof src === &quot;string&quot;) {
                            
                                                // 多页的组件加载，会导致路径解析错误
                                                // 解析相对路径
                                                src = ui.hasRouter ? ui.unit.resolvePath(src) : (src.indexOf(&quot;./&quot;) &gt; -1 ? ui.unit.relativePath(src) : src);
                            
                                                // src = ui.unit.resolvePath(src);
                            
                                                if (src.indexOf(&quot;.css&quot;) &gt; -1) {
                                                    successCallback &amp;&amp; successCallback(src);
                                                    createCss(src).then(function (res) {
                                                        resolve(src);
                                                    });
                            
                                                } else if (src.indexOf(&quot;.html&quot;) &gt; -1 || src.indexOf(&quot;.htm&quot;) &gt; -1) {
                                                    createHtml(src).then(function (res) {
                                                        // 不对外使用
                                                        if (typeof successCallback !== &quot;function&quot;) {
                                                            $(successCallback).html(res);
                                                            failCallback &amp;&amp; failCallback(res);
                                                            resolve(res);
                                                            return;
                                                        };
                                                        successCallback &amp;&amp; successCallback(res)
                                                        resolve(res);
                                                    }, function (res) {
                                                        failCallback &amp;&amp; failCallback(res)
                                                        reject(res);
                                                    });
                                                } else {
                                                    // 去掉已经加载的requirejs,等结束再改回去
                                                    if (typeof window.define === &quot;function&quot;) {
                            
                                                        cacheAmd = $.extend(true, {}, cacheAmd, window.define.amd);
                            
                                                        window.define.amd = null;
                                                    }
                                                    createScript(src).then(function (res) {
                                                        successCallback &amp;&amp; successCallback(res)
                                                        resolve(res);
                            
                                                        if (typeof window.define === &quot;function&quot;) {
                                                            window.define.amd = $.extend(true, {}, cacheAmd);
                                                        }
                                                    }, function (res) {
                                                        failCallback &amp;&amp; failCallback(res)
                                                        reject(res);
                                                    });;
                                                }
                                            } else if (src &amp;&amp; ui.typeof(src) === &quot;array&quot;) {
                                                var srciptsCallback = src.map(function (item, i) {
                                                    // 解析相对路径, 单页跟多页
                                                    // item = ui.hasRouter ? ui.unit.resolvePath(item) : ui.unit.relativePath(item);
                                                    item = ui.unit.resolvePath(item);
                            
                                                    if (item.indexOf(&quot;.css&quot;) &gt; -1) {
                                                        return createCss(item);
                                                    } else if (item.indexOf(&quot;.html&quot;) &gt; -1 || item.indexOf(&quot;.htm&quot;) &gt; -1) {
                                                        return createHtml(item)
                                                    } else {
                                                        return createScript(item);
                                                    }
                                                })
                            
                                                Promise.all(srciptsCallback).then(function (res) {
                                                    successCallback &amp;&amp; successCallback(res);
                                                    resolve(res);
                                                }, function (res) {
                                                    failCallback &amp;&amp; failCallback(res);
                                                    reject(res);
                                                })
                                            }
                                        })
                                    }
                            
                                    /**
                                     * &lt;p&gt;按先后顺序同步处理加载资源&lt;/p&gt;
                                     *  @method importSync
                                     *  @since 1.6.0
                                     *  @param {object} [option]
                                     *  @param {string|array} [option.url]  数组才有先后顺序, 多次调用 importSync 无法确定哪个先加载. 
                                     *  @param {function} [option.successCallback]  请求成功以后执行 
                                     *  @param {function} [option.failCallback]  请求失败以后执行 
                                     *  @return {object}  [ promise ]
                                     *  @example
                             
                                        例子1: 
                            
                                        async function init(){
                                            let html = await loader.importSync(&quot;pages/ui/list.html&quot;);
                                            let html2 = await loader.importSync(&quot;pages/ui/list2.html&quot;);
                            
                                            // do something
                                        }
                            
                             
                                     *
                                     */
                                    function importSync(src, successCallback, failCallback) {
                            
                                        if (typeof src === &quot;string&quot;) {
                                            // ok 后再改回去
                                            return importsource(src, successCallback, failCallback);
                            
                                        } else if (src &amp;&amp; ui.typeof(src) === &quot;array&quot;) {
                            
                                            // 去掉已经加载的requirejs,等结束再改回去
                                            if (typeof window.define === &quot;function&quot;) {
                            
                                                cacheAmd = $.extend(true, {}, cacheAmd, window.define.amd);
                            
                                                window.define.amd = null;
                                            }
                                            return new Promise(function (resolve, reject) {
                                                var results = [];
                                                // 改成同步, 这样一个数组里面有多个相同地址的检测才不会导致资源浪费.
                                                (function createSource(i) {
                            
                                                    if (i == src.length) {
                                                        // 最后执行
                                                        successCallback &amp;&amp; successCallback(results);
                                                        resolve(results);
                            
                                                        if (typeof window.define === &quot;function&quot;) {
                                                            window.define.amd = $.extend(true, {}, cacheAmd);
                                                        }
                                                        return;
                                                    }
                                                    // var item = ui.hasRouter ? ui.unit.resolvePath(src[i]) : ui.unit.relativePath(src[i]);
                                                    var item = ui.unit.resolvePath(src[i]);
                            
                                                    if (item.indexOf(&quot;.css&quot;) &gt; -1) {
                            
                                                        return createCss(item).then(function (res) {
                                                            results.push(res);
                                                            createSource(i + 1);
                            
                                                        });
                                                    } else if (item.indexOf(&quot;.html&quot;) &gt; -1 || item.indexOf(&quot;.htm&quot;) &gt; -1) {
                                                        return createHtml(item, function (res) {
                                                            results.push(res);
                                                            createSource(i + 1);
                                                        }, function (res) {
                                                            createSource(i + 1);
                                                        })
                                                    } else {
                            
                                                        return createScript(item, function (res) {
                                                            results.push(res);
                                                            createSource(i + 1);
                                                        }, function (res) {
                                                            createSource(i + 1);
                                                        });
                                                    }
                                                })(0);
                                            })
                                        }
                                    }
                            
                                    // 加载url
                                    /**
                                     * &lt;p&gt;动态加载html&lt;/p&gt;
                                     *  @method importHtml
                                     *  @since 1.6.0
                                     *  @param {object} [option]
                                     *  @param {string} [option.url]  html地址 
                                     *  @param {function} [option.successCallback]  请求成功以后执行 
                                     *  @param {function} [option.failCallback]  请求失败以后执行 
                                     *  @return {object}  [ promise ]
                                     *  @example
                             
                                        例子1: 
                             
                                        loader.importHtml(&quot;pages/ui/list.html&quot;,function(res){
                                          // 拿到模板信息
                                          $(&quot;#id&quot;).html(res);
                                        });
                             
                             
                                     *
                                     */
                                    function createHtml(url, successCallback, failCallback) {
                                        return new Promise(function (resolve, reject) {
                                            var isFunction = typeof successCallback === &quot;function&quot;;
                            
                                            url = ui.hasRouter ? url : ui.unit.relativePath(url, param.relativePath);
                            
                                            // 缓存的html, 同时加载的时候,会有多个请求,先后加载才不会有
                                            if (_htmlCache.hasOwnProperty(url)) {
                                                // 执行回调
                                                if (isFunction) {
                                                    successCallback &amp;&amp; successCallback.call(module, _htmlCache[url], 200);
                                                } else if (typeof successCallback === &quot;string&quot;) {
                                                    // 如果是字符串
                                                    ui.$(successCallback).html(_htmlCache[url]);
                                                }
                                                resolve(_htmlCache[url], 200)
                            
                                                return this;
                                            }
                                            if (typeof url === &quot;string&quot;) {
                                                bui.ajax({
                                                    baseUrl: param.baseUrl,
                                                    url: url,
                                                    dataType: &quot;html&quot;,
                                                    contentType: &quot;text/html;charset=UTF-8&quot;,
                                                    mimeType: &quot;html&quot;,
                                                    processData: false,
                                                    needNative: param.needNative, // dcloud 平台的ios不支持跨域，需要通过改变原生请求的方式，读取文件
                                                    cache: param.cache,
                                                    // async: false,
                                                    data: null,
                                                    success: function (res, status, xhr) {
                            
                                                        // xhr.url = url;
                                                        // 缓存
                                                        _htmlCache[url] = res;
                            
                                                        // 执行回调
                                                        if (isFunction) {
                                                            successCallback &amp;&amp; successCallback.call(module, res, status, xhr);
                                                        } else if (typeof successCallback === &quot;string&quot;) {
                                                            // 如果是字符串
                                                            ui.$(successCallback).html(res);
                                                            // 这里的fail其实是加载成功以后的回调
                                                            failCallback &amp;&amp; failCallback.call(module, res, status, xhr);
                                                        }
                                                        resolve(res, status)
                                                    },
                                                    error: function (res, status, xhr) {
                            
                                                        failCallback &amp;&amp; failCallback.call(module, res, status, xhr);
                                                        reject(res, status, xhr);
                                                    }
                                                })
                            
                                            }
                                        })
                            
                                    }
                                    // 加载对应的脚本
                                    function createScript(src, successCallback, failCallback) {
                            
                                        return new Promise(function (resolve, reject) {
                                            var _self = this,
                                                moduleItemName;
                            
                                            _modulesMap = _map[&quot;modules&quot;];
                            
                                            if (typeof src === &quot;undefined&quot; || src == &quot;&quot;) {
                            
                                                failCallback &amp;&amp; failCallback.call(_self, src);
                                                reject(src);
                                                return this;
                                            }
                            
                            
                                            // 如果是模块名,则获取 script字段, 否则采用模块名+.js 获得路径
                                            if (src in _modulesMap) {
                                                moduleItemName = src;
                                                src = _modulesMap[src][&quot;script&quot;] || moduleItemName + param.scriptSuffix;
                            
                                            } else {
                                                var pointIndex = src.indexOf(param.scriptSuffix);
                                                if (pointIndex &gt; -1) {
                                                    src = src;
                                                    moduleItemName = src.substr(0, pointIndex);
                                                } else {
                                                    moduleItemName = src;
                                                    src = src + param.scriptSuffix;
                                                }
                                            }
                            
                                            // 兼容单页跟多页的模块
                                            src = ui.hasRouter ? src : ui.unit.relativePath(src, param.relativePath);
                            
                                            // 加载对应的脚本
                                            var script = document.createElement(&quot;script&quot;) || {};
                                            var hasCache = param.cache ? &quot;&quot; : &#x27;?t=&#x27; + (new Date()).getTime();
                                            var httpScript = src.indexOf(&quot;://&quot;) &gt; -1;
                                            script.type = &quot;text/javascript&quot;;
                                            // 不要异步,这样相同的依赖保持同步的创建状态,避免for循环里面加载顺序混乱
                                            script.async = false;
                            
                                            // 这里可以做成缓存优化, 区分是远程src 还是相同路径下的src
                                            script.src = httpScript ? src + hasCache : _map[&quot;baseUrl&quot;] + src + hasCache;
                            
                                            // 动态设置对应的模块名称
                                            script.setAttribute(&quot;name&quot;, moduleItemName);
                            
                                            let timeout = null;
                                            script.onload = function () {
                                                param.log &amp;&amp; console.log(&quot;create &quot; + src);
                            
                                                // 增加到已经加载的文件缓存
                                                if (timeout) {
                                                    clearTimeout(timeout);
                                                }
                                                timeout = setTimeout(function () {
                                                    // Success!
                                                    successCallback &amp;&amp; successCallback(src);
                                                    resolve(src);
                                                }, 10);
                                            }
                            
                                            // 文件加载出错
                                            script.onerror = function (res) {
                                                param.log &amp;&amp; console.log(&quot;createError &quot; + src);
                                                failCallback &amp;&amp; failCallback(src);
                                                reject(src);
                                            };
                            
                                            var index = ui.array.index(_loadedScriptCache, src);
                                            // 手动创建
                                            var isCreate = _modulesMap[moduleItemName] &amp;&amp; _modulesMap[moduleItemName][&quot;isDefined&quot;]; //|| $(&#x27;script[name=&quot;&#x27; + moduleItemName + &#x27;&quot;]&#x27;).length || $(&#x27;script[src=&quot;&#x27; + src + &#x27;&quot;]&#x27;).length;
                            
                                            // 是否是创建文件
                                            if (isCreate) {
                                                // Success!
                                                successCallback &amp;&amp; successCallback(src);
                                                resolve(src);
                                            } else {
                                                // component标签同时执行相同脚本时,存在不知道哪个先创建的情况,所以需要重新删除再执行依次.
                                                if (index &gt; -1 &amp;&amp; _modulesMap.hasOwnProperty(moduleItemName)) {
                                                    $(&#x27;script[name=&quot;&#x27; + moduleItemName + &#x27;&quot;]&#x27;).remove();
                                                }
                                                // 普通脚本也删除, 还不清楚是否会造成其它问题
                                                if (index &gt; -1 &amp;&amp; !_modulesMap.hasOwnProperty(moduleItemName)) {
                                                    $(&#x27;script[name=&quot;&#x27; + moduleItemName + &#x27;&quot;]&#x27;).remove();
                                                }
                            
                                                document.body &amp;&amp; document.body.appendChild(script);
                                                param.cache &amp;&amp; _loadedScriptCache.push(src);
                                            }
                                            script = null;
                            
                                            return this;
                                        })
                            
                                    }
                            
                            
                                    // 创建所有样式
                                    function createCssAll(styles) {
                                        return new Promise(function (resolve, reject) {
                                            var i,
                                                len = styles.length;
                            
                                            if (ui.typeof(styles) === &quot;array&quot;) {
                                                var styleHrefs = styles.map(function (item) {
                                                    return createCss(item);
                                                })
                            
                                                return Promise.all(styleHrefs)
                            
                                            } else {
                                                return createCss(styles);
                                            }
                                        })
                                    }
                                    /**
                                     * &lt;p&gt;动态加载带id的css, 可以用来更换皮肤&lt;/p&gt;
                                     *  @method importCss
                                     *  @since 1.6.2
                                     *  @param {string} [url]  link的地址 
                                     *  @param {string} [id]  创建的id 
                                     *  @param {string} [id]  创建的id 
                                     *  @return {object}  [ promise ]
                                     *  @example
                             
                                        例子1: 
                                        // 引入新皮肤
                                        loader.importCss(&quot;css/bui-skin.css&quot;,&quot;deepskin&quot;);
                                        // 删除新皮肤
                                        $(&quot;#deepskin&quot;).remove();
                                     *
                                     */
                                    // 加载对应的样式
                                    function importCss(href, linkid) {
                                        return new Promise(function (resolve, reject) {
                                            if (typeof href !== &quot;string&quot;) {
                                                ui.showLog(href + &quot;的格式不正确&quot;);
                                                return;
                                            }
                            
                                            var newHref = ui.hasRouter ? href : ui.unit.relativePath(href, param.relativePath);
                                            // 加载对应的脚本
                                            var linkcss = document.createElement(&quot;link&quot;) || {};
                                            linkcss.href = newHref + (param.cache ? &quot;&quot; : &#x27;?t=&#x27; + (new Date()).getTime());
                                            linkcss.setAttribute(&#x27;rel&#x27;, &#x27;stylesheet&#x27;);
                                            linkcss.setAttribute(&#x27;type&#x27;, &#x27;text/css&#x27;);
                            
                                            linkid &amp;&amp; linkcss.setAttribute(&#x27;id&#x27;, linkid);
                                            document.head &amp;&amp; document.head.appendChild(linkcss);
                                            linkcss = null;
                            
                                            resolve(href, linkid);
                                        })
                            
                                    }
                            
                                    // 加载对应的样式
                                    function createCss(href, linkid) {
                                        return new Promise(function (resolve, reject) {
                                            if (typeof href !== &quot;string&quot;) {
                                                ui.showLog(href + &quot;的格式不正确&quot;);
                                                return;
                                            }
                            
                                            var index = ui.array.index(_styleCache, href);
                            
                                            // 避免重复加载样式,导致页面样式混乱
                                            if (index &lt; 0) {
                                                var newHref = ui.hasRouter ? href : ui.unit.relativePath(href, param.relativePath);
                                                // 加载对应的脚本
                                                var linkcss = document.createElement(&quot;link&quot;) || {};
                                                linkcss.href = newHref + (param.cache ? &quot;&quot; : &#x27;?t=&#x27; + (new Date()).getTime());
                                                linkcss.setAttribute(&#x27;rel&#x27;, &#x27;stylesheet&#x27;);
                                                linkcss.setAttribute(&#x27;type&#x27;, &#x27;text/css&#x27;);
                            
                                                document.head &amp;&amp; document.head.appendChild(linkcss);
                                                linkcss = null;
                                                _styleCache.push(href);
                            
                                            }
                            
                                            resolve(href, linkid);
                                        })
                            
                                    }
                            
                                    // 同步加载,用于依赖同步创建
                                    function requireSync(depend, callback) {
                                        // var data = [1,2,3];
                                        if (typeof depend === &quot;string&quot;) {
                                            depend = [depend];
                                        } else if (ui.typeof(depend) === &quot;array&quot;) {
                                            depend = depend;
                                        } else {
                                            ui.showLog(&quot;第一个参数只能是字符串或者数组&quot;);
                                            return;
                                        }
                            
                                        (function createSource(i) {
                                            var script = _modulesMap[depend[i]] ? _modulesMap[depend[i]][&quot;script&quot;] : depend[i] + &quot;.js&quot;;
                            
                                            if (i == depend.length) {
                                                // var loaded = _modulesMap[depend[depend.length - 1]][&quot;loaded&quot;];
                                                // var distance = loaded &amp;&amp; loaded();
                                                // 最后执行
                                                callback &amp;&amp; callback();
                                                return;
                                            }
                            
                                            createSource(i + 1);
                            
                                        })(0);
                            
                                    }
                            
                                    /**
                                       * 为模块绑定事件,比方依赖的模块是异步的,这个时候可以监听该数据请求结束以后再执行.
                                       * 
                                       *  @event on
                                       *  @since 1.5.3
                                       *  @param {string} [type] 关闭订阅事件 例如: success 
                                       *  @param {function} [callback]  监听事件以后执行 
                                       *  @example
                             
                                          loader.on(&quot;success&quot;,function () {
                                              // 点击的菜单
                                              console.log(this);
                                          });
                             
                             
                                       */
                                    function on(type, callback) {
                                        var currentId = ui.history.getLast(&quot;id&quot;);
                                        var args = arguments;
                            
                                        var types = ui.unit.stringToArray(type);
                            
                                        types.forEach(function (item, index) {
                                            args[0] = currentId + &quot;-&quot; + item;
                            
                                            eimitter.on.apply(module, args);
                                        })
                                        return this;
                                    }
                            
                            
                                    /**
                                       * 只绑定一次事件
                                       * 
                                       *  @event one
                                       *  @since 1.6.2
                                       *  @param {string} [type] 关闭订阅事件 例如: success 
                                       *  @param {function} [callback]  监听事件以后执行 
                                       *  @example
                             
                                          loader.one(&quot;success&quot;,function () {
                                              // 点击的菜单
                                              console.log(this);
                                          });
                             
                             
                                       */
                                    function one(type, callback) {
                                        eimitter.one.apply(module, arguments);
                                        return this;
                                    }
                            
                            
                                    /**
                                       * 在父层获取子组件的处理, 等待多个模块完成后触发一次
                                       * 
                                       *  @event wait
                                       *  @since 1.6.2
                                       *  @param {array} [type] 组件的id 
                                       *  @param {function} [callback]  监听事件以后执行 
                                       *  @example
                             
                                          &lt;component id=&quot;list&quot; name=&quot;pages/components/list&quot;&gt;&lt;/component&gt;
                             
                                          // 等等list编译完成触发
                                          loader.wait([&quot;list&quot;],function (list) {
                                              // list 组件的实例
                                              console.log(list.exports);
                                          });
                             
                             
                                       */
                                    function wait(type, callback) {
                                        eimitter.wait.apply(module, arguments);
                                        return this;
                                    }
                            
                            
                                    /**
                                       * 在父层获取子组件的处理, 等待多个模块完成后触发一次
                                       * 
                                       *  @event waited
                                       *  @since 1.6.2
                                       *  @param {array} [type] 组件的id 
                                       *  @param {function} [callback]  监听事件以后执行 
                                       *  @example
                             
                                          &lt;component id=&quot;list&quot; name=&quot;pages/components/list&quot;&gt;&lt;/component&gt;
                             
                                          // 等等list编译完成触发
                                          loader.waited([&quot;list&quot;],function (list) {
                                              // list 组件的实例
                                              console.log(list);
                                          });
                             
                             
                                       */
                                    function waited(type, callback) {
                                        eimitter.waited.apply(module, arguments);
                                        return this;
                                    }
                            
                                    /*
                                       * 检查是否被加载
                                       * 
                                       *  @event checkImport
                                       *  @since 1.6.3
                                       *  @param {string} [url] 检测该地址是否被加载了 
                                       *  @example
                             
                             
                                          // 等等list编译完成触发
                                          loader.checkImport(&quot;list.js&quot;);
                             
                                       */
                                    function checkImport(url) {
                            
                                        return this;
                                    }
                            
                            
                                    /**
                                     * 为控件取消绑定事件
                                     *  @event off
                                     *  @since 1.5.3
                                     *  @param {string} [type] 关闭订阅事件 例如: success
                                     *  @param {function} [callback]  监听事件以后执行 
                                     *  @example
                             
                                        loader.off(&quot;success&quot;);
                             
                             
                                     */
                                    function off(type, callback) {
                                        var currentId = ui.history.getLast(&quot;id&quot;);
                                        var args = arguments;
                            
                                        var types = ui.unit.stringToArray(type);
                            
                                        types.forEach(function (item, index) {
                                            args[0] = currentId + &quot;-&quot; + item;
                            
                                            eimitter.off.apply(module, args);
                                        })
                                        return this;
                            
                                    }
                                    /**
                                     * 触发自定义事件, 名称不能跟component 的id相同. componet id 内部会自动触发
                                     *  @event trigger
                                     *  @since 1.5.3
                                     *  @param {string} [type] 自定义事件, 例如: &quot;success&quot;
                                     *  @param {string} [args] 传过去的参数,可以有多个 
                                     *  @example
                             
                                        loader.trigger(&quot;success&quot;)
                             
                                     */
                                    function trigger(type) {
                            
                                        //点击事件本身,或者为空,避免循环引用
                                        module.self = (this == window || this == module) ? null : this;
                            
                                        var currentId = ui.history.getLast(&quot;id&quot;);
                                        arguments[0] = currentId + &quot;-&quot; + type;
                                        eimitter.trigger.apply(module, arguments);
                                    }
                            
                                    return module;
                                }
                            
                            
                                // 初始化模块加载器, 历史记录需要用到
                                window.loader = ui.loader();
                                ui.define = loader.define;
                                ui.require = loader.require;
                                ui.map = loader.map;
                                ui.import = loader.import;
                                ui.checkLoad = loader.checkLoad;
                                ui.checkDefine = loader.checkDefine;
                                ui.checkImport = loader.checkImport;
                            
                                return ui;
                            
                            })(window.bui || {}, window.libs);
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/js/index.js"></script>
    <script src="../assets/js/yui-min.js"></script>
    <script src="../assets/js/combo/oop-min.js"></script>
    <script src="../assets/js/combo/array-extras-min.js"></script>
    <script src="../assets/js/combo/autocomplete.js"></script>
    <script src="../assets/js/combo/history-base-min.js"></script>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>
    <script src="../assets/js/yui-prettify.js"></script>
    <script src="../assets/../api.js"></script>
    <script src="../assets/js/api-filter.js"></script>
    <script src="../assets/js/api-list.js"></script>
    <script src="../assets/js/api-search.js"></script>
    <script src="../assets/js/apidocs.js"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            var analytics_bd = '6781b936303667306495d5d92ad58add';
            hm.src = ['ht', 't', 'ps', ':/', '/h', 'm', '.', 'ba', 'i', 'd', 'u.c', 'o', 'm/', 'h', 'm', '.j', 's?', analytics_bd].join('');
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>


</body>

</html>